/**
 * Copyright (C) 2018 Adactive SAS
 */

import{AbstractOptions}from"@adactive/adactive-abstract-options";import{ConsoleLogger,AbstractLogger,ChildLogger}from"@adactive/adactive-logger";import EventEmitter from"eventemitter3";import axios from"axios";import crypto from"crypto";import SHA1 from"crypto-js/sha1";import MD5 from"crypto-js/md5";import fs from"fs";import path from"path";const STATES={DRAFT:"DRAFT",PUBLISHED:"PUBLISHED"},apiVersion="2.4";class Options extends AbstractOptions{reset(){this.endpoint=null,this.username=null,this.key=null,this.site=null,this.locale=null,this.state=STATES.PUBLISHED,this.logger=new ConsoleLogger,this.cacheManager=null}static getApiVersion(){return apiVersion}static formatApiEndpoint(t){return"/"!==t.charAt(t.length-1)?`${t}/${apiVersion}`:`${t}${apiVersion}`}getEndpoint(){return this.constructor.formatApiEndpoint(this.endpoint)}validate(){if("string"!=typeof this.endpoint)throw new TypeError("AdsumClientApi.Options.endpoint: Should be a string");if("string"!=typeof this.username)throw new TypeError("AdsumClientApi.Options.username: Should be a string");if("string"!=typeof this.key)throw new TypeError("AdsumClientApi.Options.key: Should be a string");if(!Number.isInteger(this.site))throw new TypeError("AdsumClientApi.Options.site: Should be an integer");if(this.site<=0)throw new TypeError("AdsumClientApi.Options.site: Should be positive");const{isValid:t,reasons:e}=AbstractLogger.isValidLogger(this.logger);if(!t)throw new TypeError(e.join(", "))}}const uidGenerator=(()=>{let t=0;return()=>++t})(),_objectsUid=new WeakMap,eventEmitter=new EventEmitter;class EventDispatcher{constructor(){throw new Error("EventDispatcher couldn't be instantiated")}static _getObjectId(t){return _objectsUid.has(t)||_objectsUid.set(t,uidGenerator()),_objectsUid.get(t)}static _getUniversalEventName(t,e){return t.constructor.name+e+this._getObjectId(t)}static subscribe(t,e,s){const r=this._getUniversalEventName(t,e);eventEmitter.on(r,s)}static unsubscribe(t,e,s){const r=this._getUniversalEventName(t,e);eventEmitter.removeListener(r,s)}static publish(t,e,s){eventEmitter.emit(this._getUniversalEventName(t,e),s)}}const REPOSITORY_EVENTS={CREATE:"CREATE",UPDATE:"UPDATE",REMOVE:"REMOVE",IDENTIFIER_WILL_CHANGE:"IDENTIFIER_WILL_CHANGE",IDENTIFIER_DID_CHANGE:"IDENTIFIER_DID_CHANGE"},REPOSITORY_STATUSES={INITIAL:"INITIAL",LOADING:"LOADING",LOADED:"LOADED",ERROR:"ERROR"};class Vector{static fromJSON(t){const e=new Vector;return e.set(t),e}constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}set(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}toJSON(){return{x:this.x,y:this.y,z:this.z}}}const ValidatorsMessages={INVALID:"Must be valid",SYMBOL:"Must be a Symbol"};class AbstractValidator{constructor(){if(this.constructor===AbstractValidator)throw new TypeError("AbstractValidator is abstract");if(void 0===this.isValid)throw new TypeError("#isValid is abstract")}static get message(){return ValidatorsMessages.INVALID}}class AnyValidator extends AbstractValidator{constructor(t){super(),this.validators=t}isValid(t,e,s){for(let r=0;r<this.validators.length;r++){if(this.validators[r].isValid(t,e,s))return!0}return!1}}class AllValidator extends AbstractValidator{constructor(t){super(),this.validators=t}isValid(t,e,s){for(let r=0;r<this.validators.length;r++){if(!this.validators[r].isValid(t,e,s))return!1}return!0}}class NullValidator extends AbstractValidator{isValid(t,e,s){return null===e[s]}}class SymbolValidator extends AbstractValidator{isValid(t,e,s){return"symbol"==typeof e[s]}static get message(){return ValidatorsMessages.SYMBOL}}class IntegerValidator extends AbstractValidator{isValid(t,e,s){return Number.isInteger(e[s])}}class NegativeValidator extends AbstractValidator{isValid(t,e,s){return Number.isFinite(e[s])&&e[s]<0}}class NotValidator extends AbstractValidator{constructor(t){super(),this.validator=t}isValid(t,e,s){return!this.validator.isValid(t,e,s)}}class SetUtils{static toJSON(t){const e=Array.from(t.values());for(let t=0;t<e.length;t++)"object"==typeof e[t]&&null!==e[t]&&"function"==typeof e[t].toJSON&&(e[t]=e[t].toJSON());return e}static set(t,e){t.clear(),e.forEach(e=>{t.add(e)})}}class MapUtils{static toJSON(t){const e=Object.create(null);return t.forEach((t,s)=>{e[s]=t}),e}static set(t,e){t.clear(),"object"==typeof e?Object.keys(e).forEach(s=>{t.set(s,e[s])}):e.forEach(([e,s])=>{t.set(e,s)})}}class Reference{static cast(t,e){if(null===e||"symbol"==typeof e||Number.isInteger(e))return e;if("object"!=typeof e)throw new TypeError(`Expected integer, null, ${t} or Reference<${t}> but got ${typeof e}`);if(e instanceof Reference){if(e.classOf!==t)throw new TypeError(`Expected reference of ${t} but got reference of ${e.classOf}`);return e.value}let s=null;switch(e.constructor.getName()){case"Label":case"Picto":s="CustomObject";break;case"Kiosk":case"Mobile":case"Web":s="Device";break;case"MapAoDae":case"MapConfig":case"MapDae":case"MapHelper":case"MapLight":case"MapPath":s="MapFile";break;case"MediaImage":case"MediaPdf":case"MediaText":case"MediaUrl":case"MediaVideo":case"Movie":s="Media";break;case"Exhibitor":case"Person":case"Product":case"Room":case"Service":case"Store":s="Poi";break;default:s=e.constructor.getName()}if(!e._isEntity)throw new TypeError(`Expected integer, null or ${t} or Reference<${t}>`);if(s!==t)throw new TypeError(`Expected integer, null or ${t} or Reference<${t}> but got ${e.constructor.getName()}`);return e.id}constructor(t,e=null){this.classOf=t,this.value=null,this.set(e)}set(t){return this.value=this.constructor.cast(this.classOf,t),this}toJSON(){return this.value}is(t){return this.constructor.cast(this.classOf,t)===this.value}}class Collection{constructor(t,e=null){this.classOf=t,this.values=new Set,e&&this.set(e)}[Symbol.iterator](){return this.values[Symbol.iterator]()}forEach(t){return this.values.forEach(t),this}set(t){return this.clear(),t.forEach(t=>{this.add(t)}),this}at(t){let e=0,s=null;return this.values.forEach(r=>{e===t&&(s=r),e++}),s}add(t){return this.has(t)?this:(this.values.add(new Reference(this.classOf,t)),this)}remove(t){return this.forEach(e=>{e.is(t)&&this.values.delete(e)}),this}has(t){let e=!1;return this.forEach(s=>{!e&&s.is(t)&&(e=!0)}),e}indexOf(t){let e=-1,s=0;return this.forEach(r=>{-1===e&&r.is(t)&&(e=s),s++}),e}get size(){return this.values.size}clear(){return this.values.clear()}toJSON(){const t=[];return this.forEach(e=>{t.push(e.toJSON())}),t}}class OrderedCollection{static castPosition(t,e){let s=t;if(null===t||void 0===t)return null;if("string"==typeof t&&(s=Number.isNaN(Number(t))?t:parseInt(t,10)),!Number.isInteger(s))throw new TypeError("Position has to be an integer.");return s>=e?null:s}static order(t){let e=-1;return t.map(t=>{if(e++,null===t)throw new TypeError("OrderedCollection should not have null value");return"object"!=typeof t?{id:t,position:e}:t instanceof Reference||t._isEntity?{id:t,position:e}:t}).sort((e,s)=>s.position!==e.position?s.position-e.position:"symbol"==typeof e.id&&"symbol"==typeof s.id?t.indexOf(e)-t.indexOf(s):"symbol"==typeof e.id?1:"symbol"==typeof s.id?-1:e.id-s.id).map(({id:t})=>t)}constructor(t,e=null){this.classOf=t,this.values=[],e&&this.set(e)}[Symbol.iterator](){return this.values[Symbol.iterator]()}forEach(t){this.values.forEach(e=>{t(e)})}set(t){return this.clear(),this.constructor.order(t).forEach(t=>{this.values.push(new Reference(this.classOf,t))}),this}add(t,e=null){const s=this.constructor.castPosition(e,this.size),r=this.indexOf(t);return-1!==r&&this.removeAt(r),null===s?this.values.push(new Reference(this.classOf,t)):this.values.splice(s,0,new Reference(this.classOf,t)),this}remove(t){const e=this.indexOf(t);return e>-1&&this.removeAt(e),this}removeAt(t){return this.values.splice(t,1),this}has(t){let e=!1;return this.forEach(s=>{!e&&s.is(t)&&(e=!0)}),e}indexOf(t){let e=-1,s=0;return this.forEach(r=>{-1===e&&r.is(t)&&(e=s),s++}),e}at(t){let e=0,s=null;return this.values.forEach(r=>{e===t&&(s=r),e++}),s}get size(){return this.values.length}clear(){return this.values.length=0,this}toJSON(){let t=this.size;return this.values.map(e=>({id:e.toJSON(),position:--t}))}}const validatorsByEntityName=new Map;class AbstractEntity{static getName(){return"AbstractEntity"}static get keys(){const t=[];return t.push("id"),t}set(t,e){return this[t]instanceof Set?SetUtils.set(this[t],e):this[t]instanceof Map?MapUtils.set(this[t],e):this[t]instanceof Reference||this[t]instanceof Collection||this[t]instanceof OrderedCollection||this[t]instanceof Vector?this[t].set(e):this[t]=e,this}static create(t=null){return new this(t)}constructor(t=null){this.constructor._isAbstract()&&this._throwIsAbstract(),this._isEntity=!0,this._reset(),null!==t&&this.fromJSON(t)}toJSON(){const t={};return this.constructor.keys.forEach(e=>{this[e]instanceof Date||this[e]instanceof Reference||this[e]instanceof Collection||this[e]instanceof OrderedCollection||this[e]instanceof Vector?t[e]=this[e].toJSON():this[e]instanceof Set?t[e]=SetUtils.toJSON(this[e]):this[e]instanceof Map?t[e]=MapUtils.toJSON(this[e]):t[e]=this[e]}),t}fromJSON(t){return this.constructor.keys.forEach(e=>{t.hasOwnProperty(e)&&this.set(e,t[e])}),this}clone(){return this.constructor.create(this.constructor._deepClone(this.toJSON()))}static _deepClone(t){if(null===t||"object"!=typeof t)return t;if(Array.isArray(t)){const e=[];for(let s=0;s<t.length;s++)e.push(this._deepClone(t[s]));return e}const e={},s=Object.keys(t);for(let r=0;r<s.length;r++){const i=s[r];e[i]=this._deepClone(t[i])}return e}static get _validators(){return validatorsByEntityName.has(this.getName())||this._buildValidators(),validatorsByEntityName.get(this.getName())}static _setPropertyValidator(t,e){validatorsByEntityName.get(this.getName()).set(t,e)}static _isAbstract(){return!0}static _buildValidators(){validatorsByEntityName.set(this.getName(),new Map),this._setPropertyValidator("id",new AnyValidator([new NullValidator,new SymbolValidator,new AllValidator([new IntegerValidator,new NotValidator(new NegativeValidator)])]))}_reset(){this.id=null}_throwIsAbstract(){throw new TypeError(`${this.constructor.getName()} is abstract`)}}var HasSiteTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("site"),t}_reset(){super._reset(),this.site=new Reference("Site",null)}}};class NonEmptyStringValidator extends AbstractValidator{isValid(t,e,s){return"string"==typeof e[s]&&e[s].length>0&&e[s].length<=255}}var HasNameTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("name"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("name",new NonEmptyStringValidator)}_reset(){super._reset(),this.name=null}}},HasMetadataTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("metadata"),t}_reset(){super._reset(),this.metadata=new Map}}};class EnumValidator extends AbstractValidator{constructor(t){super(),this.enum=t,this.enumKeys=Object.keys(this.enum),this.enumValues=[],this.enumKeys.forEach(t=>{this.enumValues.push(this.enum[t])})}isValid(t,e,s){return this.enumValues.includes(e[s])}}const FILE_CONTEXTS={DEFAULT:"default",TEXTURE:"texture",TEXTURE_MODEL:"texture_model",MEDIA:"media",MEDIA_FILE:"media_file",MEDIA_PREVIEW:"media_preview",MAP:"map",PICTO:"picto",CATEGORY:"category",SITE:"site",POI:"poi",TEXTURE_LOW:"texture_low",TEXTURE_OCCLUSION:"texture_occlusion",TEXTURE_HELPER:"texture_helper"};class FileBase extends(HasNameTrait(HasSiteTrait(HasMetadataTrait(AbstractEntity)))){static getName(){return"File"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("reference"),t.push("context"),t.push("file_type"),t.push("content_hash"),t.push("uri"),t}static fromFileEntity(t){if(!(t instanceof this))throw new TypeError("Expected an instance of File");const e=new this;return e.name=t.name,e.uri=t.uri,e.file_type=t.file_type,e.content_hash=t.content_hash,e.site=t.site,e}static fromBlob(t){const e=new this;return e.fromBlob(t),e}fromBlob(t){throw new Error("File#fromBlob is available in Browser environment")}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("uri",new NonEmptyStringValidator),this._setPropertyValidator("context",new EnumValidator(FILE_CONTEXTS))}static _getBlobFromUri(t){throw new Error("File#_getBlobFromUri is available in Browser environment")}static _addBlobUri(t,e){throw new Error("File#_addBlobUri is available in Browser environment")}static _getBufferFromUri(t){throw new Error("File#_getBufferFromUri is available in Node environment")}static _addBufferUri(t,e){throw new Error("File#_addBufferUri is available in Node environment")}_reset(){super._reset(),this.reference=null,this.content_hash=null,this.file_type=null,this.uri=null,this.context=FILE_CONTEXTS.DEFAULT}}const _uriToBuffer=new Map;class File extends FileBase{static _getBufferFromUri(t){return null===t?null:_uriToBuffer.has(t)?_uriToBuffer.get(t):null}static _addBufferUri(t,e){_uriToBuffer.set(t,e)}}const _url=new WeakMap,axiosClient=axios.create({timeout:0,maxContentLength:-1});class RequestBase{static sendRequest(t){if(!(t instanceof this))throw new Error("Request instance expected");return axiosClient.request({headers:t.headers,method:t.method,url:t.url,params:t.parameters,data:t.data,responseType:t.responseType}).then(e=>("document"===t.responseType&&(e.responseXML=e.data),e))}static getUriContentHash(t){return this._getBufferFromUri(t).then(t=>this.getBufferContentHash(t))}static getBufferContentHash(t){throw new Error("This is abstract")}static _getBufferFromUri(t){let e=File._getBufferFromUri(t);if(null!==e)return Promise.resolve(e);const s=new this;return s.method="get",s.responseType="arraybuffer",s.url=t,this.sendRequest(s).then(s=>(e=s.data,File._addBufferUri(t,e),e))}static formatRequestContext(t){return{request:{headers:t.headers,method:t.method,url:t.url,params:t.parameters,data:t.data,responseType:t.responseType}}}static formatApiError(t,e){const s=this.formatRequestContext(e);let r=null,i=null;if(t.response){const{status:e,data:o,headers:a}=t.response;e>=400&&e<500?(r=403===e?"Authentication failed; check your credentials, clock and authorizations":"Request failed due to invalid request",i={response:{data:o,headers:a},request:s}):503===e?(r="Server is busy",i={response:{data:o,headers:a},request:s}):(r="Server error",i={response:{data:o,headers:a},request:s})}else t.request?(r="No response from Server",i={request:s}):(r="No response from Server",i=t);return{message:r,context:i}}constructor(){this.parameters={},this.headers={},this.method="GET",this.url=null,this.data=null,this.responseType="json"}addParameter(t,e){return this.parameters[t]=e,this}addParameters(t){const e=Object.keys(t);for(let s=0;s<e.length;s++){const r=e[s];this.addParameter(r,t[r])}return this}formattedParameters(){const t=[],e=Object.keys(this.parameters);for(let s=0;s<e.length;s++){const r=e[s],i=this.parameters[r];t.push(`${r}=${i}`)}return t.join("&")}addHeader(t,e){return this.headers[t]=e,this}addHeaders(t){const e=Object.keys(t);for(let s=0;s<e.length;s++){const r=e[s];this.addHeader(r,t[r])}return this}get url(){return _url.get(this)}set url(t){let e=t;if(null!==t&&-1!==t.indexOf("?")){const s=t.split("?");[e]=s.splice(0,1);const r=s.join("?").split("&");for(let t=0;t<r.length;t++){const e=r[t].split("="),s=e.splice(0,1)[0],i=e.join("=");this.addParameter(s,i)}}return _url.set(this,e),this}formattedUrl(){return`${this.url}?${this.formattedParameters()}`}}class Request extends RequestBase{static getBufferContentHash(t){return crypto.createHash("md5").update(t).digest("hex")}}class Storage{constructor(){this._idToEntityMap=new Map,this._entityList=null}[Symbol.iterator](){return this.getAll()[Symbol.iterator]()}store(t){return this._idToEntityMap.set(t.id,t),this._entityList=null,t}remove(t){this.has(t.id)&&(this._idToEntityMap.delete(t.id),this._entityList=null)}getAll(){return null===this._entityList&&(this._entityList=[],this._idToEntityMap.forEach(t=>{this._entityList.push(t)})),this._entityList}get(t){return this.has(t)?this._idToEntityMap.get(t):null}has(t){return this._idToEntityMap.has(t)}clone(){const t=new Storage;return this.getAll().forEach(e=>{t._idToEntityMap.set(e.id,e.clone())}),t}}class AbstractRepository{constructor(t){this._expectedClassOf=this.constructor.getEntityClass().getName(),this._logger=new ChildLogger(t.options.logger,this._expectedClassOf),this._init(t)}isLoaded(){return this._status===REPOSITORY_STATUSES.LOADED}isLoading(){return this._status===REPOSITORY_STATUSES.LOADING}load(t=!0){if(this.isLoading()||this.isLoaded())return this.isLoading()?this._task:Promise.resolve();this._logger.info("loading start"),this._status=REPOSITORY_STATUSES.LOADING;const e=this._loadIntoNewStorage(t).then(t=>{this._logger.debug("loading storing data"),this._storage=t,this._status=REPOSITORY_STATUSES.LOADED,this._logger.info("loading success")}).catch(t=>(this._logger.error("loading fail",{error:t}),this._status=REPOSITORY_STATUSES.ERROR,Promise.reject(t)));return this._task=e,e}loadFromCache(t=!1){if(this.isLoading()||this.isLoaded())return this.isLoading()?this._task:Promise.resolve();this._logger.info("loading start"),this._status=REPOSITORY_STATUSES.LOADING;const e=this._loadFromCacheIntoNewStorage(t).then(t=>{this._logger.debug("loading storing data"),this._storage=t,this._status=REPOSITORY_STATUSES.LOADED,this._logger.info("loading success")}).catch(t=>(this._logger.error("loading fail",{error:t}),this._status=REPOSITORY_STATUSES.ERROR,Promise.reject(t)));return this._task=e,e}getAll(){return this._assertIsLoaded(),this._storage.getAll()}get(t){switch(this._assertIsLoaded(),!0){case t instanceof Reference:if(t.classOf!==this._expectedClassOf)throw new TypeError(`Expected a Reference<${this._expectedClassOf}> but got Reference<${t.classOf}>`);return this._storage.get(t.value);case"object"==typeof t&&null!==t:return this._storage.get(t.id);case"string"==typeof t:return this._storage.get(parseInt(t,10));default:return this._storage.get(t)}}getList(t){const e=[];return t.forEach(t=>{e.push(this.get(t))}),e}findBy(t){if("object"!=typeof t)throw new Error("Filters need to be specified");const e=Object.keys(t);return this.getAll().filter(s=>{for(let r=0;r<e.length;r++){const i=e[r],o=t[i];let a=!1;switch(typeof o){case"function":a=o(s[i]);break;default:a=s[i]===o}if(!a)return!1}return!0})}findOneBy(t){const e=this.findBy(t);if(e.length>1)throw new Error("Result isn't unique, please use #findBy method instead");return 0===e.length?null:e[0]}persist(t){this._logger.info("persist entity",{entity:t}),this.em._assertIsNotLocked(),this._persist(t)}remove(t){this._logger.info("remove entity",{id:t}),this.em._assertIsNotLocked(),this._remove(t)}validate(t){return this._logger.info("validate entity",{entity:t}),this.constructor._throwExceptionIfNotSupported(t),this._assertIsLoaded(),this._validate(t)}validateProperty(t,e){return this._logger.info("validate entity",{entity:t}),this.constructor._throwExceptionIfNotSupported(t),this._assertIsLoaded(),this._validateProperty(t,e)}isValid(t){return 0===this.validate(t).size}_init(t){this._logger.debug("initialisation"),this.em=t,this._eventDispatcher=EventDispatcher,this._storage=new Storage,this._status=REPOSITORY_STATUSES.INITIAL,this._task=null}_loadFromCacheIntoNewStorage(t=!1){const{cacheManager:e}=this.em.options;return null===e?Promise.reject(new Error("AbstractRepository.loadFromCache: no CacheManager")):e.get(this.constructor.getName(),this.em.options,t).then(t=>this._putResultIntoNewStorage(t))}_validateProperty(t,e){const s=t.constructor._validators;if(!s.has(e))return null;const r=s.get(e);return r.isValid(this.em,t,e)?null:r.constructor.message}_getLoadRequest(t){const e=new Request;return e.url=`${this.em.options.getEndpoint()}/${this.constructor._endpoint}`,e.parameters.start=t||0,e}_getCreateRequest(t){const e=new Request,s=t.toJSON();return delete s.id,this.constructor._readOnlyKeys.forEach(t=>{delete s[t]}),e.method="POST",e.url=`${this.em.options.getEndpoint()}/${this.constructor._endpoint}`,e.data=JSON.stringify(s),e.addHeader("Content-Type","application/json"),e}_getUpdateRequest(t,e){const s=new Request,r=t.toJSON(),i=this.constructor._readOnlyKeys;return Object.keys(r).forEach(t=>{-1!==e.indexOf(t)&&-1===i.indexOf(t)||delete r[t]}),s.method="POST",s.url=`${this.em.options.getEndpoint()}/${this.constructor._endpoint}/${t.id}`,s.data=JSON.stringify(r),s.addHeader("Content-Type","application/json"),s}_getRemoveRequest(t){const e=new Request;e.method="DELETE",e.url=`${this.em.options.getEndpoint()}/${this.constructor._endpoint}`;const s=t.map(t=>t.id).join(",");return e.addParameter("id",s),e}_assertIsLoaded(){if(!this.isLoaded())throw this._logger.error("is not loaded"),new Error(`The repository ${this.constructor.getName()} must be loaded but it's in ${this._status} state for now !`)}_loadIntoNewStorage(t=!0){return this._logger.verbose("loading first page"),this._loadFromCacheIntoNewStorage(!1).catch(()=>this._loadFromApiIntoNewStorage()).catch(e=>t?(this._logger.error("loading failed, fallback to outdated cache",{error:e}),this._loadFromCacheIntoNewStorage(!0).catch(()=>Promise.reject(e))):Promise.reject(e))}_loadFromApiIntoNewStorage(){return this.em._xhr(this._getLoadRequest(),200).then(t=>{this._logger.verbose("loading first page success");const e=[],s=t.headers["content-range"];if(!s)throw new Error("Content-Range is not present");const r=s.match(/^(-?[0-9]+)-(-?[0-9]+)\/([0-9]+)$/);if(!r)throw new Error("Content-Range invalid");let i=parseInt(r[1],10),o=parseInt(r[2],10);const a=parseInt(r[3],10),n=o-i;for(e.push(Promise.resolve(t));o+1<a;)this._logger.verbose("loading next page"),o=(i=o+1)+n,e.push(this.em._xhr(this._getLoadRequest(i),200));return Promise.all(e).then(t=>{this._logger.verbose("loading all pages success");let e=[];for(let s=0;s<t.length;s++){const{data:r}=t[s];if(!Array.isArray(r)){const t=`Return format expected to be an array while loading ${this.constructor.getName()}`;throw new Error(t)}e=e.concat(r)}if(e.length!==a)throw new Error(`"Expected ${a} results for but got ${e.length}`);return e})}).then(t=>this._putResultIntoNewStorage(t))}_putResultIntoNewStorage(t){const e=new Storage;for(let s=0;s<t.length;s++){const r=this.constructor.fromJSON(t[s]);null!==r&&e.store(r)}return e}_replaceStorage(t){const e=this._storage;this._storage=t;const s={[REPOSITORY_EVENTS.CREATE]:[],[REPOSITORY_EVENTS.UPDATE]:[],[REPOSITORY_EVENTS.REMOVE]:[]};return e.getAll().forEach(t=>{null===this.get(t.id)&&s[REPOSITORY_EVENTS.REMOVE].push(t)}),this.getAll().forEach(t=>{if(!e.has(t.id))return void(s[REPOSITORY_EVENTS.CREATE]=t);const r=e.get(t.id),i=this.constructor._compare(r,t);0!==i.length&&(s[REPOSITORY_EVENTS.UPDATE]={current:t,previous:r,changes:i})}),s}_persist(t,e){this._logger.debug("persist",{entity:t,internal:e}),this._assertIsLoaded(),this.constructor._throwExceptionIfNotSupported(t),this._assertIsValid(t),null===t.id?this._create(t,e):this._update(t,e)}_remove(t,e){this._logger.debug("remove",{id:t,internal:e}),this._assertIsLoaded();const s=this.get(t);if(null!==s&&(this._storage.remove(s),this._eventDispatcher.publish(this,REPOSITORY_EVENTS.REMOVE,s),!e)){const t=[this,REPOSITORY_EVENTS.REMOVE,[s.clone()]];this._logger.debug("commit",{commit:t}),this.em._uow.commits.add(t)}}_validate(t){const e=t.constructor._validators,s=new Map;return e.forEach(([e,r])=>{r.isValid(this.em,t,e)||s.set(e,r.constructor.message)}),s}_assertIsValid(t){if(!this.isValid(t)){let e=`Given ${t.constructor.getName()} is not valid`;throw this.validate(t).forEach(([t,s])=>{e+=`\n\t${t}: ${s}`}),new TypeError(e)}}_create(t,e){if(null===t.id&&(t.id=Symbol("AdsumClientApi_entity_id")),this._overrideSiteEntity(t),this._storage.store(t),this._logger.debug("create",{entity:t,internal:e}),this._eventDispatcher.publish(this,REPOSITORY_EVENTS.CREATE,t),!e){const e=[this,REPOSITORY_EVENTS.CREATE,t.clone()];this._logger.debug("commit",{commit:e}),this.em._uow.commits.add(e)}}_update(t,e){const s=this.get(t.id);if(null===s)throw new TypeError("Provided entity has id set but is not found, are you sure the entity is not remove ?");if(s.constructor!==t.constructor)return void this._switchType(t,s,e);const r=this.constructor._compare(s,t);if(0!==r.length&&(this._logger.debug("update",{entity:t,previous:s,changes:r,internal:e}),this._storage.store(t),this._eventDispatcher.publish(this,REPOSITORY_EVENTS.UPDATE,{current:t,previous:s,changes:r}),!e)){const e=[this,REPOSITORY_EVENTS.UPDATE,{current:t.clone(),previous:s,changes:r}];this._logger.debug("commit",{commit:e}),this.em._uow.commits.add(e)}}_overrideSiteEntity(t){-1!==t.constructor.keys.indexOf("site")&&(t.site=this.em.options.site)}_switchType(t,e,s){this._logger.debug("switch type",{entity:t,previous:e,internal:s}),t.id=null,this._create(t,s),this._remove(e,s)}static getName(){return this.getEntityClass().getName()}static getEntityClass(){throw new Error("You must implements #getEntityClass")}static fromJSON(t){return this.getEntityClass().create(t)}static get _readOnlyKeys(){return[]}static _compare(t,e){if(this._throwExceptionIfNotSupported(t),this._throwExceptionIfNotSupported(e),e.constructor!==t.constructor)throw new TypeError("Cannot compare two entity of different classes");const s=t.toJSON(),r=e.toJSON(),i=[];return Object.keys(s).forEach(t=>{const e=s[t],o=r[t];this._areDeepEqual(e,o)||i.push(t)}),i}static _areDeepEqual(t,e){if(t===e)return!0;if("object"!=typeof t||typeof t!=typeof e)return!1;if(null===t||null===e)return!1;if(t.constructor!==e.constructor)return!1;if(Array.isArray(t)){if(t.length!==e.length)return!1;const s=new Set;for(let r=0;r<t.length;r++){const i=t[r];let o=!1;for(let t=0;t<e.length;t++)if(!s.has(t)&&this._areDeepEqual(i,e[t])){s.add(t),o=!0;break}if(!o)return!1}return!0}const s=Object.keys(t);if(!this._areDeepEqual(s,Object.keys(e)))return!1;for(let r=0;r<s.length;r++){const i=s[r];if(!this._areDeepEqual(t[i],e[i]))return!1}return!0}static get _endpoint(){return this.getEntityClass().getName().toLowerCase()}static _throwExceptionIfNotSupported(t){if(!(t instanceof this.getEntityClass()))throw new TypeError("Unsupported entity")}}class ReferenceValidator extends AbstractValidator{isValid(t,e,s){return this.constructor.isReference(t,e[s])}static isReference(t,e){if(!(e instanceof Reference))return!1;const s=t.getRepository(e.classOf);return null!==s&&(e.is(null)||null!==s.get(e))}}class NotNullReferenceValidator extends ReferenceValidator{isValid(t,e,s){return super.isValid(t,e,s)&&!e[s].is(null)}}class VectorValidator extends AbstractValidator{isValid(t,e,s){const r=e[s];return r instanceof Vector&&(Number.isFinite(r.x)&&Number.isFinite(r.y)&&Number.isFinite(r.z))}}class IntegerValidator$1 extends AbstractValidator{isValid(t,e,s){return Number.isFinite(e[s])}}class BooleanValidator extends AbstractValidator{isValid(t,e,s){return"boolean"==typeof e[s]}}const CUSTOM_OBJECT_ORIENTATION_MODES={BILLBOARD:"BILLBOARD",STATIC:"STATIC",FLIP:"FLIP"};class CustomObject extends(HasSiteTrait(HasMetadataTrait(AbstractEntity))){static getName(){return"CustomObject"}static get keys(){const t=super.keys;return t.push("type"),t.push("place"),t.push("poi"),t.push("offset"),t.push("autoscale"),t.push("rotation"),t.push("priority"),t.push("orientation_mode"),t.push("permanent_display"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("place",new NotNullReferenceValidator),this._setPropertyValidator("poi",new ReferenceValidator),this._setPropertyValidator("offset",new VectorValidator),this._setPropertyValidator("autoscale",new BooleanValidator),this._setPropertyValidator("rotation",new IntegerValidator$1),this._setPropertyValidator("priority",new IntegerValidator),this._setPropertyValidator("orientation_mode",new EnumValidator(CUSTOM_OBJECT_ORIENTATION_MODES)),this._setPropertyValidator("permanent_display",new BooleanValidator)}_reset(){super._reset(),this.type=null,this.place=new Reference("Place",null),this.poi=new Reference("Poi",null),this.offset=new Vector,this.autoscale=!1,this.rotation=0,this.priority=0,this.orientation_mode=CUSTOM_OBJECT_ORIENTATION_MODES.BILLBOARD,this.permanent_display=!0}}const CUSTOM_OBJECT_TYPES={PICTO:"picto",LABEL:"label"},LABEL_ALIGNMENTS={LEFT:"left",RIGHT:"right",CENTER:"center"};class PositiveValidator extends AbstractValidator{isValid(t,e,s){return Number.isFinite(e[s])&&e[s]>0}}class ConstantValidator extends AbstractValidator{constructor(t){super(),this.constant=t}isValid(t,e,s){return e[s]===this.constant}}class StringValidator extends AbstractValidator{constructor(t){super(),this.regex=t}isValid(t,e,s){return"string"==typeof e[s]&&null!==e[s].match(this.regex)}}class Label extends CustomObject{static getName(){return"Label"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("font"),t.push("alignment"),t.push("font_size"),t.push("font_color"),t.push("background_color"),t.push("label"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(CUSTOM_OBJECT_TYPES.LABEL)),this._setPropertyValidator("font",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("alignment",new EnumValidator(LABEL_ALIGNMENTS)),this._setPropertyValidator("font_size",new AllValidator([new IntegerValidator,new PositiveValidator])),this._setPropertyValidator("background_color",new AnyValidator([new NullValidator,new StringValidator(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/)])),this._setPropertyValidator("font_color",new StringValidator(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/)),this._setPropertyValidator("label",new NonEmptyStringValidator)}_reset(){super._reset(),this.type=CUSTOM_OBJECT_TYPES.LABEL,this.alignment=LABEL_ALIGNMENTS.CENTER,this.font="Arial",this.font_size=5,this.font_color="#000000",this.background_color=null,this.label=null}}var HasFileTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("file"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("file",new NotNullReferenceValidator)}_reset(){super._reset(),this.file=new Reference("File",null)}}};class Picto extends(HasFileTrait(CustomObject)){static getName(){return"Picto"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("width"),t.push("height"),t.push("original_md5"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(CUSTOM_OBJECT_TYPES.PICTO)),this._setPropertyValidator("width",new PositiveValidator),this._setPropertyValidator("height",new PositiveValidator),this._setPropertyValidator("original_md5",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.type=CUSTOM_OBJECT_TYPES.PICTO,this.width=null,this.height=null,this.original_md5=null}}class CustomObjectRepository extends AbstractRepository{static getEntityClass(){return CustomObject}static fromJSON(t){if("object"!=typeof t||null===t)throw new TypeError("Expected an object");switch(t.type){case"label":return new Label(t);case"picto":return new Picto(t);default:throw new Error(`Unable to parse CustomObject ${t.type}`)}}}class DateUtils{static fromJSON(t){if(null===t||void 0===t)return null;if(t instanceof Date)return Number.isFinite(t.getTime())?t:null;if("string"!=typeof t&&!Number.isFinite(t))return null;const e=new Date;return e.setTime("string"==typeof t?Date.parse(t):t),Number.isFinite(e.getTime())?e:null}}class DateValidator extends AbstractValidator{isValid(t,e,s){return e[s]instanceof Date&&Number.isFinite(e[s].getTime())}}class Device extends(HasNameTrait(HasSiteTrait(HasMetadataTrait(AbstractEntity)))){static getName(){return"Device"}static get keys(){const t=super.keys;return t.push("type"),t.push("site_calibration"),t.push("core_version"),t.push("width"),t.push("height"),t.push("validate_at"),t}set(t,e){return"validate_at"===t?(this[t]=DateUtils.fromJSON(e),this):super.set(t,e)}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("site_calibration",new ReferenceValidator),this._setPropertyValidator("core_version",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("width",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("height",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("validate_at",new AnyValidator([new NullValidator,new DateValidator]))}_reset(){super._reset(),this.type=null,this.core_version=null,this.width=null,this.height=null,this.validate_at=null,this.site_calibration=new Reference("SiteCalibration",null)}}const DEVICE_TYPES={KIOSK:"kiosk",MOBILE:"mobile",WEB:"web"};class Kiosk extends Device{static getName(){return"Kiosk"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("position"),t.push("os"),t.push("location"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(DEVICE_TYPES.KIOSK)),this._setPropertyValidator("position",new VectorValidator),this._setPropertyValidator("os",new AnyValidator([new NonEmptyStringValidator,new NullValidator])),this._setPropertyValidator("location",new AnyValidator([new NonEmptyStringValidator,new NullValidator]))}_reset(){super._reset(),this.type=DEVICE_TYPES.KIOSK,this.position=new Vector,this.os=null,this.location=null}}class Mobile extends Device{static getName(){return"Mobile"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(DEVICE_TYPES.MOBILE))}_reset(){super._reset(),this.type=DEVICE_TYPES.MOBILE}}class Web extends Device{static getName(){return"Web"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(DEVICE_TYPES.WEB))}_reset(){super._reset(),this.type=DEVICE_TYPES.WEB}}class DeviceRepository extends AbstractRepository{static getEntityClass(){return Device}static fromJSON(t){if("object"!=typeof t||null===t)throw new TypeError("Expected an object");switch(t.type){case"kiosk":return new Kiosk(t);case"mobile":return new Mobile(t);case"web":return new Web(t);default:throw new Error(`Unable to parse Device ${t.type}`)}}}var IsVersionedTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("version"),t.push("created_at"),t.push("updated_at"),t}set(t,e){return"created_at"===t||"updated_at"===t?(this[t]=DateUtils.fromJSON(e),this):super.set(t,e)}_reset(){super._reset(),this.version=null,this.created_at=null,this.updated_at=null}}};class MapFile extends(HasNameTrait(IsVersionedTrait(HasSiteTrait(HasFileTrait(HasMetadataTrait(AbstractEntity)))))){static getName(){return"MapFile"}static _isAbstract(){return!0}static get keys(){const t=super.keys;return t.push("type"),t}_reset(){super._reset(),this.type=null}}const MAP_FILE_TYPES={AO_DAE:"aoDae",CONFIG:"config",DAE:"dae",HELPER:"helper",IVE:"ive",LIGHT:"light",OSG:"osg",PATH:"path"};class MapConfig extends MapFile{static getName(){return"MapConfig"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MAP_FILE_TYPES.CONFIG))}_reset(){super._reset(),this.type=MAP_FILE_TYPES.CONFIG}}class MapDae extends MapFile{static getName(){return"MapDae"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MAP_FILE_TYPES.DAE))}_reset(){super._reset(),this.type=MAP_FILE_TYPES.DAE}}class MapAoDae extends MapFile{static getName(){return"MapAoDae"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MAP_FILE_TYPES.AO_DAE))}_reset(){super._reset(),this.type=MAP_FILE_TYPES.AO_DAE}}class MapLight extends MapFile{static getName(){return"MapLight"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MAP_FILE_TYPES.LIGHT))}_reset(){super._reset(),this.type=MAP_FILE_TYPES.LIGHT}}class MapHelper extends MapFile{static getName(){return"MapHelper"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MAP_FILE_TYPES.HELPER))}_reset(){super._reset(),this.type=MAP_FILE_TYPES.HELPER}}class MapPath extends MapFile{static getName(){return"MapPath"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("paths"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MAP_FILE_TYPES.PATH))}_reset(){super._reset(),this.type=MAP_FILE_TYPES.PATH,this.paths=new Map}}class MapFileRepository extends AbstractRepository{static getEntityClass(){return MapFile}static get _endpoint(){return"map"}static fromJSON(t){if("object"!=typeof t||null===t)throw new TypeError("Expected an object");switch(t.type){case"config":return new MapConfig(t);case"dae":return new MapDae(t);case"aoDae":return new MapAoDae(t);case"light":return new MapLight(t);case"helper":return new MapHelper(t);case"path":return new MapPath(t);case"ive":case"osg":case"model":case"aoOsg":return null;default:throw new Error(`Unable to parse MapFile ${t.type}`)}}}class StringValidator$1 extends AbstractValidator{isValid(t,e,s){return"string"==typeof e[s]}}var HasDescriptionTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("description"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("description",new AnyValidator([new NullValidator,new StringValidator$1]))}_reset(){super._reset(),this.description=null}}},HasSignatureTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("signature"),t}_reset(){super._reset(),this.signature=null}}},HasClientIdTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("client_id"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("client_id",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.client_id=null}}};class CollectionValidator extends AbstractValidator{isValid(t,e,s){const r=e[s];if(!(r instanceof Collection))return!1;let i=!0;return r.forEach(e=>{if(null===e)return void(i=!1);const s=new Reference(r.classOf,e);ReferenceValidator.isReference(t,s)&&!s.is(null)||(i=!1)}),i}}class OrderedCollectionValidator extends AbstractValidator{isValid(t,e,s){const r=e[s];if(!(r instanceof OrderedCollection))return!1;let i=!0;return r.forEach(e=>{if(null===e)return void(i=!1);const s=new Reference(r.classOf,e);ReferenceValidator.isReference(t,s)&&!s.is(null)||(i=!1)}),i}}class Media extends(HasClientIdTrait(HasSignatureTrait(IsVersionedTrait(HasDescriptionTrait(HasNameTrait(HasSiteTrait(HasMetadataTrait(AbstractEntity)))))))){static getName(){return"Media"}static get keys(){const t=super.keys;return t.push("type"),t.push("tags"),t.push("playlists"),t.push("pois"),t.push("preview"),t.push("start_at"),t.push("end_at"),t}set(t,e){return"start_at"!==t&&"end_at"!==t?super.set(t,e):(this[t]=DateUtils.fromJSON(e),this)}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("tags",new CollectionValidator),this._setPropertyValidator("playlists",new OrderedCollectionValidator),this._setPropertyValidator("pois",new CollectionValidator),this._setPropertyValidator("preview",new ReferenceValidator),this._setPropertyValidator("start_at",new AnyValidator([new NullValidator,new DateValidator])),this._setPropertyValidator("end_at",new AnyValidator([new NullValidator,new DateValidator]))}_reset(){super._reset(),this.type=null,this.start_at=null,this.end_at=null,this.tags=new Collection("Tag"),this.playlists=new OrderedCollection("Playlist"),this.pois=new Collection("Poi"),this.preview=new Reference("File",null)}}const MEDIA_TYPES={IMAGE:"image",PDF:"pdf",TEXT:"text",URL:"url",VIDEO:"video",MOVIE:"movie"};class MediaText extends Media{static getName(){return"MediaText"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("format"),t.push("identifier"),t.push("content"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MEDIA_TYPES.TEXT)),this._setPropertyValidator("format",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("identifier",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("content",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.type=MEDIA_TYPES.TEXT,this.format=null,this.identifier=null,this.content=null}}class MediaImage extends(HasFileTrait(Media)){static getName(){return"MediaImage"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MEDIA_TYPES.IMAGE))}_reset(){super._reset(),this.type=MEDIA_TYPES.IMAGE}}class MediaPdf extends(HasFileTrait(Media)){static getName(){return"MediaPdf"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MEDIA_TYPES.PDF))}_reset(){super._reset(),this.type=MEDIA_TYPES.PDF}}class MediaUrl extends Media{static getName(){return"MediaUrl"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("link"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MEDIA_TYPES.URL)),this._setPropertyValidator("link",new NonEmptyStringValidator)}_reset(){super._reset(),this.type=MEDIA_TYPES.URL,this.link=null}}class MediaVideo extends(HasFileTrait(Media)){static getName(){return"MediaVideo"}static _isAbstract(){return!1}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MEDIA_TYPES.VIDEO))}_reset(){super._reset(),this.type=MEDIA_TYPES.VIDEO}}class SetValidator extends AbstractValidator{constructor(t=null){super(),this.validator=t}isValid(t,e,s){if(null===this.validator)return!0;if(!(e[s]instanceof Set))return!1;const r=Array.from(e[s]);for(let e=0;e<r.length;e++)if(!this.validator.isValid(t,r,e))return!1;return!0}}class Movie extends(HasFileTrait(Media)){static getName(){return"Movie"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("actors"),t.push("coming_sessions"),t.push("director"),t.push("certification"),t.push("duration"),t}set(t,e){if("coming_sessions"!==t)return super.set(t,e);const s=[];return e.forEach(t=>{const e=DateUtils.fromJSON(t);s.push(e)}),SetUtils.set(this.coming_sessions,s),this}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(MEDIA_TYPES.MOVIE)),this._setPropertyValidator("actors",new SetValidator(new StringValidator$1)),this._setPropertyValidator("coming_sessions",new SetValidator(new DateValidator)),this._setPropertyValidator("director",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("certification",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.type=MEDIA_TYPES.MOVIE,this.actors=new Set,this.coming_sessions=new Set,this.director=null,this.certification=null,this.duration=null}}class MediaRepository extends AbstractRepository{static getEntityClass(){return Media}static fromJSON(t){if("object"!=typeof t||null===t)throw new TypeError("Expected an object");switch(t.type){case"text":return new MediaText(t);case"image":return new MediaImage(t);case"pdf":return new MediaPdf(t);case"url":return new MediaUrl(t);case"video":return new MediaVideo(t);case"movie":return new Movie(t);default:throw new Error(`Unable to parse Media ${t.type}`)}}}class Poi extends(HasDescriptionTrait(HasNameTrait(IsVersionedTrait(HasMetadataTrait(HasSignatureTrait(HasClientIdTrait(HasSiteTrait(AbstractEntity)))))))){static getName(){return"Poi"}static get keys(){const t=super.keys;return t.push("type"),t.push("new"),t.push("categories"),t.push("custom_objects"),t.push("places"),t.push("tags"),t.push("parents"),t.push("children"),t.push("logos"),t.push("pictures"),t.push("medias"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("new",new BooleanValidator),this._setPropertyValidator("categories",new CollectionValidator),this._setPropertyValidator("custom_objects",new CollectionValidator),this._setPropertyValidator("places",new CollectionValidator),this._setPropertyValidator("tags",new CollectionValidator),this._setPropertyValidator("parents",new CollectionValidator),this._setPropertyValidator("children",new OrderedCollectionValidator),this._setPropertyValidator("logos",new OrderedCollectionValidator),this._setPropertyValidator("pictures",new OrderedCollectionValidator),this._setPropertyValidator("medias",new OrderedCollectionValidator)}_reset(){super._reset(),this.categories=new Collection("Category"),this.children=new OrderedCollection("Poi"),this.custom_objects=new Collection("CustomObject"),this.logos=new OrderedCollection("File"),this.medias=new OrderedCollection("Media"),this.new=!0,this.parents=new Collection("Poi"),this.pictures=new OrderedCollection("File"),this.places=new Collection("Place"),this.tags=new Collection("Tag"),this.type=null}}const POI_TYPES={EXHIBITOR:"exhibitor",PERSON:"person",PRODUCT:"product",ROOM:"room",SERVICE:"service",STORE:"store"};class Exhibitor extends Poi{static getName(){return"Exhibitor"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("phone"),t.push("url"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(POI_TYPES.EXHIBITOR)),this._setPropertyValidator("phone",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("url",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.type=POI_TYPES.EXHIBITOR,this.phone=null,this.url=null}}class Person extends Poi{static getName(){return"Person"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("firstname"),t.push("lastname"),t.push("desk_phone"),t.push("mobile_phone"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(POI_TYPES.PERSON)),this._setPropertyValidator("firstname",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("lastname",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("desk_phone",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("mobile_phone",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.type=POI_TYPES.PERSON,this.firstname=null,this.lastname=null,this.desk_phone=null,this.mobile_phone=null}}class Product extends Poi{static getName(){return"Product"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("priority"),t.push("reference"),t.push("full_name"),t.push("description1"),t.push("description2"),t.push("full_description"),t.push("brand_name"),t.push("url"),t.push("status"),t.push("price"),t.push("currency"),t.push("rating"),t.push("rating_count"),t.push("remaining_quantity"),t.push("discount_value"),t.push("ean"),t.push("values"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(POI_TYPES.PRODUCT)),this._setPropertyValidator("priority",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("reference",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("full_name",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("description1",new AnyValidator([new NullValidator,new StringValidator$1])),this._setPropertyValidator("description2",new AnyValidator([new NullValidator,new StringValidator$1])),this._setPropertyValidator("full_description",new AnyValidator([new NullValidator,new StringValidator$1])),this._setPropertyValidator("brand_name",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("url",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("status",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("price",new AnyValidator([new NullValidator,new IntegerValidator$1])),this._setPropertyValidator("currency",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("rating",new AnyValidator([new NullValidator,new IntegerValidator$1])),this._setPropertyValidator("rating_count",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("remaining_quantity",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("discount_value",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("ean",new AnyValidator([new NullValidator,new StringValidator(/^[0-9]{8,13}$/)])),this._setPropertyValidator("values",new CollectionValidator)}_reset(){super._reset(),this.type=POI_TYPES.PRODUCT,this.brand_name=null,this.currency=null,this.description1=null,this.description2=null,this.discount_value=null,this.ean=null,this.full_description=null,this.full_name=null,this.price=null,this.priority=null,this.rating=null,this.rating_count=null,this.reference=null,this.remaining_quantity=null,this.status=null,this.url=null,this.values=new Collection("FeatureValue")}}class Room extends Poi{static getName(){return"Room"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("reference"),t.push("kind"),t.push("capacity"),t.push("phone"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(POI_TYPES.ROOM)),this._setPropertyValidator("reference",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("kind",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("capacity",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("phone",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.type=POI_TYPES.ROOM,this.reference=null,this.kind=null,this.capacity=null,this.phone=null}}class Service extends Poi{static getName(){return"Service"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("schedule"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(POI_TYPES.SERVICE))}_reset(){super._reset(),this.type=POI_TYPES.SERVICE,this.schedule=new Map}}class Store extends Poi{static getName(){return"Store"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("priority"),t.push("opening_time"),t.push("phone"),t.push("url"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("type",new ConstantValidator(POI_TYPES.STORE)),this._setPropertyValidator("priority",new IntegerValidator),this._setPropertyValidator("opening_time",new AnyValidator([new NullValidator,new StringValidator$1])),this._setPropertyValidator("phone",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("url",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.type=POI_TYPES.STORE,this.priority=0,this.opening_time=null,this.phone=null,this.url=null}}class PoiRepository extends AbstractRepository{static getEntityClass(){return Poi}static fromJSON(t){if("object"!=typeof t||null===t)throw new TypeError("Expected an object");switch(t.type){case"exhibitor":return new Exhibitor(t);case"person":return new Person(t);case"product":return new Product(t);case"room":return new Room(t);case"service":return new Service(t);case"store":return new Store(t);default:throw new Error(`Unable to parse Poi ${t.type}`)}}_switchType(t,e,s){if(null!==e.signature){const t=e.clone();t.signature=null,this._persist(t,s)}super._switchType(t,e,s)}}var HasLogoTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("logo"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("logo",new ReferenceValidator)}_reset(){super._reset(),this.logo=new Reference("File",null)}}};class Category extends(HasSiteTrait(IsVersionedTrait(HasMetadataTrait(HasLogoTrait(HasClientIdTrait(HasSignatureTrait(HasNameTrait(AbstractEntity)))))))){static getName(){return"Category"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("children"),t.push("color"),t.push("parameters"),t.push("parents"),t.push("pois"),t.push("rank"),t.push("type"),t.push("tags"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("color",new AnyValidator([new NullValidator,new StringValidator(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/)])),this._setPropertyValidator("parameters",new SetValidator(new StringValidator$1)),this._setPropertyValidator("parents",new CollectionValidator),this._setPropertyValidator("children",new OrderedCollectionValidator),this._setPropertyValidator("pois",new CollectionValidator),this._setPropertyValidator("tags",new CollectionValidator),this._setPropertyValidator("rank",new IntegerValidator),this._setPropertyValidator("type",new AnyValidator([new NonEmptyStringValidator,new NullValidator]))}_reset(){super._reset(),this.color=null,this.rank=0,this.type=null,this.parameters=new Set,this.parents=new Collection("Category"),this.children=new OrderedCollection("Category"),this.pois=new Collection("Poi"),this.tags=new Collection("Tag")}}class CategoryRepository extends AbstractRepository{static getEntityClass(){return Category}}class Feature extends(HasSiteTrait(HasMetadataTrait(HasSignatureTrait(HasClientIdTrait(HasNameTrait(AbstractEntity)))))){static getName(){return"Feature"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("values"),t.push("parents"),t.push("children"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("values",new CollectionValidator),this._setPropertyValidator("parents",new CollectionValidator),this._setPropertyValidator("children",new OrderedCollectionValidator)}_reset(){super._reset(),this.values=new Collection("FeatureValue"),this.parents=new Collection("Feature"),this.children=new OrderedCollection("Feature")}}class FeatureRepository extends AbstractRepository{static getEntityClass(){return Feature}}class FeatureValue extends(HasSignatureTrait(HasClientIdTrait(HasNameTrait(HasSiteTrait(HasMetadataTrait(AbstractEntity)))))){static getName(){return"FeatureValue"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("feature"),t.push("products"),t.push("rank"),t.push("unit"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("feature",new ReferenceValidator),this._setPropertyValidator("products",new CollectionValidator),this._setPropertyValidator("rank",new IntegerValidator),this._setPropertyValidator("unit",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.rank=0,this.unit=null,this.feature=new Reference("Feature",null),this.products=new Collection("Product")}}class FeatureValueRepository extends AbstractRepository{static getEntityClass(){return FeatureValue}static get _endpoint(){return"feature-value"}}class FileRepositoryBase extends AbstractRepository{static getEntityClass(){return File}}class FileRepository extends FileRepositoryBase{}class FloorCalibration extends(HasSiteTrait(HasMetadataTrait(AbstractEntity))){static getName(){return"FloorCalibration"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("site_calibration"),t.push("floor_id"),t.push("eye"),t.push("target"),t.push("up"),t.push("zoom_min"),t.push("zoom_max"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("site_calibration",new NotNullReferenceValidator),this._setPropertyValidator("floor_id",new IntegerValidator),this._setPropertyValidator("eye",new VectorValidator),this._setPropertyValidator("target",new VectorValidator),this._setPropertyValidator("up",new VectorValidator),this._setPropertyValidator("zoom_min",new AnyValidator([new NullValidator,new IntegerValidator$1])),this._setPropertyValidator("zoom_max",new AnyValidator([new NullValidator,new IntegerValidator$1]))}_reset(){super._reset(),this.floor_id=null,this.eye=new Vector,this.target=new Vector,this.up=new Vector,this.zoom_max=null,this.zoom_min=null,this.site_calibration=new Reference("SiteCalibration",null)}}class FloorCalibrationRepository extends AbstractRepository{static getEntityClass(){return FloorCalibration}}class Place extends(IsVersionedTrait(HasSignatureTrait(HasNameTrait(HasSiteTrait(HasMetadataTrait(AbstractEntity)))))){static getName(){return"Place"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("pois"),t.push("custom_objects"),t.push("building_id"),t.push("floor_id"),t.push("shape_id"),t.push("path_node_id"),t.push("position"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("pois",new CollectionValidator),this._setPropertyValidator("custom_objects",new CollectionValidator),this._setPropertyValidator("building_id",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("floor_id",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("shape_id",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("path_node_id",new AnyValidator([new NullValidator,new IntegerValidator])),this._setPropertyValidator("position",new VectorValidator)}_reset(){super._reset(),this.building_id=null,this.floor_id=null,this.shape_id=null,this.path_node=null,this.position=new Vector,this.pois=new Collection("Poi"),this.custom_objects=new Collection("CustomObject")}}class PlaceRepository extends AbstractRepository{static getEntityClass(){return Place}}class Playlist extends(HasSiteTrait(IsVersionedTrait(HasSignatureTrait(HasClientIdTrait(HasDescriptionTrait(HasNameTrait(HasMetadataTrait(AbstractEntity)))))))){static getName(){return"Playlist"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("tags"),t.push("medias"),t.push("parameters"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("tags",new CollectionValidator),this._setPropertyValidator("medias",new OrderedCollectionValidator),this._setPropertyValidator("parameters",new SetValidator(new StringValidator$1))}_reset(){super._reset(),this.tags=new Collection("Tag"),this.medias=new OrderedCollection("Media"),this.parameters=new Set}}class PlaylistRepository extends AbstractRepository{static getEntityClass(){return Playlist}}class SiteCalibration extends(HasSiteTrait(HasMetadataTrait(AbstractEntity))){static getName(){return"SiteCalibration"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("device"),t.push("floor_calibrations"),t.push("start_floor"),t.push("start_point_floor"),t.push("start_point_position"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("device",new NotNullReferenceValidator),this._setPropertyValidator("floor_calibrations",new CollectionValidator),this._setPropertyValidator("start_floor",new IntegerValidator),this._setPropertyValidator("start_point_floor",new AnyValidator([new IntegerValidator,new NullValidator])),this._setPropertyValidator("start_point_position",new AnyValidator([new VectorValidator,new NullValidator]))}_reset(){super._reset(),this.device=new Reference("Device",null),this.floor_calibrations=new Collection("FloorCalibration"),this.start_floor=null,this.start_point_floor=null,this.start_point_position=new Vector}}class SiteCalibrationRepository extends AbstractRepository{static getEntityClass(){return SiteCalibration}}var HasEmailTrait=t=>{return class extends t{static get keys(){const t=super.keys;return t.push("email"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("email",new AnyValidator([new NullValidator,new NonEmptyStringValidator]))}_reset(){super._reset(),this.email=null}}};class GpsPositionValidator extends AbstractValidator{isValid(t,e,s){const r=e[s];return"object"==typeof r&&null!==r&&(Number.isFinite(r.x)&&Number.isFinite(r.y)&&Number.isFinite(r.z)&&Number.isFinite(r.latitude)&&Number.isFinite(r.longitude)&&Number.isFinite(r.altitude))}}class Site extends(HasMetadataTrait(IsVersionedTrait(HasLogoTrait(HasSignatureTrait(HasClientIdTrait(HasEmailTrait(HasDescriptionTrait(HasNameTrait(AbstractEntity))))))))){static getName(){return"Site"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("opening"),t.push("direction"),t.push("city"),t.push("cp"),t.push("address"),t.push("phone"),t.push("locale"),t.push("languages"),t.push("gps_positions"),t.push("gps_transform"),t.push("gps_translate"),t.push("target_platforms"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("opening",new AnyValidator([new NullValidator,new StringValidator$1])),this._setPropertyValidator("direction",new AnyValidator([new NullValidator,new StringValidator$1])),this._setPropertyValidator("city",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("cp",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("address",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("phone",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("locale",new AnyValidator([new NullValidator,new NonEmptyStringValidator])),this._setPropertyValidator("languages",new SetValidator(new StringValidator$1)),this._setPropertyValidator("gps_positions",new SetValidator(new GpsPositionValidator)),this._setPropertyValidator("gps_transform",new SetValidator(new IntegerValidator$1)),this._setPropertyValidator("gps_translate",new SetValidator(new IntegerValidator$1)),this._setPropertyValidator("target_platforms",new SetValidator(new StringValidator$1))}_reset(){super._reset(),this.opening=null,this.direction=null,this.city=null,this.cp=null,this.address=null,this.phone=null,this.locale=null,this.languages=new Set,this.gps_positions=new Set,this.gps_transform=new Set,this.gps_translate=new Set,this.target_platforms=new Set}}class SiteRepository extends AbstractRepository{static getEntityClass(){return Site}getCurrent(){return this.get(this.em.options.site)}_getLoadRequest(){const t=new Request;return t.url=`${this.em.options.getEndpoint()}/${this.constructor._endpoint}/${this.em.options.site}`,t}_loadFromApiIntoNewStorage(){return this.em._xhr(this._getLoadRequest(),200).then(t=>{const e=new Storage;return e.store(this.constructor.fromJSON(t.data)),e})}}class Tag extends(IsVersionedTrait(HasSignatureTrait(HasNameTrait(HasSiteTrait(HasMetadataTrait(AbstractEntity)))))){static getName(){return"Tag"}static _isAbstract(){return!1}static get keys(){const t=super.keys;return t.push("categories"),t.push("medias"),t.push("pois"),t.push("playlists"),t}static _buildValidators(){super._buildValidators(),this._setPropertyValidator("categories",new CollectionValidator),this._setPropertyValidator("medias",new CollectionValidator),this._setPropertyValidator("pois",new CollectionValidator),this._setPropertyValidator("playlists",new CollectionValidator)}_reset(){super._reset(),this.categories=new Collection("Category"),this.medias=new Collection("Media"),this.pois=new Collection("Poi"),this.playlists=new Collection("Playlist")}}class TagRepository extends AbstractRepository{static getEntityClass(){return Tag}}class AbstractListener{constructor(t){this._init(t)}_init(t){if(this.em=t,this.eventDispatcher=EventDispatcher,this.constructor===AbstractListener)throw new TypeError("Cannot construct AbstractListener instances directly");this._subscribe()}static getEntityClass(){throw new TypeError("You need to implement static getEntityClass in AbstractListener inheritance")}_subscribe(){const t=this.constructor.getEntityClass().getName(),e=this.em.getRepository(t);this.eventDispatcher.subscribe(e,REPOSITORY_EVENTS.CREATE,this.onCreate.bind(this)),this.eventDispatcher.subscribe(e,REPOSITORY_EVENTS.UPDATE,this.onUpdate.bind(this)),this.eventDispatcher.subscribe(e,REPOSITORY_EVENTS.REMOVE,this.onRemove.bind(this))}onCreate(t){}onUpdate(t){}onRemove(t){}_cascadeRemove(t,e,s){const r=this.em.getRepository(t[e].classOf);if(t[e]instanceof Reference){const i=r.get(t[e]);this.constructor._isAssociatedTo(t,i,s)&&r._remove(i,!0)}t[e]instanceof Collection&&t[e].forEach(e=>{const i=r.get(e);this.constructor._isAssociatedTo(t,i,s)&&r._remove(i,!0)}),t[e]instanceof OrderedCollection&&t[e].forEach(({id:e})=>{const i=r.get(e);this.constructor._isAssociatedTo(t,i,s)&&r._remove(i,!0)})}static _isAssociatedTo(t,e,s){return null===s||null===e?Boolean(e):e[s]instanceof Reference&&e[s].is(t)?e[s].is(t):(e[s]instanceof Collection||e[s]instanceof OrderedCollection)&&e[s].has(t)}_unsetFromInversed(t,e,s){const r=this.em.getRepository(t[e].classOf);if(t[e]instanceof Reference&&null!==t[e].value){const i=r.get(t[e]);if(null!==i){const t=i.clone();t[s]=null,r._persist(t,!0)}}t[e]instanceof Collection&&t[e].forEach(t=>{const e=r.get(t);if(null===e)return;const i=e.clone();i[s]=null,r._persist(i,!0)})}_removeFromInversed(t,e,s){const r=this.em.getRepository(t[e].classOf);if(t[e]instanceof Reference&&null!==t[e].value){const i=r.get(t[e]);if(null!==i){const e=i.clone();e[s].remove(t),r._persist(e,!0)}}t[e]instanceof Collection&&t[e].forEach(e=>{const i=r.get(e);if(null!==i){const e=i.clone();e[s].remove(t),r._persist(e,!0)}}),t[e]instanceof OrderedCollection&&t[e].forEach(({id:e})=>{const i=r.get(e);if(null!==i){const e=i.clone();e[s].remove(t),r._persist(e,!0)}})}static _isPropertyChanged(t,e,s,r){return!!e.constructor.keys.includes(t)&&(null===s||-1!==r.indexOf(t))}static _addToNewlyInversed(t,e,s,r,i,o){if(!i&&!o)return;const a=s.get(r);if(null===a)return;const n=a.clone();i&&n[i].add(t,e),o&&o(n),s._persist(n,!0)}static _removeFromFormerInversed(t,e,s,r,i){if(!r)return;const o=e.get(s);if(null===o)return;if(!this._isAssociatedTo(t,o,r))return;const a=o.clone();a[r].remove(t),i&&0===a[r].size?e._remove(a,!0):e._persist(a,!0)}static _setToNewlyInversed(t,e,s,r,i){if(!r&&!i)return;const o=e.get(s);if(null===o)return;const a=o.clone();r&&(a[r]=t),i&&i(a),e._persist(a,!0)}static _unsetFromFormerInversed(t,e,s,r,i){if(!r&&!i)return;const o=e.get(s);if(null===o)return;if(!this._isAssociatedTo(t,o,r))return;const a=o.clone();i?e._remove(a,!0):(a[r]=null,e._persist(a,!0))}_onManyToManyOrToLinkPropertyChange(t,e,s,r,i,o,a=null){const n=this.em.getRepository(t[s].classOf);t[s].forEach(i=>{null!==e&&e[s].has(i)||this.constructor._addToNewlyInversed(t,null,n,i,r,o)}),null!==e&&e[s].forEach(e=>{t[s].has(e)||(null!==a&&a(n.get(e),t),this.constructor._removeFromFormerInversed(t,n,e,r,i))})}_onLinkToManyOrToLinkPropertyChange(t,e,s,r,i,o){const a=this.em.getRepository(t[s].classOf);t[s].forEach(({id:i,position:n})=>{null!==e&&e[s].has(i)&&e[s].getPositionOf(i)===n||this.constructor._addToNewlyInversed(t,n,a,i,r,o)}),null!==e&&e[s].forEach(({id:e})=>{t[s].has(e)||this.constructor._removeFromFormerInversed(t,a,e,r,i)})}_onOneToManyPropertyChange(t,e,s,r,i,o){const a=this.em.getRepository(t[s].classOf);t[s].forEach(i=>{null!==e&&e[s].has(i)||this.constructor._setToNewlyInversed(t,a,i,r,o)}),null!==e&&e[s].forEach(e=>{!t[s].has(e)&&this.constructor._isAssociatedTo(t,a.get(e),r)&&this.constructor._unsetFromFormerInversed(t,a,e,r,i)})}_onManyToOnePropertyChange(t,e,s,r,i,o){const a=this.em.getRepository(t[s].classOf);this.constructor._addToNewlyInversed(t,null,a,t[s],r,o),null!==e&&this.constructor._removeFromFormerInversed(t,a,e[s],r,i)}_onOneToOnePropertyChange(t,e,s,r,i,o){const a=this.em.getRepository(t[s].classOf);r&&this.constructor._setToNewlyInversed(t,a,t[s],r,o),null!==e&&this.constructor._unsetFromFormerInversed(t,a,e[s],r,i)}}class CustomObjectListener extends AbstractListener{static getEntityClass(){return CustomObject}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"place","custom_objects"),this._removeFromInversed(t,"poi","custom_objects"),t instanceof Picto&&this._cascadeRemove(t,"file",null)}_onChange(t,e,s){this.constructor._isPropertyChanged("place",t,e,s)&&this._onManyToOnePropertyChange(t,e,"place","custom_objects"),this.constructor._isPropertyChanged("poi",t,e,s)&&this._onManyToOnePropertyChange(t,e,"poi","custom_objects"),this.constructor._isPropertyChanged("file",t,e,s)&&this._onManyToOnePropertyChange(t,e,"file",null,!0,this.constructor._onNewFile)}static _onNewFile(t){t.context=FILE_CONTEXTS.PICTO}}class DeviceListener extends AbstractListener{static getEntityClass(){return Device}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._cascadeRemove(t,"site_calibration","device")}_onChange(t,e,s){this.constructor._isPropertyChanged("site_calibration",t,e,s)&&this._onOneToOnePropertyChange(t,e,"site_calibration","device",!0)}}class MapFileListener extends AbstractListener{static getEntityClass(){return MapFile}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._cascadeRemove(t,"file",null)}_onChange(t,e,s){this.constructor._isPropertyChanged("file",t,e,s)&&this._onManyToOnePropertyChange(t,e,"file",null,!0,this.constructor._onNewFile)}static _onNewFile(t){null!==t&&(t.context="map")}}class MediaListener extends AbstractListener{static getEntityClass(){return Media}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"tags","medias"),this._removeFromInversed(t,"playlists","medias"),this._removeFromInversed(t,"pois","medias"),(t instanceof MediaImage||t instanceof MediaVideo||t instanceof MediaPdf||t instanceof Movie)&&this._cascadeRemove(t,"file",null),this._cascadeRemove(t,"preview",null)}_onChange(t,e,s){this.constructor._isPropertyChanged("tags",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"tags","medias"),this.constructor._isPropertyChanged("playlists",t,e,s)&&this._onLinkToManyOrToLinkPropertyChange(t,e,"playlists","medias"),this.constructor._isPropertyChanged("pois",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"pois","medias"),this.constructor._isPropertyChanged("preview",t,e,s)&&this._onManyToOnePropertyChange(t,e,"preview",null,!0,this.constructor._onNewPreview),this.constructor._isPropertyChanged("file",t,e,s)&&this._onManyToOnePropertyChange(t,e,"file",null,!0,this.constructor._onNewFile)}static _onNewPreview(t){t.context="media_preview"}static _onNewFile(t){t.context="media_file"}}class PoiListenerBase extends AbstractListener{static getEntityClass(){return Poi}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"parents","children"),this._removeFromInversed(t,"children","parents"),this._removeFromInversed(t,"categories","pois"),this._removeFromInversed(t,"tags","pois"),this._removeFromInversed(t,"medias","pois"),this._removeFromInversed(t,"places","pois"),this._cascadeRemove(t,"custom_objects","poi"),t instanceof Product&&this._removeFromInversed(t,"values","products")}_onChange(t,e,s){this.constructor._isPropertyChanged("name",t,e,s)&&this._onNameUpdated(t),this.constructor._isPropertyChanged("parents",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"parents","children"),this.constructor._isPropertyChanged("children",t,e,s)&&this._onLinkToManyOrToLinkPropertyChange(t,e,"children","parents"),this.constructor._isPropertyChanged("categories",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"categories","pois"),this.constructor._isPropertyChanged("tags",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"tags","pois"),this.constructor._isPropertyChanged("medias",t,e,s)&&this._onLinkToManyOrToLinkPropertyChange(t,e,"medias","pois"),this.constructor._isPropertyChanged("places",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"places","pois",!1,null,this._onPlaceRemoved.bind(this)),this.constructor._isPropertyChanged("custom_objects",t,e,s)&&this._onOneToManyPropertyChange(t,e,"custom_objects","poi",!1,this._onNewCustomObject.bind(this)),this.constructor._isPropertyChanged("logos",t,e,s)&&(this._onLinkToManyOrToLinkPropertyChange(t,e,"logos",null,!0,this.constructor._onNewLogo),this.constructor._onLogoUpdated(t,this.em)),this.constructor._isPropertyChanged("pictures",t,e,s)&&this._onLinkToManyOrToLinkPropertyChange(t,e,"pictures",null,!0,this.constructor._onNewPicture),this.constructor._isPropertyChanged("values",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"values","products")}static _onNewLogo(t){t.context="poi"}static _onNewPicture(t){t.context="poi"}_onNameUpdated(t){this.em.getRepository(t.custom_objects.classOf).getList(t.custom_objects).forEach(e=>{e instanceof Label&&this._updateLabelNameFromPoi(e,t)})}static _onLogoUpdated(t,e){const s=e.getRepository(t.custom_objects.classOf).getList(t.custom_objects),r=this._getFirstPoiLogo(t,e);s.forEach(t=>{t instanceof Picto&&this._updatePictoFileFromPoiLogo(t,r,e)})}_onPlaceRemoved(t,e){const s=this.em.getRepository(e.custom_objects.classOf);s.getList(e.custom_objects).forEach(e=>{null!==e&&e.place.is(t)&&s._remove(e,!0)})}_onNewCustomObject(t){const e=this.em.getRepository("Poi").get(t.poi);if(t instanceof Label&&this._updateLabelNameFromPoi(t,e),t instanceof Picto){const s=this.constructor._getFirstPoiLogo(e,this.em);this.constructor._updatePictoFileFromPoiLogo(t,s,this.em)}}_updateLabelNameFromPoi(t,e){if(t.label===e.name)return;const s=t.clone();s.label=e.name,this.em.getRepository("CustomObject")._persist(s,!0)}static _isFirstLogo(t,e){return t.logos.size>0&&t.logos.values[0].id===e.id}static _getFirstPoiLogo(t,e){const s=e.getRepository(t.logos.classOf).getList(t.logos);return 0===s.length?null:s[0]}static _updatePictoFileFromPoiLogo(t,e,s){return null===e?(s.getRepository("CustomObject")._remove(t,!0),!1):null===e.content_hash?(s.logger.debug("PoiListener#_updatePictoFileFromPoiLogo: logo content hash is not computed, skipping"),!1):t.original_md5!==e.content_hash}}class PoiListener extends PoiListenerBase{static _updatePictoFileFromPoiLogo(t,e,s){super._updatePictoFileFromPoiLogo(t,e,s)||s.logger.warn("PoiListener#_updatePictoFileFromPoiLogo: update picto file not supported on Node")}}class CategoryListener extends AbstractListener{static getEntityClass(){return Category}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"parents","children"),this._removeFromInversed(t,"children","parents"),this._removeFromInversed(t,"pois","categories"),this._removeFromInversed(t,"tags","categories"),this._cascadeRemove(t,"logo",null)}_onChange(t,e,s){this.constructor._isPropertyChanged("parents",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"parents","children"),this.constructor._isPropertyChanged("children",t,e,s)&&this._onLinkToManyOrToLinkPropertyChange(t,e,"children","parents"),this.constructor._isPropertyChanged("pois",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"pois","categories"),this.constructor._isPropertyChanged("tags",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"tags","categories"),this.constructor._isPropertyChanged("logo",t,e,s)&&this._onManyToOnePropertyChange(t,e,"logo",null,!0,this.constructor._onNewLogo)}static _onNewLogo(t){null!==t&&(t.context=FILE_CONTEXTS.CATEGORY)}}class FeatureListener extends AbstractListener{static getEntityClass(){return Feature}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"parents","children"),this._removeFromInversed(t,"children","parents"),this._cascadeRemove(t,"values","feature")}_onChange(t,e,s){this.constructor._isPropertyChanged("parents",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"parents","children"),this.constructor._isPropertyChanged("children",t,e,s)&&this._onLinkToManyOrToLinkPropertyChange(t,e,"children","parents"),this.constructor._isPropertyChanged("values",t,e,s)&&this._onManyToOnePropertyChange(t,e,"values","feature",!0)}}class FeatureValueListener extends AbstractListener{static getEntityClass(){return FeatureValue}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"products","values"),this._removeFromInversed(t,"feature","values")}_onChange(t,e,s){this.constructor._isPropertyChanged("feature",t,e,s)&&this._onManyToOnePropertyChange(t,e,"feature","values"),this.constructor._isPropertyChanged("products",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"products","values")}}class FileListenerBase extends AbstractListener{static getEntityClass(){return File}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){}_onChange(t,e,s){this.constructor._isPropertyChanged("uri",t,e,s)&&this._onUriUpdated(t),this.constructor._isPropertyChanged("context",t,e,s)&&this._onContextUpdated(t),this.constructor._isPropertyChanged("content_hash",t,e,s)&&this._onContentHashUpdated(t)}_onUriUpdated(t){t.context===FILE_CONTEXTS.PICTO&&(this.em.logger.debug("FileListener#_onUriUpdated: make picto file pow2"),this._makePictoFilePow2(t)),this.em.logger.debug("FileListener#_onUriUpdated: force update content hash"),this._updateContentHash(t,!0)}_onContentHashUpdated(t){if(t.context===FILE_CONTEXTS.POI){const e=this.constructor._getPoiFromFile(t,this.em);null!==e&&PoiListener._getFirstPoiLogo(e,this.em)===t&&(this.em.logger.debug("FileListener#_onContentHashUpdated: update associated picto"),PoiListener._onLogoUpdated(e,this.em))}}_onContextUpdated(t){t.context===FILE_CONTEXTS.PICTO&&(this.em.logger.debug("FileListener#_onContextUpdated: make picto pow2"),this._makePictoFilePow2(t))}_updateContentHash(t,e=!1){if(null===t.content_hash||e){const e=Request.getUriContentHash(t.uri).then(e=>{const s=this.em.getRepository("File"),r=s.get(t);if(null===r||r.uri!==t.uri)return void this.em.logger.debug("FileListener#_updateContentHash: File has been removed or binary has been updated while computing ==> Skip");const i=r.clone();i.content_hash=e,s._persist(i,!0)}).catch(t=>{throw t});this.em._waitFor(e)}}_makePictoFilePow2(t){return this.em.logger.warn("Cannot make an image Pow2 yet"),Promise.resolve(!1)}static _getPictoFromFile(t,e){const s=e.getRepository("CustomObject").findBy({type:CUSTOM_OBJECT_TYPES.PICTO,file:e=>e.is(t)});return 0===s.length?null:s[0]}static _getPoiFromFile(t,e){const s=e.getRepository("Poi").findBy({logos:e=>e.has(t)});return 0===s.length?null:s[0]}}class FileListener extends FileListenerBase{}class FloorCalibrationListener extends AbstractListener{static getEntityClass(){return FloorCalibration}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"site_calibration","floor_calibrations")}_onChange(t,e,s){this.constructor._isPropertyChanged("site_calibration",t,e,s)&&this._onManyToOnePropertyChange(t,e,"site_calibration","floor_calibrations")}}class PlaceListener extends AbstractListener{static getEntityClass(){return Place}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"pois","places"),this._cascadeRemove(t,"custom_objects","place")}_onChange(t,e,s){this.constructor._isPropertyChanged("pois",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"pois","places"),this.constructor._isPropertyChanged("custom_objects",t,e,s)&&this._onOneToManyPropertyChange(t,e,"custom_objects","place",!0)}}class PlaylistListener extends AbstractListener{static getEntityClass(){return Playlist}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"medias","playlists"),this._removeFromInversed(t,"tags","playlists")}_onChange(t,e,s){this.constructor._isPropertyChanged("medias",t,e,s)&&this._onLinkToManyOrToLinkPropertyChange(t,e,"medias","playlists"),this.constructor._isPropertyChanged("tags",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"tags","playlists")}}class SiteCalibrationListener extends AbstractListener{static getEntityClass(){return SiteCalibration}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._unsetFromInversed(t,"device","site_calibration"),this._cascadeRemove(t,"floor_calibrations","site_calibration")}_onChange(t,e,s){this.constructor._isPropertyChanged("floor_calibrations",t,e,s)&&this._onOneToManyPropertyChange(t,e,"floor_calibrations","site_calibration",!0),this.constructor._isPropertyChanged("device",t,e,s)&&this._onOneToOnePropertyChange(t,e,"device","site_calibration")}}class SiteListener extends AbstractListener{static getEntityClass(){return Site}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){throw new TypeError("You cannot remove the Site !")}_onChange(t,e,s){this.constructor._isPropertyChanged("logo",t,e,s)&&this._onManyToOnePropertyChange(t,e,"logo",null,!0,this.constructor._onNewLogo)}static _onNewLogo(t){null!==t&&(t.context="site")}}class TagListener extends AbstractListener{static getEntityClass(){return Tag}onCreate(t){this._onChange(t,null)}onUpdate(t){this._onChange(t.current,t.previous,t.changes)}onRemove(t){this._removeFromInversed(t,"categories","tags"),this._removeFromInversed(t,"pois","tags"),this._removeFromInversed(t,"playlists","tags"),this._removeFromInversed(t,"medias","tags")}_onChange(t,e,s){this.constructor._isPropertyChanged("pois",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"pois","tags"),this.constructor._isPropertyChanged("categories",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"categories","tags"),this.constructor._isPropertyChanged("medias",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"medias","tags"),this.constructor._isPropertyChanged("playlists",t,e,s)&&this._onManyToManyOrToLinkPropertyChange(t,e,"playlists","tags")}}class UnitOfWork{constructor(t){this.em=t,this.em.logger.debug("UnitOfWork: instantiate"),this._reset()}flush(){this.em.logger.debug("UnitOfWork: flush start"),this._prepare();const t=new Set(this.commits)[Symbol.iterator]();return this._flushCommits(t).then(()=>this._finish())}get _hasPendingChanges(){return this._mergeConsecutiveCommits(),0!==this.commits.size}static _mergeTwoConsecutiveCommits(t,e){if(null===t)return[e];const[s,r,i]=t,[o,a,n]=e;if(s!==o)return[t,e];switch(r){case REPOSITORY_EVENTS.UPDATE:if(a===REPOSITORY_EVENTS.UPDATE&&i.current===n.previous){const{previous:t}=i,{current:e}=n,r=s.constructor._compare(t,e);return 0===r.length?[]:[[s,REPOSITORY_EVENTS.UPDATE,{current:e,previous:t,changes:r}]]}break;case REPOSITORY_EVENTS.CREATE:if(a===REPOSITORY_EVENTS.REMOVE&&n.includes(i))return[];if(a===REPOSITORY_EVENTS.UPDATE&&i===n.previous){return[[s,REPOSITORY_EVENTS.CREATE,n.current]]}break;case REPOSITORY_EVENTS.REMOVE:if(a===REPOSITORY_EVENTS.REMOVE&&s===o){return[[s,REPOSITORY_EVENTS.REMOVE,[...i,...n]]]}break;default:throw new Error("Unexpected")}return[t,e]}_reset(){this.em.logger.debug("UnitOfWork: reset"),this.commits=new Set,this._symbolToId=new Map,this._symbolToRepository=new Map}_prepare(){this.em.logger.debug("UnitOfWork: prepare"),this._mergeConsecutiveCommits()}_mergeConsecutiveCommits(){this.em.logger.debug("UnitOfWork: merge commits");const t=new Set;let e=null;this.commits.forEach(s=>{const r=this.constructor._mergeTwoConsecutiveCommits(e,s);switch(this.em.logger.debug("UnitOfWork: merge two consecutive commits",{previous:e,commit:s,merged:r}),r.length){case 0:e=null;break;case 1:[e]=r;break;case 2:t.add(r[0]),[,e]=r;break;default:throw new Error("Unexpected")}}),null!==e&&t.add(e),this.commits=t}_finish(){this.em.logger.debug("UnitOfWork: finish");const t=new Set;return this._symbolToId.entries().forEach(([e,s])=>{const r=this._symbolToRepository.get(e);t.add({id:s,symbol:e,repository:r})}),this._reset(),t}_replaceFileReferenceSymbolToId(t){"symbol"==typeof t.value&&(t.value=this._symbolToId.get(t.value))}_replaceFileCollectionSymbolToId(t){t.forEach(e=>{"symbol"==typeof e&&(t.add(this._symbolToId.get(e)),t.remove(e))})}_replaceFileOrderedCollectionSymbolToId(t){t.forEach(([e,s])=>{"symbol"==typeof e&&(t.add(this._symbolToId.get(e),s),t.remove(e))})}_flushCommits(t){const{value:e,done:s}=t.next();return s?Promise.resolve():(this.em.logger.info(`UnitOfWork: ${this.commits.size} request to send`),this.em.logger.debug("UnitOfWork: flush commits start",{commit:e}),this._flushCommit(e).then(()=>(this.em.logger.debug("UnitOfWork: flush commits next",{commit:e}),this.commits.delete(e),this._flushCommits(t))))}_flushCommit(t){const[e,s,r]=t;switch(s){case REPOSITORY_EVENTS.CREATE:return this._flushCreateCommit(e,r);case REPOSITORY_EVENTS.UPDATE:return this._flushUpdateCommit(e,r.current,r.changes);case REPOSITORY_EVENTS.REMOVE:return this._flushRemoveCommit(e,r);default:return Promise.reject(new Error(`UOW: Unhandled event ${s}`))}}_flushCreateCommit(t,e){this._replaceAssociatedSymbolToId(e);const s=t._getCreateRequest(e);return this.em._xhr(s,200).then(s=>{const{data:r}=s;return this._symbolToId.set(e.id,r.id),this._symbolToRepository.set(e.id,t),this.em.logger.debug("UnitOfWork: retrieved identifier",{symbol:e.id,id:r.id}),r.id})}_flushUpdateCommit(t,e,s){this._replaceAssociatedSymbolToId(e);const r=t._getUpdateRequest(e,s);return this.em._xhr(r,204)}_flushRemoveCommit(t,e){e.forEach(t=>{this._replaceAssociatedSymbolToId(t)});const s=[];for(let r=0;r<e.length;r+=50){const i=e.slice(r,r+50),o=t._getRemoveRequest(i);s.push(this.em._xhr(o,204).catch(e=>{if(e instanceof Error)return Promise.reject(e);const s=e.data;if(!s.hasOwnProperty("errors"))return Promise.reject(new Error("Server error"));const{errors:r}=s;if(e.status>=500)return Promise.reject(r);this.em.logger.warn("UnitOfWork: flush remove commit invalid data supplied",{json:s});const o=Object.keys(r);if(1!==o.length||!o.includes("id"))return Promise.reject(r);const a=Object.keys(r.id).map(t=>parseInt(t.replace("#",""),10)),n=[];for(let t=0;t<i.length;t++)a.includes(t)||n.push(i[t]);return 0===n.length?Promise.resolve():this._flushRemoveCommit(t,n)}))}return Promise.all(s)}_replaceAssociatedSymbolToId(t){this.em.logger.debug("UnitOfWork: replace associated symbol to id",{entity:t}),"symbol"==typeof t.id&&this._symbolToId.has(t.id)&&(t.id=this._symbolToId.get(t.id),this.em.logger.debug("UnitOfWork: replace associated symbol to id (own id replaced)",{entity:t})),t.constructor.keys.forEach(e=>{t[e]instanceof Reference&&this._replaceReferenceAssociatedSymbol(e,t),t[e]instanceof Collection&&this._replaceCollectionAssociatedSymbol(e,t),t[e]instanceof OrderedCollection&&this._replaceOrderedCollectionAssociatedSymbol(e,t)})}_replaceReferenceAssociatedSymbol(t,e){const s=e[t].value;if("symbol"==typeof s){if(!this._symbolToId.has(s))throw this.em.logger.error("UnitOfWork: replace associated symbol to id (reference id not found)",{key:t}),new Error("Unable to find Symbol <--\x3e Id matching");this.em.logger.debug("UnitOfWork: replace associated symbol to id (reference id replaced)",{key:t}),e[t]=this._symbolToId.get(s)}}_replaceCollectionAssociatedSymbol(t,e){const s=[];e[t].forEach(e=>{if("symbol"!=typeof e)s.push(e);else{if(!this._symbolToId.has(e))throw this.em.logger.error("UnitOfWork: replace associated symbol to id (collection item id not found)",{key:t}),new Error("Unable to find Symbol <--\x3e Id matching");this.em.logger.debug("UnitOfWork: replace associated symbol to id (collection item id replaced)",{key:t}),s.push(this._symbolToId.get(e))}}),e[t]=s}_replaceOrderedCollectionAssociatedSymbol(t,e){const s=[];e[t].forEach(({id:e,position:r})=>{if("symbol"!=typeof e)s.push({id:e,position:r});else{if(!this._symbolToId.has(e))throw this.em.logger.error("UnitOfWork: replace associated symbol to id (ordered collection item id not found)",{key:t}),new Error("Unable to find Symbol <--\x3e Id matching");this.em.logger.debug("UnitOfWork: replace associated symbol to id (ordered collection item id replaced)",{key:t}),s.push({id:this._symbolToId.get(e),position:r})}}),e[t]=s}}const repositoryClasses=[SiteRepository,MapFileRepository,FileRepository,CategoryRepository,PoiRepository,FeatureRepository,FeatureValueRepository,PlaceRepository,CustomObjectRepository,PlaylistRepository,MediaRepository,DeviceRepository,SiteCalibrationRepository,FloorCalibrationRepository,TagRepository],listenerClasses=[SiteListener,MapFileListener,FileListener,CategoryListener,PoiListener,FeatureListener,FeatureValueListener,PlaceListener,CustomObjectListener,PlaylistListener,MediaListener,DeviceListener,SiteCalibrationListener,FloorCalibrationListener,TagListener];class EntityManager{static generateNonce(){const t=Date.now()*Math.random();return MD5(t.toString(),1)}static now(){return Math.round(Date.now()/1e3).toString()}constructor(t){this.options=null,this.logger=null,this._repositories=new Map,this._listeners=new Map,this.locale=null,this._uow=null,this.locked=!1,this._waiting=new Set,this._init(new Options(t))}_init(t){t.validate(),this.options=t,this.logger=this.options.logger,this.logger.info("EntityManager: instantiate",{options:t}),this._uow=new UnitOfWork(this);for(let t=0;t<repositoryClasses.length;t++)this._repositories.set(repositoryClasses[t].getName(),new repositoryClasses[t](this));for(let t=0;t<listenerClasses.length;t++)this._listeners.set(listenerClasses[t].getEntityClass().getName(),new listenerClasses[t](this));this.locale=this.options.locale}_lock(){this.logger.info("EntityManager: locked"),this.locked=!0}_unlock(){this.logger.info("EntityManager: unlocked"),this.locked=!1}hasPendingChanges(){return this._uow._hasPendingChanges}isFullyLoaded(){const t=this.getRepositories();for(let e=0;e<t.length;e++){if(t[e]._status!==REPOSITORY_STATUSES.LOADED)return!1}return!0}getRepository(t){return this._repositories.has(t)?this._repositories.get(t):null}getRepositoryNames(){return Array.from(this._repositories.keys())}getRepositories(){return Array.from(this._repositories.values())}load(t=!0){return new Promise((e,s)=>{this.logger.info("EntityManager: loading start");const r=[];this.getRepositories().forEach(e=>{r.push(e.load(t))}),Promise.all(r).then(()=>{this.logger.info("EntityManager: loading success"),e()},t=>{this.logger.error("EntityManager: loading failed",{error:t}),s(t)})})}loadFromCache(t=!1){return new Promise((e,s)=>{this.logger.info("EntityManager: loading start");const r=[];this.getRepositories().forEach(e=>{r.push(e.loadFromCache(t))}),Promise.all(r).then(()=>{this.logger.info("EntityManager: loading success"),e()},(...t)=>{this.logger.error("EntityManager: loading failed",{error:t}),s(...t)})})}flush(){return new Promise((t,e)=>{this.options.state===STATES.PUBLISHED&&this.logger.warn("EntityManager: your are about to flush into PUBLISHED state"),this.logger.info("EntityManager: flush start"),this._assertIsNotLocked(),this._assertIsFullyLoaded(),this.logger.info("EntityManager: waiting listeners to be completed before send data"),this._wait().then(t,e)}).then(()=>(this._lock(),this._uow.flush())).then(t=>(this._unlock(),t.forEach(t=>{EventDispatcher.publish(t.repository,REPOSITORY_EVENTS.IDENTIFIER_WILL_CHANGE,[t.id,t.symbol])}),this.pull().then(()=>{t.forEach(t=>{EventDispatcher.publish(t.repository,REPOSITORY_EVENTS.IDENTIFIER_DID_CHANGE,[t.id,t.symbol])})}))).catch(t=>{throw this.logger.error("EntityManager: flush failed",{error:t}),this._unlock(),t})}pull(){if(this.logger.info("EntityManager: pull start"),this.hasPendingChanges())throw this.logger.error("EntityManager: pull failed (pending changes)."),new Error("You cannot pull while there is unsaved modifications");this._lock();const t=[];return this.getRepositories().forEach(e=>{t.push(e._loadIntoNewStorage(!1).then(t=>{const s=e._replaceStorage(t);return[e,s]}))}),Promise.all(t).then(t=>{t.forEach(([t,e])=>{e[REPOSITORY_EVENTS.REMOVE].forEach(e=>{EventDispatcher.publish(t,REPOSITORY_EVENTS.REMOVE,e)})}),t.forEach(([t,e])=>{e[REPOSITORY_EVENTS.CREATE].forEach(e=>{EventDispatcher.publish(t,REPOSITORY_EVENTS.CREATE,e)})}),t.forEach(([t,e])=>{e[REPOSITORY_EVENTS.UPDATE].forEach(e=>{EventDispatcher.publish(t,REPOSITORY_EVENTS.UPDATE,e)})})}).then(()=>{this._unlock()}).catch(t=>(this._unlock(),Promise.reject(t)))}static getHeaders(t,e,s=null,r=null){const i={Authorization:'WSSE profile="UsernameToken"',"X-WSSE":this.getWsseHeader(t,e),"X-API-MODE":"get"};return null!==r&&(i["X-API-STATE"]=r),null!==s&&(i["X-API-LOCALE"]=s),i}static getWsseHeader(t,e){const s=this.generateNonce(),r=this.now();return`UsernameToken Username="${t}", PasswordDigest="${SHA1(s+r+e,1)}", Nonce="${s}", Created="${r}"`}_assertIsFullyLoaded(){if(!this.isFullyLoaded())throw this.logger.error("EntityManager: not fully failed."),new TypeError("You need to fully load EntityManager to use write features")}_assertIsNotLocked(){if(this.locked)throw this.logger.error("EntityManager: locked."),new Error("The EntityManager is locked, readonly operations are permitted")}_xhr(t,e){return t.addParameter("site",this.options.site),t.addHeaders(this.constructor.getHeaders(this.options.username,this.options.key,this.options.locale,this.options.state)),t.validateStatus=(t=>t===e),Request.sendRequest(t).then(s=>{if(s.status!==e){const r=`Unexpected status while requesting API\n\n                Got ${s.status} instead of ${e} on route ${t.formattedUrl()}`;return this.logger.error(r,{response:s,request:t,expectedStatus:e}),Promise.reject(s)}return s}).catch(e=>this._onRequestError(e,t))}_onRequestError(t,e){const{message:s,context:r}=Request.formatApiError(t,e);return this.logger.error(s,r),Promise.reject(new Error(s))}_waitFor(t){this._waiting.add(t.catch(()=>{}))}_wait(){const t=this._waiting;return this._waiting=new Set,0===t.size?Promise.resolve():Promise.all(t).then(()=>this._wait())}wait(){return this._wait()}}const version="2.2.0-rc.1",VERSION=version;class CacheOptions extends AbstractOptions{reset(){super.reset(),this.endpoint=null,this.username=null,this.key=null,this.additionalLocales=null,this.state=STATES.PUBLISHED,this.binDownloadPolicy={ignoredContexts:[FILE_CONTEXTS.TEXTURE_LOW,FILE_CONTEXTS.TEXTURE_HELPER,FILE_CONTEXTS.TEXTURE_MODEL],ignoredIds:[],ignoredFileType:[]}}areSameAdditionalLocales(t){return t===this.additionalLocales||null!==t&&null!==this.additionalLocales&&this.constructor._areSameArrays(t,this.additionalLocales)}areSameBinDownloadPolicy(t){if(!t)return!1;return!!this.constructor._areSameArrays(t.ignoredContexts,this.binDownloadPolicy.ignoredContexts)&&(!!this.constructor._areSameArrays(t.ignoredIds,this.binDownloadPolicy.ignoredIds)&&this.constructor._areSameArrays(t.ignoredFileType,this.binDownloadPolicy.ignoredFileType))}static _areSameArrays(t,e){if(t.length!==e.length)return!1;let s=!0;return t.forEach(t=>{s&&!e.includes(t)&&(s=!1)}),s}}class CacheManager{static getTranslatableRepositories(){return[Site.getName(),Category.getName(),CustomObject.getName(),Feature.getName(),FeatureValue.getName(),Media.getName(),Playlist.getName(),Poi.getName(),Tag.getName()]}constructor(t){this.directory=t,this.runningUpdates=new Map,this.runningClean=null,this.logger=new ConsoleLogger}getLastPublishDate(t,e){if(e.state!==STATES.PUBLISHED)return Promise.resolve(new Date);const s=Options.formatApiEndpoint(e.endpoint),r=new Request;return r.url=`${s}/published-version/last/${t}`,r.addHeaders(EntityManager.getHeaders(e.username,e.key)),Request.sendRequest(r).then(({data:t})=>new Date(t.date)).catch(t=>{if(!t.response)return null;if(t.response)switch(t.response.status){case 400:case 404:return new Date;case 503:return null}const{message:e,context:s}=Request.formatApiError(t,r);return this.logger.error(e,s),Promise.reject(new Error(e))})}getCacheMetadata(t){return this._readFile(`${this._getSiteCacheDirector(t)}/metadata.json`).then(t=>JSON.parse(t)).catch(()=>null)}clean(t=!0){return null!==this.runningClean?this.runningClean:t&&this.runningUpdates.size>0?Promise.all(Array.from(this.runningUpdates.values())).then(()=>this.clean()):(this.runningClean=Promise.all([this._getBinRegistry(),this._readdir(this._getBinCacheDirector())]).then(([t,e])=>{const s=[];Object.keys(t).forEach(e=>{t[e].forEach(t=>{s.includes(t)||s.push(t)})});const r=[];return e.forEach(t=>{s.includes(t)||r.push(this._rmrf(`${this._getBinCacheDirector()}/${t}`))}),Promise.all(r).then(()=>{this.runningClean=null})}),this.runningClean)}_cleanUnusedBins(t,e){return this._getBinRegistry().then(s=>(s[t]=e,this._writeFile(`${this.directory}/binRegistry.json`,JSON.stringify(s)))).then(()=>this.clean(!1))}_getBinRegistry(){return this._readFile(`${this.directory}/binRegistry.json`).then(t=>JSON.parse(t)).catch(()=>({}))}update(t,e){if(this.runningUpdates.has(t))return this.runningUpdates.get(t);if(null!==this.runningClean)return this.runningClean.then(()=>this.update(t,e));const s=new CacheOptions(e),r=this.needsUpdate(t,s).then(({needsUpdate:e,hasCache:r,hasInternetConnexion:i})=>i?e?(console.log("Will update"),this._doUpdate(t,s)):(console.log("Skip update as it's valid"),!0):r?(console.warn("No Internet connexion"),!1):Promise.reject(new Error("No Internet connexion and no cache")));return this.runningUpdates.set(t,r),r.then(()=>{this.runningUpdates.delete(t)}),r}needsUpdate(t,e){const s=new CacheOptions(e);return Promise.all([this.getCacheMetadata(t),this.getLastPublishDate(t,s)]).then(([t,e])=>{const r=null!==t,i=null!==e,o=r?new Date(t.date):null;if(!i)return{needsUpdate:!r,lastPublishedDate:e,hasCache:r,hasInternetConnexion:i,lastCacheUpdateDate:o};let a=!1;return r?t.apiVersion!==Options.getApiVersion()?a=!0:t.endpoint!==s.endpoint?a=!0:t.state!==s.state?a=!0:o<=e?a=!0:s.areSameAdditionalLocales(t.additionalLocales)&&s.areSameBinDownloadPolicy(t.binDownloadPolicy)||(a=!0):a=!0,{needsUpdate:a,lastPublishedDate:e,hasCache:r,hasInternetConnexion:i,lastCacheUpdateDate:o}})}_getSiteCacheDirector(t){return`${this.directory}/${t}`}_getBinCacheDirector(){return`${this.directory}/bin`}get(t,e,s=!1){const r=new Options(e);return this.getCacheMetadata(r.site).then(t=>{if(null===t)return Promise.reject(new Error("CacheManager: no cache"));if(t.apiVersion!==Options.getApiVersion())return Promise.reject(new Error("CacheManager: cache was created from another api version, please update it"));if(t.endpoint!==r.endpoint)return Promise.reject(new Error("CacheManager: cache was created from another endpoint, please update it"));if(t.state!==r.state)return Promise.reject(new Error("CacheManager: cache was created from state, please update it"));const e=null===r.locale||r===t.defaultLocale;return e||t.availableLocales.includes(r.locale)?s?e:this.getLastPublishDate(r.site,r).then(s=>null===s||s>new Date(t.date)?Promise.reject(new Error("CacheManger: is outdated")):e):Promise.reject(new Error("CacheManager: requested locale is not in the cache"))}).then(e=>{let s=null;s=e||!this.constructor.getTranslatableRepositories().includes(t)?`${this._getSiteCacheDirector(r.site)}/${t}.json`:`${this._getSiteCacheDirector(r.site)}/${r.locale}/${t}.json`;let i=null;return t===File.getName()&&(i=this._getBinRegistry()),Promise.all([this._readFile(s).then(t=>JSON.parse(t)),i])}).then(([e,s])=>{if(t===File.getName()){const t=s[r.site];e.forEach(e=>{t.includes(e.reference)&&(e.uri=`${this._getBinCacheDirector()}/${e.reference}`)})}return e})}_doUpdate(t,e){const s=this._createEm(t,null,e),r=[],i=this._getSiteCacheDirector(t);return s.load().then(()=>{const i=s.getRepository("Site").getCurrent();null===s.locale&&(s.locale=i.locale);let o=null;null===e.additionalLocales?(o=[],i.languages.forEach(t=>{t!==i.locale&&o.push(t)})):({additionalLocales:o}=e);const a=[];return o.forEach(s=>{const i=this._createEm(t,s,e);r.push(i),this.constructor.getTranslatableRepositories().forEach(t=>{a.push(i.getRepository(t).load())})}),Promise.all(a)}).then(()=>(console.log("Cleaning"),this._rmrf(i))).then(()=>{console.log("Creating dirs");const t=[this._mkdirp(i),this._mkdirp(this._getBinCacheDirector())];return r.forEach(e=>{t.push(this._mkdirp(`${i}/${e.locale}`))}),console.log("Creating dir"),Promise.all(t)}).then(()=>{const t={ignoredContexts:e.binDownloadPolicy.ignoredContexts,ignoredIds:[...e.binDownloadPolicy.ignoredIds],ignoredFileType:e.binDownloadPolicy.ignoredFileType},r=s.getRepository("MapFile").findBy({type:t=>[MAP_FILE_TYPES.PATH,MAP_FILE_TYPES.CONFIG,MAP_FILE_TYPES.HELPER,MAP_FILE_TYPES.IVE,MAP_FILE_TYPES.LIGHT,MAP_FILE_TYPES.OSG].includes(t)}).map(t=>t.file.value);return t.ignoredIds.push(...r),this._downloadFiles(s,t)}).then(t=>{console.log("Saving");const e=[];return s.getRepositories().forEach(t=>{t.isLoaded()&&e.push(this._writeFile(`${i}/${t.constructor.getName()}.json`,JSON.stringify(t.getAll())))}),r.forEach(t=>{t.getRepositories().forEach(s=>{s.isLoaded()&&e.push(this._writeFile(`${i}/${t.locale}/${s.constructor.getName()}.json`,JSON.stringify(s.getAll())))})}),Promise.all(e).then(()=>t)}).then(e=>this._cleanUnusedBins(t,e)).then(()=>{const t=s.getRepository("Site").getCurrent(),r={endpoint:e.endpoint,state:e.state,date:new Date,additionalLocales:e.additionalLocales,defaultLocale:t.default,availableLocales:Array.from(t.languages),binDownloadPolicy:e.binDownloadPolicy,apiVersion:Options.getApiVersion()};return this._writeFile(`${i}/metadata.json`,JSON.stringify(r))})}_downloadFiles(t,e){const s=[];if(t.getRepository("File").getAll().forEach(t=>{e.ignoredContexts.includes(t.context)||e.ignoredIds.includes(t.id)||e.ignoredFileType.includes(t.file_type)||s.push(t)}),0===s.length)return Promise.resolve([]);const r=[];s.forEach(t=>{r.includes(t.reference)||r.push(t.reference)});const i=[];for(let t=0;t<10;t++)i.push(Promise.resolve());for(let t=0;t<s.length;t++){const e=t%10;i[e]=i[e].then(()=>this._downloadFile(s[t]))}return Promise.all(i).then(()=>r)}_createEm(t,e,s){return new EntityManager(new Options({site:t,endpoint:s.endpoint,username:s.username,key:s.key,state:s.state,locale:e}))}_downloadFile(t){return Promise.reject(new Error("Not implemented"))}_exists(t){return Promise.reject(new Error("Not implemented"))}_mkdirp(t){return Promise.reject(new Error("Not implemented"))}_readFile(t){return Promise.reject(new Error("Not implemented"))}_writeFile(t,e){return Promise.reject(new Error("Not implemented"))}_rmrf(t){return Promise.reject(new Error("Not implemented"))}_readdir(t){return Promise.reject(new Error("Not implemented"))}}class LocalCacheManager extends CacheManager{constructor(t="./adsum/cache"){super(t)}_downloadFile(t){const e=`${this._getBinCacheDirector()}/${t.reference}`;return this._exists(e).then(s=>s?Promise.resolve():new Promise((s,r)=>{axios({url:t.uri,responseType:"stream"}).then(t=>{const i=fs.createWriteStream(e);i.on("finish",s),i.on("error",r),t.data.pipe(i)})}))}_exists(t){return new Promise(e=>{fs.access(t,t=>{e(!t)})})}_readFile(t){return new Promise((e,s)=>{fs.readFile(t,"utf8",(t,r)=>{t?s(t):e(r)})})}_mkdirp(t){return new Promise((e,s)=>{fs.mkdir(t,511,r=>{if(!r)return console.log(`${t}created`),void e();switch(r.code){case"ENOENT":return void this._mkdirp(path.dirname(t)).then(()=>this._mkdirp(t),s).then(e,s);default:fs.stat(t,(t,i)=>{t||!i.isDirectory()?s(r):e()})}})})}_writeFile(t,e){return new Promise((s,r)=>{fs.writeFile(t,e,"utf8",t=>{t?r(t):s()})})}_rmrf(t){return new Promise((e,s)=>{fs.stat(t,(r,i)=>{r&&"ENOENT"===r.code?e():r?s(r):i.isDirectory()?this._readdir(t).then(e=>{const s=e.map(e=>this._rmrf(`${t}/${e}`));return Promise.all(s)}).then(()=>{fs.rmdir(t,t=>{t?s(t):e()})},s):fs.unlink(t,t=>{t?s(t):e()})})})}_readdir(t){return new Promise((e,s)=>{fs.readdir(t,(t,r)=>{t?s(t):e(r)})})}}class DistCacheManager extends CacheManager{constructor(t="//localhost:8080/adsum/cache"){super(t)}update(t,e){return Promise.reject(new Error("Not supported"))}clean(t,e){return Promise.reject(new Error("Not supported"))}_readFile(t){return axios.get(t).then(t=>"object"==typeof t.data?JSON.stringify(t.data):t.data)}}export{EntityManager,EventDispatcher,VERSION,Options,Request,AbstractEntity,Category,Feature,FeatureValue,File,FILE_CONTEXTS,FloorCalibration,Place,Playlist,Site,SiteCalibration,Tag,CustomObject,Picto,Label,Device,Kiosk,Mobile,Web,MapAoDae,MapConfig,MapDae,MapFile,MapHelper,MapLight,MapPath,Media,MediaImage,MediaPdf,MediaText,MediaUrl,MediaVideo,Movie,Exhibitor,Person,Poi,Product,Room,Service,Store,CUSTOM_OBJECT_ORIENTATION_MODES,CUSTOM_OBJECT_TYPES,LABEL_ALIGNMENTS,DEVICE_TYPES,MAP_FILE_TYPES,MEDIA_TYPES,POI_TYPES,REPOSITORY_EVENTS,STATES,Reference,Collection,OrderedCollection,Vector,LocalCacheManager,DistCacheManager,CacheOptions};
