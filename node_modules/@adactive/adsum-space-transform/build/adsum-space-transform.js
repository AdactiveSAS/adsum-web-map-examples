/**
 * Copyright (C) 2018 Adactive SAS
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.AdsumSpaceTransform={})}(this,function(t){"use strict";var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),n=function(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)},s=function(){function t(){e(this,t)}return r(t,null,[{key:"toDegree",value:function(t){return 180*t/Math.PI}},{key:"toRadian",value:function(t){return t*Math.PI/180}}]),t}(),i=function(){function t(r,n,s){e(this,t),this.a=r,this.e=n,this.f=s,this.k0=.9996,this.ePow2=Math.pow(this.e,2),this.ePow4=Math.pow(this.e,4),this.ePow6=Math.pow(this.e,6),this.e1sq=this.ePow2/(1-this.ePow2)}return r(t,null,[{key:"fromFlattening",value:function(t,e){return new this(t,Math.sqrt(2*e-Math.pow(e,2)),e)}}]),t}().fromFlattening(6378137,1/298.257223563),a=function t(r){e(this,t),this.k=i.k0,this.E=5e5;var n=s.toDegree(r.long);this.zone=n<0?Math.floor((180+n)/6+1):Math.floor(n/6+31),this.long=s.toRadian(6*(this.zone-30)-3),this.N=r.lat<0?1e7:0,this.hemi=0===this.N?1:-1},o=1-i.ePow2/4-3/64*i.ePow4-5/256*i.ePow6,h=3/8*i.ePow2+3/32*i.ePow4+45/1024*i.ePow6,u=15/256*i.ePow4+45/1024*i.ePow6,l=35/3072*i.ePow6,c=function t(r,n,s,i,a){e(this,t),this.E=r,this.N=n,this.alt=s,this.hemi=i,this.zone=a},f=function(){function t(r,n,s){e(this,t),this.lat=r,this.long=n,this.alt=s}return r(t,[{key:"latInDegree",get:function(){return s.toDegree(this.lat)}},{key:"longInDegree",get:function(){return s.toDegree(this.long)}}],[{key:"fromDegree",value:function(t,e,r){return new this(s.toRadian(t),s.toRadian(e),r)}}]),t}(),v=function(){function t(){e(this,t)}return r(t,null,[{key:"toUtm",value:function(t,r){var n=new function t(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e(this,t),this.gps=r,this.utmGridZone=n||new a(this.gps),this.deltaLong=this.gps.long-this.utmGridZone.long,this.Nu=1/Math.sqrt(1-i.ePow2*Math.pow(Math.sin(this.gps.lat),2)),this.A=this.deltaLong*Math.cos(this.gps.lat),this.APow2=Math.pow(this.A,2),this.APow3=Math.pow(this.A,3),this.APow4=Math.pow(this.A,4),this.APow5=Math.pow(this.A,5),this.APow6=Math.pow(this.A,6);var s=Math.sin(2*this.gps.lat),c=Math.sin(4*this.gps.lat),f=Math.sin(6*this.gps.lat);this.S=o*this.gps.lat-h*s+u*c-l*f,this.T=Math.pow(Math.tan(this.gps.lat),2),this.TPow2=Math.pow(this.T,2),this.C=i.ePow2/(1-i.ePow2)*Math.pow(Math.cos(this.gps.lat),2),this.CPow2=Math.pow(this.C,2),this.E=this.A+(1-this.T+this.C)/6*this.APow3,this.E+=(5-18*this.T+this.TPow2)*this.APow5/120,this.E*=this.utmGridZone.k*i.a*this.Nu,this.E+=this.utmGridZone.E,this.N=this.APow2/2,this.N+=(5-this.T+9*this.C+4*this.CPow2)*this.APow4/24,this.N+=(61-58*this.T+this.TPow2)*this.APow6/720,this.N*=this.Nu*Math.tan(this.gps.lat),this.N+=this.S,this.N*=i.a*this.utmGridZone.k,this.N+=this.utmGridZone.N}(t,r);return new c(n.E,n.N,t.alt,n.utmGridZone.hemi,n.utmGridZone.zone)}},{key:"toGps",value:function(t){var r=new function t(r){e(this,t);var n=r.N,s=1===r.hemi;s||(n=1e7-n);var a=n/i.k0/(i.a*(1-Math.pow(i.e,2)/4-3*Math.pow(i.e,4)/64-5*Math.pow(i.e,6)/256)),o=(1-Math.pow(1-i.ePow2,.5))/(1+Math.pow(1-i.ePow2,.5)),h=3*o/2-27*Math.pow(o,3)/32,u=21*Math.pow(o,2)/16-55*Math.pow(o,4)/32,l=151*Math.pow(o,3)/96,c=1097*Math.pow(o,4)/512,f=a+h*Math.sin(2*a)+u*Math.sin(4*a)+l*Math.sin(6*a)+c*Math.sin(8*a),v=i.a/Math.pow(1-Math.pow(i.e*Math.sin(f),2),.5),w=i.a*(1-i.ePow2)/Math.pow(1-Math.pow(i.e*Math.sin(f),2),1.5),g=v*Math.tan(f)/w,p=5e5-r.E,m=p/(v*i.k0),y=m*m/2,M=Math.pow(Math.tan(f),2),d=i.e1sq*Math.pow(Math.cos(f),2),x=(5+3*M+10*d-4*d*d-9*i.e1sq)*Math.pow(m,4)/24,P=(61+90*M+298*d+45*M*M-252*i.e1sq-3*d*d)*Math.pow(m,6)/720,k=(p/(v*i.k0)-(1+2*M+d)*Math.pow(m,3)/6+(5-2*d+28*M-3*Math.pow(d,2)+8*i.e1sq+24*Math.pow(M,2))*Math.pow(m,5)/120)/Math.cos(f)*180/Math.PI;this.latitude=180*(f-g*(y+x+P))/Math.PI,s||(this.latitude=-this.latitude);var E=r.zone>0?6*r.zone-183:3;this.longitude=E-k}(t);return f.fromDegree(r.latitude,r.longitude,t.alt)}}]),t}(),w=function(){function t(r,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;e(this,t),this.n=r,this.m=n,null===s?(this.values=new Array(this.n*this.m),this.values.fill(0)):this.values=s}return r(t,[{key:"get",value:function(t,e){return this.values[this.getIndex(t,e)]}},{key:"set",value:function(t,e,r){return this.values[this.getIndex(t,e)]=r,this}},{key:"getIndex",value:function(t,e){if("number"!=typeof t||t>=this.n)throw new Error("Invalid row index");if("number"!=typeof e||e>=this.m)throw new Error("Invalid column index");return t*this.m+e}},{key:"transpose",value:function(){for(var e=new t(this.m,this.n),r=0;r<this.n;r++)for(var n=0;n<this.m;n++)e.set(n,r,this.get(r,n));return e}},{key:"multiply",value:function(t){if("number"!=typeof t)throw new Error("Expected a number");return this.values=this.values.map(function(e){return e*t}),this}},{key:"extractColumn",value:function(e){for(var r=new t(this.n,1),n=0;n<this.n;n++)r.set(n,0,this.get(n,e));return r}}],[{key:"sum",value:function(e,r){if(e.m!==r.m||e.n!==r.n)throw new Error("Invalid given matrices");return new t(e.n,e.m,e.values.map(function(t,e){return t+r.values[e]}))}},{key:"identity",value:function(e){for(var r=new t(e,e),n=0;n<e;n++)r.set(n,n,1);return r}},{key:"additiveInverse",value:function(e){return new t(e.n,e.m,e.values.map(function(t){return-1*t}))}},{key:"product",value:function(e,r){if(!(e instanceof t&&r instanceof t))throw new Error("Expected two Matrices");if(e.m!==r.n)throw new Error("Invalid given matrices");for(var n=e.m,s=new t(e.n,r.m),i=0;i<s.n;i++)for(var a=0;a<s.m;a++){for(var o=0,h=0;h<n;h++)o+=e.get(i,h)*r.get(h,a);s.set(i,a,o)}return s}},{key:"inverseMatrix3",value:function(e){if(3!==e.n||3!==e.m)throw new Error("Works only with Matrix 3");var r=e.extractColumn(0),n=e.extractColumn(1),s=e.extractColumn(2),i=this.determinantMatrix3(e);if(0===i)throw new Error("Not inversible matrix");var a=this.crossProductVector3(n,s).transpose().multiply(1/i),o=this.crossProductVector3(s,r).transpose().multiply(1/i),h=this.crossProductVector3(r,n).transpose().multiply(1/i),u=new t(3,3);return u.set(0,0,a.get(0,0)),u.set(0,1,a.get(0,1)),u.set(0,2,a.get(0,2)),u.set(1,0,o.get(0,0)),u.set(1,1,o.get(0,1)),u.set(1,2,o.get(0,2)),u.set(2,0,h.get(0,0)),u.set(2,1,h.get(0,1)),u.set(2,2,h.get(0,2)),u}},{key:"determinantMatrix3",value:function(e){if(3!==e.n||3!==e.m)throw new Error("Works only with Matrix 3");var r=e.extractColumn(0),n=e.extractColumn(1),s=e.extractColumn(2);return t.dotProductVector(r,t.crossProductVector3(n,s))}},{key:"crossProductVector3",value:function(e,r){if(3!==e.n||1!==e.m||3!==r.n||1!==r.m)throw new Error("Works only with Matrix 3x1");var n=new t(3,1);return n.set(0,0,e.get(1,0)*r.get(2,0)-e.get(2,0)*r.get(1,0)),n.set(1,0,e.get(2,0)*r.get(0,0)-e.get(0,0)*r.get(2,0)),n.set(2,0,e.get(0,0)*r.get(1,0)-e.get(1,0)*r.get(0,0)),n}},{key:"dotProductVector",value:function(t,e){if(1!==t.m||1!==e.m||t.n!==e.n)throw new Error("Works only with Matrix nx1");for(var r=0,n=0;n<t.n;n++)r+=t.get(n,0)*e.get(n,0);return r}}]),t}(),g=function(){function t(){e(this,t)}return r(t,null,[{key:"compute2ParametersRegression",value:function(t){for(var e=t.length,r=new w(e,3),n=new w(e,1),s=0;s<e;s++)r.set(s,0,1),r.set(s,1,t[s].parameters.get(0,0)),r.set(s,2,t[s].parameters.get(1,0)),n.set(s,0,t[s].result);var i=r.transpose();return w.product(w.product(w.inverseMatrix3(w.product(i,r)),i),n)}}]),t}(),p=function(){function t(r,n){e(this,t),this.transformMatrix=r,this.translateMatrix=n,this._reverseTransform=null}return r(t,[{key:"convert",value:function(t){var e=new w(3,1,[t.x,t.y,t.z]),r=w.sum(w.product(this.transformMatrix,e),this.translateMatrix);return{x:r.get(0,0),y:r.get(1,0),z:r.get(2,0)}}},{key:"revert",value:function(t){return this.reverseTransform.convert(t)}},{key:"getDistanceAverageError",value:function(t,e){for(var r=t.length,n=0,s=0;s<r;s++){var i=t[s],a=e[s];n+=this.constructor._getDistance(this.convert(i),a)}return n/r}},{key:"getDistanceErrorRepartitionFromAverage",value:function(t,e){var r=t.length,n=this.getDistanceAverageError(t,e),s=new Array(10);s.fill(0);for(var i=0;i<r;i++){var a=t[i],o=e[i],h=this.constructor._getDistance(this.convert(a),o),u=Math.abs(n-h)/n*100,l=Math.trunc(u/10);l>9&&(l=9),s[l]++}return s.map(function(t){return Math.floor(t/r*100)})}},{key:"getRelativeDistanceErrorFromAverage",value:function(t,e){for(var r=t.length,n=this.getDistanceAverageError(t,e),s=[],i=0;i<r;i++){var a=t[i],o=e[i],h=this.constructor._getDistance(this.convert(a),o);s[i]=Math.abs(n-h)/n*100}return s}},{key:"getAmplitudeError",value:function(t,e){for(var r=t.length,n={x:1/0,y:1/0,z:1/0},s={x:-1/0,y:-1/0,z:-1/0},i=0;i<r;i++){var a=t[i],o=e[i],h=this.convert(a),u=Math.abs(h.x-o.x),l=Math.abs(h.y-o.y);u<n.x&&(n.x=u),u>s.x&&(s.x=u),l<n.y&&(n.y=l),l>s.y&&(s.y=l)}return{x:s.x-n.x,y:s.y-n.y}}},{key:"reverseTransform",get:function(){if(null===this._reverseTransform){var e=w.inverseMatrix3(this.transformMatrix),r=w.additiveInverse(w.product(e,this.translateMatrix));this._reverseTransform=new t(e,r),this._reverseTransform._reverseTransform=this}return this._reverseTransform}}],[{key:"computeSample",value:function(t,e){return this._leastSquareComputeSample(t,e)}},{key:"_leastSquareComputeSample",value:function(t,e){for(var r=[],s=0;s<t.length;s++){var i=[].concat(n(t)),a=[].concat(n(e)),o=i[s],h=a[s];i[s]=i[0],a[s]=a[0],i[0]=o,a[0]=h,r.push(this._leastSquareComputeSampleWithOrigin(i,a))}return this._selectResultLeastAverageDistanceError(r,t,e)}},{key:"_leastSquareComputeSampleWithOrigin",value:function(e,r){for(var n=[],s=[],i=e[0],a=r[0],o=1;o<e.length;o++){var h=e[o],u=r[o],l=new w(2,1);l.set(0,0,h.x-i.x),l.set(1,0,h.y-i.y);var c=new w(2,1);c.set(0,0,u.x-a.x),c.set(1,0,u.y-a.y),n.push({parameters:l,result:c.get(0,0)}),s.push({parameters:l,result:c.get(1,0)})}var f=g.compute2ParametersRegression(n),v=g.compute2ParametersRegression(s),p=new w(3,3);p.set(0,0,f.get(1,0)),p.set(0,1,f.get(2,0)),p.set(0,2,0),p.set(1,0,v.get(1,0)),p.set(1,1,v.get(2,0)),p.set(1,2,0),p.set(2,0,0),p.set(2,1,0),p.set(2,2,1);var m=new w(3,1);return m.set(0,0,a.x+f.get(0,0)-f.get(1,0)*i.x-f.get(2,0)*i.y),m.set(1,0,a.y+v.get(0,0)-v.get(1,0)*i.x-v.get(2,0)*i.y),m.set(2,0,0),new t(p,m)}},{key:"_linearComputeSample",value:function(t,e){for(var r=t.length,n=[],s=0;s<r-2;s++)for(var i=t[s],a=e[s],o=s+1;o<r-1;o++)for(var h=t[o],u=e[o],l=o+1;l<r;l++){var c=t[l],f=e[l],v=this._linearComputeTripletSample(i,h,c,a,u,f);n.push(v)}return this._selectResultLeastAverageDistanceError(n,t,e)}},{key:"_linearComputeTripletSample",value:function(e,r,n,s,i,a){var o=r.x-e.x,h=r.y-e.y,u=n.x-e.x,l=n.y-e.y,c=i.x-s.x,f=i.y-s.y,v=((a.x-s.x)*o-c*u)/(l*o-u*h),g=((a.y-s.y)*o-f*u)/(l*o-u*h),p=(c-v*h)/o,m=(f-g*h)/o,y=new w(3,3);y.set(0,0,p),y.set(0,1,v),y.set(0,2,0),y.set(1,0,m),y.set(1,1,g),y.set(1,2,0),y.set(2,0,0),y.set(2,1,0),y.set(2,2,1);var M=new w(3,1);return M.set(0,0,s.x-p*e.x-v*e.y),M.set(1,0,s.y-m*e.x-g*e.y),M.set(2,0,0),new t(y,M)}},{key:"_selectResultLeastAverageDistanceError",value:function(t,e,r){var n=null,s=1/0;if(!Array.isArray(t)||0===t.length)throw new Error("Expected a non empty array");return t.forEach(function(t){var i=t.getDistanceAverageError(e,r);i<s&&(n=t,s=i)}),n}},{key:"_getDistance",value:function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}}]),t}();t.Gps=f,t.Utm=c,t.GpsUtmConverter=v,t.EuclideanSpaceTransform=p,t.UtmGridZone=a,Object.defineProperty(t,"__esModule",{value:!0})});
