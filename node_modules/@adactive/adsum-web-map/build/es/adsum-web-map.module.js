/**
 * Copyright (C) 2018 Adactive SAS
 */

import{Box3,Vector3,DoubleSide,Mesh,MeshBasicMaterial,CircleGeometry,RingGeometry,EventDispatcher,WebGLRenderer,PCFSoftShadowMap,Vector2,MOUSE,Quaternion,Spherical,PerspectiveCamera,Plane,Ray,Sphere,Raycaster,Line3,FrontSide,PlaneGeometry,CanvasTexture,Group,TextureLoader,Matrix4,Vector4,Math as Math$1,Object3D,MeshLambertMaterial,MeshPhongMaterial,MultiMaterial,SkinnedMesh,Line,DirectionalLight,PointLight,SpotLight,AmbientLight,Geometry,Color,Face3,Loader,Texture,MirroredRepeatWrapping,RepeatWrapping,ClampToEdgeWrapping,MixOperation,ImageLoader,Scene,HemisphereLight,FogExp2,VertexColors}from"three";import{update,Tween,Easing}from"es6-tween";import{AbstractOptions}from"@adactive/adactive-abstract-options";import{Manager,Tap}from"hammerjs";import{FILE_CONTEXTS,MAP_FILE_TYPES,CUSTOM_OBJECT_TYPES,CUSTOM_OBJECT_ORIENTATION_MODES}from"@adactive/adsum-client-api";import{GpsUtmConverter,Gps,Utm,UtmGridZone}from"@adactive/adsum-space-transform";const DISPLAY_MODES={NONE:"none",VISIBLE:"visible",TRANSPARENT:"transparent"},v1=new Vector3;class VisibleBox3 extends Box3{setFromObject(e){return this.makeEmpty(),e.updateMatrixWorld(!0),e.traverseVisible(e=>{const{geometry:t}=e;if(void 0!==t)if(t.isGeometry){const{vertices:s}=t;for(let t=0,i=s.length;t<i;t++)v1.copy(s[t]),v1.applyMatrix4(e.matrixWorld),this.expandByPoint(v1)}else if(t.isBufferGeometry){const s=t.attributes.position;if(void 0!==s)for(let t=0,i=s.count;t<i;t++)v1.fromBufferAttribute(s,t).applyMatrix4(e.matrixWorld),this.expandByPoint(v1)}}),this}}const AdsumObjectTypes={AdsumObject3D:"AdsumObject3D",BuildingObject:"BuildingObject",FloorObject:"FloorObject",LabelImageObject:"LabelImageObject",LabelObject:"LabelObject",LabelTextObject:"LabelTextObject",SiteObject:"SiteObject",SpaceObject:"SpaceObject",PathSectionObject:"PathSectionObject",UserObject:"UserObject"},box=new VisibleBox3;class AdsumObject3D{static _createFromMesh(e,t={},s=Symbol("AdsumObjectId")){const i=new this;return i.id=s,i._setMesh(e),t.levelOfDetails&&(i._levelOfDetails=t.levelOfDetails),t.placeId&&null!==t.placeId?i.placeId=t.placeId:i.placeId=Symbol("AdsumMapPlaceId"),i._mesh.onBeforeRender=i._onBeforeRender.bind(i),i}constructor(){this.id=null,this.isAdsumObject=!0,this._mesh=null,this._levelOfDetails=null,this.placeId=null}getType(){return AdsumObjectTypes.AdsumObject3D}_setMesh(e){return null!==this._mesh&&(this._mesh.adsumObject=null),this._mesh=e,this._mesh.adsumObject=this,this}setDisplayMode(e){switch(e){case DISPLAY_MODES.NONE:this._mesh.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._mesh.visible=!0,void 0!==this._mesh.material&&(this._mesh.material.visible=!0);break;case DISPLAY_MODES.TRANSPARENT:if(this._mesh.visible=!0,void 0===this._mesh.material)throw new Error("AdsumWebMap.AdsumObject3D: DisplayMode transparent is not supported with the current object");this._mesh.material.visible=!1;break;default:throw new Error("Unexpected")}}getDisplayMode(){return this._mesh.visible&&void 0!==this._mesh.material?this._mesh.material.visible?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT:DISPLAY_MODES.NONE}moveTo(e,t,s){this._mesh.position.x=e,this._mesh.position.y=t,this._mesh.position.z=s}moveBy(e,t,s){this._mesh.position.x+=e,this._mesh.position.y+=t,this._mesh.position.z+=s}getSizeAndCenter(e=!0){if(e)box.setFromObject(this._mesh);else{box.makeEmpty();const{vertices:e}=this._mesh.geometry,t=new Vector3;e.forEach(e=>{t.copy(e),t.applyMatrix4(this._mesh.matrixWorld),box.expandByPoint(t)})}const t=new Vector3,s=new Vector3;return box.getCenter(t),box.getSize(s),{size:s,center:t}}rotateZ(e){this._mesh.rotateZ(e)}update(){this._mesh.matrixAutoUpdate||this._mesh.updateMatrix(),this._mesh.updateMatrixWorld()}_applyLod(e){null!==this._levelOfDetails&&this._levelOfDetails.applyLod(this,e)}_onBeforeRender(e,t,s,i,n,o){}_raycast(e,t,s=!0){if(!1===this._mesh.visible)return!1;if(void 0===this._mesh.material||this._mesh.material.visible){const s=[];if(this._mesh.raycast(e,s),1===s.length){const e=s[0];t.push({object:this,distance:e.distance,position:this._mesh.worldToLocal(e.point)})}}return!0}_addChild(e){this._mesh.add(e._mesh)}_dispose(){const e=e=>{if(e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material){Object.keys(e.material).forEach(t=>{const s=e.material[t];null!==s&&"object"===s&&s.dispose&&s.dispose()}),e.material.dispose&&e.material.dispose()}};this._mesh.traverse(e),e(this._mesh),null!==this._mesh.parent&&this._mesh.parent.remove(this._mesh)}}class UserObject extends AdsumObject3D{static createDefault(e,t={},s=Symbol("AdsumObjectId")){const i=new RingGeometry(e/2,e/2-e/8,32);i.merge(new CircleGeometry(e/8,16));const n=new MeshBasicMaterial({color:769978,side:DoubleSide});n.transparent=!0;const o=new Mesh(i,n);return this._createFromMesh(o,t,s)}constructor(){super(),this.isUser=!0,this.parent=null}getType(){return AdsumObjectTypes.UserObject}}class ObjectManager{constructor(){this.site=null,this.buildings=new Map,this.floors=new Map,this.spaces=new Map,this.labels=new Map,this.user=null,this.pathSectionObjects=new Map}init(e,t){this.site=e.site,this.buildings=e.buildingsMap,this.floors=e.floorsMap,this.spaces=e.spacesMap,this.labels=e.labelsMap,this.user=UserObject.createDefault(t.meterToAdsumDistance(3),{placeId:Symbol("UserPlace")},Symbol("UserPositionId"))}getFloor(e){return this.floors.has(e)?this.floors.get(e):null}getBuilding(e){return this.buildings.has(e)?this.buildings.get(e):null}getSpace(e){return this.spaces.has(e)?this.spaces.get(e):null}getLabel(e){return this.labels.has(e)?this.labels.get(e):null}}const SceneEvents={floor:{didChanged:"scene.floor.didChanged"}};class SceneManager extends EventDispatcher{constructor(e){super(),this.awm=e,this.scene=null,this.currentFloor=null}init(e){this.scene=e.scene,e.site.setDisplayMode(DISPLAY_MODES.VISIBLE),e.buildingsMap.forEach(e=>{e.setDisplayMode(DISPLAY_MODES.VISIBLE)}),e.floorsMap.forEach(e=>{e.setDisplayMode(DISPLAY_MODES.NONE)}),this.currentFloor=null}getCurrentFloor(){return this.currentFloor}setCurrentFloor(e,t=!0){return e===this.currentFloor?Promise.resolve():new Promise((s,i)=>{try{t&&console.warn("AdsumWebMap.SceneManager.setCurrentFloor: animated parameter is not supported yet"),null===this.currentFloor?(this.awm.objectManager.site.setDisplayMode(DISPLAY_MODES.TRANSPARENT),this.awm.objectManager.buildings.forEach(e=>{e.setDisplayMode(DISPLAY_MODES.TRANSPARENT)})):this.currentFloor.setDisplayMode(DISPLAY_MODES.NONE),null===e?(this.awm.objectManager.site.setDisplayMode(DISPLAY_MODES.VISIBLE),this.awm.objectManager.buildings.forEach(e=>{e.setDisplayMode(DISPLAY_MODES.VISIBLE)})):e.setDisplayMode(DISPLAY_MODES.VISIBLE);const n=this.currentFloor;this.currentFloor=e,this.dispatchEvent({type:SceneEvents.floor.didChanged,previous:n,current:e}),s()}catch(e){i(e)}})}}class EngineManager{constructor(e,t){this.awm=e,this.options=t,this.container=t.container,this.canvas=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),this.renderer=new WebGLRenderer({antialias:!0,alpha:!0,powerPreference:t.gpuPower,canvas:this.canvas,logarithmicDepthBuffer:!0}),this.renderer.capabilities.logarithmicDepthBuffer=null!==this.renderer.extensions.get("EXT_frag_depth"),this.container.appendChild(this.canvas),this.options.shadowEnabled&&(this.renderer.shadowMap.type=PCFSoftShadowMap,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.autoUpdate=!1,this.renderer.shadowMap.needsUpdate=!0),this.renderer.setClearColor(this.options.clearColor),this._animationFrameId=null,this._animationFrameIdTween=null}init(){this.options.autoCompileMaterials&&this.compileMaterials(),this._resizeCanvas()}compileMaterials(e=!0){this.renderer.compile(this.awm.sceneManager.scene,this.awm.cameraManager.camera),e&&this.renderer.domElement.addEventListener("webglcontextrestored",()=>{this.compileMaterials(!1)},!1)}start(){this._resizeCanvas(),this._animationFrameId=requestAnimationFrame(this.start.bind(this)),update(),this.awm.cameraManager.control.update(),this._updateLevelOfDetails(this.awm.cameraManager.camera),this.renderer.render(this.awm.sceneManager.scene,this.awm.cameraManager.camera)}_updateLevelOfDetails(e){const{site:t}=this.awm.objectManager;t._applyLod(e),t.getDisplayMode()!==DISPLAY_MODES.NONE&&(t.buildings.forEach(t=>this._updateLevelOfDetailsOnBuilding(t,e)),t.spaces.forEach(t=>this._updateLevelOfDetailsOnSpace(t,e)),t.labels.forEach(t=>t._applyLod(e)))}_updateLevelOfDetailsOnBuilding(e,t){e._applyLod(t),e.getDisplayMode()!==DISPLAY_MODES.NONE&&(e.floors.forEach(e=>this._updateLevelOfDetailsOnFloor(e,t)),e.labels.forEach(e=>e._applyLod(t)))}_updateLevelOfDetailsOnFloor(e,t){e._applyLod(t),e.getDisplayMode()!==DISPLAY_MODES.NONE&&(e.spaces.forEach(e=>this._updateLevelOfDetailsOnSpace(e,t)),e.labels.forEach(e=>e._applyLod(t)))}_updateLevelOfDetailsOnSpace(e,t){e._applyLod(t),e.getDisplayMode()!==DISPLAY_MODES.NONE&&e.labels.forEach(e=>e._applyLod(t))}_getDevicePixelRatio(){return window.devicePixelRatio||1}_resizeCanvas(){const{width:e,height:t}=this.renderer.getSize(),s=e!==this.container.clientWidth||t!==this.container.clientHeight,i=this.renderer.getPixelRatio()!==this._getDevicePixelRatio();if((s||i)&&(s&&this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),i&&this.renderer.setPixelRatio(this._getDevicePixelRatio()),s)){const{camera:e,control:t}=this.awm.cameraManager;e.aspect=this.container.clientWidth/this.container.clientHeight,e.updateProjectionMatrix(),t.update()}}}const THREE={Vector3:Vector3,MOUSE:MOUSE,Quaternion:Quaternion,Spherical:Spherical,EventDispatcher:EventDispatcher,Vector2:Vector2};THREE.OrbitControls=function(e,t){var s,i,n,o,a;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.panningMode=THREE.ScreenSpacePanning,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return m.phi},this.getAzimuthalAngle=function(){return m.theta},this.saveState=function(){r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=function(){r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(l),r.update(),u=d.NONE},this.update=(s=new THREE.Vector3,i=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),n=i.clone().inverse(),o=new THREE.Vector3,a=new THREE.Quaternion,function(){var e=r.object.position;return s.copy(e).sub(r.target),s.applyQuaternion(i),m.setFromVector3(s),r.autoRotate&&u===d.NONE&&N(2*Math.PI/60/60*r.autoRotateSpeed),m.theta+=g.theta,m.phi+=g.phi,m.theta=Math.max(r.minAzimuthAngle,Math.min(r.maxAzimuthAngle,m.theta)),m.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,m.phi)),m.makeSafe(),m.radius*=f,m.radius=Math.max(r.minDistance,Math.min(r.maxDistance,m.radius)),r.target.add(b),s.setFromSpherical(m),s.applyQuaternion(n),e.copy(r.target).add(s),r.object.lookAt(r.target),!0===r.enableDamping?(g.theta*=1-r.dampingFactor,g.phi*=1-r.dampingFactor,b.multiplyScalar(1-r.dampingFactor)):(g.set(0,0,0),b.set(0,0,0)),f=1,!!(y||o.distanceToSquared(r.object.position)>p||8*(1-a.dot(r.object.quaternion))>p)&&(r.dispatchEvent(l),o.copy(r.object.position),a.copy(r.object.quaternion),y=!1,!0)}),this.dispose=function(){r.domElement.removeEventListener("contextmenu",G,!1),r.domElement.removeEventListener("mousedown",D,!1),r.domElement.removeEventListener("wheel",F,!1),r.domElement.removeEventListener("touchstart",$,!1),r.domElement.removeEventListener("touchend",V,!1),r.domElement.removeEventListener("touchmove",z,!1),document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",H,!1),window.removeEventListener("keydown",U,!1)};var r=this,l={type:"change"},c={type:"start"},h={type:"end"},d={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},u=d.NONE,p=1e-6,m=new THREE.Spherical,g=new THREE.Spherical,f=1,b=new THREE.Vector3,y=!1,E=new THREE.Vector2,w=new THREE.Vector2,M=new THREE.Vector2,_=new THREE.Vector2,T=new THREE.Vector2,O=new THREE.Vector2,v=new THREE.Vector2,x=new THREE.Vector2,A=new THREE.Vector2;function S(){return Math.pow(.95,r.zoomSpeed)}function N(e){g.theta-=e}function L(e){g.phi-=e}var j,C=(j=new THREE.Vector3,function(e,t){j.setFromMatrixColumn(t,0),j.multiplyScalar(-e),b.add(j)}),P=function(){var e=new THREE.Vector3;return function(t,s){switch(r.panningMode){case THREE.ScreenSpacePanning:e.setFromMatrixColumn(s,1);break;case THREE.HorizontalPanning:e.setFromMatrixColumn(s,0),e.crossVectors(r.object.up,e)}e.multiplyScalar(t),b.add(e)}}(),R=function(){var e=new THREE.Vector3;return function(t,s){var i=r.domElement===document?r.domElement.body:r.domElement;if(r.object.isPerspectiveCamera){var n=r.object.position;e.copy(n).sub(r.target);var o=e.length();o*=Math.tan(r.object.fov/2*Math.PI/180),C(2*t*o/i.clientHeight,r.object.matrix),P(2*s*o/i.clientHeight,r.object.matrix)}else r.object.isOrthographicCamera?(C(t*(r.object.right-r.object.left)/r.object.zoom/i.clientWidth,r.object.matrix),P(s*(r.object.top-r.object.bottom)/r.object.zoom/i.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}}();function k(e){r.object.isPerspectiveCamera?f/=e:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom*e)),r.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function I(e){r.object.isPerspectiveCamera?f*=e:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/e)),r.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function D(e){if(!1!==r.enabled){switch(e.preventDefault(),e.button){case r.mouseButtons.ORBIT:if(!1===r.enableRotate)return;!function(e){E.set(e.clientX,e.clientY)}(e),u=d.ROTATE;break;case r.mouseButtons.ZOOM:if(!1===r.enableZoom)return;!function(e){v.set(e.clientX,e.clientY)}(e),u=d.DOLLY;break;case r.mouseButtons.PAN:if(!1===r.enablePan)return;!function(e){_.set(e.clientX,e.clientY)}(e),u=d.PAN}u!==d.NONE&&(document.addEventListener("mousemove",B,!1),document.addEventListener("mouseup",H,!1),r.dispatchEvent(c))}}function B(e){if(!1!==r.enabled)switch(e.preventDefault(),u){case d.ROTATE:if(!1===r.enableRotate)return;!function(e){w.set(e.clientX,e.clientY),M.subVectors(w,E).multiplyScalar(r.rotateSpeed);var t=r.domElement===document?r.domElement.body:r.domElement;N(2*Math.PI*M.x/t.clientWidth),L(2*Math.PI*M.y/t.clientHeight),E.copy(w),r.update()}(e);break;case d.DOLLY:if(!1===r.enableZoom)return;!function(e){x.set(e.clientX,e.clientY),A.subVectors(x,v),A.y>0?k(S()):A.y<0&&I(S()),v.copy(x),r.update()}(e);break;case d.PAN:if(!1===r.enablePan)return;!function(e){T.set(e.clientX,e.clientY),O.subVectors(T,_).multiplyScalar(r.panSpeed),R(O.x,O.y),_.copy(T),r.update()}(e)}}function H(e){!1!==r.enabled&&(document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",H,!1),r.dispatchEvent(h),u=d.NONE)}function F(e){!1===r.enabled||!1===r.enableZoom||u!==d.NONE&&u!==d.ROTATE||(e.preventDefault(),e.stopPropagation(),r.dispatchEvent(c),function(e){e.deltaY<0?I(S()):e.deltaY>0&&k(S()),r.update()}(e),r.dispatchEvent(h))}function U(e){!1!==r.enabled&&!1!==r.enableKeys&&!1!==r.enablePan&&function(e){switch(e.keyCode){case r.keys.UP:R(0,r.keyPanSpeed),r.update();break;case r.keys.BOTTOM:R(0,-r.keyPanSpeed),r.update();break;case r.keys.LEFT:R(r.keyPanSpeed,0),r.update();break;case r.keys.RIGHT:R(-r.keyPanSpeed,0),r.update()}}(e)}function $(e){if(!1!==r.enabled){switch(e.touches.length){case 1:if(!1===r.enableRotate)return;!function(e){E.set(e.touches[0].pageX,e.touches[0].pageY)}(e),u=d.TOUCH_ROTATE;break;case 2:if(!1===r.enableZoom)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,s=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+s*s);v.set(0,i)}(e),u=d.TOUCH_DOLLY;break;case 3:if(!1===r.enablePan)return;!function(e){_.set(e.touches[0].pageX,e.touches[0].pageY)}(e),u=d.TOUCH_PAN;break;default:u=d.NONE}u!==d.NONE&&r.dispatchEvent(c)}}function z(e){if(!1!==r.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===r.enableRotate)return;if(u!==d.TOUCH_ROTATE)return;!function(e){w.set(e.touches[0].pageX,e.touches[0].pageY),M.subVectors(w,E).multiplyScalar(r.rotateSpeed);var t=r.domElement===document?r.domElement.body:r.domElement;N(2*Math.PI*M.x/t.clientWidth),L(2*Math.PI*M.y/t.clientHeight),E.copy(w),r.update()}(e);break;case 2:if(!1===r.enableZoom)return;if(u!==d.TOUCH_DOLLY)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,s=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+s*s);x.set(0,i),A.subVectors(x,v),A.y>0?I(S()):A.y<0&&k(S()),v.copy(x),r.update()}(e);break;case 3:if(!1===r.enablePan)return;if(u!==d.TOUCH_PAN)return;!function(e){T.set(e.touches[0].pageX,e.touches[0].pageY),O.subVectors(T,_).multiplyScalar(r.panSpeed),R(O.x,O.y),_.copy(T),r.update()}(e);break;default:u=d.NONE}}function V(e){!1!==r.enabled&&(r.dispatchEvent(h),u=d.NONE)}function G(e){!1!==r.enabled&&e.preventDefault()}r.domElement.addEventListener("contextmenu",G,!1),r.domElement.addEventListener("mousedown",D,!1),r.domElement.addEventListener("wheel",F,!1),r.domElement.addEventListener("touchstart",$,!1),r.domElement.addEventListener("touchend",V,!1),r.domElement.addEventListener("touchmove",z,!1),window.addEventListener("keydown",U,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}}),THREE.ScreenSpacePanning=0,THREE.HorizontalPanning=1;const OrbitControls=THREE.OrbitControls,DEFAULT_CALIBRATION={UP:new Vector3(0,0,1),ZOOM_MIN:25,ZOOM_MAX:2e4};class CameraCalibration{constructor(){this.eye=new Vector3,this.up=DEFAULT_CALIBRATION.UP.clone(),this.target=new Vector3,this.zoomMin=DEFAULT_CALIBRATION.ZOOM_MIN,this.zoomMax=DEFAULT_CALIBRATION.ZOOM_MAX}}class CameraCenterOnOptions extends AbstractOptions{reset(){this.zoom=!0,this.fitRatio=1.5}}const box$1=new VisibleBox3;class CameraManager extends EventDispatcher{constructor(e,t){super(),this.awm=e,this.options=t,this.camera=new PerspectiveCamera(45,1,.1,5e4),this.control=null,this.floorPlane=new Plane,this.floorPlane.normal.set(0,0,-1),this.ray=new Ray,this.cameraCalibrations=new Map,this._tween=null}init(e){const{canvas:t}=this.awm.engineManager;this.camera.aspect=t.clientWidth/t.clientHeight,this.camera.near=e.meterToAdsumDistance(1),this.camera.far=e.meterToAdsumDistance(1e4),this.camera.up.set(0,0,1),this.camera.updateProjectionMatrix(),this.control=new OrbitControls(this.camera,this.awm.engineManager.canvas),this.control.enableZoom=!0,this.control.enableRotate=!0,this.control.minPolarAngle=Math.PI/20,this.control.maxPolarAngle=Math.PI/2,this.control.minDistance=e.meterToAdsumDistance(5),this.control.enableZoom=!0,this.control.enableDamping=!1,this.control.enableKeys=!1,this.control.panningMode=1,this.control.mouseButtons={PAN:MOUSE.LEFT,ZOOM:MOUSE.MIDDLE,ORBIT:MOUSE.RIGHT}}centerOnFloor(e,t=!0){this.reset();try{let s=null;if(this.cameraCalibrations.has(e))s=this.cameraCalibrations.get(e);else{console.warn("AdsumWebMap.CameraManager: Missing calibration for centerOnFloor");const t=null===e?this.awm.objectManager.site:e;box$1.setFromObject(t._mesh);const i=new Sphere;box$1.getBoundingSphere(i);const n=new Vector3;t._mesh.getWorldPosition(n),i.center.z=n.z,(s=new CameraCalibration).target.copy(i.center),s.eye.copy(i.center);const o=1.5*i.radius*Math.sin(Math.PI/4);s.eye.setZ(s.eye.z+o),s.eye.setY(s.eye.y-o)}return this.floorPlane.constant=s.target.z,this.camera.up.copy(s.up),this.goTo(s.eye,s.target,t)}catch(e){return Promise.reject(e)}}centerOn(e,t=!0,s=null){this.reset();try{let i=null;null===s?({centerOnOptions:i}=this.options):i=new CameraCenterOnOptions(s);const{size:n,center:o}=e.getSizeAndCenter(),a=this.control.target.clone().sub(this.camera.position),r=o.clone().sub(a);if(i.zoom){const{aspect:e,fov:t}=this.camera,s=Math.max(n.x,n.y,n.z)/(2*Math.atan(Math.PI*t/360)),l=s/e;let c=i.fitRatio*Math.max(s,l);c=Math.min(Math.max(c,this.control.minDistance),this.control.maxDistance);const h=a.normalize().multiplyScalar(c);r.copy(o).sub(h)}return 0!==this.control.target.z-o.z&&(a.normalize(),this.ray.origin.copy(r),this.ray.direction.copy(a),this.ray.intersectPlane(this.floorPlane,o)),this.goTo(r,o,t)}catch(e){return Promise.reject(e)}}setCameraCalibrations(e){this.cameraCalibrations=new Map,e.forEach((e,t)=>{const s=this.awm.objectManager,i=null===t?s.site:s.getFloor(t);if(null===i)return;i._mesh.updateMatrixWorld();const n=new Vector3;if(i._mesh.getWorldPosition(n),e.target.z!==n.z){console.warn(`AdsumWebMap: invalid calibration target of ${i.id}, it's not on the floor`);const t=new Plane;t.normal.set(0,0,-1),t.constant=n.z;const s=new Vector3;s.copy(e.target).sub(e.eye),s.normalize();const o=new Ray;o.origin.copy(e.eye),o.direction.copy(s),o.intersectPlane(t,e.target)}this.cameraCalibrations.set(null===t?null:i,e)})}goTo(e,t,s=!0){return new Promise((i,n)=>{try{if(this.reset(),s){this.control.enabled=!1;const s={positionX:this.camera.position.x,positionY:this.camera.position.y,positionZ:this.camera.position.z,targetX:this.control.target.x,targetY:this.control.target.y,targetZ:this.control.target.z};this._tween=new Tween(s).to({positionX:e.x,positionY:e.y,positionZ:e.z,targetX:t.x,targetY:t.y,targetZ:t.z},700).on("update",()=>{this.camera.position.set(s.positionX,s.positionY,s.positionZ),this.control.target.set(s.targetX,s.targetY,s.targetZ),this.control.update()}).on("stop",()=>{this._setCameraPositionAndTarget(e,t),this.control.enabled=!0,i(!1)}).on("complete",()=>{this.control.enabled=!0,i(!0)}).easing(Easing.Quadratic.InOut).start()}this._setCameraPositionAndTarget(e,t),s||i(!0)}catch(e){n(e)}})}reset(){return null!==this._tween&&(this._tween.stop(),this._tween=null),this}_setCameraPositionAndTarget(e,t){this.camera.position.copy(e),this.control.target.copy(t),this.control.update()}}const MOUSE_EVENTS={click:"click",dblClick:"dblClick"};class MouseManager extends EventDispatcher{constructor(e){super(),this.awm=e,this._dragging=!1,this._mouse=new Vector2,this._raycaster=new Raycaster}init(){this.awm.engineManager.canvas.addEventListener("mousemove",this._onMouseMove.bind(this));const e=new Manager(this.awm.engineManager.canvas);e.add(new Tap({event:"doubletap",threshold:10,taps:2,posThreshold:50*window.devicePixelRatio})),e.add(new Tap({event:"singletap",threshold:10,time:500,interval:100})),e.get("doubletap").recognizeWith("singletap"),e.get("singletap").requireFailure("doubletap"),e.on("singletap ",this._onMouseClick.bind(this)),e.on("doubletap ",this._onMouseDblClick.bind(this)),this.awm.engineManager.canvas.addEventListener("mousedown",()=>{this._dragging=!0},!1),window.document.addEventListener("mouseup",()=>{this._dragging=!1},!1)}_onMouseClick(e){this._setMouseCoordinate(e),this.dispatchEvent({type:MOUSE_EVENTS.click,intersects:this._raycast()})}_onMouseDblClick(e){this._setMouseCoordinate(e),this.dispatchEvent({type:MOUSE_EVENTS.dblClick,intersects:this._raycast()})}_onMouseMove(){}_setMouseCoordinate(e){let t=0,s=0;if(void 0===e.clientX&&void 0===e.clientY){const i=e.target.getBoundingClientRect();t=e.center.x-i.left,s=e.center.y-i.top}else e.offsetX||0===e.offsetX?(t=e.offsetX,s=e.offsetY):(t=e.layerX,s=e.layerY);this._mouse.set(t/this.awm.engineManager.canvas.clientWidth*2-1,-s/this.awm.engineManager.canvas.clientHeight*2+1),this._raycaster.setFromCamera(this._mouse,this.awm.cameraManager.camera),this._raycaster.near=this.awm.cameraManager.camera.near,this._raycaster.far=this.awm.cameraManager.camera.far}_raycast(){const e=[];return this.awm.objectManager.site._raycast(this._raycaster,e),e.sort((e,t)=>e.distance-t.distance),e}}function getAdsumObjectGroundAndPosition(e){let t=null,s=null;switch(e.getType()){case AdsumObjectTypes.SiteObject:case AdsumObjectTypes.FloorObject:t=e;break;case AdsumObjectTypes.BuildingObject:t=e.site,s=e._mesh.position.clone();break;case AdsumObjectTypes.SpaceObject:case AdsumObjectTypes.UserObject:t=e.parent,s=e._mesh.position.clone();break;case AdsumObjectTypes.LabelObject:case AdsumObjectTypes.LabelTextObject:case AdsumObjectTypes.LabelImageObject:{s=e._mesh.position.clone();const{parent:i}=e;i.isSpace?(t=i.parent,s.applyMatrix4(i.matrix)):i.isBuilding?(t=i.site,s.applyMatrix4(i.matrix)):t=i;break}default:throw new Error("Unexpected")}return{ground:t,groundPosition:s}}function getUtmPosition(e,t,s){const i=e._mesh.localToWorld(t.clone());return i.setZ(e.isSite?0:e.altitude),s.adsumToUtm(i)}class PathNode{static create(e,t,s,i,n=!1){return new this(e,t,s,getUtmPosition(t,s,i),n)}static updateFromAdsumObject(e,t,s){const{ground:i,groundPosition:n}=getAdsumObjectGroundAndPosition(t,s);e.ground=i,e.groundPosition=n,e.utmPosition=getUtmPosition(i,n,s)}static createFromAdsumObject(e,t,s){const{ground:i,groundPosition:n}=getAdsumObjectGroundAndPosition(t,s);return this.create(e,i,n,s)}constructor(e,t,s,i,n=!1){this.id=e||Symbol("PathNodeId"),this.ground=t,this.links=new Set,this.utmPosition=i,this.groundPosition=s,this.isDynamic=!1,this._isGate=n}getLinkTo(e){let t=null;return this.links.forEach(s=>{s.to!==e&&s.from!==e||(t=s)}),t}}const PATH_LINK_TYPES={STANDARD:0,ONLY_DISABLED:1,NOT_DISABLED:2,CLOSED:3};class PathLink{constructor(e,t,s,i,n=!0){this.id=e,this.type=t,this.from=s,this.to=i,this.bidirectional=n,this.distance=Math.sqrt((s.utmPosition.N-i.utmPosition.N)**2+(s.utmPosition.E-i.utmPosition.E)**2+(s.utmPosition.alt-i.utmPosition.alt)**2)}isAccessible(e){return this.type===PATH_LINK_TYPES.STANDARD||(e?this.type===PATH_LINK_TYPES.ONLY_DISABLED:this.type===PATH_LINK_TYPES.NOT_DISABLED)}}class AStar{constructor(e){this.pathNetwork=e,this._cache=new Map,this._computing=new Map,this._symbolStrings=new Map,this._symbolIncrement=0}search(e,t,s=!1){if(this._isCached(e,t,s))return this._getFromCache(e,t,s);if(this._isComputing(e,t,s))return this._getFromComputing(e,t,s);const i=Promise.resolve().then(()=>{const i=new Map,n=new Set,o=new Map;for(o.set(e.id,{d:0,parent:null}),o.set(t.id,{d:1/0,parent:null}),i.set(e.id,e);i.size>0;){const e=Array.from(i.values());let a=e[0];for(let t=1;t<e.length;t++){const s=e[t];o.get(s.id).d<o.get(a.id).d&&(a=s)}if(a===t){const e=[a];let{parent:t}=o.get(a.id);for(;null!==t;){e.push(t);const s=o.get(t.id);({parent:t}=s)}return e.reverse()}i.delete(a.id),n.add(a.id);const r=[],l=[];a.links.forEach(e=>{e.isAccessible(s)&&(e.from===a?(r.push(e.to),l.push(e.distance)):e.to===a&&e.bidirectional&&(r.push(e.from),l.push(e.distance)))});for(let e=0;e<r.length;e++){const t=r[e];if(n.has(t.id))continue;i.has(t.id)||(o.set(t.id,{d:1/0,parent:null}),i.set(t.id,t));const s=o.get(a.id).d+l[e],c=o.get(t.id);s<c.d&&(c.parent=a,c.d=s)}}return[]});return this._addToComputing(e,t,s,i),i}_addToCache(e,t,s,i){if(e.isDynamic||t.isDynamic)return;const n=this._getCacheKey(e,t,s);this._cache.set(n,i.map(e=>e.id))}_getFromCache(e,t,s){const i=this._getCacheKey(e,t,s);return Promise.resolve(this._cache.get(i).map(e=>this.pathNetwork.nodes.get(e)))}_getCacheKey(e,t,s){return`${this._stringifyId(e.id)}:${this._stringifyId(t.id)}${s?":pmr":""}`}_stringifyId(e){return"symbol"!=typeof e?`${e}`:(this._symbolStrings.has(e)||this._symbolStrings.set(e,`s${this._symbolIncrement++}`),this._symbolStrings.get(e))}_isCached(e,t,s){return this._cache.has(this._getCacheKey(e,t,s))}_addToComputing(e,t,s,i){const n=this._getCacheKey(e,t,s);this._computing.set(n,i),i.then(i=>{this._addToCache(e,t,s,i),this._computing.delete(n)})}_getFromComputing(e,t,s){const i=this._getCacheKey(e,t,s);return this._computing.get(i).then(()=>this.search(e,t,s))}_isComputing(e,t,s){return this._computing.has(this._getCacheKey(e,t,s))}}class PathSection{constructor(e=null,t=null,s=null,i=[]){this.from=e,this.to=s,this.ground=t,this.nodes=i,this._distance=null,this._curve=null}getDistance(){if(null===this._distance){this._distance=0;for(let e=0;e<this.nodes.length-1;e++){const t=this.nodes[e].getLinkTo(this.nodes[e+1]);this._distance+=t.distance}}return this._distance}getCurve(){if(this.nodes.length<2)return null;if(null===this._curve){this._curve=[];for(let e=0;e<this.nodes.length-1;e++)this._curve.push({from:this.nodes[e].groundPosition,to:this.nodes[e+1].groundPosition})}return this._curve}interpolate(e,t){const s=this.getCurve();if(null===s)return[];let i=e;e>this.getDistance()/3&&(console.warn("AdsumWebMap.PathSection.interpolate: short pathSection"),i=this.getDistance()/3);const n=Math.floor(this.getDistance()/i)-1,o=this.getDistance()/(n+1),a=[];let r=o;const l=new Vector3;return s.forEach(({from:e,to:s})=>{const i=t.adsumDistanceToMeter(l.subVectors(e,s).length());if(i<r)return void(r-=i);let n=r/i;for(;n<=1;)l.lerpVectors(e,s,n),a.push(l.clone()),n+=o/i;r=i*(n-1)}),a}}class PathNetwork{constructor(e){this.awm=e,this.nodes=new Map,this.spaceGatesByAdsumObjectId=new Map,this.buildingGatesByAdsumObjectId=new Map,this.aStar=new AStar(this)}init(e){e.get("nodes").forEach(e=>{const{parent:t,ground:s}=this._findParentAndGround(e.location);if(null===t)return void console.warn("AdsumWebMap.PathNetwork: invalid node");const i=new Vector3(e.position.x,e.position.y,e.position.z+.1),n=PathNode.create(e.id,s,i,this.awm.projector,e.isGate);this.nodes.set(n.id,n),e.isGate&&("STORE"===e.location.type||"SHAPE"===e.location.type?(this.spaceGatesByAdsumObjectId.has(e.location.id)||this.spaceGatesByAdsumObjectId.set(e.location.id,[]),this.spaceGatesByAdsumObjectId.get(e.location.id).push(n)):"BUILDING"===e.location.type?(this.buildingGatesByAdsumObjectId.has(e.location.id)||this.buildingGatesByAdsumObjectId.set(e.location.id,[]),this.buildingGatesByAdsumObjectId.get(e.location.id).push(n)):console.warn(`AdsumWebMap.PathNetwork: Invalid node gate on ${e.type}#${e.id}`))}),e.get("links").forEach(e=>{const t=this.nodes.get(e.from),s=this.nodes.get(e.to);if(void 0===t||void 0===s)return void console.warn("AdsumWebMap.PathNetwork: invalid link");const i=new PathLink(e.id,e.type,t,s,e.bidirectional);t.links.add(i),i.bidirectional&&s.links.add(i)})}computePath(e){const{from:t,to:s}=e;return!t.pathNode.isDynamic&&this.nodes.has(t.pathNode.id)||this.attachNodeLocation(t),!s.pathNode.isDynamic&&this.nodes.has(s.pathNode.id)||this.attachNodeLocation(s),this.aStar.search(t.pathNode,s.pathNode,e.pmr).then(t=>{this._buildPathSections(e,t)})}attachNodeLocation(e){const{ground:t,groundPosition:s}=e.pathNode;let i=null;if(e.adsumObject&&e.adsumObject.isSpace)i=this.spaceGatesByAdsumObjectId.get(e.adsumObject.id)||[];else if(e.adsumObject&&e.adsumObject.isBuilding)i=this.buildingGatesByAdsumObjectId.get(e.adsumObject.id)||[];else{i=[];let n=1/0;const o=[];if(this.nodes.forEach(s=>{if(s!==e.pathNode&&s.ground===t){const t=s.groundPosition.distanceToSquared(e.pathNode.groundPosition);t<=9*n&&o.push({squareDistance:t,node:s}),t<n&&(n=t)}}),n!==1/0){o.sort((e,t)=>e.squareDistance-t.squareDistance);const e=new Raycaster(t._mesh.localToWorld(s.clone())),a=[],r=[];o.forEach(({squareDistance:s,node:o})=>{if(!(s>9*n)){e.ray.direction=t._mesh.localToWorld(o.groundPosition.clone()),e.ray.direction.sub(e.ray.origin),e.near=0,e.far=e.ray.direction.length(),e.ray.direction.normalize();for(let t=0;t<r.length;t++)if(r[t].angleTo(e.ray.direction)<Math.PI/4)return;a.length=0;for(let s=0;s<t._mesh.children.length;s++){const i=t._mesh.children[s],{adsumObject:n}=i;if(!(n&&(n.isLabel||n.isUser))&&(e.intersectObject(i,!1,a),0!==a.length))return}i.push(o),r.push(e.ray.direction)}})}}e.pathNode.links.forEach(t=>{t.from.links.delete(t),t.to.links.delete(t),e.pathNode.links.delete(t)}),i.forEach(t=>{const s=new PathLink(Symbol("PathLinkId"),PATH_LINK_TYPES.STANDARD,e.pathNode,t);e.pathNode.links.add(s),t.links.add(s)}),this.nodes.set(e.pathNode.id,e.pathNode),e.pathNode.needsUpdate=!1}_findParentAndGround(e){let t=null,s=null;switch(e.type){case"STORE":case"SHAPE":null!==(t=this.awm.objectManager.getSpace(e.id))&&(s=t.parent);break;case"FLOOR":null!==(t=this.awm.objectManager.getFloor(e.id))&&(s=t);break;case"BUILDING":s=(t=this.awm.objectManager.getBuilding(e.id)).site;break;case"SITE":s=t=this.awm.objectManager.site;break;default:console.warn(`AdsumWebMap.WayfindingManager.PathNetwork: unknown location.type ${e.type} `)}return null===t&&console.warn(`AdsumWebMap.WayfindingManager.PathNetwork: invalid location ${e.type}#${e.id}`),{parent:t,ground:s}}_buildPathSections(e,t){if(0===t.length)throw new Error("AdsumWebMap.PathNetwork: No path found to destination");e.clear();let s=new PathSection(e.from,e.from.pathNode.ground);e.pathSections.push(s);for(let i=0;i<t.length;i++){const n=t[i];if(s.ground!==n.ground){const t=null;s.to=t,s=new PathSection(t,n.ground),e.pathSections.push(s)}s.nodes.push(n)}s.to=e.to}}class BasicDotPathSectionDrawer{constructor(e,t,s){this.pathSectionObject=e,this.cameraManager=t,this.projector=s,this.speed=30,this.center=!0,this.tweens=[]}draw(){const e=[],t=this.pathSectionObject._mesh.children;for(let s=0;s<t.length;s++){const t=this.projector.adsumDistanceToMeter(this.pathSectionObject.patternSpace)/this.speed*s*1e3;e.push(this._showPattern(s,t))}return this.pathSectionObject._mesh.visible=!0,this.center&&e.push(this.cameraManager.centerOn(this.pathSectionObject)),this.pathSectionObject.animations.push(this),Promise.all(e).then(()=>{})}stop(){this.tweens.forEach(e=>{e.stop()})}_showPattern(e,t){return new Promise((s,i)=>{const n=this.pathSectionObject._mesh.children[e];n.traverse(e=>{e.material&&(e.material.opacity=0,e.material.transparent=!0)});const o=new Tween({opacity:0}).to({opacity:1},1e3).delay(t).easing(Easing.Exponential.In).on("complete",()=>{n.traverse(e=>{e.material&&(e.material.opacity=1)}),s(!0)}).on("stop",()=>{i(new Error("Path was stopped"))}).start();this.tweens.push(o)})}}class AdsumLocation{constructor(e=null,t=null,s=null){this.isLocation=!0,this.id=e,this.pathNode=t,this.adsumObject=s}updateFromObjectPosition(e){PathNode.updateFromAdsumObject(this.pathNode,this.adsumObject,e)}}class LocationRepository{constructor(){this.locations=new Map,this.locationsByAdsumObject=new Map,this.projector=null,this.objectManager=null,this.pathNetwork=null,this.userLocation=null}init(e,t,s){this.projector=e,this.objectManager=s,this.pathNetwork=t,s.labels.forEach(e=>{if(e.parent.isBuilding||e.parent.isSpace)return;const t=new AdsumLocation(e.placeId,PathNode.createFromAdsumObject(null,e,this.projector),e);this.locations.set(t.id,t),this.locationsByAdsumObject.set(e,t),this.pathNetwork.attachNodeLocation(t)}),s.spaces.forEach(e=>{const t=new AdsumLocation(e.placeId,PathNode.createFromAdsumObject(null,e,this.projector),e);this.locations.set(t.id,t),this.locationsByAdsumObject.set(e,t),this.pathNetwork.attachNodeLocation(t)}),s.buildings.forEach(e=>{const t=new AdsumLocation(e.placeId,PathNode.createFromAdsumObject(null,e,this.projector),e);this.locations.set(t.id,t),this.locationsByAdsumObject.set(e,t),this.pathNetwork.attachNodeLocation(t)})}createUserLocation(){if(null!==this.userLocation)throw new Error("Unexpected");this.userLocation=new AdsumLocation(Symbol("UserLocation"),PathNode.createFromAdsumObject(Symbol("UserPathNode"),this.objectManager.user,this.projector),this.objectManager.user),this.userLocation.pathNode.isDynamic=!0,this.locations.set(this.userLocation.id,this.userLocation)}get(e){return this.locations.has(e)?this.locations.get(e):null}getByAdsumObject(e){return this.locationsByAdsumObject.has(e)?this.locationsByAdsumObject.get(e):null}}const WayfindingEvents={user:{position:{didChanged:"wayfinding.user.position.didChanged"}}};class WayfindingManager extends EventDispatcher{constructor(e,t){super(),this.awm=e,this.projector=null,this.locationRepository=new LocationRepository,this.pathNetwork=new PathNetwork(e),this.options=t}init(e){this.projector=e.projector,this.pathNetwork.init(e.paths),this.options.pathBuilder.init(this.projector,this.awm.objectManager),this.locationRepository.init(this.projector,this.pathNetwork,this.awm.objectManager)}computePath(e){return this.removePath(e),null===e.from&&(e.from=this.locationRepository.userLocation,null===e.from)?Promise.reject(new Error("AdsumWebMap.WayfindingManager: cannot compute path because user position is not set")):null===e.to&&(e.to=this.locationRepository.userLocation,null===e.to)?Promise.reject(new Error("AdsumWebMap.WayfindingManager: cannot compute path because user position is not set")):this.pathNetwork.computePath(e)}removePath(e){e.pathSections.forEach(e=>{this.removePathSection(e)})}drawPathSection(e){this.removePathSection(e);const t=this.options.pathBuilder.build(e);return new BasicDotPathSectionDrawer(t,this.awm.cameraManager,this.projector).draw()}removePathSection(e){this.awm.objectManager.pathSectionObjects.forEach(t=>{t.pathSection===e&&t._dispose()})}getUserUtmPosition(){const{userLocation:e}=this.locationRepository;return null===e?null:{utm:e.pathNode.utmPosition,floor:e.adsumObject.parent.isFloor?e.adsumObject.parent:null}}getUserGpsPosition(){if(null===this.locationRepository.userLocation)return null;const{utm:e,floor:t}=this.getUserUtmPosition();return{gps:this.projector.utmToGps(e),floor:t}}setUserAdsumPosition(e,t=null,s=!1){const{x:i,y:n,z:o}=e,a=null===t?this.awm.objectManager.site:t,r=this.awm.objectManager.user;return r._mesh.position.set(i,n,o),s&&a._mesh.worldToLocal(r._mesh.position),r._mesh.position.setZ(r._mesh.position.z+.1),a._addChild(r),r.parent=a,r.update(),null===this.locationRepository.userLocation?this.locationRepository.createUserLocation():this.locationRepository.userLocation.updateFromObjectPosition(this.projector),this.dispatchEvent({type:WayfindingEvents.user.position.didChanged,floor:t}),this}setUserGpsPosition(e,t=null){return this.setUserAdsumPosition(this.projector.gpsToAdsum(e),t,!0)}setUserUtmPosition(e,t=null){return this.setUserAdsumPosition(this.projector.utmToAdsum(e),t,!0)}getUserDistanceFromPath(e){return Math.min(...e.pathSections.map(e=>this.getUserDistanceFromPathSection(e)))}getUserDistanceFromPathSection(e){const{userLocation:t}=this.locationRepository;if(null===t)throw new Error("AdsumWebMap.WayfindingManager.getUserDistanceFromPathSection: no user position set");if(e.ground!==t.pathNode.ground)return 1/0;const s=new Vector3,i=new Line3,n=e.getCurve(),{groundPosition:o}=t.pathNode;let a=1/0;return null===n?e.nodes.length>0&&(a=o.distanceTo(e.nodes[0].groundPosition)):n.forEach(({from:e,to:t})=>{i.set(e,t),i.closestPointToPoint(o,!0,s);const n=o.distanceTo(s);n<a&&(a=n)}),this.projector.adsumDistanceToMeter(a)}}class EngineOptions extends AbstractOptions{reset(){super.reset(),this.container=null,this.gpuPower="high-performance",this.autoCompileMaterials=!0,this.clearColor=16777215,this.fogEnabled=!1,this.fogRatio=0,this.fogColor=16777215,this.backgroundImage=null,this.shadowEnabled=!1,this.shadowSize=2048}}class CameraOptions extends AbstractOptions{reset(){super.reset(),this.centerOnOptions=new CameraCenterOnOptions,this.force2D=!1,this.zoomEnabled=!0,this.rotationEnabled=!0,this.keepInFloorBounds=!1}}class PathSectionObject extends AdsumObject3D{static _createFromPathSection(e,t,s){const i=this._createFromMesh(t);return i.pathSection=e,i.patternSpace=s,i}constructor(){super(),this.isPathSection=!0,this.pathSection=null,this.patternSpace=null,this.animations=[]}getType(){return AdsumObjectTypes.PathSectionObject}_dispose(){this.animations.forEach(e=>{e.stop()}),this._mesh.traverse(e=>{e.material&&e.isMaterial&&e.material.dispose()}),null!==this._mesh.parent&&this._mesh.parent.remove(this._mesh)}}class DotPathBuilderOptions extends AbstractOptions{reset(){super.reset(),this.patternSpace=5,this.patternSize=1,this.patternMesh=null}}class DotPathBuilder{constructor(e={}){this.projector=null,this.objectManager=null,this.options=new DotPathBuilderOptions(e)}init(e,t){this.projector=e,this.objectManager=t}build(e){const t=new Group;t.visible=!1;const s=e.interpolate(this.options.patternSpace,this.projector);for(let e=0;e<s.length-1;e++){const i=s[e],n=s[e+1],o=this._createPattern();o.position.copy(i);const a=n.clone().sub(o.position);let r=0;r=0===a.y?a.x>0?Math.PI/2:-Math.PI/2:Math.atan(a.x/a.y),a.y<0&&(r+=Math.PI),o.setRotationFromAxisAngle(new Vector3(-0,-0,-1),r),t.add(o)}const i=PathSectionObject._createFromPathSection(e,t,this.options.patternSpace);return e.ground._addChild(i),i.update(),this.objectManager.pathSectionObjects.set(i.id,i),i}_createPattern(){null===this.options.patternMesh&&(this.options.patternMesh=this._createDefaultPattern());const e=this.options.patternMesh.clone();return e.traverse(e=>{e.material&&e.material.isMaterial&&(e.material=e.material.clone())}),e}_createDefaultPattern(){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=64,e.height=64;const s=.5*e.height,i=.65*e.width,n=(e.width-i)/2,o=(e.height-s)/2;t.arc(e.width/2,e.height/2,35,0,2*Math.PI),t.fillStyle="#0bbfba",t.fill(),t.beginPath(),t.moveTo(n,o+s),t.lineTo(n+i/2,o),t.lineTo(n+i,o+s),t.lineTo(n+i-10,o+s),t.lineTo(n+i/2,o+2*s*10/i),t.lineTo(n+10,o+s),t.closePath(),t.fillStyle="#ffffff",t.fill(),t.lineWidth=1,t.strokeStyle="#000000",t.stroke();const a=new CanvasTexture(e),r=new MeshBasicMaterial({color:16777215,map:a,side:FrontSide}),l=new PlaneGeometry(this.projector.meterToAdsumDistance(this.options.patternSize),this.projector.meterToAdsumDistance(this.options.patternSize));return new Mesh(l,r)}}class WayfindingOptions extends AbstractOptions{reset(){super.reset(),this.pathBuilder=new DotPathBuilder}}class Options extends AbstractOptions{reset(){super.reset(),this.engine=new EngineOptions,this.camera=new CameraOptions,this.wayfinding=new WayfindingOptions,this.loader=null}}class AdsumWebMap{constructor(e){const t=new Options(e);this.objectManager=new ObjectManager,this.sceneManager=new SceneManager(this),this.engineManager=new EngineManager(this,t.engine),this.cameraManager=new CameraManager(this,t.camera),this.mouseManager=new MouseManager(this),this.wayfindingManager=new WayfindingManager(this,t.wayfinding),this.deviceId=null,this.defaultFloor=null,this.loader=t.loader}init(e=null){return null!==e&&(this.loader=e),this.loader.load().then(e=>(this.projector=e.projector,this.objectManager.init(e,this.projector),this.sceneManager.init(e),this.cameraManager.init(this.projector),this.engineManager.init(e),this.mouseManager.init(),this.wayfindingManager.init(e),this.setDeviceId(e.deviceId,!1)))}start(){this.engineManager.start()}getDeviceId(){return this.deviceId}setDeviceId(e,t=!0){return this.deviceId=e,this.defaultFloor=null,this.loader.loadCalibration(this.deviceId).then(({cameraCalibrations:e,defaultFloorId:s,userPosition:i})=>(null!==i&&(null===i.floorId?this.wayfindingManager.setUserAdsumPosition(i.position,null,!0):this.wayfindingManager.setUserAdsumPosition(i.position,this.objectManager.getFloor(i.floorId),!0)),this.cameraManager.setCameraCalibrations(e),null!==s&&(this.defaultFloor=this.objectManager.getFloor(s)),this.sceneManager.setCurrentFloor(this.defaultFloor,t))).then(()=>this.cameraManager.centerOnFloor(this.defaultFloor,t)).then(()=>{})}}class AdsumLoaderOptions extends AbstractOptions{reset(){super.reset(),this.entityManager=null,this.shadowEnabled=!1,this.shadowMapSize=2048,this.fogEnabled=!1,this.fogRatio=0,this.fogColor=16777215,this.preferAmbientOcclusion=!0,this.shapeAmbientOcclusionTopColor=16777215,this.shapeAmbientOcclusionBottomColor=8421504,this.deviceId=null}preferLambertMaterial(){return!1}advancedLightingEnabled(){return!0}}class AdsumTextureLoader{constructor(e,t){this.texturesByReference=new Map;const s=[FILE_CONTEXTS.TEXTURE];t&&s.push(FILE_CONTEXTS.TEXTURE_OCCLUSION),e.findBy({context:e=>s.includes(e)}).forEach(e=>{this.texturesByReference.set(e.reference,e)}),this.threeLoader=new TextureLoader,this.regex=/\/texture\/reference\/(?:[a-f0-9]{2,3}\/)*(.*)$/}load(e,t,s,i){const n=this.regex.exec(e);let o=e;if(null!==n){const e=n[1];this.texturesByReference.has(e)&&({uri:o}=this.texturesByReference.get(e))}return this.threeLoader.load(o,t,s,i)}}const THREE$1={Group:Group,Matrix4:Matrix4,Vector3:Vector3,Quaternion:Quaternion,Vector4:Vector4,Math:Math$1,Object3D:Object3D,DoubleSide:DoubleSide,MeshLambertMaterial:MeshLambertMaterial,MeshBasicMaterial:MeshBasicMaterial,MeshPhongMaterial:MeshPhongMaterial,FrontSide:FrontSide,MultiMaterial:MultiMaterial,SkinnedMesh:SkinnedMesh,Mesh:Mesh,Line:Line,PerspectiveCamera:PerspectiveCamera,DirectionalLight:DirectionalLight,PointLight:PointLight,SpotLight:SpotLight,AmbientLight:AmbientLight,Geometry:Geometry,Vector2:Vector2,Color:Color,Face3:Face3,Loader:Loader,Texture:Texture,MirroredRepeatWrapping:MirroredRepeatWrapping,RepeatWrapping:RepeatWrapping,ClampToEdgeWrapping:ClampToEdgeWrapping,MixOperation:MixOperation,ImageLoader:ImageLoader,Scene:Scene};function AdsumColladaLoader(){let e,t,s=null,i=null,n=null;const o={};let a,r,l,c,h,d,u,p={},m={},g={},f={},b={},y={},E={},w={};const M={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null};let _=1,T="Y",O=null;function v(o,v,A){if(s=(new DOMParser).parseFromString(o,"text/xml"),v=v||n,void 0!==A){const e=A.split("/");e.pop(),h=`${e.length<1?".":e.join("/")}/`}!function(){const e=s.querySelectorAll("asset")[0];if(e&&e.childNodes)for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];switch(i.nodeName){case"unit":var t=i.getAttribute("meter");t&&(_=parseFloat(t));break;case"up_axis":T=i.textContent.charAt(0)}}}(),function(){if(!0!==M.convertUpAxis||T===M.upAxis)O=null;else switch(T){case"X":O="Y"===M.upAxis?"XtoY":"XtoZ";break;case"Y":O="X"===M.upAxis?"YtoX":"YtoZ";break;case"Z":O="X"===M.upAxis?"ZtoX":"ZtoY"}}(),p=x("library_images image",I,"image"),b=x("library_materials material",se,"material"),y=x("library_effects effect",re,"effect"),f=x("library_geometries geometry",W,"geometry"),E=x("library_cameras camera",pe,"camera"),w=x("library_lights light",ge,"light"),g=x("library_controllers controller",D,"controller"),m=x("library_animations animation",ce,"animation"),l=x("library_visual_scenes visual_scene",F,"visual_scene"),c=x("library_kinematics_models kinematics_model",be,"kinematics_model"),d=[],u=[],e=function(){const e=s.querySelectorAll("scene instance_visual_scene")[0];if(e){const t=e.getAttribute("url").replace(/^#/,"");return l[t.length>0?t:"visual_scene0"]}return null}(),i=new THREE$1.Scene;for(let t=0;t<e.nodes.length;t++)i.add(j(e.nodes[t]));i.scale.multiplyScalar(_),a=[],function t(s){let i=e.getChildById(s.colladaId,!0),n=null;if(i&&i.keys){n={fps:60,hierarchy:[{node:i,keys:i.keys,sids:i.sids}],node:s,name:`animation_${s.name}`,length:0},a.push(n);for(var o=0,r=i.keys.length;o<r;o++)n.length=Math.max(n.length,i.keys[o].time)}else n={hierarchy:[{keys:[],sids:[]}]};for(var o=0,r=s.children.length;o<r;o++){const e=t(s.children[o]);for(let t=0,s=e.hierarchy.length;t<s;t++)n.hierarchy.push({keys:[],sids:[]})}return n}(i),t=function(){const e=s.querySelectorAll("instance_kinematics_model")[0];if(e){const t=e.getAttribute("url").replace(/^#/,"");return c[t.length>0?t:"kinematics_model0"]}return null}(),function(){if(t&&0===t.joints.length)return void(r=void 0);const n={},o=function(s,o){const a=o.getAttribute("id"),r=e.getChildById(a,!0),l=t.joints[s];i.traverse(e=>{e.colladaId==a&&(n[s]={node:e,transforms:r.transforms,joint:l,position:l.zeroPosition})})};r={joints:t&&t.joints,getJointValue(e){const t=n[e];if(t)return t.position;console.log(`getJointValue: joint ${e} doesn't exist`)},setJointValue(e,t){const s=n[e];if(s){const i=s.joint;if(t>i.limits.max||t<i.limits.min)console.log(`setJointValue: joint ${e} value ${t} outside of limits (min: ${i.limits.min}, max: ${i.limits.max})`);else if(i.static)console.log(`setJointValue: joint ${e} is static`);else{const o=s.node,a=i.axis,r=s.transforms,c=new THREE$1.Matrix4,h=new THREE$1.Matrix4;for(l=0;l<r.length;l++){const s=r[l];if(s.sid&&-1!==s.sid.indexOf(`joint${e}`))switch(i.type){case"revolute":c.multiply(h.makeRotationAxis(a,THREE$1.Math.degToRad(t)));break;case"prismatic":c.multiply(h.makeTranslation(a.x*t,a.y*t,a.z*t));break;default:console.warn(`setJointValue: unknown joint type: ${i.type}`)}else switch(s.type){case"matrix":c.multiply(s.obj);break;case"translate":c.multiply(h.makeTranslation(s.obj.x,s.obj.y,s.obj.z));break;case"rotate":c.multiply(h.makeRotationAxis(s.obj,s.angle))}}const d=c.elements,u=Array.prototype.slice.call(d),p=[u[0],u[4],u[8],u[12],u[1],u[5],u[9],u[13],u[2],u[6],u[10],u[14],u[3],u[7],u[11],u[15]];o.matrix.set.apply(o.matrix,p),o.matrix.decompose(o.position,o.quaternion,o.scale),n[e].position=t}}else console.log(`setJointValue: joint ${e} doesn't exist`)}};const a=s.querySelector("scene instance_kinematics_scene");if(a)for(var l=0;l<a.childNodes.length;l++){const e=a.childNodes[l];if(1==e.nodeType)switch(e.nodeName){case"bind_joint_axis":var c=e.getAttribute("target").split("/").pop(),h=e.querySelector("axis param").textContent,d=parseInt(h.split("joint").pop().split(".")[0]),u=s.querySelector(`[sid="${c}"]`);if(u){const e=u.parentElement;o(d,e)}}}}();const S={scene:i,morphs:d,skins:u,animations:a,kinematics:r,dae:{images:p,materials:b,cameras:E,lights:w,effects:y,geometries:f,controllers:g,animations:m,visualScenes:l,visualScene:e,scene:e,kinematicsModels:c,kinematicsModel:t}};return v&&v(S),S}function x(e,t,i){const n=s.querySelectorAll(e),o={};let a=0;const r=n.length;for(let e=0;e<r;e++){const s=n[e],r=(new t).parse(s);r.id&&0!==r.id.length||(r.id=i+a++),o[r.id]=r}return o}function A(e,t){const s=t instanceof z?g[t.url]:t;if(!s||!s.morph)return void console.log("could not find morph controller!");const i=s.morph;for(let t=0;t<i.targets.length;t++){const s=i.targets[t],n=f[s];if(!n.mesh||!n.mesh.primitives||!n.mesh.primitives.length)continue;const o=n.mesh.primitives[0].geometry;o.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:o.vertices})}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function S(e,t,s,i){if(e.world=e.world||new THREE$1.Matrix4,e.localworld=e.localworld||new THREE$1.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){const t=e.channels[0].sampler.output[s];t instanceof THREE$1.Matrix4&&(e.world.copy(t),e.localworld.copy(t),0===s&&e.matrix.copy(t))}i&&e.world.multiplyMatrices(i,e.world),t.push(e);for(let i=0;i<e.nodes.length;i++)S(e.nodes[i],t,s,e.world)}function N(e,t){for(let i=0;i<e.length;i++){const n=e[i];let o=-1;if("JOINT"==n.type){for(var s=0;s<t.joints.length;s++)if(n.sid===t.joints[s]){o=s;break}if(o>=0){const e=t.invBindMatrices[o];n.invBindMatrix=e,n.skinningMatrix=new THREE$1.Matrix4,n.skinningMatrix.multiplyMatrices(n.world,e),n.animatrix=new THREE$1.Matrix4,n.animatrix.copy(n.localworld),n.weights=[];for(s=0;s<t.weights.length;s++)for(let e=0;e<t.weights[s].length;e++){const i=t.weights[s][e];i.joint===o&&n.weights.push(i)}}else console.warn(`ColladaLoader: Could not find joint '${n.sid}'.`),n.skinningMatrix=new THREE$1.Matrix4,n.weights=[]}}}function L(t,s,i){void 0===i&&(i=40);const n=g[s.url];if(!n||!n.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!s.skeleton||!s.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");const o=function(){let e,t=1e6,s=-t,i=0;for(const n in m){const o=m[n];e=e||o.id;for(let e=0;e<o.sampler.length;e++){const n=o.sampler[e];n.create(),t=Math.min(t,n.startTime),s=Math.max(s,n.endTime),i=Math.max(i,n.input.length)}}return{start:t,end:s,frames:i,ID:e}}(),a=e.getChildById(s.skeleton[0],!0)||e.getChildBySid(s.skeleton[0],!0),r=function(e){const t=[];var s=function(e,t,i){const n={};n.name=t.sid,n.parent=e,n.matrix=t.matrix;const o=[new THREE$1.Vector3,new THREE$1.Quaternion,new THREE$1.Vector3];n.matrix.decompose(o[0],o[1],o[2]),n.pos=[o[0].x,o[0].y,o[0].z],n.scl=[o[2].x,o[2].y,o[2].z],n.rotq=[o[1].x,o[1].y,o[1].z,o[1].w],i.push(n);for(const e in t.nodes)s(t.sid,t.nodes[e],i)};return s(-1,e,t),t}(a),l=n.skin.joints,c=[];for(var h=0;h<l.length;h++)for(var d=0;d<r.length;d++)r[d].name===l[h]&&(c[h]=r[d]);for(h=0;h<c.length;h++)for(d=0;d<c.length;d++)c[h].parent===c[d].name&&(c[h].parent=d);new THREE$1.Vector3;for(h=0;h<t.vertices.length;h++)t.vertices[h].applyMatrix4(n.skin.bindShapeMatrix);const u=[],p=[],f=n.skin.weights;for(h=0;h<f.length;h++){const e=new THREE$1.Vector4(f[h][0]?f[h][0].joint:0,f[h][1]?f[h][1].joint:0,f[h][2]?f[h][2].joint:0,f[h][3]?f[h][3].joint:0);var b=new THREE$1.Vector4(f[h][0]?f[h][0].weight:0,f[h][1]?f[h][1].weight:0,f[h][2]?f[h][2].weight:0,f[h][3]?f[h][3].weight:0);u.push(e),p.push(b)}t.skinIndices=u,t.skinWeights=p,t.bones=c;const y={name:o.ID,fps:30,length:o.frames/30,hierarchy:[]};for(d=0;d<c.length;d++)y.hierarchy.push({parent:c[d].parent,name:c[d].name,keys:[]});for(console.log("ColladaLoader:",`${o.ID} has ${c.length} bones.`),function(e,t,s){const i=[];S(t,i,-1),N(i,s.skin);const n=new THREE$1.Vector3,o=[];for(var a=0;a<e.vertices.length;a++)o.push(new THREE$1.Vector3);for(a=0;a<i.length;a++)if("JOINT"==i[a].type)for(let t=0;t<i[a].weights.length;t++){const s=i[a].weights[t],r=s.index,l=s.weight,c=e.vertices[r],h=o[r];n.x=c.x,n.y=c.y,n.z=c.z,n.applyMatrix4(i[a].skinningMatrix),h.x+=n.x*l,h.y+=n.y*l,h.z+=n.z*l}for(a=0;a<e.vertices.length;a++)e.vertices[a]=o[a]}(t,a,n),i=0;i<o.frames;i++){const e=[];S(a,e,i),N(e,n.skin);for(h=0;h<e.length;h++)for(d=0;d<y.hierarchy.length;d++)if(y.hierarchy[d].name===e[h].sid){const t={};t.time=i/30,t.matrix=e[h].animatrix,0===i&&(e[h].matrix=t.matrix);const s=[new THREE$1.Vector3,new THREE$1.Quaternion,new THREE$1.Vector3];t.matrix.decompose(s[0],s[1],s[2]),t.pos=[s[0].x,s[0].y,s[0].z],t.scl=[s[2].x,s[2].y,s[2].z],t.rot=s[1],y.hierarchy[d].keys.push(t)}t.animation=y}}function j(e,t){const s=new THREE$1.Object3D;let i,n,o,a;for(o=0;o<e.controllers.length;o++){const t=g[e.controllers[o].url];switch(t.type){case"skin":if(f[t.skin.source])(r=new G).url=t.skin.source,r.instance_material=e.controllers[o].instance_material,e.geometries.push(r),i=e.controllers[o];else if(g[t.skin.source]){const s=g[t.skin.source];if(n=s,s.morph&&f[s.morph.source])(r=new G).url=s.morph.source,r.instance_material=e.controllers[o].instance_material,e.geometries.push(r)}break;case"morph":var r;if(f[t.morph.source])(r=new G).url=t.morph.source,r.instance_material=e.controllers[o].instance_material,e.geometries.push(r),n=e.controllers[o];console.log("ColladaLoader: Morph-controller partially supported.")}}const l={};for(o=0;o<e.geometries.length;o++){const t=e.geometries[o],r=t.instance_material,p=f[t.url],m={},g=[];let E=0;var c;if(p){if(!p.mesh||!p.mesh.primitives)continue;if(0===s.name.length&&(s.name=p.id),r)for(a=0;a<r.length;a++){const e=r[a],t=b[e.target],s=t.instance_effect.url;let i=y[s].shader.material;if(p.doubleSided){if(!(e.symbol in l)){const t=i.clone();t.side=THREE$1.DoubleSide,l[e.symbol]=t}i=l[e.symbol]}i.opacity=i.opacity?i.opacity:1,m[e.symbol]=E,g.push(i),(c=i).name=null===t.name||""===t.name?t.id:t.name,E++}var h;let e=c||new THREE$1.MeshLambertMaterial({color:14540253,side:p.doubleSided?THREE$1.DoubleSide:THREE$1.FrontSide});const t=p.mesh.geometry3js;if(E>1)for(e=new THREE$1.MultiMaterial(g),a=0;a<t.faces.length;a++){const e=t.faces[a];e.materialIndex=m[e.daeMaterial]}void 0!==i?(L(t,i),t.morphTargets.length>0?(e.morphTargets=!0,e.skinning=!1):(e.morphTargets=!1,e.skinning=!0),(h=new THREE$1.SkinnedMesh(t,e,!1)).name=`skin_${u.length}`,u.push(h)):void 0!==n?(A(t,n),e.morphTargets=!0,(h=new THREE$1.Mesh(t,e)).name=`morph_${d.length}`,d.push(h)):h=!0===t.isLineStrip?new THREE$1.Line(t):new THREE$1.Mesh(t,e),s.add(h)}}for(o=0;o<e.cameras.length;o++){const t=e.cameras[o],i=E[t.url],n=new THREE$1.PerspectiveCamera(i.yfov,parseFloat(i.aspect_ratio),parseFloat(i.znear),parseFloat(i.zfar));s.add(n)}for(o=0;o<e.lights.length;o++){let t=null;const i=e.lights[o],n=w[i.url];if(n&&n.technique){const e=n.color.getHex(),s=n.intensity,i=n.distance,o=n.falloff_angle;switch(n.technique){case"directional":(t=new THREE$1.DirectionalLight(e,s,i)).position.set(0,0,1);break;case"point":t=new THREE$1.PointLight(e,s,i);break;case"spot":(t=new THREE$1.SpotLight(e,s,i,o)).position.set(0,0,1);break;case"ambient":t=new THREE$1.AmbientLight(e)}}t&&s.add(t)}if(s.name=e.name||e.id||"",s.colladaId=e.id||"",s.layer=e.layer||"",s.matrix=e.matrix,s.matrix.decompose(s.position,s.quaternion,s.scale),M.centerGeometry&&s.geometry){const e=new THREE$1.Vector3;object.geometry.computeBoundingBox(),object.geometry.boundingBox.getCenter(e),s.geometry.center(),e.multiply(s.scale),e.applyQuaternion(s.quaternion),s.position.add(e)}for(o=0;o<e.nodes.length;o++)s.add(j(e.nodes[o],e));return s}function C(e){const t=s.querySelectorAll("library_nodes node");for(let s=0;s<t.length;s++){const i=t[s].attributes.getNamedItem("id");if(i&&i.value===e)return t[s]}}function P(e,t){let s=null;for(let i=0,n=e.length;i<n&&null===s;i++){const n=e[i];if(n.time===t)s=n;else if(n.time>t)break}return s}function R(e,t){let s=-1;for(let i=0,n=e.length;i<n&&-1===s;i++){e[i].time>=t&&(s=i)}return s}function k(e,t,s,i){let n=function(e,t,s){for(s=s>=0?s:s+e.length;s>=0;s--){const i=e[s];if(i.hasTarget(t))return i}return null}(e,i,s?s-1:0),o=function(e,t,s){for(;s<e.length;s++){const i=e[s];if(i.hasTarget(t))return i}return null}(e,i,s+1);if(n&&o){let e,s=(t.time-n.time)/(o.time-n.time),a=n.getTarget(i),r=o.getTarget(i).data,l=a.data;if("matrix"===a.type)e=l;else if(l.length){e=[];for(let t=0;t<l.length;++t)e[t]=l[t]+(r[t]-l[t])*s}else e=l+(r-l)*s;t.addTarget(i,a.transform,a.member,e)}}function I(){this.id="",this.init_from=""}function D(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function B(){this.method=null,this.source=null,this.targets=null,this.weights=null}function H(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function F(){this.id="",this.name="",this.nodes=[],this.scene=new THREE$1.Group}function U(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE$1.Matrix4}function $(){this.sid="",this.type="",this.data=[],this.obj=null}function z(){this.url="",this.skeleton=[],this.instance_material=[]}function V(){this.symbol="",this.target=""}function G(){this.url="",this.instance_material=[]}function W(){this.id="",this.mesh=null}function Y(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function Z(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE$1.Geometry}function X(){Z.call(this),this.vcount=[]}function q(){Z.call(this),this.vcount=1}function J(){Z.call(this),this.vcount=3}function K(){this.source="",this.count=0,this.stride=0,this.params=[]}function Q(){this.input={}}function ee(){this.semantic="",this.offset=0,this.source="",this.set=0}function te(e){this.id=e,this.type=null}function se(){this.id="",this.name="",this.instance_effect=null}function ie(){this.color=new THREE$1.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function ne(e,t){this.type=e,this.effect=t,this.material=null}function oe(e){this.effect=e,this.init_from=null,this.format=null}function ae(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function re(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function le(){this.url=""}function ce(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function he(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function de(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ue(e){this.targets=[],this.time=e}function pe(){this.id="",this.name="",this.technique=""}function me(){this.url=""}function ge(){this.id="",this.name="",this.technique=""}function fe(){this.url=""}function be(){this.id="",this.name="",this.joints=[],this.links=[]}function ye(){this.sid="",this.name="",this.axis=new THREE$1.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function Ee(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function we(){this.joint="",this.transforms=[],this.links=[]}function Me(e){const t=e.getAttribute("id");return void 0!=o[t]?o[t]:(o[t]=new te(t).parse(e),o[t])}function _e(e){const t=ve(e),s=[];for(let e=0,i=t.length;e<i;e++)s.push(!("true"!==t[e]&&"1"!==t[e]));return s}function Te(e){const t=ve(e),s=[];for(let e=0,i=t.length;e<i;e++)s.push(parseFloat(t[e]));return s}function Oe(e){const t=ve(e),s=[];for(let e=0,i=t.length;e<i;e++)s.push(parseInt(t[e],10));return s}function ve(e){return e.length>0?function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}(e).split(/\s+/):[]}function xe(e,t,s){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):s}function Ae(e,t){(new THREE$1.ImageLoader).load(t,t=>{e.image=t,e.needsUpdate=!0})}function Se(e,t){e.doubleSided=!1;const s=t.querySelectorAll("extra double_sided")[0];s&&s&&1===parseInt(s.textContent,10)&&(e.doubleSided=!0)}function Ne(e,t){if(!0===M.convertUpAxis&&T!==M.upAxis)switch(O){case"XtoY":var s=e[0];e[0]=t*e[1],e[1]=s;break;case"XtoZ":s=e[2];e[2]=e[1],e[1]=e[0],e[0]=s;break;case"YtoX":s=e[0];e[0]=e[1],e[1]=t*s;break;case"YtoZ":s=e[1];e[1]=t*e[2],e[2]=s;break;case"ZtoX":s=e[0];e[0]=e[1],e[1]=e[2],e[2]=s;break;case"ZtoY":s=e[1];e[1]=e[2],e[2]=t*s}}function Le(e,t){const s=[e[t],e[t+1],e[t+2]];return Ne(s,-1),new THREE$1.Vector3(s[0],s[1],s[2])}function je(e){if(M.convertUpAxis){let t=[e[0],e[4],e[8]];Ne(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],Ne(t=[e[1],e[5],e[9]],-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],Ne(t=[e[2],e[6],e[10]],-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],Ne(t=[e[0],e[1],e[2]],-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],Ne(t=[e[4],e[5],e[6]],-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],Ne(t=[e[8],e[9],e[10]],-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],Ne(t=[e[3],e[7],e[11]],-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE$1.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function Ce(e){if(e>-1&&e<3){e={X:0,Y:1,Z:2}[e=Pe(["X","Y","Z"][e])]}return e}function Pe(e){if(M.convertUpAxis)switch(e){case"X":switch(O){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(O){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(O){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}return I.prototype.parse=function(e){this.id=e.getAttribute("id");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];"init_from"===s.nodeName&&(this.init_from=s.textContent)}return this},D.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"skin":this.skin=(new H).parse(s),this.type=s.nodeName;break;case"morph":this.morph=(new B).parse(s),this.type=s.nodeName}}return this},B.prototype.parse=function(e){const t={};let s,i=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),s=0;s<e.childNodes.length;s++){const o=e.childNodes[s];if(1==o.nodeType)switch(o.nodeName){case"source":t[(n=(new te).parse(o)).id]=n;break;case"targets":i=this.parseInputs(o);break;default:console.log(o.nodeName)}}for(s=0;s<i.length;s++){const e=i[s];var n=t[e.source];switch(e.semantic){case"MORPH_TARGET":this.targets=n.read();break;case"MORPH_WEIGHT":this.weights=n.read()}}return this},B.prototype.parseInputs=function(e){const t=[];for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"input":t.push((new ee).parse(i))}}return t},H.prototype.parse=function(e){const t={};let s,i;this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(let a=0;a<e.childNodes.length;a++){const r=e.childNodes[a];if(1==r.nodeType)switch(r.nodeName){case"bind_shape_matrix":var n=Te(r.textContent);this.bindShapeMatrix=je(n);break;case"source":var o=(new te).parse(r);t[o.id]=o;break;case"joints":s=r;break;case"vertex_weights":i=r;break;default:console.log(r.nodeName)}}return this.parseJoints(s,t),this.parseWeights(i,t),this},H.prototype.parseJoints=function(e,t){for(let n=0;n<e.childNodes.length;n++){const o=e.childNodes[n];if(1==o.nodeType)switch(o.nodeName){case"input":var s=(new ee).parse(o),i=t[s.source];"JOINT"===s.semantic?this.joints=i.read():"INV_BIND_MATRIX"===s.semantic&&(this.invBindMatrices=i.read())}}},H.prototype.parseWeights=function(e,t){let s,i,n=[];for(var o=0;o<e.childNodes.length;o++){const t=e.childNodes[o];if(1==t.nodeType)switch(t.nodeName){case"input":n.push((new ee).parse(t));break;case"v":s=Oe(t.textContent);break;case"vcount":i=Oe(t.textContent)}}let a=0;for(o=0;o<i.length;o++){const e=i[o],l=[];for(var r=0;r<e;r++){const e={};for(let i=0;i<n.length;i++){const o=n[i],r=s[a+o.offset];switch(o.semantic){case"JOINT":e.joint=r;break;case"WEIGHT":e.weight=t[o.source].data[r]}}l.push(e),a+=n.length}for(r=0;r<l.length;r++)l[r].index=o;this.weights.push(l)}},F.prototype.getChildById=function(e,t){for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildById(e,t);if(i)return i}return null},F.prototype.getChildBySid=function(e,t){for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildBySid(e,t);if(i)return i}return null},F.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"node":this.nodes.push((new U).parse(s))}}return this},U.prototype.getChannelForTransform=function(e){for(let s=0;s<this.channels.length;s++){const i=this.channels[s];let n=i.target.split("/");n.shift();let o=n.shift();const a=o.indexOf(".")>=0,r=o.indexOf("(")>=0;var t;if(a)o=(n=o.split(".")).shift();else if(r){o=(t=o.split("(")).shift();for(let e=0;e<t.length;e++)t[e]=parseInt(t[e].replace(/\)/,""))}if(o===e)return i.info={sid:o,dotSyntax:a,arrSyntax:r,arrIndices:t},i}return null},U.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildById(e,t);if(i)return i}return null},U.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildBySid(e,t);if(i)return i}return null},U.prototype.getTransformBySid=function(e){for(let t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},U.prototype.parse=function(e){let t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE$1.Matrix4;for(let i=0;i<e.childNodes.length;i++){const n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"node":this.nodes.push((new U).parse(n));break;case"instance_camera":this.cameras.push((new me).parse(n));break;case"instance_controller":this.controllers.push((new z).parse(n));break;case"instance_geometry":this.geometries.push((new G).parse(n));break;case"instance_light":this.lights.push((new fe).parse(n));break;case"instance_node":var s=C(t=n.getAttribute("url").replace(/^#/,""));s&&this.nodes.push((new U).parse(s));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new $).parse(n));break;case"extra":break;default:console.log(n.nodeName)}}return this.channels=function(e){const t=[];let s=1e6,i=-1e6;for(var n in m){const o=m[n];for(let a=0;a<o.channel.length;a++){const r=o.channel[a],l=o.sampler[a];(n=r.target.split("/")[0])==e.id&&(l.create(),r.sampler=l,s=Math.min(s,l.startTime),i=Math.max(i,l.endTime),t.push(r))}}return t.length&&(e.startTime=s,e.endTime=i),t}(this),function(e){if(e.channels&&e.channels.length){let m=[],g=[];for(var t=0,s=e.channels.length;t<s;t++){var i,n=e.channels[t],o=n.fullSid,a=n.sampler,r=a.input,l=e.getTransformBySid(n.sid);if(n.arrIndices){i=[];for(var c=0,h=n.arrIndices.length;c<h;c++)i[c]=Ce(n.arrIndices[c])}else i=Pe(n.member);if(l)for(-1===g.indexOf(o)&&g.push(o),c=0,h=r.length;c<h;c++){var d=r[c],u=a.getData(l.type,c,i);if(!(p=P(m,d))){p=new ue(d);const e=R(m,d);m.splice(-1===e?m.length:e,0,p)}p.addTarget(o,l,i,u)}else console.log(`Could not find transform "${n.sid}" in node ${e.id}`)}for(t=0;t<g.length;t++){const e=g[t];for(c=0;c<m.length;c++){var p;(p=m[c]).hasTarget(e)||k(m,p,c,e)}}e.keys=m,e.sids=g}}(this),this.updateMatrix(),this},U.prototype.updateMatrix=function(){this.matrix.identity();for(let e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},$.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=Te(e.textContent),this.convert(),this},$.prototype.convert=function(){switch(this.type){case"matrix":this.obj=je(this.data);break;case"rotate":this.angle=THREE$1.Math.degToRad(this.data[3]);case"translate":Ne(this.data,-1),this.obj=new THREE$1.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":Ne(this.data,1),this.obj=new THREE$1.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log(`Can not convert Transform of type ${this.type}`)}},$.prototype.apply=function(){const e=new THREE$1.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),$.prototype.update=function(e,t){const s=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){const s=`n${t[0]+1}${t[1]+1}`;this.obj[s]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=s[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=s[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE$1.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE$1.Math.degToRad(e[3])}}},z.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":var t=i.querySelectorAll("instance_material");for(let e=0;e<t.length;e++){const s=t[e];this.instance_material.push((new V).parse(s))}}}return this},V.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},G.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType&&"bind_material"===s.nodeName){const e=s.querySelectorAll("instance_material");for(let t=0;t<e.length;t++){const s=e[t];this.instance_material.push((new V).parse(s))}break}}return this},W.prototype.parse=function(e){this.id=e.getAttribute("id"),Se(this,e);for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"mesh":this.mesh=new Y(this).parse(s)}}return this},Y.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"source":Me(s);break;case"vertices":this.vertices=(new Q).parse(s);break;case"linestrips":this.primitives.push((new q).parse(s));break;case"triangles":this.primitives.push((new J).parse(s));break;case"polygons":this.primitives.push((new Z).parse(s));break;case"polylist":this.primitives.push((new X).parse(s))}}if(this.geometry3js=new THREE$1.Geometry,null===this.vertices)return this;const s=o[this.vertices.input.POSITION.source].data;for(t=0;t<s.length;t+=3)this.geometry3js.vertices.push(Le(s,t).clone());for(t=0;t<this.primitives.length;t++){const e=this.primitives[t];e.setVertices(this.vertices),this.handlePrimitive(e,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},Y.prototype.handlePrimitive=function(e,t){if(e instanceof q)return void(t.isLineStrip=!0);let s,i,n,a,r,l,c,h,d=e.p,u=e.inputs,p=0,m=0;const g=[];for(s=0;s<u.length;s++){const e=(n=u[s]).offset+1;switch(m=m<e?e:m,n.semantic){case"TEXCOORD":g.push(n.set)}}for(let O=0;O<d.length;++O){let v=d[O],x=0;for(;x<v.length;){const d=[],O=[];let A=null;const S=[];for(h=e.vcount?e.vcount.length?e.vcount[p++]:e.vcount:v.length/m,s=0;s<h;s++)for(i=0;i<u.length;i++)switch(n=u[i],l=o[n.source],r=(a=v[x+s*m+n.offset])*(c=l.accessor.params.length),n.semantic){case"VERTEX":d.push(a);break;case"NORMAL":O.push(Le(l.data,r));break;case"TEXCOORD":void 0===(A=A||{})[n.set]&&(A[n.set]=[]),A[n.set].push(new THREE$1.Vector2(l.data[r],l.data[r+1]));break;case"COLOR":S.push((new THREE$1.Color).setRGB(l.data[r],l.data[r+1],l.data[r+2]))}if(0===O.length)if(n=this.vertices.input.NORMAL){c=(l=o[n.source]).accessor.params.length;for(var f=0,b=d.length;f<b;f++)O.push(Le(l.data,d[f]*c))}else t.calcNormals=!0;if(!A&&(A={},n=this.vertices.input.TEXCOORD)){g.push(n.set),c=(l=o[n.source]).accessor.params.length;for(f=0,b=d.length;f<b;f++)r=d[f]*c,void 0===A[n.set]&&(A[n.set]=[]),A[n.set].push(new THREE$1.Vector2(l.data[r],1-l.data[r+1]))}if(0===S.length&&(n=this.vertices.input.COLOR)){c=(l=o[n.source]).accessor.params.length;for(f=0,b=d.length;f<b;f++)r=d[f]*c,S.push((new THREE$1.Color).setRGB(l.data[r],l.data[r+1],l.data[r+2]))}var y,E,w=null,_=[];if(3===h)_.push(new THREE$1.Face3(d[0],d[1],d[2],O,S.length?S:new THREE$1.Color));else if(4===h)_.push(new THREE$1.Face3(d[0],d[1],d[3],O.length?[O[0].clone(),O[1].clone(),O[3].clone()]:[],S.length?[S[0],S[1],S[3]]:new THREE$1.Color)),_.push(new THREE$1.Face3(d[1],d[2],d[3],O.length?[O[1].clone(),O[2].clone(),O[3].clone()]:[],S.length?[S[1],S[2],S[3]]:new THREE$1.Color));else if(h>4&&M.subdivideFaces){var T=S.length?S:new THREE$1.Color;for(i=1;i<h-1;)_.push(new THREE$1.Face3(d[0],d[i],d[i+1],O.length?[O[0].clone(),O[i++].clone(),O[i].clone()]:[],T))}if(_.length)for(f=0,b=_.length;f<b;f++)for((w=_[f]).daeMaterial=e.material,t.faces.push(w),i=0;i<g.length;i++)y=A[g[i]],E=h>4?[y[0],y[f+1],y[f+2]]:4===h?0===f?[y[0],y[1],y[3]]:[y[1].clone(),y[2],y[3].clone()]:[y[0],y[1],y[2]],void 0===t.faceVertexUvs[i]&&(t.faceVertexUvs[i]=[]),t.faceVertexUvs[i].push(E);else console.log(`dropped face with vcount ${h} for geometry with id: ${t.id}`);x+=m*h}}},Z.prototype.setVertices=function(e){for(let t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},Z.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=xe(e,"count",0);for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"input":this.inputs.push((new ee).parse(e.childNodes[t]));break;case"vcount":this.vcount=Oe(s.textContent);break;case"p":this.p.push(Oe(s.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},X.prototype=Object.create(Z.prototype),X.prototype.constructor=X,q.prototype=Object.create(Z.prototype),q.prototype.constructor=q,J.prototype=Object.create(Z.prototype),J.prototype.constructor=J,K.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=xe(e,"count",0),this.stride=xe(e,"stride",0);for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if("param"===s.nodeName){const e={};e.name=s.getAttribute("name"),e.type=s.getAttribute("type"),this.params.push(e)}}return this},Q.prototype.parse=function(e){this.id=e.getAttribute("id");for(let t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){const s=(new ee).parse(e.childNodes[t]);this.input[s.semantic]=s}return this},ee.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=xe(e,"set",-1),this.offset=xe(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},te.prototype.parse=function(e){this.id=e.getAttribute("id");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"bool_array":this.data=_e(s.textContent),this.type=s.nodeName;break;case"float_array":this.data=Te(s.textContent),this.type=s.nodeName;break;case"int_array":this.data=Oe(s.textContent),this.type=s.nodeName;break;case"IDREF_array":case"Name_array":this.data=ve(s.textContent),this.type=s.nodeName;break;case"technique_common":for(let e=0;e<s.childNodes.length;e++)if("accessor"===s.childNodes[e].nodeName){this.accessor=(new K).parse(s.childNodes[e]);break}}}return this},te.prototype.read=function(){const e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(let t=0;t<this.data.length;t+=16){const s=je(this.data.slice(t,t+16));e.push(s)}break;default:console.log(`ColladaLoader: Source: Read dont know how to read ${t.type}.`)}return e},se.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(let t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new le).parse(e.childNodes[t]);break}return this},ie.prototype.isColor=function(){return null===this.texture},ie.prototype.isTexture=function(){return null!=this.texture},ie.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"color":var t=Te(i.textContent);this.color=new THREE$1.Color,this.color.setRGB(t[0],t[1],t[2]),this.color.a=t[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},ie.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1]).childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]);for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[s.nodeName]=parseFloat(s.textContent);break;case"wrapU":case"wrapV":"TRUE"===s.textContent.toUpperCase()?this.texOpts[s.nodeName]=1:this.texOpts[s.nodeName]=parseInt(s.textContent);break;default:this.texOpts[s.nodeName]=s.textContent}}return this},ne.prototype.parse=function(e){for(let i=0;i<e.childNodes.length;i++){const n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":this[n.nodeName]=(new ie).parse(n);break;case"bump":var t=n.getAttribute("bumptype");t?"heightfield"===t.toLowerCase()?this.bump=(new ie).parse(n):"normalmap"===t.toLowerCase()?this.normal=(new ie).parse(n):(console.error(`Shader.prototype.parse: Invalid value for attribute 'bumptype' (${t}) - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'`),this.bump=(new ie).parse(n)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new ie).parse(n));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var s=n.querySelectorAll("float");s.length>0&&(this[n.nodeName]=parseFloat(s[0].textContent))}}return this.create(),this},ne.prototype.create=function(){const e={};let t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){const s=(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency;s>0&&(t=!0,e.transparent=!0,e.opacity=1-s)}const s={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(const o in this)switch(o){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var i=this[o];if(i instanceof ie)if(i.isTexture()){const t=i.texture,a=this.effect.sampler[t];if(void 0!==a&&void 0!==a.source){const t=this.effect.surface[a.source];if(void 0!==t){const r=p[t.init_from];if(r){const t=h+r.init_from;var n;const l=THREE$1.Loader.Handlers.get(t);null!==l?n=l.load(t):Ae(n=new THREE$1.Texture,t),"MIRROR"===a.wrap_s?n.wrapS=THREE$1.MirroredRepeatWrapping:"WRAP"===a.wrap_s||i.texOpts.wrapU?n.wrapS=THREE$1.RepeatWrapping:n.wrapS=THREE$1.ClampToEdgeWrapping,"MIRROR"===a.wrap_t?n.wrapT=THREE$1.MirroredRepeatWrapping:"WRAP"===a.wrap_t||i.texOpts.wrapV?n.wrapT=THREE$1.RepeatWrapping:n.wrapT=THREE$1.ClampToEdgeWrapping,n.offset.x=i.texOpts.offsetU,n.offset.y=i.texOpts.offsetV,n.repeat.x=i.texOpts.repeatU,n.repeat.y=i.texOpts.repeatV,e[s[o]]=n,"emission"===o&&(e.emissive=16777215)}}}}else"diffuse"!==o&&t||("emission"===o?e.emissive=i.color.getHex():e[o]=i.color.getHex());break;case"shininess":e[o]=this[o];break;case"reflectivity":e[o]=this[o],e[o]>0&&(e.envMap=M.defaultEnvMap),e.combine=THREE$1.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[o],1!==this[o]&&(e.envMap=M.defaultEnvMap)}switch(e.side=this.effect.doubleSided?THREE$1.DoubleSide:THREE$1.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),void 0!==e.ambient&&delete e.ambient,this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE$1.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE$1.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE$1.MeshLambertMaterial(e)}return this.material},oe.prototype.parse=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"init_from":this.init_from=s.textContent;break;case"format":this.format=s.textContent;break;default:console.log(`unhandled Surface prop: ${s.nodeName}`)}}return this},ae.prototype.parse=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"source":this.source=s.textContent;break;case"minfilter":this.minfilter=s.textContent;break;case"magfilter":this.magfilter=s.textContent;break;case"mipfilter":this.mipfilter=s.textContent;break;case"wrap_s":this.wrap_s=s.textContent;break;case"wrap_t":this.wrap_t=s.textContent;break;default:console.log(`unhandled Sampler2D prop: ${s.nodeName}`)}}return this},re.prototype.create=function(){if(null===this.shader)return null},re.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),Se(this,e),this.shader=null;for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(s))}}return this},re.prototype.parseNewparam=function(e){const t=e.getAttribute("sid");for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"surface":this.surface[t]=new oe(this).parse(i);break;case"sampler2D":this.sampler[t]=new ae(this).parse(i);break;case"extra":break;default:console.log(i.nodeName)}}},re.prototype.parseProfileCOMMON=function(e){let t;for(let i=0;i<e.childNodes.length;i++){const n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"profile_COMMON":this.parseProfileCOMMON(n);break;case"technique":t=n;break;case"newparam":this.parseNewparam(n);break;case"image":var s=(new I).parse(n);p[s.id]=s;break;case"extra":break;default:console.log(n.nodeName)}}return t},re.prototype.parseTechnique=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new ne(s.nodeName,this).parse(s);break;case"extra":this.parseExtra(s)}}},re.prototype.parseExtra=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"technique":this.parseExtraTechnique(s)}}},re.prototype.parseExtraTechnique=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"bump":this.shader.parse(e)}}},le.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ce.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(let i=0;i<e.childNodes.length;i++){const n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"animation":var t=(new ce).parse(n);for(var s in t.source)this.source[s]=t.source[s];for(let e=0;e<t.channel.length;e++)this.channel.push(t.channel[e]),this.sampler.push(t.sampler[e]);break;case"source":s=(new te).parse(n);this.source[s.id]=s;break;case"sampler":this.sampler.push(new de(this).parse(n));break;case"channel":this.channel.push(new he(this).parse(n))}}return this},he.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");let t=this.target.split("/");t.shift();const s=t.shift(),i=s.indexOf(".")>=0,n=s.indexOf("(")>=0;if(i)t=s.split("."),this.sid=t.shift(),this.member=t.shift();else if(n){const e=s.split("(");this.sid=e.shift();for(let t=0;t<e.length;t++)e[t]=parseInt(e[t].replace(/\)/,""));this.arrIndices=e}else this.sid=s;return this.fullSid=s,this.dotSyntax=i,this.arrSyntax=n,this},de.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"input":this.inputs.push((new ee).parse(s))}}return this},de.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){const t=this.inputs[e],s=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=s.read();break;case"OUTPUT":this.output=s.read(),this.strideOut=s.accessor.stride;break;case"INTERPOLATION":this.interpolation=s.read();break;case"IN_TANGENT":case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},de.prototype.getData=function(e,t,s){let i;if("matrix"===e&&16===this.strideOut)i=this.output[t];else if(this.strideOut>1){i=[],t*=this.strideOut;for(let e=0;e<this.strideOut;++e)i[e]=this.output[t+e];if(3===this.strideOut)switch(e){case"rotate":case"translate":Ne(i,-1);break;case"scale":Ne(i,1)}else 4===this.strideOut&&"matrix"===e&&Ne(i,-1)}else i=this.output[t],s&&"translate"===e&&(i=function(e,t){if(!0!==M.convertUpAxis||T===M.upAxis)return t;switch(e){case"X":t="XtoY"===O?-1*t:t;break;case"Y":t="YtoZ"===O||"YtoX"===O?-1*t:t;break;case"Z":t="ZtoY"===O?-1*t:t}return t}(s,i));return i},ue.prototype.addTarget=function(e,t,s,i){this.targets.push({sid:e,member:s,transform:t,data:i})},ue.prototype.apply=function(e){for(let t=0;t<this.targets.length;++t){const s=this.targets[t];e&&s.sid!==e||s.transform.update(s.data,s.member)}},ue.prototype.getTarget=function(e){for(let t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},ue.prototype.hasTarget=function(e){for(let t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},ue.prototype.interpolate=function(e,t){for(let o=0,a=this.targets.length;o<a;o++){var s,i=this.targets[o],n=e.getTarget(i.sid);if("matrix"!==i.transform.type&&n){let o=(t-this.time)/(e.time-this.time),a=n.data,r=i.data;if(o<0&&(o=0),o>1&&(o=1),r.length){s=[];for(let e=0;e<r.length;++e)s[e]=r[e]+(a[e]-r[e])*o}else s=r+(a-r)*o}else s=i.data;i.transform.update(s,i.member)}},pe.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"optics":this.parseOptics(s)}}return this},pe.prototype.parseOptics=function(e){for(let i=0;i<e.childNodes.length;i++)if("technique_common"===e.childNodes[i].nodeName){const n=e.childNodes[i];for(let e=0;e<n.childNodes.length;e++)if(this.technique=n.childNodes[e].nodeName,"perspective"===this.technique){const i=n.childNodes[e];for(var t=0;t<i.childNodes.length;t++){switch((s=i.childNodes[t]).nodeName){case"yfov":this.yfov=s.textContent;break;case"xfov":this.xfov=s.textContent;break;case"znear":this.znear=s.textContent;break;case"zfar":this.zfar=s.textContent;break;case"aspect_ratio":this.aspect_ratio=s.textContent}}}else if("orthographic"===this.technique){const i=n.childNodes[e];for(t=0;t<i.childNodes.length;t++){var s;switch((s=i.childNodes[t]).nodeName){case"xmag":this.xmag=s.textContent;break;case"ymag":this.ymag=s.textContent;break;case"znear":this.znear=s.textContent;break;case"zfar":this.zfar=s.textContent;break;case"aspect_ratio":this.aspect_ratio=s.textContent}}}}return this},me.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ge.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"technique_common":this.parseCommon(s);break;case"technique":this.parseTechnique(s)}}return this},ge.prototype.parseCommon=function(e){for(let n=0;n<e.childNodes.length;n++)switch(e.childNodes[n].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[n].nodeName;var t=e.childNodes[n];for(let e=0;e<t.childNodes.length;e++){const n=t.childNodes[e];switch(n.nodeName){case"color":var s=Te(n.textContent);this.color=new THREE$1.Color(0),this.color.setRGB(s[0],s[1],s[2]),this.color.a=s[3];break;case"falloff_angle":this.falloff_angle=parseFloat(n.textContent);break;case"quadratic_attenuation":var i=parseFloat(n.textContent);this.distance=i?Math.sqrt(1/i):0}}}return this},ge.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"intensity":this.intensity=parseFloat(s.textContent)}}return this},fe.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},be.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"technique_common":this.parseCommon(s)}}return this},be.prototype.parseCommon=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new ye).parse(s));break;case"link":this.links.push((new Ee).parse(s))}}return this},ye.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE$1.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;const t=Te(e.querySelector("axis").textContent);this.axis=Le(t,0);const s=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,i=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:s,max:i};const n=["prismatic","revolute"];for(let t=0;t<n.length;t++){const s=n[t];e.querySelector(s)&&(this.type=s)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},Ee.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"attachment_full":this.attachments.push((new we).parse(s));break;case"rotate":case"translate":case"matrix":this.transforms.push((new $).parse(s))}}return this},we.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"link":this.links.push((new Ee).parse(s));break;case"rotate":case"translate":case"matrix":this.transforms.push((new $).parse(s))}}return this},{load:function(e,t,s,i){let o=0;if(document.implementation&&document.implementation.createDocument){const a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState?0===a.status||200===a.status?a.response?(n=t,v(a.response,void 0,e)):i?i({type:"error",url:e}):console.error(`ColladaLoader: Empty or non-existing file (${e})`):i?i({type:"error",url:e}):console.error(`ColladaLoader: Couldn't load "${e}" (${a.status})`):3===a.readyState&&s&&(0===o&&(o=a.getResponseHeader("Content-Length")),s({total:o,loaded:a.responseText.length}))},a.open("GET",e,!0),a.send(null)}else alert("Don't know how to parse XML!")},parse:v,applySkin:L,geometries:f,options:M}}class SiteObject extends AdsumObject3D{constructor(){super(),this.isSite=!0,this.buildings=new Set,this.spaces=new Set,this.labels=new Set}getType(){return AdsumObjectTypes.SiteObject}addLabel(e,t=null){let s=0,i=0,n=0;if(null!==t&&({x:s,y:i,z:n}=t),null!==e.parent)throw new Error("AdsumWebMap.LabelObject#addLabel: Changing labelObject parent is not supported yet.");e.parent=this,this.labels.add(e),e.moveTo(s,i,n),this._mesh.add(e._mesh),e.update()}_raycast(e,t,s=!0){return!1!==super._raycast(e,t,s)&&(s&&(this.buildings.forEach(i=>{i._raycast(e,t,s)}),this.labels.forEach(i=>{i._raycast(e,t,s)}),this.spaces.forEach(i=>{i._raycast(e,t,s)})),!0)}}class BuildingObject extends AdsumObject3D{constructor(){super(),this.isBuilding=!0,this.site=null,this.floors=new Set,this.labels=new Set,this._labelGroup=new Group,this._initialColor=null}getType(){return AdsumObjectTypes.BuildingObject}addLabel(e,t=null){let s=0,i=0,n=0;if(null!==t&&({x:s,y:i,z:n}=t),null!==e.parent)throw new Error("AdsumWebMap.SpaceObject#addLabel: Changing labelObject parent is not supported yet.");return e.parent=this,this.labels.add(e),e.moveTo(s,i,n),this._labelGroup.add(e._mesh),this.update(),this}setColor(e){return this._mesh.material.color.set(e),this}isInitialColor(){return this._initialColor.equals(this._mesh.material.color)}resetColor(){return this._mesh.material.color.copy(this._initialColor),this}_setMesh(e){return super._setMesh(e),this._mesh.add(this._labelGroup),this._updateLabelGroup(),this._initialColor=this._mesh.material.color.clone(),this}_raycast(e,t,s=!0){return!1!==super._raycast(e,t,s)&&(s&&(this.floors.forEach(i=>{i._raycast(e,t,s)}),this.labels.forEach(i=>{i._raycast(e,t,s)})),!0)}_updateLabelGroup(){super.update();const{size:e}=this.getSizeAndCenter(!1);this._labelGroup.position.setZ(e.z),this._labelGroup.updateMatrixWorld()}}class FloorObject extends AdsumObject3D{constructor(){super(),this.isFloor=!0,this.building=null,this.spaces=new Set,this.labels=new Set,this.altitude=null}getType(){return AdsumObjectTypes.FloorObject}addLabel(e,t=null){let s=0,i=0,n=0;if(null!==t&&({x:s,y:i,z:n}=t),null!==e.parent)throw new Error("AdsumWebMap.LabelObject#addLabel: Changing labelObject parent is not supported yet.");e.parent=this,this.labels.add(e),e.moveTo(s,i,n),this._mesh.add(e._mesh),e.update()}_raycast(e,t,s=!0){return!1!==super._raycast(e,t,s)&&(s&&(this.spaces.forEach(i=>{i._raycast(e,t,s)}),this.labels.forEach(i=>{i._raycast(e,t,s)})),!0)}}class SpaceObject extends AdsumObject3D{constructor(){super(),this.isSpace=!0,this.parent=null,this.labels=new Set,this._labelGroup=new Group,this._initialColor=null}getType(){return AdsumObjectTypes.SpaceObject}_setMesh(e){return super._setMesh(e),this._mesh.add(this._labelGroup),this._updateLabelGroup(),this._initialColor=this._mesh.material.color.clone(),this}setColor(e){return this._mesh.material.color.set(e),this}isInitialColor(){return this._initialColor.equals(this._mesh.material.color)}resetColor(){return this._mesh.material.color.copy(this._initialColor),this}isBounced(){return 1!==this._mesh.scale.z}getBounceFactor(){return this._mesh.scale.z}bounceUp(e){return this._mesh.scale.setZ(e),this.update(),this}bounceDown(){return this.bounceUp(1)}addLabel(e,t=null){let s=0,i=0,n=0;if(null!==t&&({x:s,y:i,z:n}=t),null!==e.parent)throw new Error("AdsumWebMap.SpaceObject#addLabel: Changing labelObject parent is not supported yet.");return e.parent=this,this.labels.add(e),e.moveTo(s,i,n),this._labelGroup.add(e._mesh),this.update(),this}_raycast(e,t,s=!0){return!1!==super._raycast(e,t,s)&&(s&&this.labels.forEach(i=>{i._raycast(e,t,s)}),!0)}update(){this._labelGroup.scale.z!==1/this.getBounceFactor()&&this._updateLabelGroup(),super.update()}_updateLabelGroup(){super.update();const{size:e}=this.getSizeAndCenter(!1);this._labelGroup.scale.setZ(1/this.getBounceFactor()),this._labelGroup.position.setZ(e.z/this.getBounceFactor()),this._labelGroup.updateMatrixWorld()}}class LoaderResult{constructor(e=null){this.scene=null,this.site=null,this.buildingsMap=new Map,this.floorsMap=new Map,this.spacesMap=new Map,this.labelsMap=new Map,this.deviceId=e,this.projector=null,this.paths=null}}const LABEL_OBJECTS_ORIENTATION_MODES={BILLBOARD:"BILLBOARD",STATIC:"STATIC",FLIP:"FLIP"},v=new Vector3;class LabelObject extends AdsumObject3D{constructor(){super(),this.isLabel=!0,this.parent=null,this.orientationMode=LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD,this.autoScale=!1}getType(){return AdsumObjectTypes.LabelObject}_onBeforeRender(e,t,s,i,n,o){super._onBeforeRender(e,t,s,i,n,o);let a=!1;this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD&&(this._mesh.quaternion.setFromRotationMatrix(this._mesh.parent.matrixWorld).inverse(),this._mesh.quaternion.multiply(s.quaternion).normalize(),a=!0);const r=new Vector3;this._mesh.getWorldPosition(r);const l=v.subVectors(s.position,r).length();if(this.autoScale){const e=Math.tan(s.fov*Math.PI/180/2)*l/1e3;this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD?(this._mesh.geometry.computeBoundingBox(),this._mesh.position.z-=this._mesh.geometry.boundingBox.max.y*this._mesh.scale.z,this._mesh.scale.set(e,e,e),this._mesh.position.z+=this._mesh.geometry.boundingBox.max.y*this._mesh.scale.z):this._mesh.scale.set(e,e,1)}a&&this._mesh.updateMatrixWorld()}}class LabelImageObject extends LabelObject{constructor(){super(),this.isLabelImage=!0,this.width=null,this.height=null}getType(){return AdsumObjectTypes.LabelImageObject}static create(e,t,s,i=Symbol("AdsumObjectId")){const{width:n,height:o,orientationMode:a,autoScale:r}=s;return new Promise((s,i)=>{t.load(e,e=>{s(new MeshBasicMaterial({color:16777215,side:FrontSide,map:e,transparent:!0,depthWrite:!1}))},void 0,i)}).then(e=>{const t=new PlaneGeometry(n,o),l=new Mesh(t,e),c=LabelImageObject._createFromMesh(l,s,i);if(a)switch(a){case LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD:case LABEL_OBJECTS_ORIENTATION_MODES.STATIC:c.orientationMode=a;break;default:console.warn(`AdsumWebMap.LabelImageObject#create: Unsupported orientation mode ${a}`)}return r&&(c.autoScale=!0),c})}}const fontHeightCache=new Map,TEXTURE_OVERSAMPLING=5,BACKGROUND_PADDING=10,LINE_HEIGHT_INTERVAL=1.25,TextUtil={TEXTURE_OVERSAMPLING:5,BACKGROUND_PADDING:10,LINE_HEIGHT_INTERVAL:1.25,renderOnTexture:(e,t)=>{let s=null;null===s&&(s=document.createElement("canvas"));const{font:i,size:n,color:o,backgroundColor:a}=t,r=`${n}pt ${void 0===i?"Arial":i}`,l=TextUtil.getFontHeight(r),c=e.length*l,h=s.getContext("2d");h.textBaseline="hanging",h.textAlign="center",h.font=r;let d=0;e.forEach(e=>{d=Math.max(d,h.measureText(e).width)}),s.width=5*(d+10),s.height=5*(c+10),h.clearRect(0,0,s.width,s.height),a&&(h.fillStyle=`rgba(${255*a.r},${255*a.g},${255*a.b},0.7)`,TextUtil.fillRectRounded(h,0,0,s.width,s.height,20)),h.scale(5,5),h.textBaseline="hanging",h.font=r,h.textAlign="center",h.fillStyle=`rgb(${255*o.r},${255*o.g},${255*o.b})`;const u=(l-l/1.25)/2;for(let t=0;t<e.length;t++)h.fillText(e[t],Math.round(5+d/2),Math.round(t*l+(t+1)*u+5));const p=new CanvasTexture(s);return p.needsUpdate=!0,p},getFontHeight:e=>{if(fontHeightCache.has(e))return fontHeightCache.get(e);let t=null;null===t&&(t=document.createElement("canvas")),t.width=1e3,t.height=500;const s=t.getContext("2d");s.fillStyle="black",s.fillRect(0,0,t.width,t.height),s.textBaseline="top",s.fillStyle="white",s.font=e,s.fillText("gM",0,t.height/2);const i=s.getImageData(0,0,t.width,t.height).data;let n=-1,o=-1;for(let e=0;e<t.height;e++)for(let s=0;s<t.width;s++){if(!(0===i[4*(e*t.width+s)])){-1===n&&(n=e),o=e+1;break}}const a=1.25*(o-n);return fontHeightCache.set(e,a),a},fillRectRounded(e,t,s,i,n,o){e.beginPath(),e.moveTo(t+o,s),e.lineTo(t+i-o,s),e.quadraticCurveTo(t+i,s,t+i,s+o),e.lineTo(t+i,s+n-o),e.quadraticCurveTo(t+i,s+n,t+i-o,s+n),e.lineTo(t+o,s+n),e.quadraticCurveTo(t,s+n,t,s+n-o),e.lineTo(t,s+o),e.quadraticCurveTo(t,s,t+o,s),e.closePath(),e.fill()}};class LabelTextObject extends LabelObject{constructor(){super(),this.isLabelText=!0}getType(){return AdsumObjectTypes.LabelTextObject}static create(e,t,s=Symbol("AdsumObjectId")){const i=e.split("\n"),n=TextUtil.renderOnTexture(i,t),o=new PlaneGeometry(n.image.width/TextUtil.TEXTURE_OVERSAMPLING,n.image.height/TextUtil.TEXTURE_OVERSAMPLING),a=new MeshBasicMaterial({color:16777215,map:n,side:FrontSide,transparent:!0,depthWrite:!1}),r=this._createFromMesh(new Mesh(o,a),t,s);if(t.orientationMode)switch(t.orientationMode){case LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD:case LABEL_OBJECTS_ORIENTATION_MODES.STATIC:r.orientationMode=t.orientationMode;break;default:console.warn(`AdsumWebMap.LabelImageObject#create: Unsupported orientation mode ${t.orientationMode}`)}return t.autoScale&&(r.autoScale=!0),r}}const v$1=new Vector3;class LevelOfDetails{constructor(){this.levels=new Map,this.active=!0,this.currentLevel=null,this.currentDistance=null}addLevelState(e,t){this.levels.set(e,t)}applyLod(e,t){if(!this.active)return;const s=new Vector3,i=new Vector3;t.getWorldPosition(s),e._mesh.getWorldPosition(i),v$1.subVectors(s,i);const n=v$1.length();if(this.currentDistance===n)return;let o=null,a=null;this.levels.forEach((e,t)=>{t>n||null!==a&&t<a||(o=e,a=t)}),null!==a?(this.currentDistance=n,a!==this.currentLevel&&o.apply(e)):console.warn("AdsumWebMap.LevelOfDetails: cannot find LevelState matching, make sure you have a default one which startAt 0")}}class AbstractLevelState{apply(e){}}class DisplayLevelState extends AbstractLevelState{constructor(e){super(),this.displayMode=e}apply(e){super.apply(e),e.setDisplayMode(this.displayMode)}}const v$2=new Vector3;class AdsumProjector{static createFake(){return new this([1,0,0,0,1,0],[0,0,0],{latitude:0,longitude:0})}constructor(e,t,s){this.matrix=new Matrix4,this.inverseMatrix=null,this.matrix.set(e[0],e[1],0,t[0],e[3],e[4],0,t[1],0,0,1,0,0,0,0,1);const i=new Vector3;i.setFromMatrixScale(this.matrix),this.scale=(i.x+i.y)/2;const n=Gps.fromDegree(s.latitude,s.longitude,0);this.utmGridZone=new UtmGridZone(n)}meterToAdsumDistance(e){return e*this.scale}adsumDistanceToMeter(e){return e/this.scale}gpsToAdsum(e){return this.utmToAdsum(this.gpsToUtm(e))}gpsToUtm(e){const{lat:t,long:s,alt:i}=e;return GpsUtmConverter.toUtm(Gps.fromDegree(t,s,i),this.utmGridZone)}utmToAdsum(e){const{E:t,N:s,alt:i}=e,n=new Vector3(t,s,i);return n.applyMatrix4(this.matrix),n}adsumToGps(e){return this.utmToGps(this.adsumToUtm(e))}adsumToUtm(e){return null===this.inverseMatrix&&(this.inverseMatrix=new Matrix4,this.inverseMatrix.getInverse(this.matrix)),v$2.copy(e),v$2.applyMatrix4(this.inverseMatrix),new Utm(v$2.x,v$2.y,v$2.z,this.utmGridZone.hemi,this.utmGridZone.zone)}utmToGps(e){return GpsUtmConverter.toGps(e)}}class AdsumLoader{constructor(e){this.options=new AdsumLoaderOptions(e),this.isAoMap=!0,this.result=new LoaderResult(e.deviceId),this.adsumTextureLoader=null,this._registerAdsumTextureLoader()}load(){return this._startEntityManagerLoading(),this._registerAdsumTextureLoader().then(()=>Promise.all([this._loadCollada(),this._loadProjectorTransform().then(()=>this._loadLabels()),this._loadPaths()])).then(()=>this._loadLabels()).then(()=>this._addLabels()).then(()=>(this.result.scene.updateMatrixWorld(!0),this.result))}_loadCollada(){const e=this.options.entityManager.getRepository("File"),t=this.options.entityManager.getRepository("MapFile"),s=this.options.entityManager.getRepository("Place");return Promise.all([e.load(),t.load()]).then(()=>{const e=this._getColladaUri();return Promise.all([this._parseCollada(e),s.load()])}).then(([{scene:e}])=>{this.result.scene=e,this._parseAndTransformAdsumScene(e,s),this._adjustSceneSettings()})}loadCalibration(e){const t=this.options.entityManager.getRepository("SiteCalibration"),s=this.options.entityManager.getRepository("FloorCalibration");return Promise.all([t.load(),s.load()]).then(()=>{const i=t.findOneBy({device:t=>t.is(e)});let n=null,o=null;const a=new Map;if(null!==i&&(s.getList(i.floor_calibrations).forEach(e=>{const t=new CameraCalibration;t.eye.copy(e.eye),t.up.copy(e.up),t.target.copy(e.target),t.zoomMin=e.zoom_min||DEFAULT_CALIBRATION.ZOOM_MIN,t.zoomMax=e.zoom_max||DEFAULT_CALIBRATION.ZOOM_MAX;const s=-1===e.floor_id?null:e.floor_id;a.set(s,t)}),n=-1===i.start_floor?null:i.start_floor,null!==i.start_point_floor)){const e=i.start_point_floor;o={floorId:-1!==e?e:null,position:i.start_point_position}}return{cameraCalibrations:a,defaultFloorId:n,userPosition:o}})}_loadLabels(){const e=this.options.entityManager.getRepository("CustomObject"),t=this.options.entityManager.getRepository("File");return Promise.all([e.load(),t.load()]).then(()=>{const s=[];return e.getAll().forEach(e=>{const i={orientationMode:e.orientation_mode,autoScale:e.autoscale,placeId:e.place.value};if(0!==e.priority){const t=new LevelOfDetails;t.addLevelState(0,new DisplayLevelState(DISPLAY_MODES.VISIBLE)),t.addLevelState(200*e.priority,new DisplayLevelState(DISPLAY_MODES.NONE)),i.levelOfDetails=t}if(e.type===CUSTOM_OBJECT_TYPES.PICTO){const n=t.get(e.file);i.width=e.width,i.height=e.height,s.push(LabelImageObject.create(n.uri,this.adsumTextureLoader,i,e.id))}else{const t=e.label.replace(/<br[ ]*\/?>/gi,"\n");i.font=e.font,i.size=e.font_size,i.color=new Color(e.font_color),i.backgroundColor=null===e.background_color?null:new Color(e.background_color),s.push(Promise.resolve(LabelTextObject.create(t,i,e.id)))}}),Promise.all(s).then(e=>{e.forEach(e=>{this.result.labelsMap.set(e.id,e)})})})}_startEntityManagerLoading(){this.options.entityManager.getRepository("Site").load(),this.options.entityManager.getRepository("MapFile").load(),this.options.entityManager.getRepository("File").load(),this.options.entityManager.getRepository("Place").load(),this.options.entityManager.getRepository("CustomObject").load(),this.options.entityManager.getRepository("SiteCalibration").load(),this.options.entityManager.getRepository("FloorCalibration").load()}_registerAdsumTextureLoader(){return this.options.entityManager.getRepository("File").load().then(()=>{this.adsumTextureLoader=new AdsumTextureLoader(this.options.entityManager.getRepository("File"),this.isAoMap),Loader.Handlers.add(this.adsumTextureLoader.regex,this.adsumTextureLoader)})}_getColladaUri(){const e=this.options.entityManager.getRepository("File"),t=this.options.entityManager.getRepository("MapFile"),s=t.findOneBy({type:MAP_FILE_TYPES.AO_DAE,file:e=>null!==e.value});let i=null;if(this.isAoMap&&null!==s)i=s.file;else{const e=t.findOneBy({type:MAP_FILE_TYPES.DAE,file:e=>null!==e.value});if(null===e)throw new Error("AdsumWebMap.AdsumLoader: No map found");i=e.file,this.isAoMap=!1}return e.get(i).uri}_parseCollada(e){return new Promise((t,s)=>{return(new AdsumColladaLoader).load(e,t,null,s)})}_parseAndTransformAdsumScene(e,t,s=null){let i=e;if(!e.geometry&&!e.material&&e.children.length>0&&("Mesh"===e.children[0].type||e.children[0].isLight)){const{parent:t}=e;t.remove(e);const s=e.children[0];s.isLight?(s.matrix=e.matrix,s.matrix.decompose(s.position,s.quaternion,s.scale)):s.applyMatrix(e.matrix),t.add(s);for(let t=e.children.length-1;t>=0;t--){const i=e.children[t];s.add(i)}(i=s).name=e.name,i.colladaId=e.colladaId,e.dispose&&e.dispose()}const n=i.name||"";if(i.material)if(i.material.flatShading=!0,i.material.side=FrontSide,i.material.isMeshPhongMaterial?(i.material.emissionMap&&!i.material.map&&(i.material.map=i.material.emissionMap,i.material.emissionMap=null,i.material.color=16777215),i.material.shininess=1e-4):i.material.isMeshLambertMaterial&&i.material.emissionMap&&!i.material.map&&(i.material.map=i.material.emissionMap,i.material.emissionMap=null),i.material.lightMap)i.material=new MeshPhongMaterial({aoMap:i.material.lightMap,map:i.material.map,color:i.material.color});else if(this.options.preferLambertMaterial()&&i.material.isMeshPhongMaterial){const e=["alphaTest","blendDst","blendDstAlpha","blendEquation","blendEquationAlpha","blending","blendSrc","blendSrcAlpha","clipIntersection","clippingPlanes","clipShadows","colorWrite","depthFunc","depthTest","depthWrite","fog","lights","name","overdraw","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","precision","premultipliedAlpha","dithering","flatShading","side","transparent","vertexColors","visible","userData","alphaMap","aoMap","aoMapIntensity","color","combine","emissive","emissiveMap","emissiveIntensity","envMap","lightMap","lightMapIntensity","map","morphNormals","morphTargets","reflectivity","refractionRatio","skinning","specularMap","wireframe","wireframeLinecap","wireframeLinejoin","wireframeLinewidth"],t={};for(let s=0;s<e.length;s++){const n=e[s];t[n]=i.material[n]}i.material=new MeshLambertMaterial(t)}if(n.startsWith("SITE"))this.isAoMap&&(i.rotateX(-Math.PI/2),i.updateMatrix()),this.result.site=SiteObject._createFromMesh(i,{},-1),s=this.result.site;else if(n.startsWith("BUILDING")){const e=n.match(/BUILDING_(\d+)_.*/),o={},a=parseInt(e[1],10),r=t.findOneBy({building_id:a});null===r?console.warn(`AdsumLoader: No place associated to building ${a}`):o.placeId=r.id;const l=BuildingObject._createFromMesh(i,o,a);l.site=s,l.site.buildings.add(l),this.result.buildingsMap.set(l.id,l),s=l}else if(n.startsWith("FLOOR")){const e=n.match(/FLOOR_(\d+)_.*/),t=FloorObject._createFromMesh(i,{},parseInt(e[1],10));t.altitude=i.position.z,t.building=s,t.building.floors.add(t),this.result.floorsMap.set(t.id,t),s=t}else if(n.startsWith("SHAPE")||n.startsWith("STORE")){const e=n.match(/(?:SHAPE|STORE)_(\d+)_.*/),o={},a=parseInt(e[1],10),r=t.findOneBy({shape_id:a});null===r?console.warn(`AdsumLoader: No place associated to space ${a}`):o.placeId=r.id;const l=SpaceObject._createFromMesh(i,o,a);l.parent=s,l.parent.spaces.add(l),this.result.spacesMap.set(l.id,l),s=l}for(let e=i.children.length-1;e>=0;e--)this._parseAndTransformAdsumScene(i.children[e],t,s)}_adjustSceneSettings(){this.result.scene.traverse(e=>{e instanceof Mesh&&(e.material.shininess=1e-5,this.options.shadowEnabled&&(e!==this.result.site._mesh&&(e.castShadow=!0),e.receiveShadow=!0))}),this._createLights(),this._createFog(),this.result.site._mesh.material.emissive&&this.result.site._mesh.material.emissive.set(0),this.result.site._mesh.material.shininess&&(this.result.site._mesh.material.shininess=1e-5),this.result.buildingsMap.forEach(e=>{const t=e._mesh;if(t.material&&t.material.specular&&t.material.specular.set(0,0,0),t.geometry){const e=new Vector3;t.geometry.computeBoundingBox(),t.geometry.boundingBox.getCenter(e),t.geometry.center(),t.geometry.translate(0,0,e.z),e.z=0,e.multiply(t.scale),e.applyQuaternion(t.quaternion),t.position.add(e),t.children.forEach(t=>{t.position.sub(e)}),t.updateMatrix(),t.updateMatrixWorld()}this._colorShapeVertices(t)}),this.result.floorsMap.forEach(e=>{e._mesh.material.emissive&&e._mesh.material.emissive.set(0),e._mesh.material.shininess&&(e._mesh.material.shininess=1e-5)}),this.result.spacesMap.forEach(e=>{const t=e._mesh;if(this._colorShapeVertices(t),t.geometry){const e=new Vector3;t.geometry.computeBoundingBox(),t.geometry.boundingBox.getCenter(e),t.geometry.center(),t.geometry.translate(0,0,e.z),e.z=0,e.multiply(t.scale),e.applyQuaternion(t.quaternion),t.position.add(e),t.updateMatrix(),t.updateMatrixWorld()}})}_colorShapeVertices(e){if(this.isAoMap){const t=e.geometry,s=new Color(this.options.shapeAmbientOcclusionTopColor),i=new Color(this.options.shapeAmbientOcclusionBottomColor);t.faces.forEach(e=>{let n=s,o=s,a=s;t.vertices[e.a]&&0===t.vertices[e.a].z&&(n=i),t.vertices[e.b]&&0===t.vertices[e.b].z&&(o=i),t.vertices[e.c]&&0===t.vertices[e.c].z&&(a=i),e.vertexColors.push(n),e.vertexColors.push(o),e.vertexColors.push(a)}),t.colorsNeedUpdate=!0,e.material.vertexColors=VertexColors,e.material.needsUpdate=!0}}_createLights(){const e=this.options.advancedLightingEnabled()?.5:1,t=new HemisphereLight(16777215,8947848,e);if(t.position.set(0,0,1),this.result.scene.add(t),t.updateMatrixWorld(),this.options.advancedLightingEnabled()){const e=new DirectionalLight(16777215,.2);e.position.set(1,0,0),this.result.scene.add(e),e.updateMatrixWorld();const t=new Box3,s=new Sphere;t.setFromObject(this.result.scene).getBoundingSphere(s);const{radius:i}=s,n=s.center.clone();n.z+=i/2,n.y+=i/2,n.x-=i/2;const o=new DirectionalLight(16777215,.85);o.position.copy(n),o.target.position.copy(s.center),this.options.shadowEnabled&&(o.castShadow=!0,o.shadow.camera.near=i/4,o.shadow.camera.far=2*i,o.shadow.camera.right=i,o.shadow.camera.left=-i,o.shadow.camera.top=i,o.shadow.camera.bottom=-i,o.shadow.mapSize.width=this.options.shadowMapSize,o.shadow.mapSize.height=this.options.shadowMapSize),this.result.scene.add(o.target),this.result.scene.add(o),o.updateMatrixWorld(),o.target.updateMatrixWorld()}}_createFog(){this.options.fogEnabled&&(this.result.scene.fog=new FogExp2(this.options.fogColor,this.options.fogRatio))}_addLabels(){const e=this.options.entityManager.getRepository("Place"),t=this.options.entityManager.getRepository("CustomObject");return e.load().then(()=>{this.result.labelsMap.forEach(s=>{const i=t.get(s.id),n=e.get(i.place),o={x:i.offset.x,y:i.offset.y,z:i.offset.z};if(i.orientation_mode===CUSTOM_OBJECT_ORIENTATION_MODES.BILLBOARD){const{size:e}=s.getSizeAndCenter();o.z+=e.y/2}else o.z+=1.1;const a=i.orientation_mode===CUSTOM_OBJECT_ORIENTATION_MODES.STATIC;if(i.rotation&&a&&s.rotateZ(i.rotation*Math.PI/180),i.permanent_display||s.setDisplayMode(DISPLAY_MODES.NONE),null!==n.shape_id){this.result.spacesMap.get(n.shape_id).addLabel(s,o)}else if(null!==n.building_id){this.result.buildingsMap.get(n.building_id).addLabel(s,o)}else if(-1===n.floor_id)this.result.site.addLabel(s,{x:o.x+n.position.x,y:o.y+n.position.y,z:o.z+n.position.z});else{this.result.floorsMap.get(n.floor_id).addLabel(s,{x:o.x+n.position.x,y:o.y+n.position.y,z:o.z+n.position.z})}})})}_loadProjectorTransform(){const e=this.options.entityManager.getRepository("Site");return e.load().then(()=>{const t=e.getCurrent();if(t.gps_positions.size<4||6!==t.gps_transform.size||3!==t.gps_translate.size)return console.warn("AdsumWebMap.AdsumLoader: No gps positions available, wayfinding will not be accurate (we assume world unit match meter) !!"),void(this.result.projector=AdsumProjector.createFake());this.result.projector=new AdsumProjector(Array.from(t.gps_transform),Array.from(t.gps_translate),Array.from(t.gps_positions)[0])})}_loadPaths(){const e=this.options.entityManager.getRepository("MapFile");return e.load().then(()=>{const t=e.findOneBy({type:MAP_FILE_TYPES.PATH});null===t?(console.warn("AdsumWebMap.AdsumLoader: No paths found, wayfinding will not be working !"),this.result.paths=new Map,this.result.paths.set("nodes",[]),this.result.paths.set("links",[])):this.result.paths=t.paths})}}class Path{constructor(e=null,t=null,s=!1){this.from=e,this.to=t,this.pmr=s,this._distance=null,this.pathSections=[],this.computed=!1}getDistance(){return this.computed?(null===this._distance&&(this._distance=0,this.pathSections.forEach(e=>{this._distance+=e.getDistance()})),this._distance):null}clear(){this.computed=!1,this.pathSections=[],this._distance=null}}export{AdsumWebMap,Options,CameraOptions,CameraCenterOnOptions,EngineOptions,AdsumLoader,AdsumLoaderOptions,MOUSE_EVENTS,AdsumObjectTypes as ADSUM_OBJECT_TYPES,DISPLAY_MODES as DISPLAY_MODE,LABEL_OBJECTS_ORIENTATION_MODES as LABEL_ORIENTATION_MODES,SceneEvents as SCENE_EVENTS,WayfindingEvents as WAYFINDING_EVENTS,Path,DotPathBuilderOptions,DotPathBuilder,PathSection,PathSectionObject,WayfindingOptions,UserObject};
