/**
 * Copyright (C) 2018 Adactive SAS
 */

import{Box3,Vector3,DoubleSide,Mesh,MeshBasicMaterial,CircleGeometry,RingGeometry,EventDispatcher,WebGLRenderer,PCFSoftShadowMap,Vector2,MOUSE,Quaternion,Spherical,PerspectiveCamera,Plane,Ray,Sphere,Raycaster,Line3,FrontSide,PlaneGeometry,CanvasTexture,Group,Cache,TextureLoader,Texture,Color,Math as Math$1,Matrix4,Vector4,Object3D,MeshLambertMaterial,MeshPhongMaterial,MultiMaterial,SkinnedMesh,Line,DirectionalLight,PointLight,SpotLight,AmbientLight,Geometry,Face3,Loader,MirroredRepeatWrapping,RepeatWrapping,ClampToEdgeWrapping,MixOperation,ImageLoader,Scene,HemisphereLight,FogExp2,VertexColors}from"three";import{AbstractOptions}from"@adactive/adactive-abstract-options";import{update,getAll,Tween,Easing}from"es6-tween";import{Manager,Tap}from"hammerjs";import{FILE_CONTEXTS,CUSTOM_OBJECT_TYPES,MAP_FILE_TYPES}from"@adactive/adsum-client-api";import{GpsUtmConverter,Gps,Utm,UtmGridZone}from"@adactive/adsum-space-transform";const DISPLAY_MODES={NONE:"none",VISIBLE:"visible",TRANSPARENT:"transparent"},v1=new Vector3;class VisibleBox3 extends Box3{setFromObject(e){return this.makeEmpty(),e.updateMatrixWorld(!0),e.traverseVisible(e=>{const{geometry:t}=e;if(void 0!==t)if(t.isGeometry){const{vertices:s}=t;for(let t=0,i=s.length;t<i;t++)v1.copy(s[t]),v1.applyMatrix4(e.matrixWorld),this.expandByPoint(v1)}else if(t.isBufferGeometry){const s=t.attributes.position;if(void 0!==s)for(let t=0,i=s.count;t<i;t++)v1.fromBufferAttribute(s,t).applyMatrix4(e.matrixWorld),this.expandByPoint(v1)}}),this}}const AdsumObjectTypes={AdsumObject3D:"AdsumObject3D",BuildingObject:"BuildingObject",FloorObject:"FloorObject",LabelImageObject:"LabelImageObject",LabelObject:"LabelObject",LabelTextObject:"LabelTextObject",SiteObject:"SiteObject",SpaceObject:"SpaceObject",PathSectionObject:"PathSectionObject",UserObject:"UserObject"},cameraWorld=new Vector3,objectWorld=new Vector3,v=new Vector3;class LevelOfDetails{constructor(){this.levels=new Map,this.active=!0}addLevelState(e,t){return this.levels.set(e,t),this}clear(){return this.levels.clear(),this}getLevelStates(){const e=[];return this.levels.forEach((t,s)=>{e.push({startAt:s,levelState:t})}),e.sort((e,t)=>e.startAt-t.startAt),e}removeLevelState(e){return this.levels.delete(e),this}applyLod(e,t,s){if(!this.active||0===this.levels.size)return!1;t.getWorldPosition(cameraWorld),e._mesh.getWorldPosition(objectWorld),v.subVectors(cameraWorld,objectWorld);const i=s.adsumDistanceToMeter(v.length());let o=null,n=null;return this.levels.forEach((e,t)=>{t>i||null!==n&&t<n||(o=e,n=t)}),null===n?(console.warn("AdsumWebMap.LevelOfDetails: cannot find LevelState matching, make sure you have a default one which startAt 0"),!1):(o.apply(e),!0)}}class AdsumObject3DOptions extends AbstractOptions{static convert(e){return e.isAdsumObject3DOptions?e:new this(e)}reset(){this.isAdsumObject3DOptions=!0,this.id=Symbol("AdsumObjectId"),this.levelOfDetails=new LevelOfDetails,this.name=null,this.placeId=Symbol("AdsumMapPlaceId")}}const box=new VisibleBox3;class AdsumObject3D{constructor(e={}){const t=AdsumObject3DOptions.convert(e);this.id=t.id,this.isAdsumObject=!0,this._mesh=null,this.levelOfDetails=t.levelOfDetails,this.name=t.name,this.placeId=t.placeId}getType(){return AdsumObjectTypes.AdsumObject3D}_setMesh(e){return null!==this._mesh&&(this._mesh.adsumObject=null,this._mesh.onBeforeRender=null),this._mesh=e,this._mesh.adsumObject=this,this._mesh.onBeforeRender=this._onBeforeRender.bind(this),this}setDisplayMode(e){switch(e){case DISPLAY_MODES.NONE:this._mesh.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._mesh.visible=!0,void 0!==this._mesh.material&&(this._mesh.material.visible=!0);break;case DISPLAY_MODES.TRANSPARENT:if(this._mesh.visible=!0,void 0===this._mesh.material)throw new Error("AdsumWebMap.AdsumObject3D: DisplayMode transparent is not supported with the current object");this._mesh.material.visible=!1;break;default:throw new Error("Unexpected")}}getDisplayMode(){return this._mesh.visible&&void 0!==this._mesh.material?this._mesh.material.visible?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT:DISPLAY_MODES.NONE}moveTo(e,t,s){this._mesh.position.x=e,this._mesh.position.y=t,this._mesh.position.z=s}moveBy(e,t,s){this._mesh.position.x+=e,this._mesh.position.y+=t,this._mesh.position.z+=s}getSizeAndCenter(e=!0){if(e)box.setFromObject(this._mesh);else{box.makeEmpty();const{vertices:e}=this._mesh.geometry,t=new Vector3;e.forEach(e=>{t.copy(e),t.applyMatrix4(this._mesh.matrixWorld),box.expandByPoint(t)})}const t=new Vector3,s=new Vector3;return box.getCenter(t),box.getSize(s),{size:s,center:t}}update(){this._mesh.matrixAutoUpdate||this._mesh.updateMatrix(),this._mesh.updateMatrixWorld()}_applyLod(e,t,s){s&&this.levelOfDetails.applyLod(this,e,t)}_onBeforeRender(e,t,s,i,o,n){}_raycast(e,t,s=!0){if(!1===this._mesh.visible)return!1;if(void 0===this._mesh.material||this._mesh.material.visible){const s=[];if(this._mesh.raycast(e,s),1===s.length){const e=s[0];t.push({object:this,distance:e.distance,position:this._mesh.worldToLocal(e.point)})}}return!0}_addChild(e){this._mesh.add(e._mesh)}_dispose(){const e=e=>{if(e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material){Object.keys(e.material).forEach(t=>{const s=e.material[t];null!==s&&"object"===s&&s.dispose&&s.dispose()}),e.material.dispose&&e.material.dispose()}};this._mesh.traverse(e),e(this._mesh),null!==this._mesh.parent&&this._mesh.parent.remove(this._mesh)}}class UserObject extends AdsumObject3D{static createDefault(e,t={},s=Symbol("AdsumObjectId")){const i=new RingGeometry(e/2,e/2-e/8,32);i.merge(new CircleGeometry(e/8,16));const o=new MeshBasicMaterial({color:769978,side:DoubleSide});o.transparent=!0,t.id=s;const n=new this(t);return n._setMesh(new Mesh(i,o)),n}constructor(e={}){super(e),this.isUser=!0,this.parent=null}getType(){return AdsumObjectTypes.UserObject}}class ObjectManager{constructor(){this.site=null,this.buildings=new Map,this.floors=new Map,this.spaces=new Map,this.labels=new Map,this.user=null,this.pathSectionObjects=new Map}init(e,t){this.site=e.site,this.buildings=e.buildingsMap,this.floors=e.floorsMap,this.spaces=e.spacesMap,this.labels=e.labelsMap,this.user=UserObject.createDefault(t.meterToAdsumDistance(3),{placeId:Symbol("UserPlace")},Symbol("UserPositionId"))}getFloor(e){return this.floors.has(e)?this.floors.get(e):null}getBuilding(e){return this.buildings.has(e)?this.buildings.get(e):null}getSpace(e){return this.spaces.has(e)?this.spaces.get(e):null}getLabel(e){return this.labels.has(e)?this.labels.get(e):null}addLabel(e,t){return this.labels.set(e.id,e),t.addLabel(e),this}removeLabel(e){return this.labels.delete(e.id),e.parent.removeLabel(e),this}}const SceneEvents={floor:{didChanged:"scene.floor.didChanged"}};class SceneManager extends EventDispatcher{constructor(e){super(),this.awm=e,this.scene=null,this.currentFloor=null}init(e){this.scene=e.scene,e.site.setDisplayMode(DISPLAY_MODES.VISIBLE),e.buildingsMap.forEach(e=>{e.setDisplayMode(DISPLAY_MODES.VISIBLE)}),e.floorsMap.forEach(e=>{e.setDisplayMode(DISPLAY_MODES.NONE)}),this.currentFloor=null}getCurrentFloor(){return this.currentFloor}setCurrentFloor(e,t=!0){return e===this.currentFloor?Promise.resolve():new Promise((s,i)=>{try{t&&console.warn("AdsumWebMap.SceneManager.setCurrentFloor: animated parameter is not supported yet"),null===this.currentFloor?(this.awm.objectManager.site.setDisplayMode(DISPLAY_MODES.TRANSPARENT),this.awm.objectManager.buildings.forEach(e=>{e.setDisplayMode(DISPLAY_MODES.TRANSPARENT)})):this.currentFloor.setDisplayMode(DISPLAY_MODES.NONE),null===e?(this.awm.objectManager.site.setDisplayMode(DISPLAY_MODES.VISIBLE),this.awm.objectManager.buildings.forEach(e=>{e.setDisplayMode(DISPLAY_MODES.VISIBLE)})):e.setDisplayMode(DISPLAY_MODES.VISIBLE);const o=this.currentFloor;this.currentFloor=e,this.dispatchEvent({type:SceneEvents.floor.didChanged,previous:o,current:e}),s()}catch(e){i(e)}})}}class EngineManager{constructor(e,t){this.awm=e,this.options=t,this.container=t.container,this.canvas=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),this.levelOfDetailsEnabled=!0,this.renderer=new WebGLRenderer({antialias:!0,alpha:!0,powerPreference:t.gpuPower,canvas:this.canvas,logarithmicDepthBuffer:!0}),this.renderer.capabilities.logarithmicDepthBuffer=null!==this.renderer.extensions.get("EXT_frag_depth"),this.container.appendChild(this.canvas),this.options.shadowEnabled&&(this.renderer.shadowMap.type=PCFSoftShadowMap,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.autoUpdate=!1,this.renderer.shadowMap.needsUpdate=!0),this.renderer.setClearColor(this.options.clearColor),this._animationFrameId=null}isLevelOfDetailsEnabled(){return this.levelOfDetailsEnabled}enableLevelOfDetails(){return this.levelOfDetailsEnabled=!0,this}disableLevelOfDetails(){return this.levelOfDetailsEnabled=!1,this}init(){this.options.autoCompileMaterials&&this.compileMaterials(),this._resizeCanvas()}compileMaterials(e=!0){this.renderer.compile(this.awm.sceneManager.scene,this.awm.cameraManager.camera),e&&this.renderer.domElement.addEventListener("webglcontextrestored",()=>{this.compileMaterials(!1)},!1)}start(){this._resizeCanvas(),this._animationFrameId=requestAnimationFrame(this.start.bind(this)),update(),this.awm.cameraManager.control.update(),this._updateLevelOfDetails(this.awm.cameraManager.camera),this.renderer.render(this.awm.sceneManager.scene,this.awm.cameraManager.camera)}pause(){this._animationFrameId&&(cancelAnimationFrame(this._animationFrameId),this._animationFrameId=null)}stop(){this.pause(),getAll().forEach(e=>{e.stop()})}_updateLevelOfDetails(e){const{site:t}=this.awm.objectManager;t._applyLod(e,this.awm.getProjector()),t.getDisplayMode()!==DISPLAY_MODES.NONE&&(t.buildings.forEach(t=>this._updateLevelOfDetailsOnBuilding(t,e)),t.spaces.forEach(t=>this._updateLevelOfDetailsOnSpace(t,e)),t.labels.forEach(t=>t._applyLod(e,this.awm.getProjector(),this.levelOfDetailsEnabled)))}_updateLevelOfDetailsOnBuilding(e,t){e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled),e.getDisplayMode()!==DISPLAY_MODES.NONE&&(e.floors.forEach(e=>this._updateLevelOfDetailsOnFloor(e,t)),e.labels.forEach(e=>e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled)))}_updateLevelOfDetailsOnFloor(e,t){e._applyLod(t,this.awm.getProjector()),e.getDisplayMode()!==DISPLAY_MODES.NONE&&(e.spaces.forEach(e=>this._updateLevelOfDetailsOnSpace(e,t)),e.labels.forEach(e=>e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled)))}_updateLevelOfDetailsOnSpace(e,t){e._applyLod(t,this.awm.getProjector()),e.getDisplayMode()!==DISPLAY_MODES.NONE&&e.labels.forEach(e=>e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled))}_getDevicePixelRatio(){return window.devicePixelRatio||1}_resizeCanvas(){const{width:e,height:t}=this.renderer.getSize(),s=e!==this.container.clientWidth||t!==this.container.clientHeight,i=this.renderer.getPixelRatio()!==this._getDevicePixelRatio();if((s||i)&&(s&&this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),i&&this.renderer.setPixelRatio(this._getDevicePixelRatio()),s)){const{camera:e,control:t}=this.awm.cameraManager;e.aspect=this.container.clientWidth/this.container.clientHeight,e.updateProjectionMatrix(),t.update()}}}const THREE={Vector3:Vector3,MOUSE:MOUSE,Quaternion:Quaternion,Spherical:Spherical,EventDispatcher:EventDispatcher,Vector2:Vector2,TOUCH_MODES:{CLASSIC:1,LEGACY:2,MAP:3}};THREE.OrbitControls=function(e,t){var s,i,o,n,a;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.touchMode=THREE.TOUCH_MODES.CLASSIC,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return m.phi},this.getAzimuthalAngle=function(){return m.theta},this.saveState=function(){r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=function(){r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(l),r.update(),u=d.NONE},this.update=(s=new THREE.Vector3,i=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),o=i.clone().inverse(),n=new THREE.Vector3,a=new THREE.Quaternion,function(){var e=r.object.position;return s.copy(e).sub(r.target),s.applyQuaternion(i),m.setFromVector3(s),r.autoRotate&&u===d.NONE&&P(2*Math.PI/60/60*r.autoRotateSpeed),m.theta+=g.theta,m.phi+=g.phi,m.theta=Math.max(r.minAzimuthAngle,Math.min(r.maxAzimuthAngle,m.theta)),m.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,m.phi)),m.makeSafe(),m.radius*=f,m.radius=Math.max(r.minDistance,Math.min(r.maxDistance,m.radius)),r.target.add(b),s.setFromSpherical(m),s.applyQuaternion(o),e.copy(r.target).add(s),r.object.lookAt(r.target),!0===r.enableDamping?(g.theta*=1-r.dampingFactor,g.phi*=1-r.dampingFactor,b.multiplyScalar(1-r.dampingFactor)):(g.set(0,0,0),b.set(0,0,0)),f=1,!!(y||n.distanceToSquared(r.object.position)>p||8*(1-a.dot(r.object.quaternion))>p)&&(r.dispatchEvent(l),n.copy(r.object.position),a.copy(r.object.quaternion),y=!1,!0)}),this.dispose=function(){r.domElement.removeEventListener("contextmenu",ee,!1),r.domElement.removeEventListener("mousedown",Y,!1),r.domElement.removeEventListener("wheel",Z,!1),r.domElement.removeEventListener("touchstart",J,!1),r.domElement.removeEventListener("touchend",Q,!1),r.domElement.removeEventListener("touchmove",K,!1),document.removeEventListener("mousemove",W,!1),document.removeEventListener("mouseup",X,!1),window.removeEventListener("keydown",q,!1)};var r=this,l={type:"change"},h={type:"start"},c={type:"end"},d={NONE:0,ROTATE_UP:1,ROTATE_LEFT:2,ROTATE:3,DOLLY:4,DOLLY_ROTATE:7,PAN:8,DOLLY_PAN:12},u=d.NONE,p=1e-6,m=new THREE.Spherical,g=new THREE.Spherical,f=1,b=new THREE.Vector3,y=!1,E=new THREE.Vector2,w=new THREE.Vector2,M=new THREE.Vector2,_=new THREE.Vector2,O=new THREE.Vector2,T=new THREE.Vector2,v=new THREE.Vector2,S=new THREE.Vector2,A=new THREE.Vector2,x=new THREE.Vector2,L=new THREE.Vector2,N=new THREE.Vector2;function C(){return Math.pow(.95,r.zoomSpeed)}function P(e){g.theta-=e}function j(e){g.phi-=e}var R,k=(R=new THREE.Vector3,function(e,t){R.setFromMatrixColumn(t,0),R.multiplyScalar(-e),b.add(R)}),D=function(){var e=new THREE.Vector3;return function(t,s){!0===r.screenSpacePanning?e.setFromMatrixColumn(s,1):(e.setFromMatrixColumn(s,0),e.crossVectors(r.object.up,e)),e.multiplyScalar(t),b.add(e)}}(),I=function(){var e=new THREE.Vector3;return function(t,s){var i=r.domElement===document?r.domElement.body:r.domElement;if(r.object.isPerspectiveCamera){var o=r.object.position;e.copy(o).sub(r.target);var n=e.length();n*=Math.tan(r.object.fov/2*Math.PI/180),k(2*t*n/i.clientHeight,r.object.matrix),D(2*s*n/i.clientHeight,r.object.matrix)}else r.object.isOrthographicCamera?(k(t*(r.object.right-r.object.left)/r.object.zoom/i.clientWidth,r.object.matrix),D(s*(r.object.top-r.object.bottom)/r.object.zoom/i.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}}();function H(e){r.object.isPerspectiveCamera?f/=e:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom*e)),r.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function B(e){r.object.isPerspectiveCamera?f*=e:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/e)),r.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function F(e){var t,s;switch(r.touchMode){case THREE.TOUCH_MODES.CLASSIC:case THREE.TOUCH_MODES.LEGACY:t=e.touches[0].pageX,s=e.touches[0].pageY,E.set(t,s);break;case THREE.TOUCH_MODES.MAP:t=e.touches[0].pageX,s=e.touches[0].pageY,E.set(t,s);var i=e.touches[1].pageX,o=e.touches[1].pageY;M.set(i,o);break;default:throw new Error("OrbitControls: Unexpected touchMode")}}function U(e){if(r.enableZoom){var t=e.touches[0].pageX-e.touches[1].pageX,s=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+s*s);x.set(0,i)}}function $(e){if(r.enablePan){var t,s;switch(r.touchMode){case THREE.TOUCH_MODES.CLASSIC:t=.5*(e.touches[0].pageX+e.touches[1].pageX),s=.5*(e.touches[0].pageY+e.touches[1].pageY);break;case THREE.TOUCH_MODES.LEGACY:t=(e.touches[0].pageX+e.touches[1].pageX+e.touches[2].pageX)/3,s=(e.touches[0].pageY+e.touches[1].pageY+e.touches[2].pageY)/3;break;case THREE.TOUCH_MODES.MAP:t=e.touches[0].pageX,s=e.touches[0].pageY;break;default:throw new Error("OrbitControls: Unexpected touchMode")}v.set(t,s)}}function V(e){if(!1!==r.enableRotate&&0!=(u&d.ROTATE))switch(r.touchMode){case THREE.TOUCH_MODES.CLASSIC:case THREE.TOUCH_MODES.LEGACY:w.set(e.touches[0].pageX,e.touches[0].pageY),O.subVectors(w,E).multiplyScalar(r.rotateSpeed);var t=r.domElement===document?r.domElement.body:r.domElement;P(2*Math.PI*O.x/t.clientHeight),j(2*Math.PI*O.y/t.clientHeight),E.copy(w);break;case THREE.TOUCH_MODES.MAP:var s=e.touches[0].pageX,i=e.touches[0].pageY;w.set(s,i);var o=e.touches[1].pageX,n=e.touches[1].pageY;_.set(o,n);var a=O.subVectors(M,E).angle(),l=O.subVectors(_,w).angle();O.subVectors(w,E).multiplyScalar(r.rotateSpeed),T.subVectors(_,M).multiplyScalar(r.rotateSpeed);var h=O.angle(),c=T.angle();if(O.dot(T)>0&&Math.abs(Math.sin(a))<.5&&Math.abs(Math.sin(l))<.5&&Math.abs(Math.cos(h))<.5&&Math.abs(Math.cos(c))<.5){t=r.domElement===document?r.domElement.body:r.domElement;j(2*Math.PI*O.y/t.clientHeight),u=d.ROTATE_UP}else 0!=(u&d.ROTATE_LEFT)&&P((a-l)*r.rotateSpeed);E.copy(w),M.copy(_);break;default:throw new Error("OrbitControls: Unexpected touchMode")}}function z(e){if(!1!==r.enableZoom&&0!=(u&d.DOLLY)){var t=e.touches[0].pageX-e.touches[1].pageX,s=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+s*s);L.set(0,i),N.set(0,Math.pow(L.y/x.y,r.zoomSpeed)),H(N.y),x.copy(L)}}function G(e){if(!1!==r.enablePan&&0!=(u&d.PAN)){var t,s;switch(r.touchMode){case THREE.TOUCH_MODES.CLASSIC:t=.5*(e.touches[0].pageX+e.touches[1].pageX),s=.5*(e.touches[0].pageY+e.touches[1].pageY);break;case THREE.TOUCH_MODES.LEGACY:t=(e.touches[0].pageX+e.touches[1].pageX+e.touches[2].pageX)/3,s=(e.touches[0].pageY+e.touches[1].pageY+e.touches[2].pageY)/3;break;case THREE.TOUCH_MODES.MAP:t=e.touches[0].pageX,s=e.touches[0].pageY;break;default:throw new Error("OrbitControls: Unexpected touchMode")}S.set(t,s),A.subVectors(S,v).multiplyScalar(r.panSpeed),I(A.x,A.y),v.copy(S)}}function Y(e){if(!1!==r.enabled){switch(e.preventDefault(),e.button){case r.mouseButtons.ORBIT:if(!1===r.enableRotate)return;!function(e){E.set(e.clientX,e.clientY)}(e),u=d.ROTATE;break;case r.mouseButtons.ZOOM:if(!1===r.enableZoom)return;!function(e){x.set(e.clientX,e.clientY)}(e),u=d.DOLLY;break;case r.mouseButtons.PAN:if(!1===r.enablePan)return;!function(e){v.set(e.clientX,e.clientY)}(e),u=d.PAN}u!==d.NONE&&(document.addEventListener("mousemove",W,!1),document.addEventListener("mouseup",X,!1),r.dispatchEvent(h))}}function W(e){if(!1!==r.enabled)switch(e.preventDefault(),u){case d.ROTATE:if(!1===r.enableRotate)return;!function(e){w.set(e.clientX,e.clientY),O.subVectors(w,E).multiplyScalar(r.rotateSpeed);var t=r.domElement===document?r.domElement.body:r.domElement;P(2*Math.PI*O.x/t.clientHeight),j(2*Math.PI*O.y/t.clientHeight),E.copy(w),r.update()}(e);break;case d.DOLLY:if(!1===r.enableZoom)return;!function(e){L.set(e.clientX,e.clientY),N.subVectors(L,x),N.y>0?H(C()):N.y<0&&B(C()),x.copy(L),r.update()}(e);break;case d.PAN:if(!1===r.enablePan)return;!function(e){S.set(e.clientX,e.clientY),A.subVectors(S,v).multiplyScalar(r.panSpeed),I(A.x,A.y),v.copy(S),r.update()}(e)}}function X(e){!1!==r.enabled&&(document.removeEventListener("mousemove",W,!1),document.removeEventListener("mouseup",X,!1),r.dispatchEvent(c),u=d.NONE)}function Z(e){!1===r.enabled||!1===r.enableZoom||u!==d.NONE&&u!==d.ROTATE||(e.preventDefault(),e.stopPropagation(),r.dispatchEvent(h),function(e){e.deltaY<0?B(C()):e.deltaY>0&&H(C()),r.update()}(e),r.dispatchEvent(c))}function q(e){!1!==r.enabled&&!1!==r.enableKeys&&!1!==r.enablePan&&function(e){switch(e.keyCode){case r.keys.UP:I(0,r.keyPanSpeed),r.update();break;case r.keys.BOTTOM:I(0,-r.keyPanSpeed),r.update();break;case r.keys.LEFT:I(r.keyPanSpeed,0),r.update();break;case r.keys.RIGHT:I(-r.keyPanSpeed,0),r.update()}}(e)}function J(e){if(!1!==r.enabled){switch(e.preventDefault(),r.touchMode){case THREE.TOUCH_MODES.CLASSIC:!function(e){switch(e.touches.length){case 1:if(!1===r.enableRotate)return;F(e),u=d.ROTATE;break;case 2:if(!1===r.enableZoom&&!1===r.enablePan)return;U(e),$(e),u=d.DOLLY_PAN;break;default:u=d.NONE}u!==d.NONE&&r.dispatchEvent(h)}(e);break;case THREE.TOUCH_MODES.LEGACY:!function(e){switch(e.touches.length){case 1:if(!1===r.enableRotate)return;F(e),u=d.ROTATE;break;case 2:if(!1===r.enableZoom)return;U(e),u=d.DOLLY;break;case 3:if(!1===r.enableZoom)return;$(e),u=d.PAN;break;default:u=d.NONE}}(e);break;case THREE.TOUCH_MODES.MAP:!function(e){switch(e.touches.length){case 1:if(!1===r.enablePan)return;$(e),u=d.PAN;break;case 2:if(!1===r.enableZoom||!1===r.enableRotate)return;F(e),U(e),u=d.DOLLY_ROTATE;break;default:u=d.NONE}}(e);break;default:throw new Error("OrbitControls: unknown touchMode")}u!==d.NONE&&r.dispatchEvent(h)}}function K(e){if(!1!==r.enabled)switch(e.preventDefault(),e.stopPropagation(),r.touchMode){case THREE.TOUCH_MODES.CLASSIC:!function(e){switch(e.touches.length){case 1:V(e),r.update();break;case 2:z(e),G(e),r.update();break;case 3:default:u=d.NONE}}(e);break;case THREE.TOUCH_MODES.LEGACY:!function(e){switch(e.touches.length){case 1:V(e),r.update();break;case 2:z(e),r.update();break;case 3:G(e),r.update();break;default:u=d.NONE}}(e);break;case THREE.TOUCH_MODES.MAP:!function(e){switch(e.touches.length){case 1:G(e),r.update();break;case 2:V(e),z(e),r.update();break;default:u=d.NONE}}(e);break;default:throw new Error("OrbitControls: unknown touchMode")}}function Q(e){!1!==r.enabled&&(r.dispatchEvent(c),u=d.NONE)}function ee(e){!1!==r.enabled&&e.preventDefault()}r.domElement.addEventListener("contextmenu",ee,!1),r.domElement.addEventListener("mousedown",Y,!1),r.domElement.addEventListener("wheel",Z,!1),r.domElement.addEventListener("touchstart",J,!1),r.domElement.addEventListener("touchend",Q,!1),r.domElement.addEventListener("touchmove",K,!1),window.addEventListener("keydown",q,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});const OrbitControls=THREE.OrbitControls,TOUCH_MODES=THREE.TOUCH_MODES,DEFAULT_CALIBRATION={UP:new Vector3(0,0,1),ZOOM_MIN:25,ZOOM_MAX:2e4};class CameraCalibration{constructor(){this.eye=new Vector3,this.up=DEFAULT_CALIBRATION.UP.clone(),this.target=new Vector3,this.zoomMin=DEFAULT_CALIBRATION.ZOOM_MIN,this.zoomMax=DEFAULT_CALIBRATION.ZOOM_MAX}}class CameraCenterOnOptions extends AbstractOptions{reset(){this.zoom=!0,this.fitRatio=1.5}}const box$1=new VisibleBox3;class CameraManager extends EventDispatcher{constructor(e,t){super(),this.awm=e,this.options=t,this.camera=new PerspectiveCamera(45,1,.1,5e4),this.control=null,this.floorPlane=new Plane,this.floorPlane.normal.set(0,0,-1),this.ray=new Ray,this.cameraCalibrations=new Map,this._tween=null}start(){this.control.enabled=!0}stop(){this.control.enabled=!1}init(e){const{canvas:t}=this.awm.engineManager;this.camera.aspect=t.clientWidth/t.clientHeight,this.camera.near=e.meterToAdsumDistance(1),this.camera.far=e.meterToAdsumDistance(1e4),this.camera.up.set(0,0,1),this.camera.updateProjectionMatrix(),this.control=new OrbitControls(this.camera,this.awm.engineManager.canvas),this.control.touchMode=TOUCH_MODES.MAP,this.control.enabled=!1,this.control.enableZoom=!0,this.control.enableRotate=!0,this.control.enableDamping=!1,this.control.enableKeys=!1,this.control.minPolarAngle=0,this.control.maxPolarAngle=5*Math.PI/12,this.control.minDistance=e.meterToAdsumDistance(5),this.control.screenSpacePanning=!1,this.control.mouseButtons={PAN:MOUSE.LEFT,ZOOM:MOUSE.MIDDLE,ORBIT:MOUSE.RIGHT}}centerOnFloor(e,t=!0){this.reset();try{let s=null;if(this.cameraCalibrations.has(e))s=this.cameraCalibrations.get(e);else{console.warn("AdsumWebMap.CameraManager: Missing calibration for centerOnFloor");const t=null===e?this.awm.objectManager.site:e;box$1.setFromObject(t._mesh);const i=new Sphere;box$1.getBoundingSphere(i);const o=new Vector3;t._mesh.getWorldPosition(o),i.center.z=o.z,(s=new CameraCalibration).target.copy(i.center),s.eye.copy(i.center);const n=1.5*i.radius*Math.sin(Math.PI/4);s.eye.setZ(s.eye.z+n),s.eye.setY(s.eye.y-n)}return this.floorPlane.constant=s.target.z,this.camera.up.copy(s.up),this.goTo(s.eye,s.target,t)}catch(e){return Promise.reject(e)}}centerOn(e,t=!0,s=null){this.reset();try{let i=null;null===s?({centerOnOptions:i}=this.options):i=new CameraCenterOnOptions(s);const{size:o,center:n}=e.getSizeAndCenter(),a=this.control.target.clone().sub(this.camera.position),r=n.clone().sub(a);if(i.zoom){const{aspect:e,fov:t}=this.camera,s=Math.max(o.x,o.y,o.z)/(2*Math.atan(Math.PI*t/360)),l=s/e;let h=i.fitRatio*Math.max(s,l);h=Math.min(Math.max(h,this.control.minDistance),this.control.maxDistance);const c=a.normalize().multiplyScalar(h);r.copy(n).sub(c)}return 0!==this.control.target.z-n.z&&(a.normalize(),this.ray.origin.copy(r),this.ray.direction.copy(a),this.ray.intersectPlane(this.floorPlane,n)),this.goTo(r,n,t)}catch(e){return Promise.reject(e)}}setCameraCalibrations(e){this.cameraCalibrations=new Map,e.forEach((e,t)=>{const s=this.awm.objectManager,i=null===t?s.site:s.getFloor(t);if(null===i)return;i._mesh.updateMatrixWorld();const o=new Vector3;if(i._mesh.getWorldPosition(o),e.target.z!==o.z){console.warn(`AdsumWebMap: invalid calibration target of ${i.id}, it's not on the floor`);const t=new Plane;t.normal.set(0,0,-1),t.constant=o.z;const s=new Vector3;s.copy(e.target).sub(e.eye),s.normalize();const n=new Ray;n.origin.copy(e.eye),n.direction.copy(s),n.intersectPlane(t,e.target)}this.cameraCalibrations.set(null===t?null:i,e)})}goTo(e,t,s=!0){return new Promise((i,o)=>{try{if(this.reset(),s){this.control.enabled=!1;const s={positionX:this.camera.position.x,positionY:this.camera.position.y,positionZ:this.camera.position.z,targetX:this.control.target.x,targetY:this.control.target.y,targetZ:this.control.target.z};this._tween=new Tween(s).to({positionX:e.x,positionY:e.y,positionZ:e.z,targetX:t.x,targetY:t.y,targetZ:t.z},700).on("update",()=>{this.camera.position.set(s.positionX,s.positionY,s.positionZ),this.control.target.set(s.targetX,s.targetY,s.targetZ),this.control.update()}).on("stop",()=>{this._setCameraPositionAndTarget(e,t),this.control.enabled=!0,i(!1)}).on("complete",()=>{this.control.enabled=!0,i(!0)}).easing(Easing.Quadratic.InOut).start()}this._setCameraPositionAndTarget(e,t),s||i(!0)}catch(e){o(e)}})}reset(){return null!==this._tween&&(this._tween.stop(),this._tween=null),this}_setCameraPositionAndTarget(e,t){this.camera.position.copy(e),this.control.target.copy(t),this.control.update()}}const MOUSE_EVENTS={click:"click",dblClick:"dblClick"};class MouseManager extends EventDispatcher{constructor(e){super(),this.awm=e,this._mouse=new Vector2,this._raycaster=new Raycaster,this.enabled=!1}start(){this.enabled=!0}stop(){this.enabled=!1}init(){this.awm.engineManager.canvas.addEventListener("mousemove",this._onMouseMove.bind(this));const e=new Manager(this.awm.engineManager.canvas);e.add(new Tap({event:"doubletap",threshold:10,taps:2,posThreshold:50*window.devicePixelRatio})),e.add(new Tap({event:"singletap",threshold:10,time:500,interval:100})),e.get("doubletap").recognizeWith("singletap"),e.get("singletap").requireFailure("doubletap"),e.on("singletap ",this._onMouseClick.bind(this)),e.on("doubletap ",this._onMouseDblClick.bind(this))}_onMouseClick(e){this.enabled&&(this._setMouseCoordinate(e),this.dispatchEvent({type:MOUSE_EVENTS.click,intersects:this._raycast()}))}_onMouseDblClick(e){this.enabled&&(this._setMouseCoordinate(e),this.dispatchEvent({type:MOUSE_EVENTS.dblClick,intersects:this._raycast()}))}_onMouseMove(){}_setMouseCoordinate(e){let t=0,s=0;if(void 0===e.clientX&&void 0===e.clientY){const i=e.target.getBoundingClientRect();t=e.center.x-i.left,s=e.center.y-i.top}else e.offsetX||0===e.offsetX?(t=e.offsetX,s=e.offsetY):(t=e.layerX,s=e.layerY);this._mouse.set(t/this.awm.engineManager.canvas.clientWidth*2-1,-s/this.awm.engineManager.canvas.clientHeight*2+1),this._raycaster.setFromCamera(this._mouse,this.awm.cameraManager.camera),this._raycaster.near=this.awm.cameraManager.camera.near,this._raycaster.far=this.awm.cameraManager.camera.far}_raycast(){const e=[];return this.awm.objectManager.site._raycast(this._raycaster,e),e.sort((e,t)=>e.distance-t.distance),e}}function getAdsumObjectGroundAndPosition(e){let t=null,s=null;switch(e.getType()){case AdsumObjectTypes.SiteObject:case AdsumObjectTypes.FloorObject:t=e;break;case AdsumObjectTypes.BuildingObject:t=e.site,(s=e._mesh.position.clone()).setZ(0);break;case AdsumObjectTypes.SpaceObject:case AdsumObjectTypes.UserObject:t=e.parent,(s=e._mesh.position.clone()).setZ(0);break;case AdsumObjectTypes.LabelObject:case AdsumObjectTypes.LabelTextObject:case AdsumObjectTypes.LabelImageObject:{(s=e._mesh.position.clone()).setZ(0);const{parent:i}=e;i.isSpace?(t=i.parent,s.applyMatrix4(i.matrix)):i.isBuilding?(t=i.site,s.applyMatrix4(i.matrix)):t=i;break}default:throw new Error("Unexpected")}return{ground:t,groundPosition:s}}function getUtmPosition(e,t,s){const i=e._mesh.localToWorld(t.clone());return i.setZ(e.isSite?0:e.altitude),s.adsumToUtm(i)}class PathNode{static create(e,t,s,i,o){return new this(e,t,s,getUtmPosition(t,s,i),o)}static updateFromAdsumObject(e,t,s){const{ground:i,groundPosition:o}=getAdsumObjectGroundAndPosition(t,s);e.ground=i,e.groundPosition=o,e.utmPosition=getUtmPosition(i,o,s)}static createFromAdsumObject(e,t){const{ground:s,groundPosition:i}=getAdsumObjectGroundAndPosition(e,t);return this.create(e.placeId,s,i,t,{isGate:!1,isCheckpoint:!1,isFloorAccess:!1})}constructor(e,t,s,i,{isGate:o,isCheckpoint:n,isFloorAccess:a}){this.id=e||Symbol("PathNodeId"),this.ground=t,this.links=new Set,this.utmPosition=i,this.groundPosition=s,this.isDynamic=!1,this.isGate=Boolean(o),this.isCheckpoint=Boolean(n),this.isFloorAccess=Boolean(a)}getLinkTo(e){let t=null;return this.links.forEach(s=>{s.to!==e&&s.from!==e||(t=s)}),t}}const PATH_LINK_TYPES={STANDARD:0,ONLY_DISABLED:1,NOT_DISABLED:2,CLOSED:3};class PathLink{constructor(e,t,s,i,o=!0){this.id=e,this.type=t,this.from=s,this.to=i,this.bidirectional=o,this.distance=Math.sqrt((s.utmPosition.N-i.utmPosition.N)**2+(s.utmPosition.E-i.utmPosition.E)**2+(s.utmPosition.alt-i.utmPosition.alt)**2)}isAccessible(e){return this.type===PATH_LINK_TYPES.STANDARD||(e?this.type===PATH_LINK_TYPES.ONLY_DISABLED:this.type===PATH_LINK_TYPES.NOT_DISABLED)}}class AStar{constructor(e){this.pathNetwork=e,this._cache=new Map,this._computing=new Map,this._symbolStrings=new Map,this._symbolIncrement=0}search(e,t,s=!1){if(this._isCached(e,t,s))return this._getFromCache(e,t,s);if(this._isComputing(e,t,s))return this._getFromComputing(e,t,s);const i=Promise.resolve().then(()=>{const i=new Map,o=new Set,n=new Map;for(n.set(e.id,{d:0,parent:null}),n.set(t.id,{d:1/0,parent:null}),i.set(e.id,e);i.size>0;){const e=Array.from(i.values());let a=e[0];for(let t=1;t<e.length;t++){const s=e[t];n.get(s.id).d<n.get(a.id).d&&(a=s)}if(a===t){const e=[a];let{parent:t}=n.get(a.id);for(;null!==t;){e.push(t);const s=n.get(t.id);({parent:t}=s)}return e.reverse()}i.delete(a.id),o.add(a.id);const r=[],l=[];a.links.forEach(e=>{e.isAccessible(s)&&(e.from===a?(r.push(e.to),l.push(e.distance)):e.to===a&&e.bidirectional&&(r.push(e.from),l.push(e.distance)))});for(let e=0;e<r.length;e++){const t=r[e];if(o.has(t.id))continue;i.has(t.id)||(n.set(t.id,{d:1/0,parent:null}),i.set(t.id,t));const s=n.get(a.id).d+l[e],h=n.get(t.id);s<h.d&&(h.parent=a,h.d=s)}}return[]});return this._addToComputing(e,t,s,i),i}_addToCache(e,t,s,i){if(e.isDynamic||t.isDynamic)return;const o=this._getCacheKey(e,t,s);this._cache.set(o,i.map(e=>e.id))}_getFromCache(e,t,s){const i=this._getCacheKey(e,t,s);return Promise.resolve(this._cache.get(i).map(e=>this.pathNetwork.nodes.get(e)))}_getCacheKey(e,t,s){return`${this._stringifyId(e.id)}:${this._stringifyId(t.id)}${s?":pmr":""}`}_stringifyId(e){return"symbol"!=typeof e?`${e}`:(this._symbolStrings.has(e)||this._symbolStrings.set(e,`s${this._symbolIncrement++}`),this._symbolStrings.get(e))}_isCached(e,t,s){return this._cache.has(this._getCacheKey(e,t,s))}_addToComputing(e,t,s,i){const o=this._getCacheKey(e,t,s);this._computing.set(o,i),i.then(i=>{this._addToCache(e,t,s,i),this._computing.delete(o)})}_getFromComputing(e,t,s){const i=this._getCacheKey(e,t,s);return this._computing.get(i).then(()=>this.search(e,t,s))}_isComputing(e,t,s){return this._computing.has(this._getCacheKey(e,t,s))}}class PathSection{constructor(e=null,t=null,s=null,i=[],o=[]){this.from=e,this.to=s,this.ground=t,this.grounds=i,this.nodes=o,this._distance=null,this._curve=null}isInterGround(){return this.grounds.length>1}getLastGround(){return this.grounds[this.grounds.length-1]}getDistance(){return null===this._distance&&this._initCurveAndDistance(),this._distance}getCurve(){return this.nodes.length<2?null:(null===this._curve&&this._initCurveAndDistance(),this._curve)}_initCurveAndDistance(){this._curve=[],this._distance=0;for(let e=0;e<this.nodes.length-1;e++){const t=this.nodes[e].getLinkTo(this.nodes[e+1]);this._distance+=t.distance;const s=this.nodes[e],i=this.nodes[e+1];this._curve.push({from:s,to:i,distance:t.distance})}}getRealInterval(e){let t=e;e>this.getDistance()/3&&(console.warn("AdsumWebMap.PathSection.interpolate: short pathSection"),t=this.getDistance()/3);const s=Math.floor(this.getDistance()/t);return this.getDistance()/s}interpolate(e){if(null===this.getCurve())return[];const t=this.getRealInterval(e),s=Math.round(this.getDistance()/t),i=[];for(let e=0;e<=s;e++)i.push(this.at(t*e));return i}at(e,t=new Vector3){const s=this.getCurve();if(null===s)return null;let i=e;for(let e=0;e<s.length;e++){const{from:o,to:n,distance:a}=s[e];if(!(a<i)){const e=i/a;return t.lerpVectors(this.getLocalNodePosition(o),this.getLocalNodePosition(n),e),t}i-=a}const{to:o}=s[s.length-1];return this.getLocalNodePosition(o)}getLocalNodePosition(e){if(e.ground===this.ground)return e.groundPosition.clone();const t=e.groundPosition.clone();return e.ground._mesh.localToWorld(t),this.ground._mesh.worldToLocal(t),t}}class PathNetwork{constructor(e){this.awm=e,this.nodes=new Map,this.spaceGatesByAdsumObjectId=new Map,this.buildingGatesByAdsumObjectId=new Map,this.aStar=new AStar(this)}init(e){e.get("nodes").forEach(e=>{const{parent:t,ground:s}=this._findParentAndGround(e.location);if(null===t)return void console.warn("AdsumWebMap.PathNetwork: invalid node");const i=new Vector3(e.position.x,e.position.y,e.position.z),o=PathNode.create(e.id,s,i,this.awm.projector,e);this.nodes.set(o.id,o),o.isGate&&("STORE"===e.location.type||"SHAPE"===e.location.type?(this.spaceGatesByAdsumObjectId.has(e.location.id)||this.spaceGatesByAdsumObjectId.set(e.location.id,[]),this.spaceGatesByAdsumObjectId.get(e.location.id).push(o)):"BUILDING"===e.location.type?(this.buildingGatesByAdsumObjectId.has(e.location.id)||this.buildingGatesByAdsumObjectId.set(e.location.id,[]),this.buildingGatesByAdsumObjectId.get(e.location.id).push(o)):console.warn(`AdsumWebMap.PathNetwork: Invalid node gate on ${e.type}#${e.id}`))}),e.get("links").forEach(e=>{const t=this.nodes.get(e.from),s=this.nodes.get(e.to);if(void 0===t||void 0===s)return void console.warn("AdsumWebMap.PathNetwork: invalid link");const i=new PathLink(e.id,e.type,t,s,e.bidirectional);t.links.add(i),i.bidirectional&&s.links.add(i)})}computePath(e){const{from:t,to:s}=e;return!t.pathNode.isDynamic&&this.nodes.has(t.pathNode.id)||this.attachNodeLocation(t),!s.pathNode.isDynamic&&this.nodes.has(s.pathNode.id)||this.attachNodeLocation(s),this.aStar.search(t.pathNode,s.pathNode,e.pmr).then(t=>{this._buildPathSections(e,t)})}attachNodeLocation(e){const{ground:t,groundPosition:s}=e.pathNode;let i=null;if(e.adsumObject&&e.adsumObject.isSpace)i=this.spaceGatesByAdsumObjectId.get(e.adsumObject.id)||[];else if(e.adsumObject&&e.adsumObject.isBuilding)i=this.buildingGatesByAdsumObjectId.get(e.adsumObject.id)||[];else{i=[];let o=1/0;const n=[];if(this.nodes.forEach(s=>{if(s!==e.pathNode&&s.ground===t){const t=s.groundPosition.distanceToSquared(e.pathNode.groundPosition);t<=9*o&&n.push({squareDistance:t,node:s}),t<o&&(o=t)}}),o!==1/0){n.sort((e,t)=>e.squareDistance-t.squareDistance);const e=new Raycaster(t._mesh.localToWorld(s.clone())),a=[],r=[];n.forEach(({squareDistance:s,node:n})=>{if(!(s>9*o)){e.ray.direction=t._mesh.localToWorld(n.groundPosition.clone()),e.ray.direction.sub(e.ray.origin),e.near=0,e.far=e.ray.direction.length(),e.ray.direction.normalize();for(let t=0;t<r.length;t++)if(r[t].angleTo(e.ray.direction)<Math.PI/4)return;a.length=0;for(let s=0;s<t._mesh.children.length;s++){const i=t._mesh.children[s],{adsumObject:o}=i;if(!(o&&(o.isLabel||o.isUser))&&(e.intersectObject(i,!1,a),0!==a.length))return}i.push(n),r.push(e.ray.direction)}})}}e.pathNode.links.forEach(t=>{t.from.links.delete(t),t.to.links.delete(t),e.pathNode.links.delete(t)}),i.forEach(t=>{const s=new PathLink(Symbol("PathLinkId"),PATH_LINK_TYPES.STANDARD,e.pathNode,t);e.pathNode.links.add(s),t.links.add(s)}),this.nodes.set(e.pathNode.id,e.pathNode),e.pathNode.needsUpdate=!1}_findParentAndGround(e){let t=null,s=null;switch(e.type){case"STORE":case"SHAPE":null!==(t=this.awm.objectManager.getSpace(e.id))&&(s=t.parent);break;case"FLOOR":null!==(t=this.awm.objectManager.getFloor(e.id))&&(s=t);break;case"BUILDING":s=(t=this.awm.objectManager.getBuilding(e.id)).site;break;case"SITE":s=t=this.awm.objectManager.site;break;default:console.warn(`AdsumWebMap.WayfindingManager.PathNetwork: unknown location.type ${e.type} `)}return null===t&&console.warn(`AdsumWebMap.WayfindingManager.PathNetwork: invalid location ${e.type}#${e.id}`),{parent:t,ground:s}}_buildPathSections(e,t){if(t.length<2)throw new Error("AdsumWebMap.PathNetwork: No path found to destination");const s=[],i=this.constructor._detectPathBreakpoints(t);let o=0;for(let e=0;e<i.length;e++){const n=i[e];s.push(this._getPathSection(o,n,t)),o=n}s.push(this._getPathSection(o,t.length-1,t)),e.setPathSections(s)}_getPathSection(e,t,s){const i=s[e],o=s[t],n=this.getPathNodeLocation(i),a=this.getPathNodeLocation(o),r=[],l=[];for(let i=e;i<=t;i++)0!==r.length&&r[r.length-1]===s[i].ground||r.push(s[i].ground),l.push(s[i]);return new PathSection(n,r[0],a,r,l)}getPathNodeLocation(e){const{locationRepository:t}=this.awm.wayfindingManager;return t.locationsByPathNodeId.has(e.id)?t.locationsByPathNodeId.get(e.id):null}static _detectPathBreakpoints(e){if(e.length<2)throw new Error("AdsumWebMap.PathNetwork: No path found to destination");const t=[];for(let s=1;s<e.length-1;s++){const i=e[s-1],o=e[s],n=e[s+1],a=i.ground!==o.ground,r=o.ground!==n.ground;o.isCheckpoint?t.push(s):(a||r)&&a!==r&&t.push(s)}return t}}class BasicDotPathSectionDrawer{constructor(e,t,s){this.pathSectionObject=e,this.cameraManager=t,this.projector=s,this.speed=30,this.center=!0,this.tweens=[]}draw(){const e=[],t=this.pathSectionObject._mesh.children;for(let s=0;s<t.length;s++){const t=this.projector.adsumDistanceToMeter(this.pathSectionObject.patternSpace)/this.speed*s*1e3;e.push(this._showPattern(s,t))}return this.pathSectionObject._mesh.visible=!0,this.center&&e.push(this.cameraManager.centerOn(this.pathSectionObject)),this.pathSectionObject.animations.push(this),Promise.all(e).then(()=>{})}stop(){this.tweens.forEach(e=>{e.stop()})}_showPattern(e,t){return new Promise((s,i)=>{const o=this.pathSectionObject._mesh.children[e],n={opacity:0};o.traverse(e=>{e.material&&(e.material.opacity=0,e.material.transparent=!0)});const a=new Tween(n).to({opacity:1},1e3).delay(t).easing(Easing.Exponential.In).on("update",()=>{o.traverse(e=>{e.material&&(e.material.opacity=n.opacity)})}).on("complete",()=>{o.traverse(e=>{e.material&&(e.material.opacity=1)}),s(!0)}).on("stop",()=>{i(new Error("Path was stopped"))}).start();this.tweens.push(a)})}}class AdsumLocation{constructor(e=null,t=null,s=null){this.isLocation=!0,this.id=e,this.pathNode=t,this.adsumObject=s}updateFromObjectPosition(e){PathNode.updateFromAdsumObject(this.pathNode,this.adsumObject,e)}}class LocationRepository{constructor(){this.locations=new Map,this.locationsByAdsumObject=new Map,this.locationsByPathNodeId=new Map,this.projector=null,this.objectManager=null,this.pathNetwork=null,this.userLocation=null}init(e,t,s,i){this.projector=e,this.objectManager=s,this.pathNetwork=t,i.forEach(e=>{if(null!==e.path_node_id&&t.nodes.has(e.path_node_id)){const i=t.nodes.get(e.path_node_id);let o=null;e.custom_objects.size>0&&(o=s.getLabel(e.custom_objects.at(0).value));const n=new AdsumLocation(e.id,i,o);this.locations.set(n.id,n),this.locationsByPathNodeId.set(n.pathNode.id,n),null!==o&&this.locationsByAdsumObject.set(o,n)}}),s.labels.forEach(e=>{if(e.parent.isBuilding||e.parent.isSpace||this.locations.has(e.placeId))return;const t=new AdsumLocation(e.placeId,PathNode.createFromAdsumObject(e,this.projector),e);this.locations.set(t.id,t),this.locationsByAdsumObject.set(e,t),this.locationsByPathNodeId.set(t.pathNode.id,t),this.pathNetwork.attachNodeLocation(t)}),s.spaces.forEach(e=>{const t=new AdsumLocation(e.placeId,PathNode.createFromAdsumObject(e,this.projector),e);this.locations.set(t.id,t),this.locationsByAdsumObject.set(e,t),this.locationsByPathNodeId.set(t.pathNode.id,t),this.pathNetwork.attachNodeLocation(t)}),s.buildings.forEach(e=>{const t=new AdsumLocation(e.placeId,PathNode.createFromAdsumObject(e,this.projector),e);this.locations.set(t.id,t),this.locationsByAdsumObject.set(e,t),this.locationsByPathNodeId.set(t.pathNode.id,t),this.pathNetwork.attachNodeLocation(t)})}createUserLocation(){if(null!==this.userLocation)throw new Error("Unexpected");const e=Symbol("UserLocation");this.userLocation=new AdsumLocation(e,PathNode.createFromAdsumObject(this.objectManager.user,this.projector),this.objectManager.user),this.userLocation.pathNode.isDynamic=!0,this.locations.set(e,this.userLocation),this.locationsByPathNodeId.set(this.userLocation.pathNode.id,this.userLocation)}get(e){return this.locations.has(e)?this.locations.get(e):null}getByAdsumObject(e){return this.locationsByAdsumObject.has(e)?this.locationsByAdsumObject.get(e):null}}const WayfindingEvents={user:{position:{didChanged:"wayfinding.user.position.didChanged"}}};class WayfindingManager extends EventDispatcher{constructor(e,t){super(),this.awm=e,this.projector=null,this.locationRepository=new LocationRepository,this.pathNetwork=new PathNetwork(e),this.options=t}init(e){this.projector=e.projector,this.pathNetwork.init(e.paths),this.options.pathBuilder.init(this.projector,this.awm.objectManager),this.locationRepository.init(this.projector,this.pathNetwork,this.awm.objectManager,e.places)}computePath(e){return this.removePath(e),null===e.from&&(e.from=this.locationRepository.userLocation,null===e.from)?Promise.reject(new Error("AdsumWebMap.WayfindingManager: cannot compute path because user position is not set")):null===e.to&&(e.to=this.locationRepository.userLocation,null===e.to)?Promise.reject(new Error("AdsumWebMap.WayfindingManager: cannot compute path because user position is not set")):this.pathNetwork.computePath(e)}removePath(e){e.getPathSections(!0).forEach(e=>{this.removePathSection(e)})}drawPathSection(e){this.removePathSection(e);const t=this.options.pathBuilder.build(e);return new BasicDotPathSectionDrawer(t,this.awm.cameraManager,this.projector).draw()}removePathSection(e){this.awm.objectManager.pathSectionObjects.forEach(t=>{t.pathSection===e&&t._dispose()})}getUserUtmPosition(){const{userLocation:e}=this.locationRepository;return null===e?null:{utm:e.pathNode.utmPosition,floor:e.adsumObject.parent.isFloor?e.adsumObject.parent:null}}getUserGpsPosition(){if(null===this.locationRepository.userLocation)return null;const{utm:e,floor:t}=this.getUserUtmPosition();return{gps:this.projector.utmToGps(e),floor:t}}setUserAdsumPosition(e,t=null,s=!1){const{x:i,y:o,z:n}=e,a=null===t?this.awm.objectManager.site:t,r=this.awm.objectManager.user;return r._mesh.position.set(i,o,n),s&&a._mesh.worldToLocal(r._mesh.position),r._mesh.position.setZ(this.projector.meterToAdsumDistance(.05)),a._addChild(r),r.parent=a,r.update(),null===this.locationRepository.userLocation?this.locationRepository.createUserLocation():this.locationRepository.userLocation.updateFromObjectPosition(this.projector),this.dispatchEvent({type:WayfindingEvents.user.position.didChanged,floor:t}),this}setUserGpsPosition(e,t=null){return this.setUserAdsumPosition(this.projector.gpsToAdsum(e),t,!0)}setUserUtmPosition(e,t=null){return this.setUserAdsumPosition(this.projector.utmToAdsum(e),t,!0)}getUserDistanceFromPath(e){return Math.min(...e.getPathSections(!0).map(e=>this.getUserDistanceFromPathSection(e)))}getUserDistanceFromPathSection(e){const{userLocation:t}=this.locationRepository;if(null===t)throw new Error("AdsumWebMap.WayfindingManager.getUserDistanceFromPathSection: no user position set");if(e.ground!==t.pathNode.ground)return 1/0;const s=new Vector3,i=new Line3,o=e.getCurve(),{groundPosition:n}=t.pathNode;let a=1/0;return null===o?e.nodes.length>0&&(a=n.distanceTo(e.nodes[0].groundPosition)):o.forEach(({from:e,to:t})=>{i.set(e,t),i.closestPointToPoint(n,!0,s);const o=n.distanceTo(s);o<a&&(a=o)}),this.projector.adsumDistanceToMeter(a)}}class EngineOptions extends AbstractOptions{reset(){super.reset(),this.container=null,this.gpuPower="high-performance",this.autoCompileMaterials=!0,this.clearColor=16777215,this.fogEnabled=!1,this.fogRatio=0,this.fogColor=16777215,this.backgroundImage=null,this.shadowEnabled=!1,this.shadowSize=2048}}class CameraOptions extends AbstractOptions{reset(){super.reset(),this.centerOnOptions=new CameraCenterOnOptions,this.force2D=!1,this.zoomEnabled=!0,this.rotationEnabled=!0,this.keepInFloorBounds=!1}}class PathSectionObjectOptions extends AdsumObject3DOptions{static convert(e){return e.isPathSectionObjectOptions?e:new this(e)}reset(){super.reset(),this.isPathSectionObjectOptions=!0,this.pathSection=null,this.patternSpace=null}}class PathSectionObject extends AdsumObject3D{constructor(e={}){const t=PathSectionObjectOptions.convert(e);super(t),this.isPathSection=!0,this.pathSection=t.pathSection,this.patternSpace=t.patternSpace,this.animations=[]}getType(){return AdsumObjectTypes.PathSectionObject}_dispose(){this.animations.forEach(e=>{e.stop()}),this._mesh.traverse(e=>{e.material&&e.isMaterial&&e.material.dispose()}),null!==this._mesh.parent&&this._mesh.parent.remove(this._mesh)}}class DotPathBuilderOptions extends AbstractOptions{reset(){super.reset(),this.patternSpace=5,this.patternSize=1,this.patternMesh=null}}const yAxis=new Vector3(0,1,0),direction=new Vector3;class DotPathBuilder{constructor(e={}){this.projector=null,this.objectManager=null,this.options=new DotPathBuilderOptions(e)}init(e,t){this.projector=e,this.objectManager=t}build(e){const t=new Group;t.visible=!1;const s=e.interpolate(this.options.patternSpace);for(let e=0;e<s.length-1;e++){const i=s[e],o=s[e+1],n=this._createPattern();n.position.copy(i),direction.subVectors(o,n.position).normalize(),n.quaternion.setFromUnitVectors(yAxis,direction),t.add(n)}e.isInterGround()||t.position.setZ(this.projector.meterToAdsumDistance(.025));const i=new PathSectionObject({pathSection:e,patternSpace:this.options.patternSpace});return i._setMesh(t),e.ground._addChild(i),i.update(),this.objectManager.pathSectionObjects.set(i.id,i),i}_createPattern(){null===this.options.patternMesh&&(this.options.patternMesh=this._createDefaultPattern());const e=this.options.patternMesh.clone();return e.traverse(e=>{e.material&&e.material.isMaterial&&(e.material=e.material.clone())}),e}_createDefaultPattern(){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=64,e.height=64;const s=.5*e.height,i=.65*e.width,o=(e.width-i)/2,n=(e.height-s)/2;t.arc(e.width/2,e.height/2,35,0,2*Math.PI),t.fillStyle="#0bbfba",t.fill(),t.beginPath(),t.moveTo(o,n+s),t.lineTo(o+i/2,n),t.lineTo(o+i,n+s),t.lineTo(o+i-10,n+s),t.lineTo(o+i/2,n+2*s*10/i),t.lineTo(o+10,n+s),t.closePath(),t.fillStyle="#ffffff",t.fill(),t.lineWidth=1,t.strokeStyle="#000000",t.stroke();const a=new CanvasTexture(e),r=new MeshBasicMaterial({color:16777215,map:a,side:FrontSide}),l=new PlaneGeometry(this.projector.meterToAdsumDistance(this.options.patternSize),this.projector.meterToAdsumDistance(this.options.patternSize));return new Mesh(l,r)}}class WayfindingOptions extends AbstractOptions{reset(){super.reset(),this.pathBuilder=new DotPathBuilder}}class Options extends AbstractOptions{reset(){super.reset(),this.engine=new EngineOptions,this.camera=new CameraOptions,this.wayfinding=new WayfindingOptions,this.loader=null}}Cache.enabled=!0;class AdsumWebMap{constructor(e){const t=new Options(e);this.objectManager=new ObjectManager,this.sceneManager=new SceneManager(this),this.engineManager=new EngineManager(this,t.engine),this.cameraManager=new CameraManager(this,t.camera),this.mouseManager=new MouseManager(this),this.wayfindingManager=new WayfindingManager(this,t.wayfinding),this.deviceId=null,this.defaultFloor=null,this.loader=t.loader}init(e=null){return null!==e&&(this.loader=e),this.loader.load().then(e=>(this.projector=e.projector,this.objectManager.init(e,this.projector),this.sceneManager.init(e),this.cameraManager.init(this.projector),this.engineManager.init(e),this.mouseManager.init(),this.wayfindingManager.init(e),this.setDeviceId(e.deviceId,!1)))}start(){this.engineManager.start(),this.mouseManager.start(),this.cameraManager.start()}stop(){this.engineManager.stop(),this.mouseManager.stop(),this.cameraManager.stop()}getDeviceId(){return this.deviceId}getProjector(){return this.projector}setDeviceId(e,t=!0){return this.deviceId=e,this.defaultFloor=null,this.loader.loadCalibration(this.deviceId).then(({cameraCalibrations:e,defaultFloorId:s,userPosition:i})=>(null!==i&&(null===i.floorId?this.wayfindingManager.setUserAdsumPosition(i.position,null,!0):this.wayfindingManager.setUserAdsumPosition(i.position,this.objectManager.getFloor(i.floorId),!0)),this.cameraManager.setCameraCalibrations(e),null!==s&&(this.defaultFloor=this.objectManager.getFloor(s)),this.sceneManager.setCurrentFloor(this.defaultFloor,t))).then(()=>this.cameraManager.centerOnFloor(this.defaultFloor,t)).then(()=>{})}}class AdsumLoaderOptions extends AbstractOptions{reset(){super.reset(),this.entityManager=null,this.shadowEnabled=!1,this.shadowMapSize=2048,this.fogEnabled=!1,this.fogRatio=0,this.fogColor=16777215,this.preferAmbientOcclusion=!0,this.shapeAmbientOcclusionTopColor=16777215,this.shapeAmbientOcclusionBottomColor=8421504,this.deviceId=null}preferLambertMaterial(){return!1}advancedLightingEnabled(){return!0}}class AdsumTextureLoader{constructor(e,t){this.texturesByReference=new Map;const s=[FILE_CONTEXTS.TEXTURE];t&&s.push(FILE_CONTEXTS.TEXTURE_OCCLUSION),e.findBy({context:e=>s.includes(e)}).forEach(e=>{this.texturesByReference.set(e.reference,e)}),this.threeLoader=new TextureLoader,this.regex=/\/texture\/reference\/(?:[a-f0-9]{2,3}\/)*(.*)$/}load(e,t,s,i){const o=this.regex.exec(e);let n=e;if(null!==o){const e=o[1];this.texturesByReference.has(e)&&({uri:n}=this.texturesByReference.get(e))}return this.threeLoader.load(n,t,s,i)}}const LABEL_OBJECTS_ORIENTATION_MODES={BILLBOARD:"BILLBOARD",STATIC:"STATIC",FLIP:"FLIP"};class LabelObjectOptions extends AdsumObject3DOptions{static convert(e){return e.isLabelObjectOptions?e:new this(e)}reset(){super.reset(),this.isLabelObjectOptions=!0,this.autoScale=!1,this.isPermanentDisplay=!0,this.orientationMode=LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD,this.offset={x:0,y:0,z:0},this.opacity=1,this.rotation=0,this.scale={x:1,y:1,z:1}}}const v$1=new Vector3,worldPosition=new Vector3,zAxis=new Vector3(0,0,1);class LabelObject extends AdsumObject3D{constructor(e={}){const t=LabelObjectOptions.convert(e);super(t),this.autoScale=t.autoScale,this.isLabel=!0,this.isPermanentDisplay=t.isPermanentDisplay,this.offset=new Vector3(0,0,0),this.offset.copy(t.offset),this.orientationMode=null,this.setOrientationMode(t.orientationMode),this.opacity=t.opacity,this.parent=null,this.rotation=t.rotation%360,this.scale=new Vector3(1,1,1),this.scale.copy(t.scale),this.selected=!1}getType(){return AdsumObjectTypes.LabelObject}moveTo(e,t,s){return this.offset.set(e,t,s),this._updatePosition(),this}moveBy(e,t,s){return this.moveTo(this.offset.x+e,this.offset.y+t,this.offset.z+s)}setAutoScale(e){return this.autoScale=Boolean(e),this._updatePosition(),this}setOrientationMode(e){switch(e){case LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD:case LABEL_OBJECTS_ORIENTATION_MODES.STATIC:this.orientationMode=e;break;default:console.warn(`AdsumWebMap.LabelImageObject#create: Unsupported orientation mode ${e}`)}return this._applyRotation(),this._updatePosition(),this}setOpacity(e){return this.opacity=e,this._updateVisibility(),this}setPermanentDisplay(e){return this.isPermanentDisplay=Boolean(e),this._updateVisibility(),this}setRotation(e){return this.orientationMode!==LABEL_OBJECTS_ORIENTATION_MODES.STATIC&&console.warn("AdsumWebMap.LabelObject.setRotation: only static labels can be rotated"),this.rotation=e%360,this._applyRotation(),this._updatePosition(),this}setScale(e,t,s){return this.scale.set(e,t,s),this._updatePosition(),this}select(){return this.selected=!0,this._updateVisibility(),this}unselect(){return this.selected=!1,this._updateVisibility(),this}_updateVisibility(){if(null!==this._mesh){const e=this.isPermanentDisplay||this.selected;this.setDisplayMode(e?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.NONE),this._mesh.material.opacity=this.opacity}}_applyRotation(){return null!==this._mesh&&this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.STATIC&&this._mesh.setRotationFromAxisAngle(zAxis,this.rotation*Math.PI/180),this}_onBeforeRender(e,t,s,i,o,n){super._onBeforeRender(e,t,s,i,o,n);let a=!1;this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD&&(this._mesh.quaternion.setFromRotationMatrix(this._mesh.parent.matrixWorld).inverse(),this._mesh.quaternion.multiply(s.quaternion).normalize(),a=!0),this._mesh.getWorldPosition(worldPosition);const r=v$1.subVectors(s.position,worldPosition).length();if(this.autoScale){const e=Math.tan(s.fov*Math.PI/180/2)*r/1e3;this.setScale(e,e,e)}a&&this._mesh.updateMatrixWorld()}_applyLod(e,t,s){return this._updateVisibility(),super._applyLod(e,t,s),this.selected&&this._updateVisibility(),!1}_setMesh(e){return super._setMesh(e),this._updateVisibility(),this._applyRotation(),this._updatePosition(),this}_updatePosition(){if(null!==this._mesh)if(this._mesh.position.copy(this.offset),this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD){this._mesh.geometry.computeBoundingBox();const{max:e,min:t}=this._mesh.geometry.boundingBox,s=e.y-t.y;this._mesh.scale.copy(this.scale),this._mesh.position.z+=this.scale.z*s/2}else this._mesh.position.z+=1.1,this._mesh.scale.set(this.scale.x,this.scale.y,1)}}class LabelImageObjectOptions extends LabelObjectOptions{static convert(e){return e.isLabelImageObjectOptions?e:new this(e)}reset(){super.reset(),this.isLabelImageObjectOptions=!0,this.width=null,this.height=null,this.image=null}}const textureLoader=new TextureLoader;class LabelImageObject extends LabelObject{constructor(e={}){const t=LabelImageObjectOptions.convert(e);super(t),this.isLabelImage=!0,this.width=t.width,this.height=t.height,this.image=t.image,this._updateMesh()}getType(){return AdsumObjectTypes.LabelImageObject}setImage(e){return this.image=e,this._updateMesh(),this}setHeight(e){return this.height=e,this._updateMesh(),this}setWidth(e){return this.width=e,this._updateMesh(),this}_updateMesh(){if(null===this._mesh){const e=new PlaneGeometry(this.width,this.height),t=new MeshBasicMaterial({color:16777215,map:this._createTexture(),side:FrontSide,transparent:!0,depthWrite:!1});this._setMesh(new Mesh(e,t))}else this._mesh.material.map.dispose(),this._mesh.material.map=this._createTexture(),this._mesh.geometry.width===this.width&&this._mesh.geometry.height===this.height||(this._mesh.geometry.dispose(),this._mesh.geometry=new PlaneGeometry(this.width,this.height),this._updatePosition())}_createTexture(){if("string"==typeof this.image){const e=textureLoader.load(this.image,()=>{e.needsUpdate=!0},void 0,e=>{console.error(`AdsumWebMap.LabelImageObject: unable to load image ${this.image}`,e)});return e}if(this.image instanceof HTMLImageElement){const e=new Texture(this.image);return this.image.complete?e.needsUpdate=!0:(this.image.addEventListener("load",()=>{e.needsUpdate=!0},!1),this.image.addEventListener("error",e=>{console.error(`AdsumWebMap.LabelImageObject: unable to load image ${this.image}`,e)},!1)),e}if(this.image instanceof HTMLCanvasElement)return new CanvasTexture(this.image);throw new TypeError("AdsumWebMap.LabelImageObject: invalid image; expected an url, an image or a canvas")}}const fontHeightCache=new Map,color=new Color;let workingCanvas=null;const TextUtil={createTextTexture(e,t,s=document.createElement("canvas")){const i=e.split("\n");null===workingCanvas&&(workingCanvas=document.createElement("canvas"));const o=TextUtil.getFontHeight(t.size,t.font,workingCanvas),n=o*t.lineHeight,a=i.length*n;let r=0;i.forEach(e=>{r=Math.max(r,TextUtil.getTextWidth(e,t.size,t.font,workingCanvas))});const l=r+t.backgroundPadding,h=a+t.backgroundPadding;workingCanvas.width=l*t.quality,workingCanvas.height=h*t.quality;const c=workingCanvas.getContext("2d");if(c.scale(t.quality,t.quality),c.clearRect(0,0,l,h),t.backgroundColor){color.set(t.backgroundColor);const e=255*color.r,s=255*color.g,i=255*color.b,o=t.backgroundOpacity;c.fillStyle=`rgba(${e},${s},${i},${o})`,TextUtil.fillRoundedRect(c,0,0,l,h,t.backgroundRadius)}c.textBaseline="hanging",c.textAlign="center",c.font=`${t.size}pt ${t.font}`,color.set(t.color),c.fillStyle=`rgb(${255*color.r},${255*color.g},${255*color.b})`;const d=(n-o)/2;let u=d+t.backgroundPadding/2;for(let e=0;e<i.length;e++)c.fillText(i[e],Math.round(l/2),Math.round(u)),u+=n+d;return s.width=Math$1.floorPowerOfTwo(workingCanvas.width),s.height=Math$1.floorPowerOfTwo(workingCanvas.height),s.getContext("2d").drawImage(workingCanvas,0,0,workingCanvas.width,workingCanvas.height,0,0,s.width,s.height),{canvas:s,width:l,height:h}},fillRoundedRect(e,t,s,i,o,n){e.beginPath(),e.moveTo(t+n,s),e.lineTo(t+i-n,s),e.quadraticCurveTo(t+i,s,t+i,s+n),e.lineTo(t+i,s+o-n),e.quadraticCurveTo(t+i,s+o,t+i-n,s+o),e.lineTo(t+n,s+o),e.quadraticCurveTo(t,s+o,t,s+o-n),e.lineTo(t,s+n),e.quadraticCurveTo(t,s,t+n,s),e.closePath(),e.fill()},getFontHeight(e,t,s){const i=`${e}pt ${t}`;if(fontHeightCache.has(i))return fontHeightCache.get(i);s.width=1e3,s.height=500;const o=s.getContext("2d");o.fillStyle="black",o.fillRect(0,0,s.width,s.height),o.textBaseline="top",o.fillStyle="white",o.font=i,o.fillText("gM",0,s.height/2);const n=o.getImageData(0,0,s.width,s.height).data;let a=-1,r=-1;for(let e=0;e<s.height;e++)for(let t=0;t<s.width;t++){if(!(0===n[4*(e*s.width+t)])){-1===a&&(a=e),r=e+1;break}}const l=r-a;return fontHeightCache.set(i,l),l},getTextWidth(e,t,s,i){const o=i.getContext("2d");return o.font=`${t}pt ${s}`,o.measureText(e).width}};class TextStyleOptions extends AbstractOptions{reset(){this.backgroundColor=null,this.backgroundOpacity=.7,this.backgroundPadding=10,this.backgroundRadius=5,this.color="#000000",this.font="Arial",this.lineHeight=1.25,this.quality=5,this.size=5}}class LabelTextObjectOptions extends LabelObjectOptions{static convert(e){return e.isLabelTextObjectOptions?e:new this(e)}reset(){super.reset(),this.isLabelTextObjectOptions=!0,this.text=null,this.style=new TextStyleOptions}}class LabelTextObject extends LabelObject{constructor(e={}){const t=LabelTextObjectOptions.convert(e);super(t),this.isLabelText=!0,this.text=t.text,this.style=t.style,this._updateMesh()}getType(){return AdsumObjectTypes.LabelTextObject}setText(e,t=null){return this.text=e,null!==t&&this.style.merge(t),this._updateMesh(),this}setStyle(e){return this.style.merge(e),this._updateMesh(),this}_updateMesh(){if(null===this._mesh){const{canvas:e,width:t,height:s}=TextUtil.createTextTexture(this.text,this.style),i=new CanvasTexture(e);i.anisotropy=4;const o=new PlaneGeometry(t,s),n=new MeshBasicMaterial({color:16777215,map:i,side:FrontSide,transparent:!0,depthWrite:!1});this._setMesh(new Mesh(o,n))}else{const{width:e,height:t}=TextUtil.createTextTexture(this.text,this.style,this._mesh.material.map.image);this._mesh.material.map.needsUpdate=!0,this._mesh.geometry.width===e&&this._mesh.geometry.height===t||(this._mesh.geometry.dispose(),this._mesh.geometry=new PlaneGeometry(e,t),this._updatePosition())}return this}}class AbstractLevelState{apply(e){}}class DisplayLevelState extends AbstractLevelState{constructor(e){super(),this.displayMode=e}apply(e){super.apply(e),e.setDisplayMode(this.displayMode)}}class AdsumLabelLoader{constructor(e,t){this.entityManager=e,this.projector=t}load(){const e=this.entityManager.getRepository("CustomObject"),t=this.entityManager.getRepository("File"),s=this.entityManager.getRepository("Place");return Promise.all([e.load(),t.load(),s.load()]).then(()=>{const t=[];return e.getAll().forEach(e=>{t.push(this.build(e))}),Promise.all(t)})}build(e){const t=this.entityManager.getRepository("File"),s=this.entityManager.getRepository("Place").get(e.place),i={x:e.offset.x,y:e.offset.y,z:e.offset.z};null===s.shape_id&&null===s.building_id&&(i.x+=s.position.x,i.y+=s.position.y,i.z+=s.position.z);const o={orientationMode:e.orientation_mode,autoScale:e.autoscale,placeId:s.id,rotation:e.rotation,id:e.id,isPermanentDisplay:e.permanent_display,offset:i};if(0!==e.priority){const t=new LevelOfDetails;t.addLevelState(0,new DisplayLevelState(DISPLAY_MODES.VISIBLE)),t.addLevelState(this.projector.adsumDistanceToMeter(200*e.priority),new DisplayLevelState(DISPLAY_MODES.NONE)),o.levelOfDetails=t}if(e.type===CUSTOM_OBJECT_TYPES.PICTO){const s=t.get(e.file);return o.width=e.width,o.height=e.height,o.image=s.uri,new LabelImageObject(o)}const n={};return o.text=e.label.replace(/<br[ ]*\/?>/gi,"\n"),n.font=e.font,n.size=e.font_size,n.color=e.font_color,n.backgroundColor=e.background_color,o.style=n,new LabelTextObject(o)}}const THREE$1={Group:Group,Matrix4:Matrix4,Vector3:Vector3,Quaternion:Quaternion,Vector4:Vector4,Math:Math$1,Object3D:Object3D,DoubleSide:DoubleSide,MeshLambertMaterial:MeshLambertMaterial,MeshBasicMaterial:MeshBasicMaterial,MeshPhongMaterial:MeshPhongMaterial,FrontSide:FrontSide,MultiMaterial:MultiMaterial,SkinnedMesh:SkinnedMesh,Mesh:Mesh,Line:Line,PerspectiveCamera:PerspectiveCamera,DirectionalLight:DirectionalLight,PointLight:PointLight,SpotLight:SpotLight,AmbientLight:AmbientLight,Geometry:Geometry,Vector2:Vector2,Color:Color,Face3:Face3,Loader:Loader,Texture:Texture,MirroredRepeatWrapping:MirroredRepeatWrapping,RepeatWrapping:RepeatWrapping,ClampToEdgeWrapping:ClampToEdgeWrapping,MixOperation:MixOperation,ImageLoader:ImageLoader,Scene:Scene};function AdsumColladaLoader(){let e,t,s=null,i=null,o=null;const n={};let a,r,l,h,c,d,u,p={},m={},g={},f={},b={},y={},E={},w={};const M={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null};let _=1,O="Y",T=null;function v(n,v,A){if(s=(new DOMParser).parseFromString(n,"text/xml"),v=v||o,void 0!==A){const e=A.split("/");e.pop(),c=`${e.length<1?".":e.join("/")}/`}!function(){const e=s.querySelectorAll("asset")[0];if(e&&e.childNodes)for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];switch(i.nodeName){case"unit":var t=i.getAttribute("meter");t&&(_=parseFloat(t));break;case"up_axis":O=i.textContent.charAt(0)}}}(),function(){if(!0!==M.convertUpAxis||O===M.upAxis)T=null;else switch(O){case"X":T="Y"===M.upAxis?"XtoY":"XtoZ";break;case"Y":T="X"===M.upAxis?"YtoX":"YtoZ";break;case"Z":T="X"===M.upAxis?"ZtoX":"ZtoY"}}(),p=S("library_images image",D,"image"),b=S("library_materials material",se,"material"),y=S("library_effects effect",re,"effect"),f=S("library_geometries geometry",Y,"geometry"),E=S("library_cameras camera",pe,"camera"),w=S("library_lights light",ge,"light"),g=S("library_controllers controller",I,"controller"),m=S("library_animations animation",he,"animation"),l=S("library_visual_scenes visual_scene",F,"visual_scene"),h=S("library_kinematics_models kinematics_model",be,"kinematics_model"),d=[],u=[],e=function(){const e=s.querySelectorAll("scene instance_visual_scene")[0];if(e){const t=e.getAttribute("url").replace(/^#/,"");return l[t.length>0?t:"visual_scene0"]}return null}(),i=new THREE$1.Scene;for(let t=0;t<e.nodes.length;t++)i.add(C(e.nodes[t]));i.scale.multiplyScalar(_),a=[],function t(s){let i=e.getChildById(s.colladaId,!0),o=null;if(i&&i.keys){o={fps:60,hierarchy:[{node:i,keys:i.keys,sids:i.sids}],node:s,name:`animation_${s.name}`,length:0},a.push(o);for(var n=0,r=i.keys.length;n<r;n++)o.length=Math.max(o.length,i.keys[n].time)}else o={hierarchy:[{keys:[],sids:[]}]};for(var n=0,r=s.children.length;n<r;n++){const e=t(s.children[n]);for(let t=0,s=e.hierarchy.length;t<s;t++)o.hierarchy.push({keys:[],sids:[]})}return o}(i),t=function(){const e=s.querySelectorAll("instance_kinematics_model")[0];if(e){const t=e.getAttribute("url").replace(/^#/,"");return h[t.length>0?t:"kinematics_model0"]}return null}(),function(){if(t&&0===t.joints.length)return void(r=void 0);const o={},n=function(s,n){const a=n.getAttribute("id"),r=e.getChildById(a,!0),l=t.joints[s];i.traverse(e=>{e.colladaId==a&&(o[s]={node:e,transforms:r.transforms,joint:l,position:l.zeroPosition})})};r={joints:t&&t.joints,getJointValue(e){const t=o[e];if(t)return t.position;console.log(`getJointValue: joint ${e} doesn't exist`)},setJointValue(e,t){const s=o[e];if(s){const i=s.joint;if(t>i.limits.max||t<i.limits.min)console.log(`setJointValue: joint ${e} value ${t} outside of limits (min: ${i.limits.min}, max: ${i.limits.max})`);else if(i.static)console.log(`setJointValue: joint ${e} is static`);else{const n=s.node,a=i.axis,r=s.transforms,h=new THREE$1.Matrix4,c=new THREE$1.Matrix4;for(l=0;l<r.length;l++){const s=r[l];if(s.sid&&-1!==s.sid.indexOf(`joint${e}`))switch(i.type){case"revolute":h.multiply(c.makeRotationAxis(a,THREE$1.Math.degToRad(t)));break;case"prismatic":h.multiply(c.makeTranslation(a.x*t,a.y*t,a.z*t));break;default:console.warn(`setJointValue: unknown joint type: ${i.type}`)}else switch(s.type){case"matrix":h.multiply(s.obj);break;case"translate":h.multiply(c.makeTranslation(s.obj.x,s.obj.y,s.obj.z));break;case"rotate":h.multiply(c.makeRotationAxis(s.obj,s.angle))}}const d=h.elements,u=Array.prototype.slice.call(d),p=[u[0],u[4],u[8],u[12],u[1],u[5],u[9],u[13],u[2],u[6],u[10],u[14],u[3],u[7],u[11],u[15]];n.matrix.set.apply(n.matrix,p),n.matrix.decompose(n.position,n.quaternion,n.scale),o[e].position=t}}else console.log(`setJointValue: joint ${e} doesn't exist`)}};const a=s.querySelector("scene instance_kinematics_scene");if(a)for(var l=0;l<a.childNodes.length;l++){const e=a.childNodes[l];if(1==e.nodeType)switch(e.nodeName){case"bind_joint_axis":var h=e.getAttribute("target").split("/").pop(),c=e.querySelector("axis param").textContent,d=parseInt(c.split("joint").pop().split(".")[0]),u=s.querySelector(`[sid="${h}"]`);if(u){const e=u.parentElement;n(d,e)}}}}();const x={scene:i,morphs:d,skins:u,animations:a,kinematics:r,dae:{images:p,materials:b,cameras:E,lights:w,effects:y,geometries:f,controllers:g,animations:m,visualScenes:l,visualScene:e,scene:e,kinematicsModels:h,kinematicsModel:t}};return v&&v(x),x}function S(e,t,i){const o=s.querySelectorAll(e),n={};let a=0;const r=o.length;for(let e=0;e<r;e++){const s=o[e],r=(new t).parse(s);r.id&&0!==r.id.length||(r.id=i+a++),n[r.id]=r}return n}function A(e,t){const s=t instanceof V?g[t.url]:t;if(!s||!s.morph)return void console.log("could not find morph controller!");const i=s.morph;for(let t=0;t<i.targets.length;t++){const s=i.targets[t],o=f[s];if(!o.mesh||!o.mesh.primitives||!o.mesh.primitives.length)continue;const n=o.mesh.primitives[0].geometry;n.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:n.vertices})}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function x(e,t,s,i){if(e.world=e.world||new THREE$1.Matrix4,e.localworld=e.localworld||new THREE$1.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){const t=e.channels[0].sampler.output[s];t instanceof THREE$1.Matrix4&&(e.world.copy(t),e.localworld.copy(t),0===s&&e.matrix.copy(t))}i&&e.world.multiplyMatrices(i,e.world),t.push(e);for(let i=0;i<e.nodes.length;i++)x(e.nodes[i],t,s,e.world)}function L(e,t){for(let i=0;i<e.length;i++){const o=e[i];let n=-1;if("JOINT"==o.type){for(var s=0;s<t.joints.length;s++)if(o.sid===t.joints[s]){n=s;break}if(n>=0){const e=t.invBindMatrices[n];o.invBindMatrix=e,o.skinningMatrix=new THREE$1.Matrix4,o.skinningMatrix.multiplyMatrices(o.world,e),o.animatrix=new THREE$1.Matrix4,o.animatrix.copy(o.localworld),o.weights=[];for(s=0;s<t.weights.length;s++)for(let e=0;e<t.weights[s].length;e++){const i=t.weights[s][e];i.joint===n&&o.weights.push(i)}}else console.warn(`ColladaLoader: Could not find joint '${o.sid}'.`),o.skinningMatrix=new THREE$1.Matrix4,o.weights=[]}}}function N(t,s,i){void 0===i&&(i=40);const o=g[s.url];if(!o||!o.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!s.skeleton||!s.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");const n=function(){let e,t=1e6,s=-t,i=0;for(const o in m){const n=m[o];e=e||n.id;for(let e=0;e<n.sampler.length;e++){const o=n.sampler[e];o.create(),t=Math.min(t,o.startTime),s=Math.max(s,o.endTime),i=Math.max(i,o.input.length)}}return{start:t,end:s,frames:i,ID:e}}(),a=e.getChildById(s.skeleton[0],!0)||e.getChildBySid(s.skeleton[0],!0),r=function(e){const t=[];var s=function(e,t,i){const o={};o.name=t.sid,o.parent=e,o.matrix=t.matrix;const n=[new THREE$1.Vector3,new THREE$1.Quaternion,new THREE$1.Vector3];o.matrix.decompose(n[0],n[1],n[2]),o.pos=[n[0].x,n[0].y,n[0].z],o.scl=[n[2].x,n[2].y,n[2].z],o.rotq=[n[1].x,n[1].y,n[1].z,n[1].w],i.push(o);for(const e in t.nodes)s(t.sid,t.nodes[e],i)};return s(-1,e,t),t}(a),l=o.skin.joints,h=[];for(var c=0;c<l.length;c++)for(var d=0;d<r.length;d++)r[d].name===l[c]&&(h[c]=r[d]);for(c=0;c<h.length;c++)for(d=0;d<h.length;d++)h[c].parent===h[d].name&&(h[c].parent=d);new THREE$1.Vector3;for(c=0;c<t.vertices.length;c++)t.vertices[c].applyMatrix4(o.skin.bindShapeMatrix);const u=[],p=[],f=o.skin.weights;for(c=0;c<f.length;c++){const e=new THREE$1.Vector4(f[c][0]?f[c][0].joint:0,f[c][1]?f[c][1].joint:0,f[c][2]?f[c][2].joint:0,f[c][3]?f[c][3].joint:0);var b=new THREE$1.Vector4(f[c][0]?f[c][0].weight:0,f[c][1]?f[c][1].weight:0,f[c][2]?f[c][2].weight:0,f[c][3]?f[c][3].weight:0);u.push(e),p.push(b)}t.skinIndices=u,t.skinWeights=p,t.bones=h;const y={name:n.ID,fps:30,length:n.frames/30,hierarchy:[]};for(d=0;d<h.length;d++)y.hierarchy.push({parent:h[d].parent,name:h[d].name,keys:[]});for(console.log("ColladaLoader:",`${n.ID} has ${h.length} bones.`),function(e,t,s){const i=[];x(t,i,-1),L(i,s.skin);const o=new THREE$1.Vector3,n=[];for(var a=0;a<e.vertices.length;a++)n.push(new THREE$1.Vector3);for(a=0;a<i.length;a++)if("JOINT"==i[a].type)for(let t=0;t<i[a].weights.length;t++){const s=i[a].weights[t],r=s.index,l=s.weight,h=e.vertices[r],c=n[r];o.x=h.x,o.y=h.y,o.z=h.z,o.applyMatrix4(i[a].skinningMatrix),c.x+=o.x*l,c.y+=o.y*l,c.z+=o.z*l}for(a=0;a<e.vertices.length;a++)e.vertices[a]=n[a]}(t,a,o),i=0;i<n.frames;i++){const e=[];x(a,e,i),L(e,o.skin);for(c=0;c<e.length;c++)for(d=0;d<y.hierarchy.length;d++)if(y.hierarchy[d].name===e[c].sid){const t={};t.time=i/30,t.matrix=e[c].animatrix,0===i&&(e[c].matrix=t.matrix);const s=[new THREE$1.Vector3,new THREE$1.Quaternion,new THREE$1.Vector3];t.matrix.decompose(s[0],s[1],s[2]),t.pos=[s[0].x,s[0].y,s[0].z],t.scl=[s[2].x,s[2].y,s[2].z],t.rot=s[1],y.hierarchy[d].keys.push(t)}t.animation=y}}function C(e,t){const s=new THREE$1.Object3D;let i,o,n,a;for(n=0;n<e.controllers.length;n++){const t=g[e.controllers[n].url];switch(t.type){case"skin":if(f[t.skin.source])(r=new G).url=t.skin.source,r.instance_material=e.controllers[n].instance_material,e.geometries.push(r),i=e.controllers[n];else if(g[t.skin.source]){const s=g[t.skin.source];if(o=s,s.morph&&f[s.morph.source])(r=new G).url=s.morph.source,r.instance_material=e.controllers[n].instance_material,e.geometries.push(r)}break;case"morph":var r;if(f[t.morph.source])(r=new G).url=t.morph.source,r.instance_material=e.controllers[n].instance_material,e.geometries.push(r),o=e.controllers[n];console.log("ColladaLoader: Morph-controller partially supported.")}}const l={};for(n=0;n<e.geometries.length;n++){const t=e.geometries[n],r=t.instance_material,p=f[t.url],m={},g=[];let E=0;var h;if(p){if(!p.mesh||!p.mesh.primitives)continue;if(0===s.name.length&&(s.name=p.id),r)for(a=0;a<r.length;a++){const e=r[a],t=b[e.target],s=t.instance_effect.url;let i=y[s].shader.material;if(p.doubleSided){if(!(e.symbol in l)){const t=i.clone();t.side=THREE$1.DoubleSide,l[e.symbol]=t}i=l[e.symbol]}i.opacity=i.opacity?i.opacity:1,m[e.symbol]=E,g.push(i),(h=i).name=null===t.name||""===t.name?t.id:t.name,E++}var c;let e=h||new THREE$1.MeshLambertMaterial({color:14540253,side:p.doubleSided?THREE$1.DoubleSide:THREE$1.FrontSide});const t=p.mesh.geometry3js;if(E>1)for(e=new THREE$1.MultiMaterial(g),a=0;a<t.faces.length;a++){const e=t.faces[a];e.materialIndex=m[e.daeMaterial]}void 0!==i?(N(t,i),t.morphTargets.length>0?(e.morphTargets=!0,e.skinning=!1):(e.morphTargets=!1,e.skinning=!0),(c=new THREE$1.SkinnedMesh(t,e,!1)).name=`skin_${u.length}`,u.push(c)):void 0!==o?(A(t,o),e.morphTargets=!0,(c=new THREE$1.Mesh(t,e)).name=`morph_${d.length}`,d.push(c)):c=!0===t.isLineStrip?new THREE$1.Line(t):new THREE$1.Mesh(t,e),s.add(c)}}for(n=0;n<e.cameras.length;n++){const t=e.cameras[n],i=E[t.url],o=new THREE$1.PerspectiveCamera(i.yfov,parseFloat(i.aspect_ratio),parseFloat(i.znear),parseFloat(i.zfar));s.add(o)}for(n=0;n<e.lights.length;n++){let t=null;const i=e.lights[n],o=w[i.url];if(o&&o.technique){const e=o.color.getHex(),s=o.intensity,i=o.distance,n=o.falloff_angle;switch(o.technique){case"directional":(t=new THREE$1.DirectionalLight(e,s,i)).position.set(0,0,1);break;case"point":t=new THREE$1.PointLight(e,s,i);break;case"spot":(t=new THREE$1.SpotLight(e,s,i,n)).position.set(0,0,1);break;case"ambient":t=new THREE$1.AmbientLight(e)}}t&&s.add(t)}if(s.name=e.name||e.id||"",s.colladaId=e.id||"",s.layer=e.layer||"",s.matrix=e.matrix,s.matrix.decompose(s.position,s.quaternion,s.scale),M.centerGeometry&&s.geometry){const e=new THREE$1.Vector3;object.geometry.computeBoundingBox(),object.geometry.boundingBox.getCenter(e),s.geometry.center(),e.multiply(s.scale),e.applyQuaternion(s.quaternion),s.position.add(e)}for(n=0;n<e.nodes.length;n++)s.add(C(e.nodes[n],e));return s}function P(e){const t=s.querySelectorAll("library_nodes node");for(let s=0;s<t.length;s++){const i=t[s].attributes.getNamedItem("id");if(i&&i.value===e)return t[s]}}function j(e,t){let s=null;for(let i=0,o=e.length;i<o&&null===s;i++){const o=e[i];if(o.time===t)s=o;else if(o.time>t)break}return s}function R(e,t){let s=-1;for(let i=0,o=e.length;i<o&&-1===s;i++){e[i].time>=t&&(s=i)}return s}function k(e,t,s,i){let o=function(e,t,s){for(s=s>=0?s:s+e.length;s>=0;s--){const i=e[s];if(i.hasTarget(t))return i}return null}(e,i,s?s-1:0),n=function(e,t,s){for(;s<e.length;s++){const i=e[s];if(i.hasTarget(t))return i}return null}(e,i,s+1);if(o&&n){let e,s=(t.time-o.time)/(n.time-o.time),a=o.getTarget(i),r=n.getTarget(i).data,l=a.data;if("matrix"===a.type)e=l;else if(l.length){e=[];for(let t=0;t<l.length;++t)e[t]=l[t]+(r[t]-l[t])*s}else e=l+(r-l)*s;t.addTarget(i,a.transform,a.member,e)}}function D(){this.id="",this.init_from=""}function I(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function H(){this.method=null,this.source=null,this.targets=null,this.weights=null}function B(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function F(){this.id="",this.name="",this.nodes=[],this.scene=new THREE$1.Group}function U(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE$1.Matrix4}function $(){this.sid="",this.type="",this.data=[],this.obj=null}function V(){this.url="",this.skeleton=[],this.instance_material=[]}function z(){this.symbol="",this.target=""}function G(){this.url="",this.instance_material=[]}function Y(){this.id="",this.mesh=null}function W(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function X(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE$1.Geometry}function Z(){X.call(this),this.vcount=[]}function q(){X.call(this),this.vcount=1}function J(){X.call(this),this.vcount=3}function K(){this.source="",this.count=0,this.stride=0,this.params=[]}function Q(){this.input={}}function ee(){this.semantic="",this.offset=0,this.source="",this.set=0}function te(e){this.id=e,this.type=null}function se(){this.id="",this.name="",this.instance_effect=null}function ie(){this.color=new THREE$1.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function oe(e,t){this.type=e,this.effect=t,this.material=null}function ne(e){this.effect=e,this.init_from=null,this.format=null}function ae(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function re(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function le(){this.url=""}function he(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ce(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function de(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ue(e){this.targets=[],this.time=e}function pe(){this.id="",this.name="",this.technique=""}function me(){this.url=""}function ge(){this.id="",this.name="",this.technique=""}function fe(){this.url=""}function be(){this.id="",this.name="",this.joints=[],this.links=[]}function ye(){this.sid="",this.name="",this.axis=new THREE$1.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function Ee(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function we(){this.joint="",this.transforms=[],this.links=[]}function Me(e){const t=e.getAttribute("id");return void 0!=n[t]?n[t]:(n[t]=new te(t).parse(e),n[t])}function _e(e){const t=ve(e),s=[];for(let e=0,i=t.length;e<i;e++)s.push(!("true"!==t[e]&&"1"!==t[e]));return s}function Oe(e){const t=ve(e),s=[];for(let e=0,i=t.length;e<i;e++)s.push(parseFloat(t[e]));return s}function Te(e){const t=ve(e),s=[];for(let e=0,i=t.length;e<i;e++)s.push(parseInt(t[e],10));return s}function ve(e){return e.length>0?function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}(e).split(/\s+/):[]}function Se(e,t,s){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):s}function Ae(e,t){(new THREE$1.ImageLoader).load(t,t=>{e.image=t,e.needsUpdate=!0})}function xe(e,t){e.doubleSided=!1;const s=t.querySelectorAll("extra double_sided")[0];s&&s&&1===parseInt(s.textContent,10)&&(e.doubleSided=!0)}function Le(e,t){if(!0===M.convertUpAxis&&O!==M.upAxis)switch(T){case"XtoY":var s=e[0];e[0]=t*e[1],e[1]=s;break;case"XtoZ":s=e[2];e[2]=e[1],e[1]=e[0],e[0]=s;break;case"YtoX":s=e[0];e[0]=e[1],e[1]=t*s;break;case"YtoZ":s=e[1];e[1]=t*e[2],e[2]=s;break;case"ZtoX":s=e[0];e[0]=e[1],e[1]=e[2],e[2]=s;break;case"ZtoY":s=e[1];e[1]=e[2],e[2]=t*s}}function Ne(e,t){const s=[e[t],e[t+1],e[t+2]];return Le(s,-1),new THREE$1.Vector3(s[0],s[1],s[2])}function Ce(e){if(M.convertUpAxis){let t=[e[0],e[4],e[8]];Le(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],Le(t=[e[1],e[5],e[9]],-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],Le(t=[e[2],e[6],e[10]],-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],Le(t=[e[0],e[1],e[2]],-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],Le(t=[e[4],e[5],e[6]],-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],Le(t=[e[8],e[9],e[10]],-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],Le(t=[e[3],e[7],e[11]],-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE$1.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function Pe(e){if(e>-1&&e<3){e={X:0,Y:1,Z:2}[e=je(["X","Y","Z"][e])]}return e}function je(e){if(M.convertUpAxis)switch(e){case"X":switch(T){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(T){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(T){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}return D.prototype.parse=function(e){this.id=e.getAttribute("id");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];"init_from"===s.nodeName&&(this.init_from=s.textContent)}return this},I.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"skin":this.skin=(new B).parse(s),this.type=s.nodeName;break;case"morph":this.morph=(new H).parse(s),this.type=s.nodeName}}return this},H.prototype.parse=function(e){const t={};let s,i=[];for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),s=0;s<e.childNodes.length;s++){const n=e.childNodes[s];if(1==n.nodeType)switch(n.nodeName){case"source":t[(o=(new te).parse(n)).id]=o;break;case"targets":i=this.parseInputs(n);break;default:console.log(n.nodeName)}}for(s=0;s<i.length;s++){const e=i[s];var o=t[e.source];switch(e.semantic){case"MORPH_TARGET":this.targets=o.read();break;case"MORPH_WEIGHT":this.weights=o.read()}}return this},H.prototype.parseInputs=function(e){const t=[];for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"input":t.push((new ee).parse(i))}}return t},B.prototype.parse=function(e){const t={};let s,i;this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(let a=0;a<e.childNodes.length;a++){const r=e.childNodes[a];if(1==r.nodeType)switch(r.nodeName){case"bind_shape_matrix":var o=Oe(r.textContent);this.bindShapeMatrix=Ce(o);break;case"source":var n=(new te).parse(r);t[n.id]=n;break;case"joints":s=r;break;case"vertex_weights":i=r;break;default:console.log(r.nodeName)}}return this.parseJoints(s,t),this.parseWeights(i,t),this},B.prototype.parseJoints=function(e,t){for(let o=0;o<e.childNodes.length;o++){const n=e.childNodes[o];if(1==n.nodeType)switch(n.nodeName){case"input":var s=(new ee).parse(n),i=t[s.source];"JOINT"===s.semantic?this.joints=i.read():"INV_BIND_MATRIX"===s.semantic&&(this.invBindMatrices=i.read())}}},B.prototype.parseWeights=function(e,t){let s,i,o=[];for(var n=0;n<e.childNodes.length;n++){const t=e.childNodes[n];if(1==t.nodeType)switch(t.nodeName){case"input":o.push((new ee).parse(t));break;case"v":s=Te(t.textContent);break;case"vcount":i=Te(t.textContent)}}let a=0;for(n=0;n<i.length;n++){const e=i[n],l=[];for(var r=0;r<e;r++){const e={};for(let i=0;i<o.length;i++){const n=o[i],r=s[a+n.offset];switch(n.semantic){case"JOINT":e.joint=r;break;case"WEIGHT":e.weight=t[n.source].data[r]}}l.push(e),a+=o.length}for(r=0;r<l.length;r++)l[r].index=n;this.weights.push(l)}},F.prototype.getChildById=function(e,t){for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildById(e,t);if(i)return i}return null},F.prototype.getChildBySid=function(e,t){for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildBySid(e,t);if(i)return i}return null},F.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"node":this.nodes.push((new U).parse(s))}}return this},U.prototype.getChannelForTransform=function(e){for(let s=0;s<this.channels.length;s++){const i=this.channels[s];let o=i.target.split("/");o.shift();let n=o.shift();const a=n.indexOf(".")>=0,r=n.indexOf("(")>=0;var t;if(a)n=(o=n.split(".")).shift();else if(r){n=(t=n.split("(")).shift();for(let e=0;e<t.length;e++)t[e]=parseInt(t[e].replace(/\)/,""))}if(n===e)return i.info={sid:n,dotSyntax:a,arrSyntax:r,arrIndices:t},i}return null},U.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildById(e,t);if(i)return i}return null},U.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildBySid(e,t);if(i)return i}return null},U.prototype.getTransformBySid=function(e){for(let t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},U.prototype.parse=function(e){let t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE$1.Matrix4;for(let i=0;i<e.childNodes.length;i++){const o=e.childNodes[i];if(1==o.nodeType)switch(o.nodeName){case"node":this.nodes.push((new U).parse(o));break;case"instance_camera":this.cameras.push((new me).parse(o));break;case"instance_controller":this.controllers.push((new V).parse(o));break;case"instance_geometry":this.geometries.push((new G).parse(o));break;case"instance_light":this.lights.push((new fe).parse(o));break;case"instance_node":var s=P(t=o.getAttribute("url").replace(/^#/,""));s&&this.nodes.push((new U).parse(s));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new $).parse(o));break;case"extra":break;default:console.log(o.nodeName)}}return this.channels=function(e){const t=[];let s=1e6,i=-1e6;for(var o in m){const n=m[o];for(let a=0;a<n.channel.length;a++){const r=n.channel[a],l=n.sampler[a];(o=r.target.split("/")[0])==e.id&&(l.create(),r.sampler=l,s=Math.min(s,l.startTime),i=Math.max(i,l.endTime),t.push(r))}}return t.length&&(e.startTime=s,e.endTime=i),t}(this),function(e){if(e.channels&&e.channels.length){let m=[],g=[];for(var t=0,s=e.channels.length;t<s;t++){var i,o=e.channels[t],n=o.fullSid,a=o.sampler,r=a.input,l=e.getTransformBySid(o.sid);if(o.arrIndices){i=[];for(var h=0,c=o.arrIndices.length;h<c;h++)i[h]=Pe(o.arrIndices[h])}else i=je(o.member);if(l)for(-1===g.indexOf(n)&&g.push(n),h=0,c=r.length;h<c;h++){var d=r[h],u=a.getData(l.type,h,i);if(!(p=j(m,d))){p=new ue(d);const e=R(m,d);m.splice(-1===e?m.length:e,0,p)}p.addTarget(n,l,i,u)}else console.log(`Could not find transform "${o.sid}" in node ${e.id}`)}for(t=0;t<g.length;t++){const e=g[t];for(h=0;h<m.length;h++){var p;(p=m[h]).hasTarget(e)||k(m,p,h,e)}}e.keys=m,e.sids=g}}(this),this.updateMatrix(),this},U.prototype.updateMatrix=function(){this.matrix.identity();for(let e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},$.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=Oe(e.textContent),this.convert(),this},$.prototype.convert=function(){switch(this.type){case"matrix":this.obj=Ce(this.data);break;case"rotate":this.angle=THREE$1.Math.degToRad(this.data[3]);case"translate":Le(this.data,-1),this.obj=new THREE$1.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":Le(this.data,1),this.obj=new THREE$1.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log(`Can not convert Transform of type ${this.type}`)}},$.prototype.apply=function(){const e=new THREE$1.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),$.prototype.update=function(e,t){const s=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){const s=`n${t[0]+1}${t[1]+1}`;this.obj[s]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=s[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=s[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE$1.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE$1.Math.degToRad(e[3])}}},V.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":var t=i.querySelectorAll("instance_material");for(let e=0;e<t.length;e++){const s=t[e];this.instance_material.push((new z).parse(s))}}}return this},z.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},G.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType&&"bind_material"===s.nodeName){const e=s.querySelectorAll("instance_material");for(let t=0;t<e.length;t++){const s=e[t];this.instance_material.push((new z).parse(s))}break}}return this},Y.prototype.parse=function(e){this.id=e.getAttribute("id"),xe(this,e);for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"mesh":this.mesh=new W(this).parse(s)}}return this},W.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"source":Me(s);break;case"vertices":this.vertices=(new Q).parse(s);break;case"linestrips":this.primitives.push((new q).parse(s));break;case"triangles":this.primitives.push((new J).parse(s));break;case"polygons":this.primitives.push((new X).parse(s));break;case"polylist":this.primitives.push((new Z).parse(s))}}if(this.geometry3js=new THREE$1.Geometry,null===this.vertices)return this;const s=n[this.vertices.input.POSITION.source].data;for(t=0;t<s.length;t+=3)this.geometry3js.vertices.push(Ne(s,t).clone());for(t=0;t<this.primitives.length;t++){const e=this.primitives[t];e.setVertices(this.vertices),this.handlePrimitive(e,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},W.prototype.handlePrimitive=function(e,t){if(e instanceof q)return void(t.isLineStrip=!0);let s,i,o,a,r,l,h,c,d=e.p,u=e.inputs,p=0,m=0;const g=[];for(s=0;s<u.length;s++){const e=(o=u[s]).offset+1;switch(m=m<e?e:m,o.semantic){case"TEXCOORD":g.push(o.set)}}for(let T=0;T<d.length;++T){let v=d[T],S=0;for(;S<v.length;){const d=[],T=[];let A=null;const x=[];for(c=e.vcount?e.vcount.length?e.vcount[p++]:e.vcount:v.length/m,s=0;s<c;s++)for(i=0;i<u.length;i++)switch(o=u[i],l=n[o.source],r=(a=v[S+s*m+o.offset])*(h=l.accessor.params.length),o.semantic){case"VERTEX":d.push(a);break;case"NORMAL":T.push(Ne(l.data,r));break;case"TEXCOORD":void 0===(A=A||{})[o.set]&&(A[o.set]=[]),A[o.set].push(new THREE$1.Vector2(l.data[r],l.data[r+1]));break;case"COLOR":x.push((new THREE$1.Color).setRGB(l.data[r],l.data[r+1],l.data[r+2]))}if(0===T.length)if(o=this.vertices.input.NORMAL){h=(l=n[o.source]).accessor.params.length;for(var f=0,b=d.length;f<b;f++)T.push(Ne(l.data,d[f]*h))}else t.calcNormals=!0;if(!A&&(A={},o=this.vertices.input.TEXCOORD)){g.push(o.set),h=(l=n[o.source]).accessor.params.length;for(f=0,b=d.length;f<b;f++)r=d[f]*h,void 0===A[o.set]&&(A[o.set]=[]),A[o.set].push(new THREE$1.Vector2(l.data[r],1-l.data[r+1]))}if(0===x.length&&(o=this.vertices.input.COLOR)){h=(l=n[o.source]).accessor.params.length;for(f=0,b=d.length;f<b;f++)r=d[f]*h,x.push((new THREE$1.Color).setRGB(l.data[r],l.data[r+1],l.data[r+2]))}var y,E,w=null,_=[];if(3===c)_.push(new THREE$1.Face3(d[0],d[1],d[2],T,x.length?x:new THREE$1.Color));else if(4===c)_.push(new THREE$1.Face3(d[0],d[1],d[3],T.length?[T[0].clone(),T[1].clone(),T[3].clone()]:[],x.length?[x[0],x[1],x[3]]:new THREE$1.Color)),_.push(new THREE$1.Face3(d[1],d[2],d[3],T.length?[T[1].clone(),T[2].clone(),T[3].clone()]:[],x.length?[x[1],x[2],x[3]]:new THREE$1.Color));else if(c>4&&M.subdivideFaces){var O=x.length?x:new THREE$1.Color;for(i=1;i<c-1;)_.push(new THREE$1.Face3(d[0],d[i],d[i+1],T.length?[T[0].clone(),T[i++].clone(),T[i].clone()]:[],O))}if(_.length)for(f=0,b=_.length;f<b;f++)for((w=_[f]).daeMaterial=e.material,t.faces.push(w),i=0;i<g.length;i++)y=A[g[i]],E=c>4?[y[0],y[f+1],y[f+2]]:4===c?0===f?[y[0],y[1],y[3]]:[y[1].clone(),y[2],y[3].clone()]:[y[0],y[1],y[2]],void 0===t.faceVertexUvs[i]&&(t.faceVertexUvs[i]=[]),t.faceVertexUvs[i].push(E);else console.log(`dropped face with vcount ${c} for geometry with id: ${t.id}`);S+=m*c}}},X.prototype.setVertices=function(e){for(let t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},X.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=Se(e,"count",0);for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"input":this.inputs.push((new ee).parse(e.childNodes[t]));break;case"vcount":this.vcount=Te(s.textContent);break;case"p":this.p.push(Te(s.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},Z.prototype=Object.create(X.prototype),Z.prototype.constructor=Z,q.prototype=Object.create(X.prototype),q.prototype.constructor=q,J.prototype=Object.create(X.prototype),J.prototype.constructor=J,K.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=Se(e,"count",0),this.stride=Se(e,"stride",0);for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if("param"===s.nodeName){const e={};e.name=s.getAttribute("name"),e.type=s.getAttribute("type"),this.params.push(e)}}return this},Q.prototype.parse=function(e){this.id=e.getAttribute("id");for(let t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){const s=(new ee).parse(e.childNodes[t]);this.input[s.semantic]=s}return this},ee.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=Se(e,"set",-1),this.offset=Se(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},te.prototype.parse=function(e){this.id=e.getAttribute("id");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"bool_array":this.data=_e(s.textContent),this.type=s.nodeName;break;case"float_array":this.data=Oe(s.textContent),this.type=s.nodeName;break;case"int_array":this.data=Te(s.textContent),this.type=s.nodeName;break;case"IDREF_array":case"Name_array":this.data=ve(s.textContent),this.type=s.nodeName;break;case"technique_common":for(let e=0;e<s.childNodes.length;e++)if("accessor"===s.childNodes[e].nodeName){this.accessor=(new K).parse(s.childNodes[e]);break}}}return this},te.prototype.read=function(){const e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(let t=0;t<this.data.length;t+=16){const s=Ce(this.data.slice(t,t+16));e.push(s)}break;default:console.log(`ColladaLoader: Source: Read dont know how to read ${t.type}.`)}return e},se.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(let t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new le).parse(e.childNodes[t]);break}return this},ie.prototype.isColor=function(){return null===this.texture},ie.prototype.isTexture=function(){return null!=this.texture},ie.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"color":var t=Oe(i.textContent);this.color=new THREE$1.Color,this.color.setRGB(t[0],t[1],t[2]),this.color.a=t[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},ie.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1]).childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]);for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[s.nodeName]=parseFloat(s.textContent);break;case"wrapU":case"wrapV":"TRUE"===s.textContent.toUpperCase()?this.texOpts[s.nodeName]=1:this.texOpts[s.nodeName]=parseInt(s.textContent);break;default:this.texOpts[s.nodeName]=s.textContent}}return this},oe.prototype.parse=function(e){for(let i=0;i<e.childNodes.length;i++){const o=e.childNodes[i];if(1==o.nodeType)switch(o.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":this[o.nodeName]=(new ie).parse(o);break;case"bump":var t=o.getAttribute("bumptype");t?"heightfield"===t.toLowerCase()?this.bump=(new ie).parse(o):"normalmap"===t.toLowerCase()?this.normal=(new ie).parse(o):(console.error(`Shader.prototype.parse: Invalid value for attribute 'bumptype' (${t}) - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'`),this.bump=(new ie).parse(o)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new ie).parse(o));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var s=o.querySelectorAll("float");s.length>0&&(this[o.nodeName]=parseFloat(s[0].textContent))}}return this.create(),this},oe.prototype.create=function(){const e={};let t=!1;if(void 0!==this.transparency&&void 0!==this.transparent){const s=(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency;s>0&&(t=!0,e.transparent=!0,e.opacity=1-s)}const s={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(const n in this)switch(n){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var i=this[n];if(i instanceof ie)if(i.isTexture()){const t=i.texture,a=this.effect.sampler[t];if(void 0!==a&&void 0!==a.source){const t=this.effect.surface[a.source];if(void 0!==t){const r=p[t.init_from];if(r){const t=c+r.init_from;var o;const l=THREE$1.Loader.Handlers.get(t);null!==l?o=l.load(t):Ae(o=new THREE$1.Texture,t),"MIRROR"===a.wrap_s?o.wrapS=THREE$1.MirroredRepeatWrapping:"WRAP"===a.wrap_s||i.texOpts.wrapU?o.wrapS=THREE$1.RepeatWrapping:o.wrapS=THREE$1.ClampToEdgeWrapping,"MIRROR"===a.wrap_t?o.wrapT=THREE$1.MirroredRepeatWrapping:"WRAP"===a.wrap_t||i.texOpts.wrapV?o.wrapT=THREE$1.RepeatWrapping:o.wrapT=THREE$1.ClampToEdgeWrapping,o.offset.x=i.texOpts.offsetU,o.offset.y=i.texOpts.offsetV,o.repeat.x=i.texOpts.repeatU,o.repeat.y=i.texOpts.repeatV,e[s[n]]=o,"emission"===n&&(e.emissive=16777215)}}}}else"diffuse"!==n&&t||("emission"===n?e.emissive=i.color.getHex():e[n]=i.color.getHex());break;case"shininess":e[n]=this[n];break;case"reflectivity":e[n]=this[n],e[n]>0&&(e.envMap=M.defaultEnvMap),e.combine=THREE$1.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[n],1!==this[n]&&(e.envMap=M.defaultEnvMap)}switch(e.side=this.effect.doubleSided?THREE$1.DoubleSide:THREE$1.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),void 0!==e.ambient&&delete e.ambient,this.type){case"constant":void 0!=e.emissive&&(e.color=e.emissive),this.material=new THREE$1.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE$1.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE$1.MeshLambertMaterial(e)}return this.material},ne.prototype.parse=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"init_from":this.init_from=s.textContent;break;case"format":this.format=s.textContent;break;default:console.log(`unhandled Surface prop: ${s.nodeName}`)}}return this},ae.prototype.parse=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"source":this.source=s.textContent;break;case"minfilter":this.minfilter=s.textContent;break;case"magfilter":this.magfilter=s.textContent;break;case"mipfilter":this.mipfilter=s.textContent;break;case"wrap_s":this.wrap_s=s.textContent;break;case"wrap_t":this.wrap_t=s.textContent;break;default:console.log(`unhandled Sampler2D prop: ${s.nodeName}`)}}return this},re.prototype.create=function(){if(null===this.shader)return null},re.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),xe(this,e),this.shader=null;for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(s))}}return this},re.prototype.parseNewparam=function(e){const t=e.getAttribute("sid");for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"surface":this.surface[t]=new ne(this).parse(i);break;case"sampler2D":this.sampler[t]=new ae(this).parse(i);break;case"extra":break;default:console.log(i.nodeName)}}},re.prototype.parseProfileCOMMON=function(e){let t;for(let i=0;i<e.childNodes.length;i++){const o=e.childNodes[i];if(1==o.nodeType)switch(o.nodeName){case"profile_COMMON":this.parseProfileCOMMON(o);break;case"technique":t=o;break;case"newparam":this.parseNewparam(o);break;case"image":var s=(new D).parse(o);p[s.id]=s;break;case"extra":break;default:console.log(o.nodeName)}}return t},re.prototype.parseTechnique=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new oe(s.nodeName,this).parse(s);break;case"extra":this.parseExtra(s)}}},re.prototype.parseExtra=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"technique":this.parseExtraTechnique(s)}}},re.prototype.parseExtraTechnique=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"bump":this.shader.parse(e)}}},le.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},he.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(let i=0;i<e.childNodes.length;i++){const o=e.childNodes[i];if(1==o.nodeType)switch(o.nodeName){case"animation":var t=(new he).parse(o);for(var s in t.source)this.source[s]=t.source[s];for(let e=0;e<t.channel.length;e++)this.channel.push(t.channel[e]),this.sampler.push(t.sampler[e]);break;case"source":s=(new te).parse(o);this.source[s.id]=s;break;case"sampler":this.sampler.push(new de(this).parse(o));break;case"channel":this.channel.push(new ce(this).parse(o))}}return this},ce.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");let t=this.target.split("/");t.shift();const s=t.shift(),i=s.indexOf(".")>=0,o=s.indexOf("(")>=0;if(i)t=s.split("."),this.sid=t.shift(),this.member=t.shift();else if(o){const e=s.split("(");this.sid=e.shift();for(let t=0;t<e.length;t++)e[t]=parseInt(e[t].replace(/\)/,""));this.arrIndices=e}else this.sid=s;return this.fullSid=s,this.dotSyntax=i,this.arrSyntax=o,this},de.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"input":this.inputs.push((new ee).parse(s))}}return this},de.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){const t=this.inputs[e],s=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=s.read();break;case"OUTPUT":this.output=s.read(),this.strideOut=s.accessor.stride;break;case"INTERPOLATION":this.interpolation=s.read();break;case"IN_TANGENT":case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},de.prototype.getData=function(e,t,s){let i;if("matrix"===e&&16===this.strideOut)i=this.output[t];else if(this.strideOut>1){i=[],t*=this.strideOut;for(let e=0;e<this.strideOut;++e)i[e]=this.output[t+e];if(3===this.strideOut)switch(e){case"rotate":case"translate":Le(i,-1);break;case"scale":Le(i,1)}else 4===this.strideOut&&"matrix"===e&&Le(i,-1)}else i=this.output[t],s&&"translate"===e&&(i=function(e,t){if(!0!==M.convertUpAxis||O===M.upAxis)return t;switch(e){case"X":t="XtoY"===T?-1*t:t;break;case"Y":t="YtoZ"===T||"YtoX"===T?-1*t:t;break;case"Z":t="ZtoY"===T?-1*t:t}return t}(s,i));return i},ue.prototype.addTarget=function(e,t,s,i){this.targets.push({sid:e,member:s,transform:t,data:i})},ue.prototype.apply=function(e){for(let t=0;t<this.targets.length;++t){const s=this.targets[t];e&&s.sid!==e||s.transform.update(s.data,s.member)}},ue.prototype.getTarget=function(e){for(let t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},ue.prototype.hasTarget=function(e){for(let t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},ue.prototype.interpolate=function(e,t){for(let n=0,a=this.targets.length;n<a;n++){var s,i=this.targets[n],o=e.getTarget(i.sid);if("matrix"!==i.transform.type&&o){let n=(t-this.time)/(e.time-this.time),a=o.data,r=i.data;if(n<0&&(n=0),n>1&&(n=1),r.length){s=[];for(let e=0;e<r.length;++e)s[e]=r[e]+(a[e]-r[e])*n}else s=r+(a-r)*n}else s=i.data;i.transform.update(s,i.member)}},pe.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"optics":this.parseOptics(s)}}return this},pe.prototype.parseOptics=function(e){for(let i=0;i<e.childNodes.length;i++)if("technique_common"===e.childNodes[i].nodeName){const o=e.childNodes[i];for(let e=0;e<o.childNodes.length;e++)if(this.technique=o.childNodes[e].nodeName,"perspective"===this.technique){const i=o.childNodes[e];for(var t=0;t<i.childNodes.length;t++){switch((s=i.childNodes[t]).nodeName){case"yfov":this.yfov=s.textContent;break;case"xfov":this.xfov=s.textContent;break;case"znear":this.znear=s.textContent;break;case"zfar":this.zfar=s.textContent;break;case"aspect_ratio":this.aspect_ratio=s.textContent}}}else if("orthographic"===this.technique){const i=o.childNodes[e];for(t=0;t<i.childNodes.length;t++){var s;switch((s=i.childNodes[t]).nodeName){case"xmag":this.xmag=s.textContent;break;case"ymag":this.ymag=s.textContent;break;case"znear":this.znear=s.textContent;break;case"zfar":this.zfar=s.textContent;break;case"aspect_ratio":this.aspect_ratio=s.textContent}}}}return this},me.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ge.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"technique_common":this.parseCommon(s);break;case"technique":this.parseTechnique(s)}}return this},ge.prototype.parseCommon=function(e){for(let o=0;o<e.childNodes.length;o++)switch(e.childNodes[o].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[o].nodeName;var t=e.childNodes[o];for(let e=0;e<t.childNodes.length;e++){const o=t.childNodes[e];switch(o.nodeName){case"color":var s=Oe(o.textContent);this.color=new THREE$1.Color(0),this.color.setRGB(s[0],s[1],s[2]),this.color.a=s[3];break;case"falloff_angle":this.falloff_angle=parseFloat(o.textContent);break;case"quadratic_attenuation":var i=parseFloat(o.textContent);this.distance=i?Math.sqrt(1/i):0}}}return this},ge.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];switch(s.nodeName){case"intensity":this.intensity=parseFloat(s.textContent)}}return this},fe.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},be.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"technique_common":this.parseCommon(s)}}return this},be.prototype.parseCommon=function(e){for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new ye).parse(s));break;case"link":this.links.push((new Ee).parse(s))}}return this},ye.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE$1.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;const t=Oe(e.querySelector("axis").textContent);this.axis=Ne(t,0);const s=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,i=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:s,max:i};const o=["prismatic","revolute"];for(let t=0;t<o.length;t++){const s=o[t];e.querySelector(s)&&(this.type=s)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},Ee.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"attachment_full":this.attachments.push((new we).parse(s));break;case"rotate":case"translate":case"matrix":this.transforms.push((new $).parse(s))}}return this},we.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(let t=0;t<e.childNodes.length;t++){const s=e.childNodes[t];if(1==s.nodeType)switch(s.nodeName){case"link":this.links.push((new Ee).parse(s));break;case"rotate":case"translate":case"matrix":this.transforms.push((new $).parse(s))}}return this},{load:function(e,t,s,i){let n=0;if(document.implementation&&document.implementation.createDocument){const a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState?0===a.status||200===a.status?a.response?(o=t,v(a.response,void 0,e)):i?i({type:"error",url:e}):console.error(`ColladaLoader: Empty or non-existing file (${e})`):i?i({type:"error",url:e}):console.error(`ColladaLoader: Couldn't load "${e}" (${a.status})`):3===a.readyState&&s&&(0===n&&(n=a.getResponseHeader("Content-Length")),s({total:n,loaded:a.responseText.length}))},a.open("GET",e,!0),a.send(null)}else alert("Don't know how to parse XML!")},parse:v,applySkin:N,geometries:f,options:M}}class SiteObject extends AdsumObject3D{constructor(e={}){super(e),this.isSite=!0,this.buildings=new Set,this.spaces=new Set,this.labels=new Set,this._labelGroup=new Group}getType(){return AdsumObjectTypes.SiteObject}addLabel(e){if(null!==e.parent)throw new Error("AdsumWebMap.LabelObject#addLabel: Changing labelObject parent is not supported yet.");return e.parent=this,this.labels.add(e),this._labelGroup.add(e._mesh),e.update(),this}removeLabel(e){return this.labels.delete(e),e.parent=null,this._labelGroup.remove(e._mesh),this}setDisplayMode(e){switch(super.setDisplayMode(e),e){case DISPLAY_MODES.NONE:case DISPLAY_MODES.TRANSPARENT:this._labelGroup.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._labelGroup.visible=!0;break;default:throw new Error("Unexpected")}}_raycast(e,t,s=!0){return!1!==super._raycast(e,t,s)&&(s&&(this.buildings.forEach(i=>{i._raycast(e,t,s)}),this.labels.forEach(i=>{i._raycast(e,t,s)}),this.spaces.forEach(i=>{i._raycast(e,t,s)})),!0)}_setMesh(e){return super._setMesh(e),this._mesh.add(this._labelGroup),this}}class BuildingObject extends AdsumObject3D{constructor(e={}){super(e),this.isBuilding=!0,this.site=null,this.floors=new Set,this.labels=new Set,this._labelGroup=new Group,this._initialColor=null}getType(){return AdsumObjectTypes.BuildingObject}addLabel(e){if(null!==e.parent)throw new Error("AdsumWebMap.SpaceObject#addLabel: Changing labelObject parent is not supported yet.");return e.parent=this,this.labels.add(e),this._labelGroup.add(e._mesh),this.update(),this}removeLabel(e){return this.labels.delete(e),e.parent=null,this._labelGroup.remove(e._mesh),this}setColor(e){return null===this._initialColor&&(this._initialColor=this._mesh.material.color.clone()),this._mesh.material.color.set(e),this}isInitialColor(){return null===this._initialColor||this._initialColor.equals(this._mesh.material.color)}resetColor(){return null!==this._initialColor&&this._mesh.material.color.copy(this._initialColor),this}_setMesh(e){return super._setMesh(e),this._mesh.add(this._labelGroup),this._updateLabelGroup(),this._initialColor=null,this}setDisplayMode(e){switch(super.setDisplayMode(e),e){case DISPLAY_MODES.NONE:case DISPLAY_MODES.TRANSPARENT:this._labelGroup.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._labelGroup.visible=!0;break;default:throw new Error("Unexpected")}}_raycast(e,t,s=!0){return!1!==super._raycast(e,t,s)&&(s&&(this.floors.forEach(i=>{i._raycast(e,t,s)}),this.labels.forEach(i=>{i._raycast(e,t,s)})),!0)}_updateLabelGroup(){super.update();const{size:e}=this.getSizeAndCenter(!1);this._labelGroup.position.setZ(e.z),this._labelGroup.updateMatrixWorld()}}class FloorObject extends AdsumObject3D{constructor(e={}){super(e),this.isFloor=!0,this.building=null,this.spaces=new Set,this.labels=new Set,this._labelGroup=new Group,this.altitude=null}getType(){return AdsumObjectTypes.FloorObject}addLabel(e){if(null!==e.parent)throw new Error("AdsumWebMap.LabelObject#addLabel: Changing labelObject parent is not supported yet.");return e.parent=this,this.labels.add(e),this._labelGroup.add(e._mesh),e.update(),this}removeLabel(e){return this.labels.delete(e),e.parent=null,this._labelGroup.remove(e._mesh),this}_raycast(e,t,s=!0){return!1!==super._raycast(e,t,s)&&(s&&(this.spaces.forEach(i=>{i._raycast(e,t,s)}),this.labels.forEach(i=>{i._raycast(e,t,s)})),!0)}_setMesh(e){return super._setMesh(e),this._mesh.add(this._labelGroup),this}}class SpaceObject extends AdsumObject3D{constructor(e={}){super(e),this.isSpace=!0,this.parent=null,this.labels=new Set,this._labelGroup=new Group,this._initialColor=null}getType(){return AdsumObjectTypes.SpaceObject}_setMesh(e){return super._setMesh(e),this._mesh.add(this._labelGroup),this._updateLabelGroup(),this._initialColor=null,this}setColor(e){return null===this._initialColor&&(this._initialColor=this._mesh.material.color.clone()),this._mesh.material.color.set(e),this}isInitialColor(){return null===this._initialColor||this._initialColor.equals(this._mesh.material.color)}resetColor(){return null!==this._initialColor&&this._mesh.material.color.copy(this._initialColor),this}isBounced(){return 1!==this._mesh.scale.z}getBounceFactor(){return this._mesh.scale.z}bounceUp(e){return this._mesh.scale.setZ(e),this.update(),this}bounceDown(){return this.bounceUp(1)}addLabel(e){if(null!==e.parent)throw new Error("AdsumWebMap.SpaceObject#addLabel: Changing labelObject parent is not supported yet.");return e.parent=this,this.labels.add(e),this._labelGroup.add(e._mesh),this.update(),this}removeLabel(e){return this.labels.delete(e),e.parent=null,this._labelGroup.remove(e._mesh),this}_raycast(e,t,s=!0){return!1!==super._raycast(e,t,s)&&(s&&this.labels.forEach(i=>{i._raycast(e,t,s)}),!0)}update(){this._labelGroup.scale.z!==1/this.getBounceFactor()&&this._updateLabelGroup(),super.update()}_updateLabelGroup(){super.update();const{size:e}=this.getSizeAndCenter(!1);this._labelGroup.scale.setZ(1/this.getBounceFactor()),this._labelGroup.position.setZ(e.z/this.getBounceFactor()),this._labelGroup.updateMatrixWorld()}}class LoaderResult{constructor(e=null){this.scene=null,this.site=null,this.buildingsMap=new Map,this.floorsMap=new Map,this.spacesMap=new Map,this.labelsMap=new Map,this.deviceId=e,this.projector=null,this.paths=null,this.places=null}}const v$2=new Vector3;class AdsumProjector{static createFake(){return new this([1,0,0,0,1,0],[0,0,0],{latitude:0,longitude:0})}constructor(e,t,s){this.matrix=new Matrix4,this.inverseMatrix=null,this.matrix.set(e[0],e[1],0,t[0],e[3],e[4],0,t[1],0,0,1,0,0,0,0,1);const i=new Vector3;i.setFromMatrixScale(this.matrix),this.scale=(i.x+i.y)/2,this.matrix.set(e[0],e[1],0,t[0],e[3],e[4],0,t[1],0,0,this.scale,0,0,0,0,1);const o=Gps.fromDegree(s.latitude,s.longitude,0);this.utmGridZone=new UtmGridZone(o)}meterToAdsumDistance(e){return e*this.scale}adsumDistanceToMeter(e){return e/this.scale}gpsToAdsum(e){return this.utmToAdsum(this.gpsToUtm(e))}gpsToUtm(e){const{lat:t,long:s,alt:i}=e;return GpsUtmConverter.toUtm(Gps.fromDegree(t,s,i),this.utmGridZone)}utmToAdsum(e){const{E:t,N:s,alt:i}=e,o=new Vector3(t,s,i);return o.applyMatrix4(this.matrix),o}adsumToGps(e){return this.utmToGps(this.adsumToUtm(e))}adsumToUtm(e){return null===this.inverseMatrix&&(this.inverseMatrix=new Matrix4,this.inverseMatrix.getInverse(this.matrix)),v$2.copy(e),v$2.applyMatrix4(this.inverseMatrix),new Utm(v$2.x,v$2.y,v$2.z,this.utmGridZone.hemi,this.utmGridZone.zone)}utmToGps(e){return GpsUtmConverter.toGps(e)}}class AdsumLoader{constructor(e){this.options=new AdsumLoaderOptions(e),this.isAoMap=!0,this.result=new LoaderResult(e.deviceId),this.adsumTextureLoader=null,this.adsumLabelLoader=null,this._registerAdsumTextureLoader()}buildLabel(e){return this.adsumLabelLoader.build(e)}load(){return this._startEntityManagerLoading(),this._registerAdsumTextureLoader().then(()=>Promise.all([this._loadCollada(),this._loadProjectorTransform(),this._loadPaths(),this._loadPlaces()])).then(()=>this._loadLabels()).then(()=>this._addLabels()).then(()=>(this.result.scene.updateMatrixWorld(!0),this.result))}_loadCollada(){const e=this.options.entityManager.getRepository("File"),t=this.options.entityManager.getRepository("MapFile"),s=this.options.entityManager.getRepository("Place");return Promise.all([e.load(),t.load()]).then(()=>{const e=this._getColladaUri();return Promise.all([this._parseCollada(e),s.load()])}).then(([{scene:e}])=>{this.result.scene=e,this._parseAndTransformAdsumScene(e,s),this._adjustSceneSettings()})}loadCalibration(e){const t=this.options.entityManager.getRepository("SiteCalibration"),s=this.options.entityManager.getRepository("FloorCalibration");return Promise.all([t.load(),s.load()]).then(()=>{const i=t.findOneBy({device:t=>t.is(e)});let o=null,n=null;const a=new Map;if(null!==i&&(s.getList(i.floor_calibrations).forEach(e=>{const t=new CameraCalibration;t.eye.copy(e.eye),t.up.copy(e.up),t.target.copy(e.target),t.zoomMin=e.zoom_min||DEFAULT_CALIBRATION.ZOOM_MIN,t.zoomMax=e.zoom_max||DEFAULT_CALIBRATION.ZOOM_MAX;const s=-1===e.floor_id?null:e.floor_id;a.set(s,t)}),o=-1===i.start_floor?null:i.start_floor,null!==i.start_point_floor)){const e=i.start_point_floor;n={floorId:-1!==e?e:null,position:i.start_point_position}}return{cameraCalibrations:a,defaultFloorId:o,userPosition:n}})}_loadPlaces(){const e=this.options.entityManager.getRepository("Place");return e.load().then(()=>{this.result.places=e.getAll()})}_loadLabels(){return this.adsumLabelLoader=new AdsumLabelLoader(this.options.entityManager,this.result.projector),this.adsumLabelLoader.load().then(e=>{e.forEach(e=>{this.result.labelsMap.set(e.id,e)})})}_startEntityManagerLoading(){this.options.entityManager.getRepository("Site").load(),this.options.entityManager.getRepository("MapFile").load(),this.options.entityManager.getRepository("File").load(),this.options.entityManager.getRepository("Place").load(),this.options.entityManager.getRepository("CustomObject").load(),this.options.entityManager.getRepository("SiteCalibration").load(),this.options.entityManager.getRepository("FloorCalibration").load()}_registerAdsumTextureLoader(){return this.options.entityManager.getRepository("File").load().then(()=>{this.adsumTextureLoader=new AdsumTextureLoader(this.options.entityManager.getRepository("File"),this.isAoMap),Loader.Handlers.add(this.adsumTextureLoader.regex,this.adsumTextureLoader)})}_getColladaUri(){const e=this.options.entityManager.getRepository("File"),t=this.options.entityManager.getRepository("MapFile"),s=t.findOneBy({type:MAP_FILE_TYPES.AO_DAE,file:e=>null!==e.value});let i=null;if(this.isAoMap&&null!==s)i=s.file;else{const e=t.findOneBy({type:MAP_FILE_TYPES.DAE,file:e=>null!==e.value});if(null===e)throw new Error("AdsumWebMap.AdsumLoader: No map found");i=e.file,this.isAoMap=!1}return e.get(i).uri}_parseCollada(e){return new Promise((t,s)=>{return(new AdsumColladaLoader).load(e,t,null,s)})}_parseAndTransformAdsumScene(e,t,s=null){let i=e;if(!e.geometry&&!e.material&&e.children.length>0&&("Mesh"===e.children[0].type||e.children[0].isLight)){const{parent:t}=e;t.remove(e);const s=e.children[0];s.isLight?(s.matrix=e.matrix,s.matrix.decompose(s.position,s.quaternion,s.scale)):s.applyMatrix(e.matrix),t.add(s);for(let t=e.children.length-1;t>=0;t--){const i=e.children[t];s.add(i)}(i=s).name=e.name,i.colladaId=e.colladaId,e.dispose&&e.dispose()}const o=i.name||"";if(i.material)if(i.material.flatShading=!0,i.material.side=FrontSide,i.material.isMeshPhongMaterial?(i.material.emissionMap&&!i.material.map&&(i.material.map=i.material.emissionMap,i.material.emissionMap=null,i.material.color=16777215),i.material.shininess=1e-4):i.material.isMeshLambertMaterial&&i.material.emissionMap&&!i.material.map&&(i.material.map=i.material.emissionMap,i.material.emissionMap=null),i.material.lightMap)i.material=new MeshPhongMaterial({aoMap:i.material.lightMap,map:i.material.map,color:i.material.color});else if(this.options.preferLambertMaterial()&&i.material.isMeshPhongMaterial){const e=["alphaTest","blendDst","blendDstAlpha","blendEquation","blendEquationAlpha","blending","blendSrc","blendSrcAlpha","clipIntersection","clippingPlanes","clipShadows","colorWrite","depthFunc","depthTest","depthWrite","fog","lights","name","overdraw","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","precision","premultipliedAlpha","dithering","flatShading","side","transparent","vertexColors","visible","userData","alphaMap","aoMap","aoMapIntensity","color","combine","emissive","emissiveMap","emissiveIntensity","envMap","lightMap","lightMapIntensity","map","morphNormals","morphTargets","reflectivity","refractionRatio","skinning","specularMap","wireframe","wireframeLinecap","wireframeLinejoin","wireframeLinewidth"],t={};for(let s=0;s<e.length;s++){const o=e[s];t[o]=i.material[o]}i.material=new MeshLambertMaterial(t)}if(o.startsWith("SITE"))this.isAoMap&&(i.rotateX(-Math.PI/2),i.updateMatrix()),this.result.site=new SiteObject(new AdsumObject3DOptions({id:-1})),this.result.site._setMesh(i),s=this.result.site;else if(o.startsWith("BUILDING")){const e=o.match(/BUILDING_(\d+)_(.*)/),n=new AdsumObject3DOptions({id:parseInt(e[1],10),name:e[2]}),a=t.findOneBy({building_id:n.id});null===a?console.warn(`AdsumLoader: No place associated to building ${n.id}`):n.placeId=a.id;const r=new BuildingObject(n);r._setMesh(i),r.site=s,r.site.buildings.add(r),this.result.buildingsMap.set(r.id,r),s=r}else if(o.startsWith("FLOOR")){const e=o.match(/FLOOR_(\d+)_(.*)/),t=new FloorObject(new AdsumObject3DOptions({id:parseInt(e[1],10),name:e[2]}));t._setMesh(i),t.altitude=i.position.z,t.building=s,t.building.floors.add(t),this.result.floorsMap.set(t.id,t),s=t}else if(o.startsWith("SHAPE")||o.startsWith("STORE")){const e=o.match(/(?:SHAPE|STORE)_(\d+)_(.*)/),n=new AdsumObject3DOptions({id:parseInt(e[1],10),name:e[2]}),a=t.findOneBy({shape_id:n.id});null===a?console.warn(`AdsumLoader: No place associated to space ${n.id}`):n.placeId=a.id;const r=new SpaceObject(n);r._setMesh(i),r.parent=s,r.parent.spaces.add(r),this.result.spacesMap.set(r.id,r),s=r}for(let e=i.children.length-1;e>=0;e--)this._parseAndTransformAdsumScene(i.children[e],t,s)}_adjustSceneSettings(){this.result.scene.traverse(e=>{e instanceof Mesh&&(e.material.shininess=1e-5,this.options.shadowEnabled&&(e!==this.result.site._mesh&&(e.castShadow=!0),e.receiveShadow=!0))}),this._createLights(),this._createFog(),this.result.site._mesh.material.emissive&&this.result.site._mesh.material.emissive.set(0),this.result.site._mesh.material.shininess&&(this.result.site._mesh.material.shininess=1e-5),this.result.buildingsMap.forEach(e=>{const t=e._mesh;if(t.material&&t.material.specular&&t.material.specular.set(0,0,0),t.geometry){const e=new Vector3;t.geometry.computeBoundingBox(),t.geometry.boundingBox.getCenter(e),t.geometry.center(),t.geometry.translate(0,0,e.z),e.z=0,e.multiply(t.scale),e.applyQuaternion(t.quaternion),t.position.add(e),t.children.forEach(t=>{t.position.sub(e)}),t.updateMatrix(),t.updateMatrixWorld()}this._colorShapeVertices(t)}),this.result.floorsMap.forEach(e=>{e._mesh.material.emissive&&e._mesh.material.emissive.set(0),e._mesh.material.shininess&&(e._mesh.material.shininess=1e-5)}),this.result.spacesMap.forEach(e=>{const t=e._mesh;if(this._colorShapeVertices(t),t.geometry){const e=new Vector3;t.geometry.computeBoundingBox(),t.geometry.boundingBox.getCenter(e),t.geometry.center(),t.geometry.translate(0,0,e.z),e.z=0,e.multiply(t.scale),e.applyQuaternion(t.quaternion),t.position.add(e),t.updateMatrix(),t.updateMatrixWorld()}})}_colorShapeVertices(e){if(this.isAoMap){const t=e.geometry,s=new Color(this.options.shapeAmbientOcclusionTopColor),i=new Color(this.options.shapeAmbientOcclusionBottomColor);t.faces.forEach(e=>{let o=s,n=s,a=s;t.vertices[e.a]&&0===t.vertices[e.a].z&&(o=i),t.vertices[e.b]&&0===t.vertices[e.b].z&&(n=i),t.vertices[e.c]&&0===t.vertices[e.c].z&&(a=i),e.vertexColors.push(o),e.vertexColors.push(n),e.vertexColors.push(a)}),t.colorsNeedUpdate=!0,e.material.vertexColors=VertexColors,e.material.needsUpdate=!0}}_createLights(){const e=this.options.advancedLightingEnabled()?.5:1,t=new HemisphereLight(16777215,8947848,e);if(t.position.set(0,0,1),this.result.scene.add(t),t.updateMatrixWorld(),this.options.advancedLightingEnabled()){const e=new DirectionalLight(16777215,.2);e.position.set(1,0,0),this.result.scene.add(e),e.updateMatrixWorld();const t=new Box3,s=new Sphere;t.setFromObject(this.result.scene).getBoundingSphere(s);const{radius:i}=s,o=s.center.clone();o.z+=i/2,o.y+=i/2,o.x-=i/2;const n=new DirectionalLight(16777215,.85);n.position.copy(o),n.target.position.copy(s.center),this.options.shadowEnabled&&(n.castShadow=!0,n.shadow.camera.near=i/4,n.shadow.camera.far=2*i,n.shadow.camera.right=i,n.shadow.camera.left=-i,n.shadow.camera.top=i,n.shadow.camera.bottom=-i,n.shadow.mapSize.width=this.options.shadowMapSize,n.shadow.mapSize.height=this.options.shadowMapSize),this.result.scene.add(n.target),this.result.scene.add(n),n.updateMatrixWorld(),n.target.updateMatrixWorld()}}_createFog(){this.options.fogEnabled&&(this.result.scene.fog=new FogExp2(this.options.fogColor,this.options.fogRatio))}_addLabels(){const e=this.options.entityManager.getRepository("Place"),t=this.options.entityManager.getRepository("CustomObject");return e.load().then(()=>{this.result.labelsMap.forEach(s=>{const i=t.get(s.id),o=e.get(i.place);if(null!==o.shape_id){this.result.spacesMap.get(o.shape_id).addLabel(s)}else if(null!==o.building_id){this.result.buildingsMap.get(o.building_id).addLabel(s)}else if(-1===o.floor_id)this.result.site.addLabel(s);else{this.result.floorsMap.get(o.floor_id).addLabel(s)}})})}_loadProjectorTransform(){const e=this.options.entityManager.getRepository("Site");return e.load().then(()=>{const t=e.getCurrent();t.gps_positions.size<4||6!==t.gps_transform.size||3!==t.gps_translate.size?(console.warn("AdsumWebMap.AdsumLoader: No gps positions available, wayfinding will not be accurate (we assume world unit match meter) !!"),this.result.projector=AdsumProjector.createFake()):this.result.projector=new AdsumProjector(Array.from(t.gps_transform),Array.from(t.gps_translate),Array.from(t.gps_positions)[0])})}_loadPaths(){const e=this.options.entityManager.getRepository("MapFile");return e.load().then(()=>{const t=e.findOneBy({type:MAP_FILE_TYPES.PATH});null===t?(console.warn("AdsumWebMap.AdsumLoader: No paths found, wayfinding will not be working !"),this.result.paths=new Map,this.result.paths.set("nodes",[]),this.result.paths.set("links",[])):this.result.paths=t.paths})}}class Path{constructor(e=null,t=null,s=!1){this.from=e,this.to=t,this.pmr=s,this._distance=null,this._pathSections=[],this.computed=!1}get pathSections(){return console.warn("Deprecated: AdsumWebMap.Path.pathSections property access is deprecated, please use 'getPathSections'"),this.getPathSections()}getPathSections(e=!1){return e?this._pathSections:this._pathSections.filter(e=>!e.isInterGround())}setPathSections(e){return this._pathSections=e,this.computed=!0,this._distance=null,this}getDistance(){return this.computed?(null===this._distance&&(this._distance=0,this.getPathSections(!0).forEach(e=>{this._distance+=e.getDistance()})),this._distance):null}}export{AdsumWebMap,Options,CameraOptions,CameraCenterOnOptions,EngineOptions,AdsumLoader,AdsumLoaderOptions,MOUSE_EVENTS,LabelTextObject,LabelImageObject,AdsumObjectTypes as ADSUM_OBJECT_TYPES,DISPLAY_MODES as DISPLAY_MODE,DISPLAY_MODES,LABEL_OBJECTS_ORIENTATION_MODES as LABEL_ORIENTATION_MODES,SceneEvents as SCENE_EVENTS,WayfindingEvents as WAYFINDING_EVENTS,Path,DotPathBuilderOptions,DotPathBuilder,DisplayLevelState,LevelOfDetails,PathSection,PathSectionObject,WayfindingOptions,UserObject};
