/**
 * Copyright (C) 2018 Adactive SAS
 */

import{EventDispatcher,WebGLRenderer,PCFSoftShadowMap,Vector2,Vector3,MOUSE,Quaternion,Spherical,Box3,Math as Math$1,Ray,Plane,PerspectiveCamera,Sphere,Raycaster,Line3,CanvasTexture,Mesh,MeshBasicMaterial,PlaneBufferGeometry,FrontSide,Color,ObjectLoader,Group,BufferAttribute,BufferGeometry,CircleBufferGeometry,DoubleSide,RingBufferGeometry,Shape,ShapeBufferGeometry,Cache,Object3D,Matrix4,Vector4,MeshLambertMaterial,MeshPhongMaterial,MultiMaterial,SkinnedMesh,Line,DirectionalLight,PointLight,SpotLight,AmbientLight,Geometry,Face3,Loader,Texture,MirroredRepeatWrapping,RepeatWrapping,ClampToEdgeWrapping,MixOperation,ImageLoader,Scene,TextureLoader,HemisphereLight,FogExp2,VertexColors}from"three";import{update,getAll,onRequestTick,FrameThrottle,Tween,Easing}from"es6-tween";import{AbstractOptions}from"@adactive/adactive-abstract-options";import{Manager,Tap}from"hammerjs";import{EntityManager,FILE_CONTEXTS,CUSTOM_OBJECT_TYPES,MAP_FILE_TYPES}from"@adactive/adsum-client-api";import{GpsUtmConverter,Gps,Utm,UtmGridZone}from"@adactive/adsum-space-transform";class ObjectManager{constructor(){this.site=null,this.buildings=new Map,this.floors=new Map,this.spaces=new Map,this.labels=new Map,this.user=null,this.pathSectionObjects=new Map}init(t){this.site=t.site,this.buildings=t.buildingsMap,this.floors=t.floorsMap,this.spaces=t.spacesMap,this.labels=t.labelsMap}getFloor(t){return this.floors.has(t)?this.floors.get(t):null}getBuilding(t){return this.buildings.has(t)?this.buildings.get(t):null}getSpace(t){return this.spaces.has(t)?this.spaces.get(t):null}getLabel(t){return this.labels.has(t)?this.labels.get(t):null}getByAdsumLocation(t){return null==t?null:t.adsumObject}addLabel(t,e){return this.labels.set(t.id,t),e.addLabel(t),this}removeLabel(t){return this.labels.delete(t.id),t.parent.removeLabel(t),this}}const SceneEvents={floor:{didChanged:"scene.floor.didChanged",willChanged:"scene.floor.willChanged"}};class SceneManager extends EventDispatcher{constructor(t,e){super(),this.awm=t,this.scene=null,this.currentGround=null,this.options=e}init(t){this.scene=t.scene,this.options.animation.init(this.awm),this.currentGround=t.site,this.scene.addEventListener("change",()=>{this.awm.engineManager.requestUpdate()})}get currentFloor(){return console.warn("SceneManager.currentFloor is deprecated, use SceneManager.getCurrentFloor instead"),this.getCurrentFloor()}set currentFloor(t){console.warn("SceneManager.currentFloor is deprecated, use SceneManager.setCurrentFloor instead"),this.setCurrentFloor(t,!1)}getCurrentFloor(){return this.getFloor(this.currentGround)}isCurrentFloor(t){return t===this.currentGround||this.isSite(this.currentGround)&&this.isSite(t)}setCurrentFloor(t,e=!0){if(this.isCurrentFloor(t))return Promise.resolve();const s=this.currentGround;return this.currentGround=this.getGround(t),this.dispatchEvent({type:SceneEvents.floor.willChanged,previous:this.getFloor(s),current:this.getFloor(this.currentGround)}),this.options.animation.stop(),this.options.animation.start(s,this.currentGround,e).then(()=>{this.dispatchEvent({type:SceneEvents.floor.didChanged,previous:this.getFloor(s),current:this.getFloor(this.currentGround)})})}getGround(t){return this.isSite(t)?this.awm.objectManager.site:t}getFloor(t){return this.isSite(t)?null:t}isSite(t){return null===t||t.isSite}}const DISPLAY_MODES={NONE:"none",VISIBLE:"visible",TRANSPARENT:"transparent"};FrameThrottle(5);class EngineManagerBase{constructor(t,e){this.awm=t,this.options=e,this.container=e.container,this.canvas=null,this.levelOfDetailsEnabled=!0,this.renderer=null,this._animationFrameId=null,this.running=!1}isLevelOfDetailsEnabled(){return this.levelOfDetailsEnabled}enableLevelOfDetails(){return this.levelOfDetailsEnabled=!0,this.requestUpdate(),this}disableLevelOfDetails(){return this.levelOfDetailsEnabled=!1,this.requestUpdate(),this}init(){window.addEventListener("resize",()=>{this.requestUpdate()}),onRequestTick(()=>{this.requestUpdate()})}compileMaterials(t=!0){this.renderer.compile(this.awm.sceneManager.scene,this.awm.cameraManager.camera),t&&this.renderer.domElement.addEventListener("webglcontextrestored",()=>{this.compileMaterials(!1)},!1)}start(){this.running=!0,this.update()}requestUpdate(){this.running&&null===this._animationFrameId&&(this._animationFrameId=requestAnimationFrame(this.update.bind(this)))}update(){try{this._resizeCanvas();const t=update();this.awm.cameraManager.control.update(),this._updateLevelOfDetails(this.awm.cameraManager.camera),this.renderer.render(this.awm.sceneManager.scene,this.awm.cameraManager.camera),this._animationFrameId&&(cancelAnimationFrame(this._animationFrameId),this._animationFrameId=null),this.options.autoCompileMaterials&&(this.options.autoCompileMaterials=!1,this.compileMaterials()),t&&this.requestUpdate()}catch(t){throw this.requestUpdate(),t}}stop(){this._animationFrameId&&(cancelAnimationFrame(this._animationFrameId),this._animationFrameId=null),this.running=!1,getAll().forEach(t=>{t.stop()})}_updateLevelOfDetails(t){const{site:e}=this.awm.objectManager;e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled),e.getDisplayMode()!==DISPLAY_MODES.NONE&&(e.buildings.forEach(e=>this._updateLevelOfDetailsOnBuilding(e,t)),e.spaces.forEach(e=>this._updateLevelOfDetailsOnSpace(e,t)),e.labels.forEach(e=>e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled)))}_updateLevelOfDetailsOnBuilding(t,e){t._applyLod(e,this.awm.getProjector(),this.levelOfDetailsEnabled),t.getDisplayMode()!==DISPLAY_MODES.NONE&&(t.floors.forEach(t=>this._updateLevelOfDetailsOnFloor(t,e)),t.labels.forEach(t=>t._applyLod(e,this.awm.getProjector(),this.levelOfDetailsEnabled)))}_updateLevelOfDetailsOnFloor(t,e){t._applyLod(e,this.awm.getProjector(),this.levelOfDetailsEnabled),t.getDisplayMode()!==DISPLAY_MODES.NONE&&(t.spaces.forEach(t=>this._updateLevelOfDetailsOnSpace(t,e)),t.labels.forEach(t=>t._applyLod(e,this.awm.getProjector(),this.levelOfDetailsEnabled)))}_updateLevelOfDetailsOnSpace(t,e){t._applyLod(e,this.awm.getProjector(),this.levelOfDetailsEnabled),t.getDisplayMode()!==DISPLAY_MODES.NONE&&t.labels.forEach(t=>t._applyLod(e,this.awm.getProjector(),this.levelOfDetailsEnabled))}_getDevicePixelRatio(){return window.devicePixelRatio||1}_resizeCanvas(){const{width:t,height:e}=this.renderer.getSize(),s=t!==this.container.clientWidth||e!==this.container.clientHeight,i=this.renderer.getPixelRatio()!==this._getDevicePixelRatio();if((s||i)&&(s&&this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),i&&this.renderer.setPixelRatio(this._getDevicePixelRatio()),s)){const{camera:t,control:e}=this.awm.cameraManager;t.aspect=this.container.clientWidth/this.container.clientHeight,t.updateProjectionMatrix(),e.update()}}}class EngineManager extends EngineManagerBase{init(){this.canvas=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),this.renderer=new WebGLRenderer({antialias:!0,alpha:!0,powerPreference:this.options.gpuPower,canvas:this.canvas,logarithmicDepthBuffer:!0}),this.renderer.capabilities.logarithmicDepthBuffer=null!==this.renderer.extensions.get("EXT_frag_depth"),this.container.appendChild(this.canvas),this.options.shadowEnabled&&(this.renderer.shadowMap.type=PCFSoftShadowMap,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.autoUpdate=!1,this.renderer.shadowMap.needsUpdate=!0),this.renderer.setClearColor(this.options.clearColor),super.init()}}const THREE={Vector3:Vector3,MOUSE:MOUSE,Quaternion:Quaternion,Spherical:Spherical,EventDispatcher:EventDispatcher,Vector2:Vector2};THREE.MapControls=function(t,e){var s,i,n,o,a;this.object=t,this.domElement=void 0!==e?e:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return m.phi},this.getAzimuthalAngle=function(){return m.theta},this.saveState=function(){r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=function(){r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(l),r.update(),u=d.NONE},this.update=(s=new THREE.Vector3,i=(new THREE.Quaternion).setFromUnitVectors(t.up,new THREE.Vector3(0,1,0)),n=i.clone().inverse(),o=new THREE.Vector3,a=new THREE.Quaternion,function(){var t=r.object.position;return s.copy(t).sub(r.target),s.applyQuaternion(i),m.setFromVector3(s),r.autoRotate&&u===d.NONE&&R(2*Math.PI/60/60*r.autoRotateSpeed),m.theta+=g.theta,m.phi+=g.phi,m.theta=Math.max(r.minAzimuthAngle,Math.min(r.maxAzimuthAngle,m.theta)),m.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,m.phi)),m.makeSafe(),m.radius*=f,m.radius=Math.max(r.minDistance,Math.min(r.maxDistance,m.radius)),r.target.add(b),s.setFromSpherical(m),s.applyQuaternion(n),t.copy(r.target).add(s),r.object.lookAt(r.target),!0===r.enableDamping?(g.theta*=1-r.dampingFactor,g.phi*=1-r.dampingFactor,b.multiplyScalar(1-r.dampingFactor)):(g.set(0,0,0),b.set(0,0,0)),f=1,!!(y||o.distanceToSquared(r.object.position)>p||8*(1-a.dot(r.object.quaternion))>p)&&(r.dispatchEvent(l),o.copy(r.object.position),a.copy(r.object.quaternion),y=!1,!0)}),this.dispose=function(){r.domElement.removeEventListener("contextmenu",tt,!1),r.domElement.removeEventListener("mousedown",W,!1),r.domElement.removeEventListener("wheel",X,!1),r.domElement.removeEventListener("touchstart",J,!1),r.domElement.removeEventListener("touchend",Q,!1),r.domElement.removeEventListener("touchmove",K,!1),document.removeEventListener("mousemove",Y,!1),document.removeEventListener("mouseup",q,!1),window.removeEventListener("keydown",Z,!1)};var r=this,l={type:"change"},h={type:"start"},c={type:"end"},d={NONE:0,ROTATE_UP:1,ROTATE_LEFT:2,ROTATE:3,DOLLY:4,DOLLY_ROTATE:7,PAN:8,DOLLY_PAN:12},u=d.NONE,p=1e-6,m=new THREE.Spherical,g=new THREE.Spherical,f=1,b=new THREE.Vector3,y=!1,w=new THREE.Vector2,E=new THREE.Vector2,M=new THREE.Vector2,_=new THREE.Vector2,O=new THREE.Vector2,T=new THREE.Vector2,v=new THREE.Vector2,x=new THREE.Vector2,A=new THREE.Vector2,P=new THREE.Vector2,S=new THREE.Vector2,j=new THREE.Vector2,L=new THREE.Vector2,C=new THREE.Vector2;function N(){return Math.pow(.95,r.zoomSpeed)}function R(t){g.theta-=t}function D(t){g.phi-=t}var I,B=(I=new THREE.Vector3,function(t,e){I.setFromMatrixColumn(e,0),I.multiplyScalar(-t),b.add(I)}),k=function(){var t=new THREE.Vector3;return function(e,s){!0===r.screenSpacePanning?t.setFromMatrixColumn(s,1):(t.setFromMatrixColumn(s,0),t.crossVectors(r.object.up,t)),t.multiplyScalar(e),b.add(t)}}(),F=function(){var t=new THREE.Vector3;return function(e,s){var i=r.domElement===document?r.domElement.body:r.domElement;if(r.object.isPerspectiveCamera){var n=r.object.position;t.copy(n).sub(r.target);var o=t.length();o*=Math.tan(r.object.fov/2*Math.PI/180),B(2*e*o/i.clientHeight,r.object.matrix),k(2*s*o/i.clientHeight,r.object.matrix)}else r.object.isOrthographicCamera?(B(e*(r.object.right-r.object.left)/r.object.zoom/i.clientWidth,r.object.matrix),k(s*(r.object.top-r.object.bottom)/r.object.zoom/i.clientHeight,r.object.matrix)):(console.warn("WARNING: MapControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}}();function H(t){r.object.isPerspectiveCamera?f/=t:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom*t)),r.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: MapControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function V(t){r.object.isPerspectiveCamera?f*=t:r.object.isOrthographicCamera?(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/t)),r.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: MapControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function $(t){if(!1!==r.enableRotate&&0!=(u&d.ROTATE)){if(M.set(t.touches[0].pageX,t.touches[0].pageY),_.set(t.touches[1].pageX,t.touches[1].pageY),O.subVectors(M,w),T.subVectors(_,E),v.subVectors(E,w),x.subVectors(_,M),function(){if(!z(v))return!1;if(!z(x))return!1;if(!G(O))return!1;if(!G(T))return!1;return O.dot(T)>0}()){var e=r.domElement===document?r.domElement.body:r.domElement;D(2*Math.PI*O.y/e.clientHeight),u=d.ROTATE_UP}else 0!=(u&d.ROTATE_LEFT)&&R((v.angle()-x.angle())*r.rotateSpeed);w.copy(M),E.copy(_)}}var U,z=(U=Math.sin(Math.PI/6),function(t){return Math.abs(Math.sin(t.angle()))<U}),G=function(){var t=Math.cos(Math.PI/2-Math.PI/6);return function(e){return Math.abs(Math.cos(e.angle()))<t}}();function W(t){if(!1!==r.enabled){switch(t.preventDefault(),t.button){case r.mouseButtons.ORBIT:if(!1===r.enableRotate)return;!function(t){w.set(t.clientX,t.clientY)}(t),u=d.ROTATE;break;case r.mouseButtons.ZOOM:if(!1===r.enableZoom)return;!function(t){j.set(t.clientX,t.clientY)}(t),u=d.DOLLY;break;case r.mouseButtons.PAN:if(!1===r.enablePan)return;!function(t){A.set(t.clientX,t.clientY)}(t),u=d.PAN}u!==d.NONE&&(document.addEventListener("mousemove",Y,!1),document.addEventListener("mouseup",q,!1),r.dispatchEvent(h))}}function Y(t){if(!1!==r.enabled)switch(t.preventDefault(),u){case d.ROTATE:if(!1===r.enableRotate)return;!function(t){M.set(t.clientX,t.clientY),O.subVectors(M,w).multiplyScalar(r.rotateSpeed);var e=r.domElement===document?r.domElement.body:r.domElement;R(2*Math.PI*O.x/e.clientHeight),D(2*Math.PI*O.y/e.clientHeight),w.copy(M),r.update()}(t);break;case d.DOLLY:if(!1===r.enableZoom)return;!function(t){L.set(t.clientX,t.clientY),C.subVectors(L,j),C.y>0?H(N()):C.y<0&&V(N()),j.copy(L),r.update()}(t);break;case d.PAN:if(!1===r.enablePan)return;!function(t){P.set(t.clientX,t.clientY),S.subVectors(P,A).multiplyScalar(r.panSpeed),F(S.x,S.y),A.copy(P),r.update()}(t)}}function q(t){!1!==r.enabled&&(document.removeEventListener("mousemove",Y,!1),document.removeEventListener("mouseup",q,!1),r.dispatchEvent(c),u=d.NONE)}function X(t){!1===r.enabled||!1===r.enableZoom||u!==d.NONE&&u!==d.ROTATE||(t.preventDefault(),t.stopPropagation(),r.dispatchEvent(h),function(t){t.deltaY<0?V(N()):t.deltaY>0&&H(N()),r.update()}(t),r.dispatchEvent(c))}function Z(t){!1!==r.enabled&&!1!==r.enableKeys&&!1!==r.enablePan&&function(t){switch(t.keyCode){case r.keys.UP:F(0,r.keyPanSpeed),r.update();break;case r.keys.BOTTOM:F(0,-r.keyPanSpeed),r.update();break;case r.keys.LEFT:F(r.keyPanSpeed,0),r.update();break;case r.keys.RIGHT:F(-r.keyPanSpeed,0),r.update()}}(t)}function J(t){if(!1!==r.enabled){switch(t.preventDefault(),t.touches.length){case 1:if(!1===r.enablePan)return;!function(t){r.enablePan&&A.set(t.touches[0].pageX,t.touches[0].pageY)}(t),u=d.PAN;break;case 2:if(!1===r.enableZoom&&!1===r.enableRotate)return;!function(t){w.set(t.touches[0].pageX,t.touches[0].pageY),E.set(t.touches[1].pageX,t.touches[1].pageY)}(t),function(t){if(r.enableZoom){var e=t.touches[0].pageX-t.touches[1].pageX,s=t.touches[0].pageY-t.touches[1].pageY,i=Math.sqrt(e*e+s*s);j.set(0,i)}}(t),u=d.DOLLY_ROTATE;break;default:u=d.NONE}u!==d.NONE&&r.dispatchEvent(h)}}function K(t){if(!1!==r.enabled)switch(t.preventDefault(),t.stopPropagation(),t.touches.length){case 1:if(!1===r.enablePan)return;if(u!==d.PAN)return;!function(t){!1!==r.enablePan&&0!=(u&d.PAN)&&(P.set(t.touches[0].pageX,t.touches[0].pageY),S.subVectors(P,A).multiplyScalar(r.panSpeed),F(S.x,S.y),A.copy(P))}(t),r.update();break;case 2:if(!1===r.enableZoom&&!1===r.enableRotate)return;if(0==(u&d.DOLLY_ROTATE))return;$(t),function(t){if(!1!==r.enableZoom&&0!=(u&d.DOLLY)){var e=t.touches[0].pageX-t.touches[1].pageX,s=t.touches[0].pageY-t.touches[1].pageY,i=Math.sqrt(e*e+s*s);L.set(0,i),C.set(0,Math.pow(L.y/j.y,r.zoomSpeed)),H(C.y),j.copy(L)}}(t),r.update();break;default:u=d.NONE}}function Q(t){!1!==r.enabled&&(r.dispatchEvent(c),u=d.NONE)}function tt(t){t.preventDefault(),r.enabled}r.domElement.addEventListener("contextmenu",tt,!1),r.domElement.addEventListener("mousedown",W,!1),r.domElement.addEventListener("wheel",X,!1),r.domElement.addEventListener("touchstart",J,!1),r.domElement.addEventListener("touchend",Q,!1),r.domElement.addEventListener("touchmove",K,!1),window.addEventListener("keydown",Z,!1),this.update()},THREE.MapControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.MapControls.prototype.constructor=THREE.MapControls,Object.defineProperties(THREE.MapControls.prototype,{center:{get:function(){return console.warn("THREE.MapControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.MapControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(t){console.warn("THREE.MapControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!t}},noRotate:{get:function(){return console.warn("THREE.MapControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(t){console.warn("THREE.MapControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!t}},noPan:{get:function(){return console.warn("THREE.MapControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(t){console.warn("THREE.MapControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!t}},noKeys:{get:function(){return console.warn("THREE.MapControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(t){console.warn("THREE.MapControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!t}},staticMoving:{get:function(){return console.warn("THREE.MapControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(t){console.warn("THREE.MapControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!t}},dynamicDampingFactor:{get:function(){return console.warn("THREE.MapControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(t){console.warn("THREE.MapControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=t}}});const MapControls=THREE.MapControls,v1=new Vector3;class VisibleBox3 extends Box3{setFromObject(t){return this.makeEmpty(),t.traverseVisible(t=>{const{geometry:e}=t;if(void 0!==e)if(e.isGeometry){const{vertices:s}=e;for(let e=0,i=s.length;e<i;e++)v1.copy(s[e]),v1.applyMatrix4(t.matrixWorld),this.expandByPoint(v1)}else if(e.isBufferGeometry){const s=e.attributes.position;if(void 0!==s)for(let e=0,i=s.count;e<i;e++)v1.fromBufferAttribute(s,e).applyMatrix4(t.matrixWorld),this.expandByPoint(v1)}}),this}}const DEFAULT_CALIBRATION={UP:new Vector3(0,0,1),ZOOM_MIN:25,ZOOM_MAX:2e4};class CameraCalibration{constructor(){this.eye=new Vector3,this.up=DEFAULT_CALIBRATION.UP.clone(),this.target=new Vector3,this.zoomMin=DEFAULT_CALIBRATION.ZOOM_MIN,this.zoomMax=DEFAULT_CALIBRATION.ZOOM_MAX}}class CameraCenterOnOptions extends AbstractOptions{reset(){this.altitude=null,this.azimuth=null,this.fitRatio=1.5,this.time=700,this.zoom=!0}getAzimuth(t){return null===this.azimuth?t:Math$1.degToRad(this.azimuth)}getAltitude(t){return null===this.altitude?t:Math$1.degToRad(this.altitude)}}const THREE$1={Vector3:Vector3,Ray:Ray,Plane:Plane,Math:Math$1,CameraViewBox:function(){this.viewBasis={x:new THREE$1.Vector3,y:new THREE$1.Vector3,z:new THREE$1.Vector3},this.fitRatio=1,this.verticalTanFov=0,this.horizontalTanFov=0,this.viewProjection={top:new THREE$1.Vector3,left:new THREE$1.Vector3,bottom:new THREE$1.Vector3,right:new THREE$1.Vector3},this.bounds={isEmpty:!0,anchor:new THREE$1.Vector3,plane:new THREE$1.Plane,top:-1/0,left:1/0,bottom:1/0,right:-1/0}}};Object.assign(THREE$1.CameraViewBox.prototype,{isCameraViewBox:!0,setFitRatio:function(t){return this.fitRatio=t,this},setViewFromCamera:function(){var t=new THREE$1.Vector3,e=new THREE$1.Vector3,s=new THREE$1.Vector3;return function(i){return i.updateMatrixWorld(!0),i.matrixWorld.extractBasis(t,e,s),this.setViewFromBasis(t,e,s,i.fov,i.aspect)}}(),setViewFromBasis:function(){var t=new THREE$1.Vector3;return function(e,s,i,n,o){var a=THREE$1.Math.degToRad(n);this.verticalTanFov=2*Math.tan(a/2);var r=2*Math.atan(this.verticalTanFov/2*o);return this.horizontalTanFov=2*Math.tan(r/2),this.viewBasis.x.copy(e),this.viewBasis.y.copy(s),this.viewBasis.z.copy(i),this.viewProjection.top.set(0,0,0),this.viewProjection.bottom.set(0,0,0),this.viewProjection.left.set(0,0,0),this.viewProjection.right.set(0,0,0),t.copy(i).multiplyScalar(-Math.cos(a/2)),this.viewProjection.top.add(t),this.viewProjection.bottom.add(t),t.copy(s).multiplyScalar(Math.sin(a/2)),this.viewProjection.top.add(t),this.viewProjection.bottom.add(t.negate()),t.copy(i).multiplyScalar(-Math.cos(r/2)),this.viewProjection.left.add(t),this.viewProjection.right.add(t),t.copy(e).multiplyScalar(Math.sin(r/2)),this.viewProjection.right.add(t),this.viewProjection.left.add(t.negate()),this}}(),setFromObject:function(t){return this.makeEmpty(),this.expandByObject(t)},setFromObjects:function(t){return this.makeEmpty(),this.expandByObjects(t)},makeEmpty:function(){return this.isEmpty=!0,this.bounds.top=-1/0,this.bounds.left=1/0,this.bounds.bottom=1/0,this.bounds.right=-1/0,this},expandByObject:function(){var t,e,s,i=new THREE$1.Vector3;function n(n){var o=n.geometry;if(void 0!==o)if(o.isGeometry){var a=o.vertices;for(e=0,s=a.length;e<s;e++)i.copy(a[e]),i.applyMatrix4(n.matrixWorld),t.expandByPoint(i)}else if(o.isBufferGeometry){var r=o.attributes.position;if(void 0!==r)for(e=0,s=r.count;e<s;e++)i.fromBufferAttribute(r,e).applyMatrix4(n.matrixWorld),t.expandByPoint(i)}}return function(e){return t=this,e.updateMatrixWorld(!0),e.traverse(n),this}}(),expandByObjects:function(t){for(var e=0;e<t.length;e++)this.expandByObject(t[e]);return this},expandByPoint:function(){var t,e=new THREE$1.Ray,s=new THREE$1.Vector3;return function(i){this.isEmpty&&(this.bounds.anchor.copy(i),this.bounds.plane.setFromNormalAndCoplanarPoint(this.viewBasis.z,this.bounds.anchor),this.isEmpty=!1),e.origin.copy(i),e.direction.copy(this.viewProjection.top),null===e.intersectPlane(this.bounds.plane,s)&&(e.direction.negate(),e.intersectPlane(this.bounds.plane,s)),t=s.sub(this.bounds.anchor).dot(this.viewBasis.y),this.bounds.top=Math.max(this.bounds.top,t),e.direction.copy(this.viewProjection.bottom),null===e.intersectPlane(this.bounds.plane,s)&&(e.direction.negate(),e.intersectPlane(this.bounds.plane,s)),t=s.sub(this.bounds.anchor).dot(this.viewBasis.y),this.bounds.bottom=Math.min(this.bounds.bottom,t),e.direction.copy(this.viewProjection.left),null===e.intersectPlane(this.bounds.plane,s)&&(e.direction.negate(),e.intersectPlane(this.bounds.plane,s)),t=s.sub(this.bounds.anchor).dot(this.viewBasis.x),this.bounds.left=Math.min(this.bounds.left,t),e.direction.copy(this.viewProjection.right),null===e.intersectPlane(this.bounds.plane,s)&&(e.direction.negate(),e.intersectPlane(this.bounds.plane,s)),t=s.sub(this.bounds.anchor).dot(this.viewBasis.x),this.bounds.right=Math.max(this.bounds.right,t)}}(),getTarget:function(){var t=new THREE$1.Vector3;return function(e,s){return this.getCameraPositionAndTarget(t,e,s)}}(),getCameraPosition:function(){var t=new THREE$1.Vector3;return function(e){return this.getCameraPositionAndTarget(e,t)}}(),getCameraPositionAndTarget:function(){var t=new THREE$1.Vector3,e=new THREE$1.Vector3,s=new THREE$1.Ray;return function(i,n,o){e.copy(this.bounds.anchor),t.copy(this.viewBasis.y).multiplyScalar((this.bounds.top+this.bounds.bottom)/2),e.add(t),t.copy(this.viewBasis.x).multiplyScalar((this.bounds.left+this.bounds.right)/2),e.add(t);var a=Math.max((this.bounds.top-this.bounds.bottom)/this.verticalTanFov,(this.bounds.right-this.bounds.left)/this.horizontalTanFov);return t.copy(this.viewBasis.z).multiplyScalar(a*this.fitRatio),i.copy(e).add(t),n.copy(e),void 0!==o&&(s.origin.copy(i),s.direction.copy(this.viewBasis.z).negate(),null===s.intersectPlane(o,n)&&(s.direction.negate(),null===s.intersectPlane(o,n)&&console.warn("THREE.CameraViewBox: unable to put target on given floor plane"))),this}}()});const CameraViewBox=THREE$1.CameraViewBox,v2=new Vector2,v0=new Vector2,visibleBox=new VisibleBox3;class CameraManagerBase extends EventDispatcher{constructor(t,e){super(),this.awm=t,this.options=e,this.camera=new PerspectiveCamera(45,1,.1,5e4),this.control=null,this.floorPlane=new Plane,this.floorPlane.normal.set(0,0,-1),this.ray=new Ray,this.cameraCalibrations=new Map,this._tween=null,this.cameraViewBox=new CameraViewBox}start(){this.control.enabled=!0}stop(){this.control.enabled=!1}init(t){this.projector=t,this.awm.sceneManager.addEventListener(SceneEvents.floor.didChanged,({current:t})=>{const e=this._getFloorCalibration(t);this.floorPlane.constant=e.target.z;const s=this.control.target.clone().sub(this.camera.position).normalize();this._putTargetOnFloorPlan(this.control.target,s),this.camera.updateMatrix(),this.control.update(),this.awm.engineManager.requestUpdate()})}_getFloorCalibration(t){let e=null;if(this.cameraCalibrations.has(t))e=this.cameraCalibrations.get(t);else{console.warn("AdsumWebMap.CameraManager: Missing calibration for centerOnFloor");const s=null===t?this.awm.objectManager.site:t;s.getBoundingBox(visibleBox);const i=new Sphere;visibleBox.getBoundingSphere(i);const n=new Vector3;s.getWorldPosition(n),i.center.z=n.z,(e=new CameraCalibration).target.copy(i.center),e.eye.copy(i.center);const o=1.5*i.radius*Math.sin(Math.PI/4);e.eye.setZ(e.eye.z+o),e.eye.setY(e.eye.y-o),this.cameraCalibrations.set(t,e)}return e}centerOnFloor(t,e=!0){this.reset();try{const s=this._getFloorCalibration(t),i=this.getState(s.target,s.eye);return this._goTo(i.target,i.distance,i.azimuth,i.altitude,e)}catch(t){return Promise.reject(t)}}centerOnObjects(t,e=!0,s=null){this.reset();try{let i=null;null===s?({centerOnOptions:i}=this.options):i=new CameraCenterOnOptions(s);const n=this.getState(),o=i.getAzimuth(n.azimuth),a=i.getAltitude(n.altitude);let{distance:r}=n;const{x:l,y:h,z:c}=this.getCameraBasis(o,a);this.cameraViewBox.setViewFromBasis(l,h,c,this.camera.fov,this.camera.aspect),this.cameraViewBox.makeEmpty(),t.forEach(t=>this.cameraViewBox.expandByObject(t._mesh));const d=new Vector3;if(i.zoom){const t=new Vector3;this.cameraViewBox.setFitRatio(i.fitRatio),this.cameraViewBox.getCameraPositionAndTarget(t,d,this.floorPlane),r=t.sub(d).length(),r=Math$1.clamp(r,this.control.minDistance,this.control.maxDistance)}else this.cameraViewBox.getTarget(d,this.floorPlane);return this._goTo(d,r,o,a,e,i.time)}catch(t){return Promise.reject(t)}}centerOn(t,e=!0,s=null){return this.centerOnObjects([t],e,s)}_putTargetOnFloorPlan(t,e,s=this.floorPlane){this.ray.direction.copy(e),this.ray.origin.copy(t),null===this.ray.intersectPlane(s,t)&&(this.ray.direction.negate(),this.ray.intersectPlane(s,t))}setCameraCalibrations(t){this.cameraCalibrations=new Map,t.forEach((t,e)=>{const s=this.awm.objectManager,i=null===e?s.site:s.getFloor(e);if(null===i)return;const n=new Vector3;if(i.getWorldPosition(n),t.target.z!==n.z){console.warn(`AdsumWebMap: invalid calibration target of ${i.id}, it's not on the floor`);const e=new Plane;e.normal.set(0,0,-1),e.constant=n.z;const s=new Vector3;s.copy(t.target).sub(t.eye),s.normalize(),this._putTargetOnFloorPlan(t.target,s,e)}this.cameraCalibrations.set(null===e?null:i,t)})}move(t,e=!0,s=700){const i=this.getState(),n=Number.isFinite(t.azimuth)?Math$1.degToRad(t.azimuth):i.azimuth,o=Number.isFinite(t.altitude)?Math$1.degToRad(t.altitude):i.altitude,a=Number.isFinite(t.distance)?this.projector.meterToAdsumDistance(t.distance):i.distance;return this._goTo(i.target,a,n,o,e,s)}_goTo(t,e,s,i,n=!0,o=700){const a=this.getState();if(a.distance===e&&a.azimuth===s&&a.altitude===i&&a.target.equals(t))return Promise.resolve(!0);let r=Math.max(e,1.1*this.camera.near,this.control.minDistance);return r=Math.min(r,this.control.maxDistance,.9*this.camera.far),new Promise((e,l)=>{try{if(this.reset(),n){const n=t.clone();this.control.enabled=!1,i=this._clampAltitude(i);const l=r-a.distance,h=i-a.altitude;let c=s-a.azimuth;c>Math.PI?c-=2*Math.PI:c<-Math.PI&&(c+=2*Math.PI);const d={deltaDistance:0,deltaAltitude:0,deltaAzimuth:0,x:this.control.target.x,y:this.control.target.y,z:this.control.target.z};this._tween=new Tween(d).to({deltaDistance:l,deltaAltitude:h,deltaAzimuth:c,x:t.x,y:t.y,z:t.z},o).on("update",()=>{this.updateState(n.set(d.x,d.y,d.z),a.distance+d.deltaDistance,a.azimuth+d.deltaAzimuth,a.altitude+d.deltaAltitude)}).on("stop",()=>{this.updateState(t,r,s,i),this.control.enabled=!0,e(!1)}).on("complete",()=>{this.updateState(t,r,s,i),this.control.enabled=!0,e(!0)}).easing(Easing.Quadratic.InOut).start(),this.awm.engineManager.requestUpdate()}else this.updateState(t,r,s,i),e(!0)}catch(t){l(t)}})}reset(){return null!==this._tween&&(this._tween.stop(),this._tween=null),this}getState(t=this.control.target,e=this.camera.position){const s=t.clone().sub(e),i=s.length(),n=this.projector.getAdsumNorthAngle();v2.set(s.x,s.y);let o=n-v2.angle();return o<0&&(o+=2*Math.PI),{target:t,distance:i,altitude:Math.asin(-s.z/i),azimuth:o}}updateState(t,e,s,i){this.control.target.copy(t),i=this._clampAltitude(i);const n=(e=Math$1.clamp(e,this.control.minDistance,this.control.maxDistance))*Math.sin(i),o=this.projector.getAdsumNorthAngle()-s;v2.set(Math.cos(o),Math.sin(o)),v2.multiplyScalar(e*Math.cos(i)),this.camera.position.set(t.x-v2.x,t.y-v2.y,t.z+n),this.camera.updateMatrix(),this.control.update(),this.awm.engineManager.requestUpdate()}getCameraBasis(t,e){e=this._clampAltitude(e),this.projector.getAdsumNorthDirection(v2),v0.set(0,0),v2.rotateAround(v0,-t),v2.multiplyScalar(Math.abs(Math.cos(e)));const s=new Vector3(+v2.x,+v2.y,-Math.sin(e));s.normalize().negate();const i=new Vector3(v2.x,v2.y,0);i.normalize();const n=new Vector3;return n.crossVectors(i,s),n.normalize(),i.crossVectors(s,n),i.normalize(),{x:n,y:i,z:s}}_clampAltitude(t){return Math$1.clamp(t,Math.PI/2-this.control.maxPolarAngle,Math.PI/2-this.control.minPolarAngle)}}class CameraManager extends CameraManagerBase{init(t){super.init(t);const{canvas:e}=this.awm.engineManager;this.camera.aspect=e.clientWidth/e.clientHeight,this.camera.near=t.meterToAdsumDistance(1),this.camera.far=t.meterToAdsumDistance(1e4),this.camera.up.set(0,0,1),this.camera.updateProjectionMatrix(),this.control=new MapControls(this.camera,this.awm.engineManager.canvas),this.control.enabled=!1,this.control.enableZoom=!0,this.control.enableRotate=!0,this.control.enableDamping=!1,this.control.enableKeys=!1,this.control.minPolarAngle=.001,this.control.maxPolarAngle=5*Math.PI/12,this.control.minDistance=t.meterToAdsumDistance(5),this.control.addEventListener("change",()=>{this.camera.updateMatrix(),this.awm.engineManager.requestUpdate()})}}const MOUSE_EVENTS={click:"click",dblClick:"dblClick"};class MouseManagerBase extends EventDispatcher{constructor(t){super(),this.awm=t,this._mouse=new Vector2,this._raycaster=new Raycaster,this.enabled=!1}init(){}start(){this.enabled=!0}stop(){this.enabled=!1}_onMouseClick(t){this.enabled&&(this._setMouseCoordinate(t),this.dispatchEvent({type:MOUSE_EVENTS.click,intersects:this._raycast()}))}_onMouseDblClick(t){this.enabled&&(this._setMouseCoordinate(t),this.dispatchEvent({type:MOUSE_EVENTS.dblClick,intersects:this._raycast()}))}_onMouseMove(){}_setMouseCoordinate(t){let e=0,s=0;if(void 0===t.clientX&&void 0===t.clientY){const i=t.target.getBoundingClientRect();e=t.center.x-i.left,s=t.center.y-i.top}else t.offsetX||0===t.offsetX?(e=t.offsetX,s=t.offsetY):(e=t.layerX,s=t.layerY);this._mouse.set(e/this.awm.engineManager.canvas.clientWidth*2-1,-s/this.awm.engineManager.canvas.clientHeight*2+1),this._raycaster.setFromCamera(this._mouse,this.awm.cameraManager.camera),this._raycaster.near=this.awm.cameraManager.camera.near,this._raycaster.far=this.awm.cameraManager.camera.far}_raycast(){const t=[];return this.awm.objectManager.site._raycast(this._raycaster,t),t.sort((t,e)=>t.distance-e.distance),t}}class MouseManager extends MouseManagerBase{init(){super.init(),this.awm.engineManager.canvas.addEventListener("mousemove",this._onMouseMove.bind(this));const t=new Manager(this.awm.engineManager.canvas);t.add(new Tap({event:"doubletap",threshold:10,taps:2,posThreshold:50*window.devicePixelRatio})),t.add(new Tap({event:"singletap",threshold:10,time:500,interval:100})),t.get("doubletap").recognizeWith("singletap"),t.get("singletap").requireFailure("doubletap"),t.on("singletap ",this._onMouseClick.bind(this)),t.on("doubletap ",this._onMouseDblClick.bind(this))}}const AdsumObjectTypes={AdsumObject3D:"AdsumObject3D",BuildingObject:"BuildingObject",FloorObject:"FloorObject",LabelImageObject:"LabelImageObject",LabelObject:"LabelObject",LabelTextObject:"LabelTextObject",SiteObject:"SiteObject",SpaceObject:"SpaceObject",PathSectionObject:"PathSectionObject",UserObject:"UserObject",DotUserObject:"DotUserObject",OrientedDotUserObject:"OrientedDotUserObject"};function getAdsumObjectGroundAndPosition(t){let e=null,s=null;switch(t.getType()){case AdsumObjectTypes.SiteObject:case AdsumObjectTypes.FloorObject:e=t;break;case AdsumObjectTypes.BuildingObject:e=t.site,(s=t.getPosition(new Vector3)).setZ(0);break;case AdsumObjectTypes.SpaceObject:case AdsumObjectTypes.UserObject:e=t.parent,(s=t.getPosition(new Vector3)).setZ(0);break;case AdsumObjectTypes.LabelObject:case AdsumObjectTypes.LabelTextObject:case AdsumObjectTypes.LabelImageObject:{(s=t.getPosition(new Vector3)).setZ(0);const{parent:i}=t;i.isSpace?(e=i.parent,s.applyMatrix4(i.matrix)):i.isBuilding?(e=i.site,s.applyMatrix4(i.matrix)):e=i;break}default:throw new Error("Unexpected")}return{ground:e,groundPosition:s}}function getUtmPosition(t,e,s){const i=t.localToWorld(e.clone());return i.setZ(t.isSite?0:t.altitude),s.adsumToUtm(i)}class PathNode{static create(t,e,s,i,n){return new this(t,e,s,getUtmPosition(e,s,i),n)}static updateFromAdsumObject(t,e,s){const{ground:i,groundPosition:n}=getAdsumObjectGroundAndPosition(e,s);t.ground=i,t.groundPosition=n,t.utmPosition=getUtmPosition(i,n,s),t.version++}static createFromAdsumObject(t,e){const{ground:s,groundPosition:i}=getAdsumObjectGroundAndPosition(t,e);return this.create(t.placeId,s,i,e,{isGate:!1,isCheckpoint:!1,isFloorAccess:!1})}constructor(t,e,s,i,{isGate:n,isCheckpoint:o,isFloorAccess:a}){this.id=t||Symbol("PathNodeId"),this.ground=e,this.links=new Set,this.utmPosition=i,this.groundPosition=s,this.isDynamic=!1,this.version=0,this.isGate=Boolean(n),this.isCheckpoint=Boolean(o),this.isFloorAccess=Boolean(a)}getLinkTo(t){let e=null;return this.links.forEach(s=>{s.to!==t&&s.from!==t||(e=s)}),e}}const PATH_LINK_TYPES={STANDARD:0,ONLY_DISABLED:1,NOT_DISABLED:2,CLOSED:3};class PathLink{constructor(t,e,s,i,n=!0){this.id=t,this.type=e,this.from=s,this.to=i,this.bidirectional=n,this.distance=Math.sqrt((s.utmPosition.N-i.utmPosition.N)**2+(s.utmPosition.E-i.utmPosition.E)**2+(s.utmPosition.alt-i.utmPosition.alt)**2)}isAccessible(t){return this.type===PATH_LINK_TYPES.STANDARD||(t?this.type===PATH_LINK_TYPES.ONLY_DISABLED:this.type===PATH_LINK_TYPES.NOT_DISABLED)}}class AStar{constructor(t){this.pathNetwork=t,this._cache=new Map,this._dynamicCache=new Map,this._computing=new Map,this._symbolStrings=new Map,this._symbolIncrement=0}search(t,e,s=!1){if(this._isCached(t,e,s))return this._getFromCache(t,e,s);if(this._isComputing(t,e,s))return this._getFromComputing(t,e,s);const i=Promise.resolve().then(()=>{const i=new Map,n=new Set,o=new Map;for(o.set(t.id,{d:0,parent:null}),o.set(e.id,{d:1/0,parent:null}),i.set(t.id,t);i.size>0;){const t=Array.from(i.values());let a=t[0];for(let e=1;e<t.length;e++){const s=t[e];o.get(s.id).d<o.get(a.id).d&&(a=s)}if(a===e){const t=[a];let{parent:e}=o.get(a.id);for(;null!==e;){t.push(e);const s=o.get(e.id);({parent:e}=s)}return t.reverse()}i.delete(a.id),n.add(a.id);const r=[],l=[];a.links.forEach(t=>{t.isAccessible(s)&&(t.from===a?(r.push(t.to),l.push(t.distance)):t.to===a&&t.bidirectional&&(r.push(t.from),l.push(t.distance)))});for(let t=0;t<r.length;t++){const e=r[t];if(n.has(e.id))continue;i.has(e.id)||(o.set(e.id,{d:1/0,parent:null}),i.set(e.id,e));const s=o.get(a.id).d+l[t],h=o.get(e.id);s<h.d&&(h.parent=a,h.d=s)}}return[]});return this._addToComputing(t,e,s,i),i}_addToCache(t,e,s,i){const n=this._getCacheKey(t,e,s);t.isDynamic&&(this._dynamicCache.has(t.id)?this._dynamicCache.get(t.id).cacheEntries.add(n):this._dynamicCache.set(t.id,{version:t.version,cacheEntries:new Set([n])})),e.isDynamic&&(this._dynamicCache.has(e.id)?this._dynamicCache.get(e.id).cacheEntries.add(n):this._dynamicCache.set(e.id,{version:e.version,cacheEntries:new Set([n])})),this._cache.set(n,i.map(t=>t.id))}_getFromCache(t,e,s){const i=this._getCacheKey(t,e,s);return Promise.resolve(this._cache.get(i).map(t=>this.pathNetwork.nodes.get(t)))}_getCacheKey(t,e,s){return`${this._stringifyId(t.id)}:${this._stringifyId(e.id)}${s?":pmr":""}`}_stringifyId(t){return"symbol"!=typeof t?`${t}`:(this._symbolStrings.has(t)||this._symbolStrings.set(t,`s${this._symbolIncrement++}`),this._symbolStrings.get(t))}_isCached(t,e,s){let i=!1;if(t.isDynamic)if(this._dynamicCache.has(t.id)){const e=this._dynamicCache.get(t.id);e.version!==t.version&&(e.cacheEntries.forEach(t=>{this._cache.delete(t)}),e.cacheEntries.clear(),i=!0)}else i=!0;if(e.isDynamic)if(this._dynamicCache.has(e.id)){const t=this._dynamicCache.get(e.id);t.version!==e.version&&(t.cacheEntries.forEach(t=>{this._cache.delete(t)}),t.cacheEntries.clear(),i=!0)}else i=!0;return!i&&this._cache.has(this._getCacheKey(t,e,s))}_addToComputing(t,e,s,i){const n=this._getCacheKey(t,e,s);this._computing.set(n,i),i.then(i=>{this._addToCache(t,e,s,i),this._computing.delete(n)})}_getFromComputing(t,e,s){const i=this._getCacheKey(t,e,s);return this._computing.get(i).then(()=>this.search(t,e,s))}_isComputing(t,e,s){return this._computing.has(this._getCacheKey(t,e,s))}}class PathSection{constructor(t=null,e=null,s=null,i=[],n=[]){this.from=t,this.to=s,this.ground=e,this.grounds=i,this.nodes=n,this._distance=null,this._curve=null}isInterGround(){return this.grounds.length>1}getLastGround(){return this.grounds[this.grounds.length-1]}getDistance(){return null===this._distance&&this._initCurveAndDistance(),this._distance}getCurve(){return this.nodes.length<2?null:(null===this._curve&&this._initCurveAndDistance(),this._curve)}_initCurveAndDistance(){this._curve=[],this._distance=0;const t=null!==this.to?this.to.adsumObject:null,e=null!==t&&(t.isSpace||t.isBuilding);for(let t=0;t<this.nodes.length-1;t++){const s=this.nodes[t].getLinkTo(this.nodes[t+1]);let i=s.distance;const n=this.nodes[t],o=this.nodes[t+1];e&&this.to.pathNode===o&&(i=0),this._distance+=i,this._curve.push({from:n,to:o,fromGround:n.ground,fromGroundPosition:n.isDynamic?n.groundPosition.clone():n.groundPosition,toGround:o.ground,toGroundPosition:o.isDynamic?o.groundPosition.clone():o.groundPosition,distance:s.distance,cumulativeDistance:this._distance})}}getRealInterval(t){let e=t;t>this.getDistance()/3&&(console.warn("AdsumWebMap.PathSection.interpolate: short pathSection"),e=this.getDistance()/3);const s=Math.floor(this.getDistance()/e);return this.getDistance()/s}interpolate(t){if(null===this.getCurve())return[];const e=this.getRealInterval(t),s=Math.round(this.getDistance()/e),i=[];for(let t=0;t<=s;t++)i.push(this.at(e*t));return i}at(t,e=new Vector3){const s=this.getCurve();if(null===s)return null;let i=t;for(let t=0;t<s.length;t++){const{from:n,to:o,distance:a}=s[t];if(!(a<i)){const t=i/a;return e.lerpVectors(this.getLocalNodePosition(n),this.getLocalNodePosition(o),t),e}i-=a}const{to:n}=s[s.length-1];return this.getLocalNodePosition(n)}getLocalNodePosition(t){if(t.ground===this.ground)return t.groundPosition.clone();const e=t.groundPosition.clone();return t.ground.localToWorld(e),this.ground.worldToLocal(e),e}getAzimuthOrientation(){if(this.nodes.length<2)return null;const t=this.nodes[0],e=this.nodes[this.nodes.length-1],s=e.utmPosition.E-t.utmPosition.E,i=e.utmPosition.N-t.utmPosition.N,n=Math.atan2(i,s);let o=Math.PI/2-n;return o<0&&(o+=2*Math.PI),Math$1.radToDeg(o)}}class PathNetwork{constructor(t){this.awm=t,this.nodes=new Map,this.spaceGatesByAdsumObjectId=new Map,this.buildingGatesByAdsumObjectId=new Map,this.aStar=new AStar(this),this.dynamicNodeAttachCache=new Map}init(t){t.get("nodes").forEach(t=>{const{parent:e,ground:s}=this._findParentAndGround(t.location);if(null===e)return void console.warn("AdsumWebMap.PathNetwork: invalid node");const i=new Vector3(t.position.x,t.position.y,t.position.z),n=PathNode.create(t.id,s,i,this.awm.projector,t);this.nodes.set(n.id,n),n.isGate&&("STORE"===t.location.type||"SHAPE"===t.location.type?(this.spaceGatesByAdsumObjectId.has(t.location.id)||this.spaceGatesByAdsumObjectId.set(t.location.id,[]),this.spaceGatesByAdsumObjectId.get(t.location.id).push(n)):"BUILDING"===t.location.type?(this.buildingGatesByAdsumObjectId.has(t.location.id)||this.buildingGatesByAdsumObjectId.set(t.location.id,[]),this.buildingGatesByAdsumObjectId.get(t.location.id).push(n)):console.warn(`AdsumWebMap.PathNetwork: Invalid node gate on ${t.type}#${t.id}`))}),t.get("links").forEach(t=>{const e=this.nodes.get(t.from),s=this.nodes.get(t.to);if(void 0===e||void 0===s)return void console.warn("AdsumWebMap.PathNetwork: invalid link");const i=new PathLink(t.id,t.type,e,s,t.bidirectional);e.links.add(i),i.bidirectional&&s.links.add(i)})}computePath(t){const{from:e,to:s}=t;return!e.pathNode.isDynamic&&this.nodes.has(e.pathNode.id)||this.attachNodeLocation(e),!s.pathNode.isDynamic&&this.nodes.has(s.pathNode.id)||this.attachNodeLocation(s),this.aStar.search(e.pathNode,s.pathNode,t.pmr).then(e=>{this._buildPathSections(t,e)})}attachNodeLocation(t){const{ground:e,groundPosition:s,version:i}=t.pathNode;if(this.nodes.has(t.pathNode.id)&&this.dynamicNodeAttachCache.get(t.pathNode.id)===i)return;let n=null;if(t.adsumObject&&t.adsumObject.isSpace)n=this.spaceGatesByAdsumObjectId.get(t.adsumObject.id)||[];else if(t.adsumObject&&t.adsumObject.isBuilding)n=this.buildingGatesByAdsumObjectId.get(t.adsumObject.id)||[];else{n=[];let i=1/0;const o=[];if(this.nodes.forEach(s=>{if(s!==t.pathNode&&s.ground===e){const e=s.groundPosition.distanceToSquared(t.pathNode.groundPosition);e<=9*i&&o.push({squareDistance:e,node:s}),e<i&&(i=e)}}),i!==1/0){o.sort((t,e)=>t.squareDistance-e.squareDistance);const t=new Raycaster(e.localToWorld(s.clone())),a=[],r=[];o.forEach(({squareDistance:s,node:o})=>{if(!(s>9*i)){t.ray.direction=e.localToWorld(o.groundPosition.clone()),t.ray.direction.sub(t.ray.origin),t.near=0,t.far=t.ray.direction.length(),t.ray.direction.normalize();for(let e=0;e<r.length;e++)if(r[e].angleTo(t.ray.direction)<Math.PI/4)return;a.length=0;for(let s=0;s<e._mesh.children.length;s++){const i=e._mesh.children[s],{adsumObject:n}=i;if(!(n&&(n.isLabel||n.isUser))&&(t.intersectObject(i,!1,a),0!==a.length))return}n.push(o),r.push(t.ray.direction)}})}}t.pathNode.links.forEach(e=>{e.from.links.delete(e),e.to.links.delete(e),t.pathNode.links.delete(e)}),n.forEach(e=>{const s=new PathLink(Symbol("PathLinkId"),PATH_LINK_TYPES.STANDARD,t.pathNode,e);t.pathNode.links.add(s),e.links.add(s)}),this.nodes.set(t.pathNode.id,t.pathNode),this.dynamicNodeAttachCache.set(t.pathNode.id,i)}_findParentAndGround(t){let e=null,s=null;switch(t.type){case"STORE":case"SHAPE":null!==(e=this.awm.objectManager.getSpace(t.id))&&(s=e.parent);break;case"FLOOR":null!==(e=this.awm.objectManager.getFloor(t.id))&&(s=e);break;case"BUILDING":s=(e=this.awm.objectManager.getBuilding(t.id)).site;break;case"SITE":s=e=this.awm.objectManager.site;break;default:console.warn(`AdsumWebMap.WayfindingManager.PathNetwork: unknown location.type ${t.type} `)}return null===e&&console.warn(`AdsumWebMap.WayfindingManager.PathNetwork: invalid location ${t.type}#${t.id}`),{parent:e,ground:s}}_buildPathSections(t,e){if(e.length<2)throw new Error("AdsumWebMap.PathNetwork: No path found to destination");const s=[],i=this.constructor._detectPathBreakpoints(e);let n=0;for(let t=0;t<i.length;t++){const o=i[t];s.push(this._getPathSection(n,o,e)),n=o}s.push(this._getPathSection(n,e.length-1,e)),t.setPathSections(s)}_getPathSection(t,e,s){const i=s[t],n=s[e],o=this.getPathNodeLocation(i),a=this.getPathNodeLocation(n),r=[],l=[];for(let i=t;i<=e;i++)0!==r.length&&r[r.length-1]===s[i].ground||r.push(s[i].ground),l.push(s[i]);return new PathSection(o,r[0],a,r,l)}getPathNodeLocation(t){const{locationRepository:e}=this.awm.wayfindingManager;return e.locationsByPathNodeId.has(t.id)?e.locationsByPathNodeId.get(t.id):null}static _detectPathBreakpoints(t){if(t.length<2)throw new Error("AdsumWebMap.PathNetwork: No path found to destination");const e=[];for(let s=1;s<t.length-1;s++){const i=t[s-1],n=t[s],o=t[s+1],a=i.ground!==n.ground,r=n.ground!==o.ground;n.isCheckpoint?e.push(s):(a||r)&&a!==r&&e.push(s)}return e}}class AdsumLocation{constructor(t=null,e=null,s=null){this.isLocation=!0,this.id=t,this.pathNode=e,this.adsumObject=s}updateFromObjectPosition(t){PathNode.updateFromAdsumObject(this.pathNode,this.adsumObject,t)}}class LocationRepository{constructor(){this.locations=new Map,this.locationsByAdsumObject=new Map,this.locationsByPathNodeId=new Map,this.projector=null,this.objectManager=null,this.userLocation=null}init(t,e,s,i){this.projector=t,this.objectManager=s,i.forEach(t=>{if(null!==t.path_node_id&&e.nodes.has(t.path_node_id)){const i=e.nodes.get(t.path_node_id);let n=null;t.custom_objects.size>0&&(n=s.getLabel(t.custom_objects.at(0).value));const o=new AdsumLocation(t.id,i,n);this.locations.set(o.id,o),this.locationsByPathNodeId.set(o.pathNode.id,o),null!==n&&this.locationsByAdsumObject.set(n,o)}}),s.labels.forEach(t=>{if(t.parent.isBuilding||t.parent.isSpace||this.locations.has(t.placeId))return;const e=new AdsumLocation(t.placeId,PathNode.createFromAdsumObject(t,this.projector),t);this.locations.set(e.id,e),this.locationsByAdsumObject.set(t,e),this.locationsByPathNodeId.set(e.pathNode.id,e)}),s.spaces.forEach(t=>{const e=new AdsumLocation(t.placeId,PathNode.createFromAdsumObject(t,this.projector),t);this.locations.set(e.id,e),this.locationsByAdsumObject.set(t,e),this.locationsByPathNodeId.set(e.pathNode.id,e)}),s.buildings.forEach(t=>{const e=new AdsumLocation(t.placeId,PathNode.createFromAdsumObject(t,this.projector),t);this.locations.set(e.id,e),this.locationsByAdsumObject.set(t,e),this.locationsByPathNodeId.set(e.pathNode.id,e)})}createUserLocation(){if(null!==this.userLocation)throw new Error("Unexpected");const t=Symbol("UserLocation");this.userLocation=new AdsumLocation(t,PathNode.createFromAdsumObject(this.objectManager.user,this.projector),this.objectManager.user),this.userLocation.pathNode.isDynamic=!0,this.locations.set(t,this.userLocation),this.locationsByPathNodeId.set(this.userLocation.pathNode.id,this.userLocation)}get(t){return this.locations.has(t)?this.locations.get(t):null}getByAdsumObject(t){return this.locationsByAdsumObject.has(t)?this.locationsByAdsumObject.get(t):null}}const WayfindingEvents={user:{position:{didChanged:"wayfinding.user.position.didChanged"}}};class WayfindingManager extends EventDispatcher{constructor(t,e){super(),this.awm=t,this.projector=null,this.locationRepository=new LocationRepository,this.pathNetwork=new PathNetwork(t),this.options=e,this.userPositionUpdate=null}init(t){return this.projector=t.projector,this.awm.objectManager.user=this.options.userObject,this.awm.objectManager.user.setScale(this.projector.scale),this.setUserAzimuthHeading(0),this.pathNetwork.init(t.paths),this.options.pathSectionDrawer.init(this.awm),this.locationRepository.init(this.projector,this.pathNetwork,this.awm.objectManager,t.places),this.options.pathBuilder.init(this.projector,this.awm.objectManager)}computePath(t){return this.removePath(t),null===t.from&&(t.from=this.locationRepository.userLocation,null===t.from)?Promise.reject(new Error("AdsumWebMap.WayfindingManager: cannot compute path because user position is not set")):null===t.to&&(t.to=this.locationRepository.userLocation,null===t.to)?Promise.reject(new Error("AdsumWebMap.WayfindingManager: cannot compute path because user position is not set")):this.pathNetwork.computePath(t)}removePath(t){t.getPathSections(!0).forEach(t=>{this.removePathSection(t)})}drawPathSection(t,e=null){this.removePathSection(t);const s=this.options.pathBuilder.build(t);return this.options.pathSectionDrawer.draw(s,e)}removePathSection(t){this.awm.objectManager.pathSectionObjects.forEach(e=>{e.pathSection===t&&e._dispose()})}getUserUtmPosition(){const{userLocation:t}=this.locationRepository;return null===t?null:{utm:t.pathNode.utmPosition,floor:t.adsumObject.parent.isFloor?t.adsumObject.parent:null}}getUserGpsPosition(){if(null===this.locationRepository.userLocation)return null;const{utm:t,floor:e}=this.getUserUtmPosition();return{gps:this.projector.utmToGps(t),floor:e}}setUserAdsumPosition(t,e=null,s=!1){const i=null===e?this.awm.objectManager.site:e,n=this.awm.objectManager.user;null!==this.userPositionUpdate&&this.userPositionUpdate.stop();const o=new Vector3;if(o.copy(t),s&&i.worldToLocal(o),o.setZ(this.projector.meterToAdsumDistance(.05)),this.options.userPositionUpdateOptions.animated&&n.parent===i){const t=n.getPosition(new Vector3);this.userPositionUpdate=new Tween(t).to(o,this.options.userPositionUpdateOptions.duration).on("update",()=>{this._doAdsumUserPositionUpdate(t,i)}).on("complete",()=>{this._doAdsumUserPositionUpdate(o,i),this.userPositionUpdate=null,this.dispatchEvent({type:WayfindingEvents.user.position.didChanged,floor:i.isSite?null:i})}),this.userPositionUpdate.start()}else this._doAdsumUserPositionUpdate(o,i),this.dispatchEvent({type:WayfindingEvents.user.position.didChanged,floor:i.isSite?null:i});return this}_doAdsumUserPositionUpdate(t,e){this.awm.objectManager.user.setPosition(t,e),null===this.locationRepository.userLocation?this.locationRepository.createUserLocation():this.locationRepository.userLocation.updateFromObjectPosition(this.projector)}setUserGpsPosition(t,e=null){return this.setUserAdsumPosition(this.projector.gpsToAdsum(t),e,!0)}setUserUtmPosition(t,e=null){return this.setUserAdsumPosition(this.projector.utmToAdsum(t),e,!0)}setUserAzimuthHeading(t){return this.awm.objectManager.user.setRotation(this.projector.getAdsumNorthAngle()-Math$1.degToRad(t)),this}getUserDistanceFromPath(t){return Math.min(1/0,...t.getPathSections(!0).map(t=>this.getUserDistanceFromPathSection(t)))}getUserDistanceFromPathSection(t){return this.getUserPathSectionProgress(t).distanceFromPathSection}getUserPathSectionProgress(t){const{userLocation:e}=this.locationRepository;if(null===e)throw new Error("AdsumWebMap.WayfindingManager.getUserPathSectionProgress: no user position set");if(t.ground!==e.pathNode.ground)return{distanceFromPathSection:1/0,progress:0};const s=new Vector3,i=new Line3,n=t.getCurve(),{groundPosition:o}=e.pathNode;let a=1/0,r=null,l=null;null===n?t.nodes.length>0&&(a=o.distanceTo(t.nodes[0].groundPosition)):n.forEach(t=>{const{fromGroundPosition:e,toGroundPosition:n}=t;i.set(e,n);const h=i.closestPointToPointParameter(o,!0);i.at(h,s);const c=o.distanceTo(s);c<a&&(a=c,r=t,l=h)});let h=0;return null!==r&&(h=r.cumulativeDistance-r.distance,h+=l*r.distance,h/=t.getDistance()),{distanceFromPathSection:this.projector.adsumDistanceToMeter(a),progress:h}}}class EngineOptions extends AbstractOptions{reset(){super.reset(),this.container=null,this.gpuPower="high-performance",this.autoCompileMaterials=!0,this.clearColor=16777215,this.fogEnabled=!1,this.fogRatio=0,this.fogColor=16777215,this.backgroundImage=null,this.shadowEnabled=!1,this.shadowSize=2048}}class CameraCenterOnPathSectionOptions extends AbstractOptions{reset(){this.azimuth=null,this.fitRatio=1.5,this.oriented=null,this.time=700,this.zoom=!0}}class CameraOptions extends AbstractOptions{reset(){super.reset(),this.centerOnOptions=new CameraCenterOnOptions,this.centerOnPathSectionOptions=new CameraCenterOnPathSectionOptions,this.force2D=!1,this.zoomEnabled=!0,this.rotationEnabled=!0,this.keepInFloorBounds=!1}}const cameraWorld=new Vector3,objectWorld=new Vector3,v=new Vector3;class LevelOfDetails{constructor(){this.levels=new Map,this.active=!0}addLevelState(t,e){return this.levels.set(t,e),this}clear(){return this.levels.clear(),this}getLevelStates(){const t=[];return this.levels.forEach((e,s)=>{t.push({startAt:s,levelState:e})}),t.sort((t,e)=>t.startAt-e.startAt),t}removeLevelState(t){return this.levels.delete(t),this}applyLod(t,e,s){if(!this.active||0===this.levels.size)return!1;e.getWorldPosition(cameraWorld),t.getWorldPosition(objectWorld),v.subVectors(cameraWorld,objectWorld);const i=s.adsumDistanceToMeter(v.length());let n=null,o=null;return this.levels.forEach((t,e)=>{e>i||null!==o&&e<o||(n=t,o=e)}),null===o?(console.warn("AdsumWebMap.LevelOfDetails: cannot find LevelState matching, make sure you have a default one which startAt 0"),!1):(n.apply(t),!0)}}class AdsumObject3DOptions extends AbstractOptions{static convert(t){return t.isAdsumObject3DOptions?t:new this(t)}reset(){this.isAdsumObject3DOptions=!0,this.id=Symbol("AdsumObjectId"),this.levelOfDetails=new LevelOfDetails,this.name=null,this.placeId=Symbol("AdsumMapPlaceId")}}function forEachMaterial(t,e){if(t.material)if(t.material.isMaterial)e(t.material,null);else{const s=t.material.length;for(let i=0;i<s;i++)e(t.material[i],i)}}function replaceMaterial(t,e,s=null){t.material?t.material.isMaterial||null===s?(forEachMaterial(t,t=>{t.dispose()}),t.material=e):(t.material[s].dispose(),t.material[s]=e):t.material=e}const changeEvent={type:"change"};class AdsumObject3D{constructor(t={}){const e=AdsumObject3DOptions.convert(t);this.id=e.id,this.isAdsumObject=!0,this._mesh=null,this.levelOfDetails=e.levelOfDetails,this.name=e.name,this.placeId=e.placeId,this.fading=1,this._initialOpacities=null}getType(){return AdsumObjectTypes.AdsumObject3D}_setMesh(t){return null!==this._mesh&&(this._mesh.adsumObject=null,this._mesh.onBeforeRender=null),this._mesh=t,this._mesh.adsumObject=this,this._mesh.onBeforeRender=this._onBeforeRender.bind(this),this._updateVisibility(),this.triggerChange(),this}setDisplayMode(t){switch(t){case DISPLAY_MODES.NONE:this._mesh.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._mesh.visible=!0,forEachMaterial(this._mesh,t=>{t.visible=!0});break;case DISPLAY_MODES.TRANSPARENT:this._mesh.visible=!0,forEachMaterial(this._mesh,t=>{t.visible=!1});break;default:throw new Error("Unexpected")}this.triggerChange()}getDisplayMode(){if(!this._mesh.visible)return DISPLAY_MODES.NONE;let t=!1;return forEachMaterial(this._mesh,e=>{e.visible&&(t=!0)}),t?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT}setFading(t){return this.fading=t,this._updateVisibility(),this}isFaded(){return 1!==this.fading}getFading(){return this.fading}_updateVisibility(){null!==this._mesh&&(null===this._initialOpacities&&(this._initialOpacities=new Map,forEachMaterial(this._mesh,t=>{t.transparent&&(this._initialOpacities.set(t,t.opacity),t.addEventListener("dispose",()=>{this._initialOpacities.delete(t)}))})),forEachMaterial(this._mesh,t=>{let e=this.fading,s=1!==this.fading;this._initialOpacities.has(t)&&(e*=this._initialOpacities.get(t),s=!0),t.opacity=e,t.transparent=s})),this.triggerChange()}moveTo(t,e,s){this._mesh.position.x=t,this._mesh.position.y=e,this._mesh.position.z=s,this.updateMatrix()}moveBy(t,e,s){this._mesh.position.x+=t,this._mesh.position.y+=e,this._mesh.position.z+=s,this.updateMatrix()}getBbox(t){return t.setFromObject(this._mesh),t}rotateOnAxis(t,e){return this._mesh.rotateOnAxis(t,e),this.updateMatrix(),this}updateMatrix(){null!==this._mesh&&(this._mesh.updateMatrix(),this._mesh.updateMatrixWorld(),this.triggerChange())}_applyLod(t,e,s){s&&this.levelOfDetails.applyLod(this,t,e)}_onBeforeRender(t,e,s,i,n,o){}_raycast(t,e,s=!0){const i=this.getDisplayMode();if(i===DISPLAY_MODES.NONE)return!1;if(i===DISPLAY_MODES.VISIBLE){const s=[];if(this._mesh.raycast(t,s),1===s.length){const t=s[0];e.push({object:this,distance:t.distance,position:this._mesh.worldToLocal(t.point)})}}return!0}_addChild(t){this._mesh.add(t._mesh),t.updateMatrix()}_dispose(){const t=t=>{t.geometry&&t.geometry.dispose&&t.geometry.dispose(),forEachMaterial(t,t=>{Object.keys(t).forEach(e=>{const s=t[e];null!==s&&"object"===s&&s.dispose&&s.dispose()}),t.dispose()})};this._mesh.traverse(t),t(this._mesh),null!==this._mesh.parent&&(this.triggerChange(),this._mesh.parent.remove(this._mesh))}getBoundingBox(t){return t.setFromObject(this._mesh),t}getWorldPosition(t){return this._mesh.getWorldPosition(t)}localToWorld(t){return this._mesh.localToWorld(t)}worldToLocal(t){return this._mesh.worldToLocal(t)}getPosition(t){return t.copy(this._mesh.position),t}triggerChange(){let t=this._mesh;for(;null!==t.parent;)t=t.parent;t.dispatchEvent(changeEvent)}}class PathSectionObjectOptions extends AdsumObject3DOptions{static convert(t){return t.isPathSectionObjectOptions?t:new this(t)}reset(){super.reset(),this.isPathSectionObjectOptions=!0,this.pathSection=null,this.patternSpace=null}}class PathSectionObject extends AdsumObject3D{constructor(t={}){const e=PathSectionObjectOptions.convert(t);super(e),this.isPathSection=!0,this.pathSection=e.pathSection,this.patternSpace=e.patternSpace,this.tweens=[]}getType(){return AdsumObjectTypes.PathSectionObject}getPatterns(){return this._mesh.children}getPattern(t){return this._mesh.children[t]}_dispose(){this.tweens.forEach(t=>{t.stop()}),forEachMaterial(this._mesh,t=>{t.dispose()}),null!==this._mesh.parent&&(this.triggerChange(),this._mesh.parent.remove(this._mesh))}}class FlatArrowPathPatternOptions extends AbstractOptions{get isPathPatternOptions(){return!0}reset(){super.reset(),this.backgroundColor=769978,this.arrowBorderColor=0,this.arrowFillColor=16777215}getPattern(){const t=null===this.backgroundColor?null:new Color(this.backgroundColor),e=null===this.arrowBorderColor?null:new Color(this.arrowBorderColor),s=null===this.arrowFillColor?null:new Color(this.arrowFillColor),i=document.createElement("canvas"),n=i.getContext("2d");i.width=64,i.height=64;null!==t&&(n.arc(32,32,32,0,2*Math.PI),n.fillStyle=`#${t.getHexString()}`,n.fill()),n.beginPath(),n.moveTo(11.2,48),n.lineTo(32,16),n.lineTo(52.8,48),n.lineTo(42.8,48),n.lineTo(32,16+640/41.6),n.lineTo(21.2,48),n.closePath(),null!==s&&(n.fillStyle=`#${s.getHexString()}`,n.fill()),null!==e&&(n.lineWidth=1,n.strokeStyle=`#${e.getHexString()}`,n.stroke());const o=new CanvasTexture(i),a=new MeshBasicMaterial({color:16777215,map:o,side:FrontSide}),r=new PlaneBufferGeometry(1,1);return r.center(),Promise.resolve(new Mesh(r,a))}}const PATH_PATTERN_OPTIONS_TYPES={arrow:"arrow",flatArrow:"flatArrow"},metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"},geometries=[{uuid:"37479CAC-7F5B-4703-892E-871B6E547DD5",type:"BufferGeometry",data:{attributes:{position:{itemSize:3,type:"Float32Array",array:[.42857158184051514,-.5,.10101523995399475,8.84001920553601e-8,-.35714268684387207,0,3.9206022961479903e-7,.5,.101015105843544,3.9206022961479903e-7,.5,.101015105843544,8.84001920553601e-8,-.35714268684387207,0,.42857158184051514,-.5,.10101523995399475,.42857158184051514,-.5,.10101523995399475,3.9206022961479903e-7,.5,.101015105843544,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,3.9206022961479903e-7,.5,.101015105843544,.42857158184051514,-.5,.10101523995399475,.42857158184051514,-.5,.10101523995399475,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,8.84001920553601e-8,-.35714268684387207,0,8.84001920553601e-8,-.35714268684387207,0,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,.42857158184051514,-.5,.10101523995399475,-.42857158184051514,-.49999988079071045,.10101444274187088,3.9206022961479903e-7,.5,.101015105843544,8.84001920553601e-8,-.35714268684387207,0,8.84001920553601e-8,-.35714268684387207,0,3.9206022961479903e-7,.5,.101015105843544,-.42857158184051514,-.49999988079071045,.10101444274187088,-.42857158184051514,-.49999988079071045,.10101444274187088,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,3.9206022961479903e-7,.5,.101015105843544,3.9206022961479903e-7,.5,.101015105843544,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,-.42857158184051514,-.49999988079071045,.10101444274187088,8.84001920553601e-8,-.35714268684387207,0,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,-.42857158184051514,-.49999988079071045,.10101444274187088,-.42857158184051514,-.49999988079071045,.10101444274187088,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,8.84001920553601e-8,-.35714268684387207,0],normalized:!1},normal:{itemSize:3,type:"Float32Array",array:[34.704898834228516,14.873491287231445,-126.20626068115234,34.704898834228516,14.873491287231445,-126.20626068115234,34.704898834228516,14.873491287231445,-126.20626068115234,-34.704898834228516,-14.873491287231445,126.20626068115234,-34.704898834228516,-14.873491287231445,126.20626068115234,-34.704898834228516,-14.873491287231445,126.20626068115234,34.704898834228516,14.873491287231445,126.20626068115234,34.704898834228516,14.873491287231445,126.20626068115234,34.704898834228516,14.873491287231445,126.20626068115234,-34.704898834228516,-14.873491287231445,-126.20626068115234,-34.704898834228516,-14.873491287231445,-126.20626068115234,-34.704898834228516,-14.873491287231445,-126.20626068115234,-41.65779113769531,-124.97323608398438,2.880212449189588e-22,-41.65779113769531,-124.97323608398438,2.880212449189588e-22,-41.65779113769531,-124.97323608398438,2.880212449189588e-22,41.65779113769531,124.97323608398438,-2.880212449189588e-22,41.65779113769531,124.97323608398438,-2.880212449189588e-22,41.65779113769531,124.97323608398438,-2.880212449189588e-22,-34.70476531982422,14.87362289428711,-126.20639038085938,-34.70476531982422,14.87362289428711,-126.20639038085938,-34.70476531982422,14.87362289428711,-126.20639038085938,34.70476531982422,-14.87362289428711,126.20639038085938,34.70476531982422,-14.87362289428711,126.20639038085938,34.70476531982422,-14.87362289428711,126.20639038085938,-34.705162048339844,14.87362289428711,126.20626068115234,-34.705162048339844,14.87362289428711,126.20626068115234,-34.705162048339844,14.87362289428711,126.20626068115234,34.705162048339844,-14.87362289428711,-126.20626068115234,34.705162048339844,-14.87362289428711,-126.20626068115234,34.705162048339844,-14.87362289428711,-126.20626068115234,41.65779113769531,-124.97323608398438,2.880212449189588e-22,41.65779113769531,-124.97323608398438,2.880212449189588e-22,41.65779113769531,-124.97323608398438,2.880212449189588e-22,-41.65779113769531,124.97323608398438,-2.880212449189588e-22,-41.65779113769531,124.97323608398438,-2.880212449189588e-22,-41.65779113769531,124.97323608398438,-2.880212449189588e-22],normalized:!1}},groups:[{start:0,count:36,materialIndex:0}],boundingSphere:{center:[0,0,.10101520270109177],radius:.6585389895528455}}}],materials=[{uuid:"B4F824CB-4D3B-4F41-A053-771C64851466",type:"MeshLambertMaterial",name:"Color_A06",color:13369344,emissive:0,depthFunc:3,depthTest:!0,depthWrite:!0}],object$1={uuid:"D059C6D5-2900-4095-B5C0-6F465BE2E1F9",type:"Mesh",name:"instance_0",layers:1,matrix:[2.319827504683324,0,0,0,0,2.319827504683324,0,0,0,0,2.319827504683324,0,0,0,0,1],matrixAutoUpdate:!1,geometry:"37479CAC-7F5B-4703-892E-871B6E547DD5",material:"B4F824CB-4D3B-4F41-A053-771C64851466"};var arrow={metadata:metadata,geometries:geometries,materials:materials,object:object$1};class ArrowPathPatternOptions extends AbstractOptions{get isPathPatternOptions(){return!0}reset(){super.reset(),this.color=769978}getPattern(){const t=(new ObjectLoader).parse(arrow);return t.material.color.set(this.color),Promise.resolve(t)}}class DotPathBuilderOptions extends AbstractOptions{reset(){super.reset(),this.patternSpace=5,this.patternSize=1,this.pattern=new FlatArrowPathPatternOptions}set(t,e,s){return"pattern"===t?this.setPattern(e):super.set(t,e,s)}setPattern(t){if(t.isPathPatternOptions)return this.pattern=t,this;switch(t.type){case PATH_PATTERN_OPTIONS_TYPES.arrow:this.pattern=new ArrowPathPatternOptions(t.options||{});break;case PATH_PATTERN_OPTIONS_TYPES.flatArrow:this.pattern=new FlatArrowPathPatternOptions(t.options||{});break;default:console.warn(`DotPathBuilderOptions.pattern: unknown type "${t.type}"`)}return this}}const yAxis=new Vector3(0,1,0),direction=new Vector3;class DotPathBuilder{constructor(t={}){this.isPathBuilder=!0,this.projector=null,this.objectManager=null,this.options=new DotPathBuilderOptions(t),this.pattern=null}init(t,e){return this.projector=t,this.objectManager=e,this.options.pattern.getPattern().then(t=>{this.pattern=t;const e=this.projector.meterToAdsumDistance(this.options.patternSize);this.pattern.scale.set(e,e,e),this.pattern.updateMatrix(),this.pattern.updateMatrixWorld()})}build(t){const e=new Group;e.visible=!1;const s=t.interpolate(this.options.patternSpace);for(let t=0;t<s.length-1;t++){const i=s[t],n=s[t+1],o=this._createPattern();o.position.copy(i),direction.subVectors(n,o.position).normalize(),o.quaternion.setFromUnitVectors(yAxis,direction),o.updateMatrix(),e.add(o)}t.isInterGround()||e.position.setZ(this.projector.meterToAdsumDistance(.025));const i=new PathSectionObject({pathSection:t,patternSpace:this.options.patternSpace});return i._setMesh(e),t.ground._addChild(i),i.updateMatrix(),this.objectManager.pathSectionObjects.set(i.id,i),i}_createPattern(){const t=this.pattern.clone();return t.traverse(t=>{t.material&&(Array.isArray(t.material)?t.material=t.material.map(t=>t.clone()):t.material=t.material.clone())}),t}}class UserPositionUpdateOptions extends AbstractOptions{reset(){super.reset(),this.animated=!0,this.duration=700}}class DotPathSectionDrawerOptions extends AbstractOptions{reset(){super.reset(),this.center=!0,this.centerOnOptions=null,this.oriented=!1,this.speed=30}}class DotPathSectionDrawer{constructor(t={}){this.isPathSectionDrawer=!0,this.awm=null,this.options=new DotPathSectionDrawerOptions(t)}init(t){this.awm=t}draw(t,e=null){const s=[];let i=null;i=null===e?this.options:new DotPathSectionDrawerOptions(e);const n=t.getPatterns();for(let e=0;e<n.length;e++){const n=this.awm.getProjector().adsumDistanceToMeter(t.patternSpace)/i.speed*e*1e3;s.push(this._showPattern(t,e,n))}if(t.setDisplayMode(DISPLAY_MODES.VISIBLE),i.center){const{pathSection:e}=t,n=i.oriented?e.getAzimuthOrientation():null,{from:o,to:a}=e,r=[t];null!==o&&null!==o.adsumObject&&r.push(o.adsumObject),null!==a&&null!==a.adsumObject&&r.push(a.adsumObject);let l=i.centerOnOptions;null!==n&&(l=null===l?{azimuth:n}:Object.assign(l,{azimuth:n})),s.push(this.awm.cameraManager.centerOnObjects(r,!0,l))}return Promise.all(s).then(()=>{})}_showPattern(t,e,s){return new Promise((i,n)=>{const o=t.getPattern(e),a={opacity:0};o.traverse(t=>{forEachMaterial(t,t=>{t.opacity=0,t.transparent=!0})});const r=new Tween(a).to({opacity:1},1e3).delay(s).easing(Easing.Exponential.In).on("update",()=>{o.traverse(t=>{forEachMaterial(t,t=>{t.opacity=a.opacity})})}).on("complete",()=>{o.traverse(t=>{forEachMaterial(t,t=>{t.opacity=1})}),i(!0)}).on("stop",()=>{n(new Error("Path was stopped"))}).start();t.tweens.push(r)})}}class UserObject extends AdsumObject3D{constructor(t={}){t.id=Symbol("AdsumObjectId"),t.placeId=Symbol("UserPlace"),super(t),this.isUser=!0,this.parent=null}getType(){return AdsumObjectTypes.UserObject}setPosition(t,e){return this._mesh.position.copy(t),null!==this.parent&&(this.parent.user=null),e.user=this,e._addChild(this),this.setFading(e.getFading()),this.parent=e,this.updateMatrix(),this}setRotation(t){this._mesh.rotation.set(0,0,0),this._mesh.rotateZ(t-Math.PI/2),this.updateMatrix()}setScale(t){return this._mesh.scale.set(t,t,t),this.updateMatrix(),this}}const THREE$2={BufferAttribute:BufferAttribute,Vector3:Vector3,Vector2:Vector2,BufferGeometry:BufferGeometry};THREE$2.BufferGeometryUtils={computeTangents:function(t){var e=t.index,s=t.attributes;if(null!==e&&void 0!==s.position&&void 0!==s.normal&&void 0!==s.uv){var i=e.array,n=s.position.array,o=s.normal.array,a=s.uv.array,r=n.length/3;void 0===s.tangent&&t.addAttribute("tangent",new THREE$2.BufferAttribute(new Float32Array(4*r),4));for(var l=s.tangent.array,h=[],c=[],d=0;d<r;d++)h[d]=new THREE$2.Vector3,c[d]=new THREE$2.Vector3;var u=new THREE$2.Vector3,p=new THREE$2.Vector3,m=new THREE$2.Vector3,g=new THREE$2.Vector2,f=new THREE$2.Vector2,b=new THREE$2.Vector2,y=new THREE$2.Vector3,w=new THREE$2.Vector3,E=t.groups;0===E.length&&(E=[{start:0,count:i.length}]);for(var M=0,_=E.length;M<_;++M)for(var O=N=(C=E[M]).start,T=N+C.count;O<T;O+=3)R(i[O+0],i[O+1],i[O+2]);var v,x,A,P=new THREE$2.Vector3,S=new THREE$2.Vector3,j=new THREE$2.Vector3,L=new THREE$2.Vector3;for(M=0,_=E.length;M<_;++M){var C,N;for(O=N=(C=E[M]).start,T=N+C.count;O<T;O+=3)D(i[O+0]),D(i[O+1]),D(i[O+2])}}else console.warn("THREE.BufferGeometry: Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");function R(t,e,s){u.fromArray(n,3*t),p.fromArray(n,3*e),m.fromArray(n,3*s),g.fromArray(a,2*t),f.fromArray(a,2*e),b.fromArray(a,2*s);var i=p.x-u.x,o=m.x-u.x,r=p.y-u.y,l=m.y-u.y,d=p.z-u.z,E=m.z-u.z,M=f.x-g.x,_=b.x-g.x,O=f.y-g.y,T=b.y-g.y,v=1/(M*T-_*O);y.set((T*i-O*o)*v,(T*r-O*l)*v,(T*d-O*E)*v),w.set((M*o-_*i)*v,(M*l-_*r)*v,(M*E-_*d)*v),h[t].add(y),h[e].add(y),h[s].add(y),c[t].add(w),c[e].add(w),c[s].add(w)}function D(t){j.fromArray(o,3*t),L.copy(j),x=h[t],P.copy(x),P.sub(j.multiplyScalar(j.dot(x))).normalize(),S.crossVectors(L,x),A=S.dot(c[t]),v=A<0?-1:1,l[4*t]=P.x,l[4*t+1]=P.y,l[4*t+2]=P.z,l[4*t+3]=v}},mergeBufferGeometries:function(t){for(var e=null!==t[0].index,s=new Set(Object.keys(t[0].attributes)),i=new Set(Object.keys(t[0].morphAttributes)),n={},o={},a=new THREE$2.BufferGeometry,r=0;r<t.length;++r){var l=t[r];if(e!==(null!==l.index))return null;for(var h in l.attributes){if(!s.has(h))return null;void 0===n[h]&&(n[h]=[]),n[h].push(l.attributes[h])}for(var h in l.morphAttributes){if(!i.has(h))return null;void 0===o[h]&&(o[h]=[]),o[h].push(l.morphAttributes[h])}void 0!==l.userData&&(a.userData=a.userData||{},a.userData.mergedUserData=a.userData.mergedUserData||[],a.userData.mergedUserData.push(l.userData))}if(e){var c=0,d=[];for(r=0;r<t.length;++r){var u=t[r].index;if(c>0){u=u.clone();for(var p=0;p<u.count;++p)u.setX(p,u.getX(p)+c)}d.push(u),c+=t[r].attributes.position.count}var m=this.mergeBufferAttributes(d);if(!m)return null;a.index=m}for(var h in n){var g=this.mergeBufferAttributes(n[h]);if(!g)return null;a.addAttribute(h,g)}for(var h in o){var f=o[h][0].length;if(0===f)break;a.morphAttributes=a.morphAttributes||{},a.morphAttributes[h]=[];for(r=0;r<f;++r){var b=[];for(p=0;p<o[h].length;++p)b.push(o[h][p][r]);var y=this.mergeBufferAttributes(b);if(!y)return null;a.morphAttributes[h].push(y)}}return a},mergeBufferAttributes:function(t){for(var e,s,i,n=0,o=0;o<t.length;++o){var a=t[o];if(a.isInterleavedBufferAttribute)return null;if(void 0===e&&(e=a.array.constructor),e!==a.array.constructor)return null;if(void 0===s&&(s=a.itemSize),s!==a.itemSize)return null;if(void 0===i&&(i=a.normalized),i!==a.normalized)return null;n+=a.array.length}for(var r=new e(n),l=0,h=0;h<t.length;++h)r.set(t[h].array,l),l+=t[h].array.length;return new THREE$2.BufferAttribute(r,s,i)}};var BufferGeometryUtils=THREE$2.BufferGeometryUtils;class DotUserObjectOptions extends AbstractOptions{reset(){this.size=3,this.color=769978}}class DotUserObject extends UserObject{constructor(t={}){const e=new DotUserObjectOptions(t);super();const{size:s}=e,i=BufferGeometryUtils.mergeBufferGeometries([new RingBufferGeometry(s/2,s/2-s/8,32),new CircleBufferGeometry(s/8,16)]),n=new MeshBasicMaterial({color:e.color,side:DoubleSide});n.transparent=!0,this._setMesh(new Mesh(i,n))}}const PATH_BUILDER_TYPES={dot:"dot"},PathSectionDrawerTypes={dot:"dot"};class OrientedDotUserObject extends UserObject{constructor(t={}){super(t);const e=t.size||3,s=new Shape;s.absarc(0,0,e/2+e/32,Math.PI/3,2*Math.PI/3),s.lineTo(0,e/2+e/6);const i=BufferGeometryUtils.mergeBufferGeometries([new RingBufferGeometry(e/2,e/2-e/8,32),new CircleBufferGeometry(e/8,16),new ShapeBufferGeometry(s)]),n=new MeshBasicMaterial({color:void 0===t.color?769978:t.color,side:DoubleSide});n.transparent=!0,this._setMesh(new Mesh(i,n))}}class WayfindingOptions extends AbstractOptions{reset(){super.reset(),this.pathBuilder=new DotPathBuilder,this.pathSectionDrawer=new DotPathSectionDrawer,this.userObject=new DotUserObject,this.userPositionUpdateOptions=new UserPositionUpdateOptions}set(t,e,s){switch(t){case"pathBuilder":return this.setPathBuilder(e);case"pathSectionDrawer":return this.setPathSectionDrawer(e);case"userObject":return this.setUserObject(e);default:return super.set(t,e,s)}}setPathBuilder(t){if(t.isPathBuilder)return this.pathBuilder=t,this;switch(t.type){case PATH_BUILDER_TYPES.dot:this.pathBuilder=new DotPathBuilder(t.options||{});break;default:console.warn(`WayfindingOptions.pathBuilder: unknown type "${t.type}"`)}return this}setPathSectionDrawer(t){if(t.isPathSectionDrawer)return this.pathSectionDrawer=t,this;switch(t.type){case PathSectionDrawerTypes.dot:this.pathSectionDrawer=new DotPathSectionDrawer(t.options||{});break;default:console.warn(`WayfindingOptions.pathSectionDrawer: unknown type "${t.type}"`)}return this}setUserObject(t){if(t.isUser)return this.userObject=t,this;switch(t.type){case AdsumObjectTypes.DotUserObject:this.userObject=new DotUserObject(t.options||{});break;case AdsumObjectTypes.OrientedDotUserObject:this.userObject=new OrientedDotUserObject(t.options||{});break;default:console.warn(`WayfindingOptions.userObject: unknown type "${t.type}"`)}return this}}class SingleFloorAnimationOptions extends AbstractOptions{reset(){super.reset(),this.inTime=300,this.keepSiteVisible=!0,this.outTime=300,this.pause=300}}class SingleFloorAnimation{constructor(t={}){this.isFloorAnimation=!0,this.awm=null,this.options=new SingleFloorAnimationOptions(t),this.isSameBuilding=!1,this.tweenIn=null,this.tweenOut=null}init(t){this.awm=t,this.setVisibility(this.awm.objectManager.site,!0,1),this.awm.objectManager.floors.forEach(t=>{this.setVisibility(t,!1,0)})}start(t,e,s){if(this.isSameBuilding=t.isFloor&&e.isFloor&&t.building===e.building,!s)return new Promise((s,i)=>{try{this.setVisibility(t,!1,0),this.setVisibility(e,!0,1),s()}catch(t){i(t)}});const i=()=>{this.setVisibility(t,!1,0),this.setVisibility(e,!0,1)},n=Promise.all([this.prepareFadeOut(t,i),this.prepareFadeIn(e,i)]);return this.tweenOut.chainedTweens(this.tweenIn),this.tweenOut.start(),n.then(()=>{})}stop(){null!==this.tweenOut&&this.tweenOut.stop(),null!==this.tweenIn&&this.tweenIn.stop()}setVisibility(t,e,s){if(t.isSite)this.options.keepSiteVisible||(t.setFading(s),t.setDisplayMode(e?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT),t.buildings.forEach(t=>{t.setDisplayMode(e?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT)}));else if(t.setFading(s),t.setDisplayMode(e?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.NONE),this.options.keepSiteVisible){const i=!(e&&1===s)&&!this.isSameBuilding;t.building.setDisplayMode(i?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT)}}prepareFadeIn(t,e){return new Promise((s,i)=>{const n={fading:0};this.tweenIn=new Tween(n).to({fading:1},this.options.inTime).delay(this.options.pause).on("start",()=>{this.setVisibility(t,!0,0)}).on("update",()=>{t.setFading(n.fading)}).on("stop",()=>{e(),this.tweenIn=null,i(new Error("AdsumWebMap.SingleFloorAnimation: stopped"))}).on("complete",()=>{this.setVisibility(t,!0,1),this.tweenIn=null,s()})})}prepareFadeOut(t,e){return new Promise((s,i)=>{const n={fading:t.getFading()};this.tweenOut=new Tween(n).to({fading:0},this.options.outTime).on("update",()=>{this.setVisibility(t,!0,n.fading)}).on("stop",()=>{e(),this.tweenOut=null,i(new Error("AdsumWebMap.SingleFloorAnimation: stopped"))}).on("complete",()=>{this.setVisibility(t,!1,0),this.tweenOut=null,s()})})}}const FLOOR_ANIMATION_TYPES={single:"single"};class SceneOptions extends AbstractOptions{reset(){super.reset(),this.animation=new SingleFloorAnimation}set(t,e,s){switch(t){case"animation":return this.setAnimation(e);default:return super.set(t,e,s)}}setAnimation(t){if(t.isFloorAnimation)return this.animation=t,this;switch(t.type){case FLOOR_ANIMATION_TYPES.single:this.animation=new SingleFloorAnimation(t.options||{});break;default:console.warn(`SceneOptions.animation: unknown type "${t.type}"`)}return this}}class Options extends AbstractOptions{reset(){super.reset(),this.engine=new EngineOptions,this.camera=new CameraOptions,this.scene=new SceneOptions,this.wayfinding=new WayfindingOptions,this.loader=null}}Cache.enabled=!0,Object3D.DefaultMatrixAutoUpdate=!1;class AdsumWebMap{constructor(t){const e=new Options(t);this.objectManager=new ObjectManager,this.sceneManager=new SceneManager(this,e.scene),this.engineManager=new EngineManager(this,e.engine),this.cameraManager=new CameraManager(this,e.camera),this.mouseManager=new MouseManager(this),this.wayfindingManager=new WayfindingManager(this,e.wayfinding),this.deviceId=null,this.defaultFloor=null,this.loader=e.loader}init(t=null){return null!==t&&(this.loader=t),this.loader.load().then(t=>(this.projector=t.projector,this.engineManager.init(t),this.objectManager.init(t),this.sceneManager.init(t),this.cameraManager.init(this.projector),this.mouseManager.init(),this.wayfindingManager.init(t).then(()=>this.setDeviceId(t.deviceId,!1))))}start(){this.engineManager.start(),this.mouseManager.start(),this.cameraManager.start()}stop(){this.engineManager.stop(),this.mouseManager.stop(),this.cameraManager.stop()}getDeviceId(){return this.deviceId}getProjector(){return this.projector}setDeviceId(t,e=!0){return this.deviceId=t,this.defaultFloor=null,this.loader.loadCalibration(this.deviceId).then(({cameraCalibrations:t,defaultFloorId:s,userPosition:i})=>(null!==i&&(null===i.floorId?this.wayfindingManager.setUserAdsumPosition(i.position,null,!0):this.wayfindingManager.setUserAdsumPosition(i.position,this.objectManager.getFloor(i.floorId),!0)),this.cameraManager.setCameraCalibrations(t),null!==s&&(this.defaultFloor=this.objectManager.getFloor(s)),this.sceneManager.setCurrentFloor(this.defaultFloor,e))).then(()=>this.cameraManager.centerOnFloor(this.defaultFloor,e)).then(()=>{})}}const THREE$3={Group:Group,Matrix4:Matrix4,Vector3:Vector3,Quaternion:Quaternion,Vector4:Vector4,Math:Math$1,Object3D:Object3D,DoubleSide:DoubleSide,MeshLambertMaterial:MeshLambertMaterial,MeshBasicMaterial:MeshBasicMaterial,MeshPhongMaterial:MeshPhongMaterial,FrontSide:FrontSide,MultiMaterial:MultiMaterial,SkinnedMesh:SkinnedMesh,Mesh:Mesh,Line:Line,PerspectiveCamera:PerspectiveCamera,DirectionalLight:DirectionalLight,PointLight:PointLight,SpotLight:SpotLight,AmbientLight:AmbientLight,Geometry:Geometry,Vector2:Vector2,Color:Color,Face3:Face3,Loader:Loader,Texture:Texture,MirroredRepeatWrapping:MirroredRepeatWrapping,RepeatWrapping:RepeatWrapping,ClampToEdgeWrapping:ClampToEdgeWrapping,MixOperation:MixOperation,ImageLoader:ImageLoader,Scene:Scene,BufferGeometry:BufferGeometry};function AdsumColladaLoader(){let t,e,s=null,i=null,n=null;const o={};let a,r,l,h,c,d,u,p={},m={},g={},f={},b={},y={},w={},E={};const M={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null};let _=1,O="Y",T=null;function v(o,M,v){if(s=(new DOMParser).parseFromString(o,"text/xml"),M=M||n,void 0!==v){const t=v.split("/");t.pop(),c=`${t.length<1?".":t.join("/")}/`}!function(){const t=s.querySelectorAll("asset")[0];if(t&&t.childNodes)for(let s=0;s<t.childNodes.length;s++){const i=t.childNodes[s];switch(i.nodeName){case"unit":var e=i.getAttribute("meter");e&&(_=parseFloat(e));break;case"up_axis":O=i.textContent.charAt(0)}}}(),T=null,p=x("library_images image",I,"image"),b=x("library_materials material",st,"material"),y=x("library_effects effect",rt,"effect"),f=x("library_geometries geometry",W,"geometry"),w=x("library_cameras camera",pt,"camera"),E=x("library_lights light",gt,"light"),g=x("library_controllers controller",B,"controller"),m=x("library_animations animation",ht,"animation"),l=x("library_visual_scenes visual_scene",H,"visual_scene"),h=x("library_kinematics_models kinematics_model",bt,"kinematics_model"),d=[],u=[],t=function(){const t=s.querySelectorAll("scene instance_visual_scene")[0];if(t){const e=t.getAttribute("url").replace(/^#/,"");return l[e.length>0?e:"visual_scene0"]}return null}(),i=new THREE$3.Scene;for(let e=0;e<t.nodes.length;e++)i.add(L(t.nodes[e]));i.scale.multiplyScalar(_),a=[],function e(s){let i=t.getChildById(s.colladaId,!0),n=null;if(i&&i.keys){n={fps:60,hierarchy:[{node:i,keys:i.keys,sids:i.sids}],node:s,name:`animation_${s.name}`,length:0},a.push(n);for(var o=0,r=i.keys.length;o<r;o++)n.length=Math.max(n.length,i.keys[o].time)}else n={hierarchy:[{keys:[],sids:[]}]};for(var o=0,r=s.children.length;o<r;o++){const t=e(s.children[o]);for(let e=0,s=t.hierarchy.length;e<s;e++)n.hierarchy.push({keys:[],sids:[]})}return n}(i),e=function(){const t=s.querySelectorAll("instance_kinematics_model")[0];if(t){const e=t.getAttribute("url").replace(/^#/,"");return h[e.length>0?e:"kinematics_model0"]}return null}(),function(){if(e&&0===e.joints.length)return void(r=void 0);const n={},o=function(s,o){const a=o.getAttribute("id"),r=t.getChildById(a,!0),l=e.joints[s];i.traverse(t=>{t.colladaId==a&&(n[s]={node:t,transforms:r.transforms,joint:l,position:l.zeroPosition})})};r={joints:e&&e.joints,getJointValue(t){const e=n[t];if(e)return e.position;console.log(`getJointValue: joint ${t} doesn't exist`)},setJointValue(t,e){const s=n[t];if(s){const i=s.joint;if(e>i.limits.max||e<i.limits.min)console.log(`setJointValue: joint ${t} value ${e} outside of limits (min: ${i.limits.min}, max: ${i.limits.max})`);else if(i.static)console.log(`setJointValue: joint ${t} is static`);else{const o=s.node,a=i.axis,r=s.transforms,h=new THREE$3.Matrix4,c=new THREE$3.Matrix4;for(l=0;l<r.length;l++){const s=r[l];if(s.sid&&-1!==s.sid.indexOf(`joint${t}`))switch(i.type){case"revolute":h.multiply(c.makeRotationAxis(a,THREE$3.Math.degToRad(e)));break;case"prismatic":h.multiply(c.makeTranslation(a.x*e,a.y*e,a.z*e));break;default:console.warn(`setJointValue: unknown joint type: ${i.type}`)}else switch(s.type){case"matrix":h.multiply(s.obj);break;case"translate":h.multiply(c.makeTranslation(s.obj.x,s.obj.y,s.obj.z));break;case"rotate":h.multiply(c.makeRotationAxis(s.obj,s.angle))}}const d=h.elements,u=Array.prototype.slice.call(d),p=[u[0],u[4],u[8],u[12],u[1],u[5],u[9],u[13],u[2],u[6],u[10],u[14],u[3],u[7],u[11],u[15]];o.matrix.set.apply(o.matrix,p),o.matrix.decompose(o.position,o.quaternion,o.scale),n[t].position=e}}else console.log(`setJointValue: joint ${t} doesn't exist`)}};const a=s.querySelector("scene instance_kinematics_scene");if(a)for(var l=0;l<a.childNodes.length;l++){const t=a.childNodes[l];if(1==t.nodeType)switch(t.nodeName){case"bind_joint_axis":var h=t.getAttribute("target").split("/").pop(),c=t.querySelector("axis param").textContent,d=parseInt(c.split("joint").pop().split(".")[0]),u=s.querySelector(`[sid="${h}"]`);if(u){const t=u.parentElement;o(d,t)}}}}();const A={scene:i,morphs:d,skins:u,animations:a,kinematics:r,dae:{images:p,materials:b,cameras:w,lights:E,effects:y,geometries:f,controllers:g,animations:m,visualScenes:l,visualScene:t,scene:t,kinematicsModels:h,kinematicsModel:e}};return M&&M(A),A}function x(t,e,i){const n=s.querySelectorAll(t),o={};let a=0;const r=n.length;for(let t=0;t<r;t++){const s=n[t],r=(new e).parse(s);r.id&&0!==r.id.length||(r.id=i+a++),o[r.id]=r}return o}function A(t,e){const s=e instanceof U?g[e.url]:e;if(!s||!s.morph)return void console.log("could not find morph controller!");const i=s.morph;for(let e=0;e<i.targets.length;e++){const s=i.targets[e],n=f[s];if(!n.mesh||!n.mesh.primitives||!n.mesh.primitives.length)continue;const o=n.mesh.primitives[0].geometry;o.vertices.length===t.vertices.length&&t.morphTargets.push({name:"target_1",vertices:o.vertices})}t.morphTargets.push({name:"target_Z",vertices:t.vertices})}function P(t,e,s,i){if(t.world=t.world||new THREE$3.Matrix4,t.localworld=t.localworld||new THREE$3.Matrix4,t.world.copy(t.matrix),t.localworld.copy(t.matrix),t.channels&&t.channels.length){const e=t.channels[0].sampler.output[s];e instanceof THREE$3.Matrix4&&(t.world.copy(e),t.localworld.copy(e),0===s&&t.matrix.copy(e))}i&&t.world.multiplyMatrices(i,t.world),e.push(t);for(let i=0;i<t.nodes.length;i++)P(t.nodes[i],e,s,t.world)}function S(t,e){for(let i=0;i<t.length;i++){const n=t[i];let o=-1;if("JOINT"==n.type){for(var s=0;s<e.joints.length;s++)if(n.sid===e.joints[s]){o=s;break}if(o>=0){const t=e.invBindMatrices[o];n.invBindMatrix=t,n.skinningMatrix=new THREE$3.Matrix4,n.skinningMatrix.multiplyMatrices(n.world,t),n.animatrix=new THREE$3.Matrix4,n.animatrix.copy(n.localworld),n.weights=[];for(s=0;s<e.weights.length;s++)for(let t=0;t<e.weights[s].length;t++){const i=e.weights[s][t];i.joint===o&&n.weights.push(i)}}else console.warn(`ColladaLoader: Could not find joint '${n.sid}'.`),n.skinningMatrix=new THREE$3.Matrix4,n.weights=[]}}}function j(e,s,i){void 0===i&&(i=40);const n=g[s.url];if(!n||!n.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!s.skeleton||!s.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");const o=function(){let t,e=1e6,s=-e,i=0;for(const n in m){const o=m[n];t=t||o.id;for(let t=0;t<o.sampler.length;t++){const n=o.sampler[t];n.create(),e=Math.min(e,n.startTime),s=Math.max(s,n.endTime),i=Math.max(i,n.input.length)}}return{start:e,end:s,frames:i,ID:t}}(),a=t.getChildById(s.skeleton[0],!0)||t.getChildBySid(s.skeleton[0],!0),r=function(t){const e=[];var s=function(t,e,i){const n={};n.name=e.sid,n.parent=t,n.matrix=e.matrix;const o=[new THREE$3.Vector3,new THREE$3.Quaternion,new THREE$3.Vector3];n.matrix.decompose(o[0],o[1],o[2]),n.pos=[o[0].x,o[0].y,o[0].z],n.scl=[o[2].x,o[2].y,o[2].z],n.rotq=[o[1].x,o[1].y,o[1].z,o[1].w],i.push(n);for(const t in e.nodes)s(e.sid,e.nodes[t],i)};return s(-1,t,e),e}(a),l=n.skin.joints,h=[];for(var c=0;c<l.length;c++)for(var d=0;d<r.length;d++)r[d].name===l[c]&&(h[c]=r[d]);for(c=0;c<h.length;c++)for(d=0;d<h.length;d++)h[c].parent===h[d].name&&(h[c].parent=d);new THREE$3.Vector3;for(c=0;c<e.vertices.length;c++)e.vertices[c].applyMatrix4(n.skin.bindShapeMatrix);const u=[],p=[],f=n.skin.weights;for(c=0;c<f.length;c++){const t=new THREE$3.Vector4(f[c][0]?f[c][0].joint:0,f[c][1]?f[c][1].joint:0,f[c][2]?f[c][2].joint:0,f[c][3]?f[c][3].joint:0);var b=new THREE$3.Vector4(f[c][0]?f[c][0].weight:0,f[c][1]?f[c][1].weight:0,f[c][2]?f[c][2].weight:0,f[c][3]?f[c][3].weight:0);u.push(t),p.push(b)}e.skinIndices=u,e.skinWeights=p,e.bones=h;const y={name:o.ID,fps:30,length:o.frames/30,hierarchy:[]};for(d=0;d<h.length;d++)y.hierarchy.push({parent:h[d].parent,name:h[d].name,keys:[]});for(console.log("ColladaLoader:",`${o.ID} has ${h.length} bones.`),function(t,e,s){const i=[];P(e,i,-1),S(i,s.skin);const n=new THREE$3.Vector3,o=[];for(var a=0;a<t.vertices.length;a++)o.push(new THREE$3.Vector3);for(a=0;a<i.length;a++)if("JOINT"==i[a].type)for(let e=0;e<i[a].weights.length;e++){const s=i[a].weights[e],r=s.index,l=s.weight,h=t.vertices[r],c=o[r];n.x=h.x,n.y=h.y,n.z=h.z,n.applyMatrix4(i[a].skinningMatrix),c.x+=n.x*l,c.y+=n.y*l,c.z+=n.z*l}for(a=0;a<t.vertices.length;a++)t.vertices[a]=o[a]}(e,a,n),i=0;i<o.frames;i++){const t=[];P(a,t,i),S(t,n.skin);for(c=0;c<t.length;c++)for(d=0;d<y.hierarchy.length;d++)if(y.hierarchy[d].name===t[c].sid){const e={};e.time=i/30,e.matrix=t[c].animatrix,0===i&&(t[c].matrix=e.matrix);const s=[new THREE$3.Vector3,new THREE$3.Quaternion,new THREE$3.Vector3];e.matrix.decompose(s[0],s[1],s[2]),e.pos=[s[0].x,s[0].y,s[0].z],e.scl=[s[2].x,s[2].y,s[2].z],e.rot=s[1],y.hierarchy[d].keys.push(e)}e.animation=y}}function L(t,e){const s=new THREE$3.Object3D;let i,n,o,a;for(o=0;o<t.controllers.length;o++){const e=g[t.controllers[o].url];switch(e.type){case"skin":if(f[e.skin.source])(r=new G).url=e.skin.source,r.instance_material=t.controllers[o].instance_material,t.geometries.push(r),i=t.controllers[o];else if(g[e.skin.source]){const s=g[e.skin.source];if(n=s,s.morph&&f[s.morph.source])(r=new G).url=s.morph.source,r.instance_material=t.controllers[o].instance_material,t.geometries.push(r)}break;case"morph":var r;if(f[e.morph.source])(r=new G).url=e.morph.source,r.instance_material=t.controllers[o].instance_material,t.geometries.push(r),n=t.controllers[o];console.log("ColladaLoader: Morph-controller partially supported.")}}const l={};for(o=0;o<t.geometries.length;o++){const e=t.geometries[o],r=e.instance_material,p=f[e.url],m={},g=[];let w=0;var h;if(p){if(!p.mesh||!p.mesh.primitives)continue;if(0===s.name.length&&(s.name=p.id),r)for(a=0;a<r.length;a++){const t=r[a],e=b[t.target],s=e.instance_effect.url;let i=y[s].shader.material;if(p.doubleSided){if(!(t.symbol in l)){const e=i.clone();e.side=THREE$3.DoubleSide,l[t.symbol]=e}i=l[t.symbol]}i.opacity=i.opacity?i.opacity:1,m[t.symbol]=w,g.push(i),(h=i).name=null===e.name||""===e.name?e.id:e.name,w++}var c;let t=h||new THREE$3.MeshLambertMaterial({color:14540253,side:p.doubleSided?THREE$3.DoubleSide:THREE$3.FrontSide});const e=p.mesh.geometry3js;if(w>1)for(t=new THREE$3.MultiMaterial(g),a=0;a<e.faces.length;a++){const t=e.faces[a];t.materialIndex=m[t.daeMaterial]}void 0!==i?(j(e,i),e.morphTargets.length>0?(t.morphTargets=!0,t.skinning=!1):(t.morphTargets=!1,t.skinning=!0),(c=new THREE$3.SkinnedMesh(e,t,!1)).name=`skin_${u.length}`,u.push(c)):void 0!==n?(A(e,n),t.morphTargets=!0,(c=new THREE$3.Mesh(e,t)).name=`morph_${d.length}`,d.push(c)):c=!0===e.isLineStrip?new THREE$3.Line(e):new THREE$3.Mesh(e,t),s.add(c)}}for(o=0;o<t.cameras.length;o++){const e=t.cameras[o],i=w[e.url],n=new THREE$3.PerspectiveCamera(i.yfov,parseFloat(i.aspect_ratio),parseFloat(i.znear),parseFloat(i.zfar));s.add(n)}for(o=0;o<t.lights.length;o++){let e=null;const i=t.lights[o],n=E[i.url];if(n&&n.technique){const t=n.color.getHex(),s=n.intensity,i=n.distance,o=n.falloff_angle;switch(n.technique){case"directional":(e=new THREE$3.DirectionalLight(t,s,i)).position.set(0,0,1);break;case"point":e=new THREE$3.PointLight(t,s,i);break;case"spot":(e=new THREE$3.SpotLight(t,s,i,o)).position.set(0,0,1);break;case"ambient":e=new THREE$3.AmbientLight(t)}}e&&s.add(e)}for(s.name=t.name||t.id||"",s.colladaId=t.id||"",s.layer=t.layer||"",s.matrix=t.matrix,s.matrix.decompose(s.position,s.quaternion,s.scale),o=0;o<t.nodes.length;o++)s.add(L(t.nodes[o],t));return s}function C(t){const e=s.querySelectorAll("library_nodes node");for(let s=0;s<e.length;s++){const i=e[s].attributes.getNamedItem("id");if(i&&i.value===t)return e[s]}}function N(t,e){let s=null;for(let i=0,n=t.length;i<n&&null===s;i++){const n=t[i];if(n.time===e)s=n;else if(n.time>e)break}return s}function R(t,e){let s=-1;for(let i=0,n=t.length;i<n&&-1===s;i++){t[i].time>=e&&(s=i)}return s}function D(t,e,s,i){let n=function(t,e,s){for(s=s>=0?s:s+t.length;s>=0;s--){const i=t[s];if(i.hasTarget(e))return i}return null}(t,i,s?s-1:0),o=function(t,e,s){for(;s<t.length;s++){const i=t[s];if(i.hasTarget(e))return i}return null}(t,i,s+1);if(n&&o){let t,s=(e.time-n.time)/(o.time-n.time),a=n.getTarget(i),r=o.getTarget(i).data,l=a.data;if("matrix"===a.type)t=l;else if(l.length){t=[];for(let e=0;e<l.length;++e)t[e]=l[e]+(r[e]-l[e])*s}else t=l+(r-l)*s;e.addTarget(i,a.transform,a.member,t)}}function I(){this.id="",this.init_from=""}function B(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function k(){this.method=null,this.source=null,this.targets=null,this.weights=null}function F(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function H(){this.id="",this.name="",this.nodes=[],this.scene=new THREE$3.Group}function V(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE$3.Matrix4}function $(){this.sid="",this.type="",this.data=[],this.obj=null}function U(){this.url="",this.skeleton=[],this.instance_material=[]}function z(){this.symbol="",this.target=""}function G(){this.url="",this.instance_material=[]}function W(){this.id="",this.mesh=null}function Y(t){this.geometry=t.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function q(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE$3.Geometry}function X(){q.call(this),this.vcount=[]}function Z(){q.call(this),this.vcount=1}function J(){q.call(this),this.vcount=3}function K(){this.source="",this.count=0,this.stride=0,this.params=[]}function Q(){this.input={}}function tt(){this.semantic="",this.offset=0,this.source="",this.set=0}function et(t){this.id=t,this.type=null}function st(){this.id="",this.name="",this.instance_effect=null}function it(){this.color=new THREE$3.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function nt(t,e){this.type=t,this.effect=e,this.material=null}function ot(t){this.effect=t,this.init_from=null,this.format=null}function at(t){this.effect=t,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function rt(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function lt(){this.url=""}function ht(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function ct(t){this.animation=t,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function dt(t){this.id="",this.animation=t,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function ut(t){this.targets=[],this.time=t}function pt(){this.id="",this.name="",this.technique=""}function mt(){this.url=""}function gt(){this.id="",this.name="",this.technique=""}function ft(){this.url=""}function bt(){this.id="",this.name="",this.joints=[],this.links=[]}function yt(){this.sid="",this.name="",this.axis=new THREE$3.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function wt(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function Et(){this.joint="",this.transforms=[],this.links=[]}function Mt(t){const e=t.getAttribute("id");return null!=o[e]?o[e]:(o[e]=new et(e).parse(t),o[e])}function _t(t){const e=vt(t),s=[];for(let t=0,i=e.length;t<i;t++)s.push(!("true"!==e[t]&&"1"!==e[t]));return s}function Ot(t){const e=vt(t),s=[];for(let t=0,i=e.length;t<i;t++)s.push(parseFloat(e[t]));return s}function Tt(t){const e=vt(t),s=[];for(let t=0,i=e.length;t<i;t++)s.push(parseInt(e[t],10));return s}function vt(t){return t.length>0?function(t){return t.replace(/^\s+/,"").replace(/\s+$/,"")}(t).split(/\s+/):[]}function xt(t,e,s){return t.hasAttribute(e)?parseInt(t.getAttribute(e),10):s}function At(t,e){(new THREE$3.ImageLoader).load(e,e=>{t.image=e,t.needsUpdate=!0})}function Pt(t,e){t.doubleSided=!1;const s=e.querySelectorAll("extra double_sided")[0];s&&s&&1===parseInt(s.textContent,10)&&(t.doubleSided=!0)}function St(t,e){}function jt(t,e){const s=[t[e],t[e+1],t[e+2]];return new THREE$3.Vector3(s[0],s[1],s[2])}function Lt(t){return(new THREE$3.Matrix4).set(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function Ct(t){if(t>-1&&t<3){t={X:0,Y:1,Z:2}[t=Nt(["X","Y","Z"][t])]}return t}function Nt(t){return t}return I.prototype.parse=function(t){this.id=t.getAttribute("id");for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];"init_from"===s.nodeName&&(this.init_from=s.textContent)}return this},B.prototype.parse=function(t){this.id=t.getAttribute("id"),this.name=t.getAttribute("name"),this.type="none";for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];switch(s.nodeName){case"skin":this.skin=(new F).parse(s),this.type=s.nodeName;break;case"morph":this.morph=(new k).parse(s),this.type=s.nodeName}}return this},k.prototype.parse=function(t){const e={};let s,i=[];for(this.method=t.getAttribute("method"),this.source=t.getAttribute("source").replace(/^#/,""),s=0;s<t.childNodes.length;s++){const o=t.childNodes[s];if(1==o.nodeType)switch(o.nodeName){case"source":e[(n=(new et).parse(o)).id]=n;break;case"targets":i=this.parseInputs(o);break;default:console.log(o.nodeName)}}for(s=0;s<i.length;s++){const t=i[s];var n=e[t.source];switch(t.semantic){case"MORPH_TARGET":this.targets=n.read();break;case"MORPH_WEIGHT":this.weights=n.read()}}return this},k.prototype.parseInputs=function(t){const e=[];for(let s=0;s<t.childNodes.length;s++){const i=t.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"input":e.push((new tt).parse(i))}}return e},F.prototype.parse=function(t){const e={};let s,i;this.source=t.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(let a=0;a<t.childNodes.length;a++){const r=t.childNodes[a];if(1==r.nodeType)switch(r.nodeName){case"bind_shape_matrix":var n=Ot(r.textContent);this.bindShapeMatrix=Lt(n);break;case"source":var o=(new et).parse(r);e[o.id]=o;break;case"joints":s=r;break;case"vertex_weights":i=r;break;default:console.log(r.nodeName)}}return this.parseJoints(s,e),this.parseWeights(i,e),this},F.prototype.parseJoints=function(t,e){for(let n=0;n<t.childNodes.length;n++){const o=t.childNodes[n];if(1==o.nodeType)switch(o.nodeName){case"input":var s=(new tt).parse(o),i=e[s.source];"JOINT"===s.semantic?this.joints=i.read():"INV_BIND_MATRIX"===s.semantic&&(this.invBindMatrices=i.read())}}},F.prototype.parseWeights=function(t,e){let s,i,n=[];for(var o=0;o<t.childNodes.length;o++){const e=t.childNodes[o];if(1==e.nodeType)switch(e.nodeName){case"input":n.push((new tt).parse(e));break;case"v":s=Tt(e.textContent);break;case"vcount":i=Tt(e.textContent)}}let a=0;for(o=0;o<i.length;o++){const t=i[o],l=[];for(var r=0;r<t;r++){const t={};for(let i=0;i<n.length;i++){const o=n[i],r=s[a+o.offset];switch(o.semantic){case"JOINT":t.joint=r;break;case"WEIGHT":t.weight=e[o.source].data[r]}}l.push(t),a+=n.length}for(r=0;r<l.length;r++)l[r].index=o;this.weights.push(l)}},H.prototype.getChildById=function(t,e){for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildById(t,e);if(i)return i}return null},H.prototype.getChildBySid=function(t,e){for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildBySid(t,e);if(i)return i}return null},H.prototype.parse=function(t){this.id=t.getAttribute("id"),this.name=t.getAttribute("name"),this.nodes=[];for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"node":this.nodes.push((new V).parse(s))}}return this},V.prototype.getChannelForTransform=function(t){for(let s=0;s<this.channels.length;s++){const i=this.channels[s];let n=i.target.split("/");n.shift();let o=n.shift();const a=o.indexOf(".")>=0,r=o.indexOf("(")>=0;var e;if(a)n=o.split("."),o=n.shift();else if(r){e=o.split("("),o=e.shift();for(let t=0;t<e.length;t++)e[t]=parseInt(e[t].replace(/\)/,""))}if(o===t)return i.info={sid:o,dotSyntax:a,arrSyntax:r,arrIndices:e},i}return null},V.prototype.getChildById=function(t,e){if(this.id===t)return this;if(e)for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildById(t,e);if(i)return i}return null},V.prototype.getChildBySid=function(t,e){if(this.sid===t)return this;if(e)for(let s=0;s<this.nodes.length;s++){const i=this.nodes[s].getChildBySid(t,e);if(i)return i}return null},V.prototype.getTransformBySid=function(t){for(let e=0;e<this.transforms.length;e++)if(this.transforms[e].sid===t)return this.transforms[e];return null},V.prototype.parse=function(t){let e;this.id=t.getAttribute("id"),this.sid=t.getAttribute("sid"),this.name=t.getAttribute("name"),this.type=t.getAttribute("type"),this.layer=t.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE$3.Matrix4;for(let i=0;i<t.childNodes.length;i++){const n=t.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"node":this.nodes.push((new V).parse(n));break;case"instance_camera":this.cameras.push((new mt).parse(n));break;case"instance_controller":this.controllers.push((new U).parse(n));break;case"instance_geometry":this.geometries.push((new G).parse(n));break;case"instance_light":this.lights.push((new ft).parse(n));break;case"instance_node":var s=C(e=n.getAttribute("url").replace(/^#/,""));s&&this.nodes.push((new V).parse(s));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new $).parse(n));break;case"extra":break;default:console.log(n.nodeName)}}return this.channels=function(t){const e=[];let s=1e6,i=-1e6;for(var n in m){const o=m[n];for(let a=0;a<o.channel.length;a++){const r=o.channel[a],l=o.sampler[a];(n=r.target.split("/")[0])==t.id&&(l.create(),r.sampler=l,s=Math.min(s,l.startTime),i=Math.max(i,l.endTime),e.push(r))}}return e.length&&(t.startTime=s,t.endTime=i),e}(this),function(t){if(t.channels&&t.channels.length){let m=[],g=[];for(var e=0,s=t.channels.length;e<s;e++){var i,n=t.channels[e],o=n.fullSid,a=n.sampler,r=a.input,l=t.getTransformBySid(n.sid);if(n.arrIndices){i=[];for(var h=0,c=n.arrIndices.length;h<c;h++)i[h]=Ct(n.arrIndices[h])}else i=Nt(n.member);if(l)for(-1===g.indexOf(o)&&g.push(o),h=0,c=r.length;h<c;h++){var d=r[h],u=a.getData(l.type,h,i);if(!(p=N(m,d))){p=new ut(d);const t=R(m,d);m.splice(-1===t?m.length:t,0,p)}p.addTarget(o,l,i,u)}else console.log(`Could not find transform "${n.sid}" in node ${t.id}`)}for(e=0;e<g.length;e++){const t=g[e];for(h=0;h<m.length;h++){var p;(p=m[h]).hasTarget(t)||D(m,p,h,t)}}t.keys=m,t.sids=g}}(this),this.updateMatrix(),this},V.prototype.updateMatrix=function(){this.matrix.identity();for(let t=0;t<this.transforms.length;t++)this.transforms[t].apply(this.matrix)},$.prototype.parse=function(t){return this.sid=t.getAttribute("sid"),this.type=t.nodeName,this.data=Ot(t.textContent),this.convert(),this},$.prototype.convert=function(){switch(this.type){case"matrix":this.obj=Lt(this.data);break;case"rotate":this.angle=THREE$3.Math.degToRad(this.data[3]);case"translate":St(this.data,-1),this.obj=new THREE$3.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":St(this.data,1),this.obj=new THREE$3.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log(`Can not convert Transform of type ${this.type}`)}},$.prototype.apply=function(){const t=new THREE$3.Matrix4;return function(e){switch(this.type){case"matrix":e.multiply(this.obj);break;case"translate":e.multiply(t.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":e.multiply(t.makeRotationAxis(this.obj,this.angle));break;case"scale":e.scale(this.obj)}}}(),$.prototype.update=function(t,e){const s=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(e)if(1===e.length)switch(e[0]){case 0:this.obj.n11=t[0],this.obj.n21=t[1],this.obj.n31=t[2],this.obj.n41=t[3];break;case 1:this.obj.n12=t[0],this.obj.n22=t[1],this.obj.n32=t[2],this.obj.n42=t[3];break;case 2:this.obj.n13=t[0],this.obj.n23=t[1],this.obj.n33=t[2],this.obj.n43=t[3];break;case 3:this.obj.n14=t[0],this.obj.n24=t[1],this.obj.n34=t[2],this.obj.n44=t[3]}else if(2===e.length){const s=`n${e[0]+1}${e[1]+1}`;this.obj[s]=t}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(t);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(e)&&(e=s[e[0]]),e){case"X":this.obj.x=t;break;case"Y":this.obj.y=t;break;case"Z":this.obj.z=t;break;default:this.obj.x=t[0],this.obj.y=t[1],this.obj.z=t[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(e)&&(e=s[e[0]]),e){case"X":this.obj.x=t;break;case"Y":this.obj.y=t;break;case"Z":this.obj.z=t;break;case"ANGLE":this.angle=THREE$3.Math.degToRad(t);break;default:this.obj.x=t[0],this.obj.y=t[1],this.obj.z=t[2],this.angle=THREE$3.Math.degToRad(t[3])}}},U.prototype.parse=function(t){this.url=t.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(let s=0;s<t.childNodes.length;s++){const i=t.childNodes[s];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":var e=i.querySelectorAll("instance_material");for(let t=0;t<e.length;t++){const s=e[t];this.instance_material.push((new z).parse(s))}}}return this},z.prototype.parse=function(t){return this.symbol=t.getAttribute("symbol"),this.target=t.getAttribute("target").replace(/^#/,""),this},G.prototype.parse=function(t){this.url=t.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType&&"bind_material"===s.nodeName){const t=s.querySelectorAll("instance_material");for(let e=0;e<t.length;e++){const s=t[e];this.instance_material.push((new z).parse(s))}break}}return this},W.prototype.parse=function(t){this.id=t.getAttribute("id"),Pt(this,t);for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];switch(s.nodeName){case"mesh":this.mesh=new Y(this).parse(s)}}return this},Y.prototype.parse=function(t){this.primitives=[];for(var e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];switch(s.nodeName){case"source":Mt(s);break;case"vertices":this.vertices=(new Q).parse(s);break;case"linestrips":this.primitives.push((new Z).parse(s));break;case"triangles":this.primitives.push((new J).parse(s));break;case"polygons":this.primitives.push((new q).parse(s));break;case"polylist":this.primitives.push((new X).parse(s))}}if(this.geometry3js=new THREE$3.Geometry,null===this.vertices)return this;const s=o[this.vertices.input.POSITION.source].data;for(e=0;e<s.length;e+=3)this.geometry3js.vertices.push(jt(s,e).clone());for(e=0;e<this.primitives.length;e++){const t=this.primitives[e];t.setVertices(this.vertices),this.handlePrimitive(t,this.geometry3js)}this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals);const i=this.geometry3js;return this.geometry3js=new THREE$3.BufferGeometry,this.geometry3js.fromGeometry(i),i.dispose(),this},Y.prototype.handlePrimitive=function(t,e){if(t instanceof Z)return void(e.isLineStrip=!0);let s,i,n,a,r,l,h,c,d=t.p,u=t.inputs,p=0,m=0;const g=[];for(s=0;s<u.length;s++){const t=(n=u[s]).offset+1;switch(m=m<t?t:m,n.semantic){case"TEXCOORD":g.push(n.set)}}for(let T=0;T<d.length;++T){let v=d[T],x=0;for(;x<v.length;){const d=[],T=[];let A=null;const P=[];for(c=t.vcount?t.vcount.length?t.vcount[p++]:t.vcount:v.length/m,s=0;s<c;s++)for(i=0;i<u.length;i++)switch(n=u[i],l=o[n.source],r=(a=v[x+s*m+n.offset])*(h=l.accessor.params.length),n.semantic){case"VERTEX":d.push(a);break;case"NORMAL":T.push(jt(l.data,r));break;case"TEXCOORD":void 0===(A=A||{})[n.set]&&(A[n.set]=[]),A[n.set].push(new THREE$3.Vector2(l.data[r],l.data[r+1]));break;case"COLOR":P.push((new THREE$3.Color).setRGB(l.data[r],l.data[r+1],l.data[r+2]))}if(0===T.length)if(n=this.vertices.input.NORMAL){h=(l=o[n.source]).accessor.params.length;for(var f=0,b=d.length;f<b;f++)T.push(jt(l.data,d[f]*h))}else e.calcNormals=!0;if(!A&&(A={},n=this.vertices.input.TEXCOORD)){g.push(n.set),h=(l=o[n.source]).accessor.params.length;for(f=0,b=d.length;f<b;f++)r=d[f]*h,void 0===A[n.set]&&(A[n.set]=[]),A[n.set].push(new THREE$3.Vector2(l.data[r],1-l.data[r+1]))}if(0===P.length&&(n=this.vertices.input.COLOR)){h=(l=o[n.source]).accessor.params.length;for(f=0,b=d.length;f<b;f++)r=d[f]*h,P.push((new THREE$3.Color).setRGB(l.data[r],l.data[r+1],l.data[r+2]))}var y,w,E=null,_=[];if(3===c)_.push(new THREE$3.Face3(d[0],d[1],d[2],T,P.length?P:new THREE$3.Color));else if(4===c)_.push(new THREE$3.Face3(d[0],d[1],d[3],T.length?[T[0].clone(),T[1].clone(),T[3].clone()]:[],P.length?[P[0],P[1],P[3]]:new THREE$3.Color)),_.push(new THREE$3.Face3(d[1],d[2],d[3],T.length?[T[1].clone(),T[2].clone(),T[3].clone()]:[],P.length?[P[1],P[2],P[3]]:new THREE$3.Color));else if(c>4&&M.subdivideFaces){var O=P.length?P:new THREE$3.Color;for(i=1;i<c-1;)_.push(new THREE$3.Face3(d[0],d[i],d[i+1],T.length?[T[0].clone(),T[i++].clone(),T[i].clone()]:[],O))}if(_.length)for(f=0,b=_.length;f<b;f++)for((E=_[f]).daeMaterial=t.material,e.faces.push(E),i=0;i<g.length;i++)y=A[g[i]],w=c>4?[y[0],y[f+1],y[f+2]]:4===c?0===f?[y[0],y[1],y[3]]:[y[1].clone(),y[2],y[3].clone()]:[y[0],y[1],y[2]],void 0===e.faceVertexUvs[i]&&(e.faceVertexUvs[i]=[]),e.faceVertexUvs[i].push(w);else console.log(`dropped face with vcount ${c} for geometry with id: ${e.id}`);x+=m*c}}},q.prototype.setVertices=function(t){for(let e=0;e<this.inputs.length;e++)this.inputs[e].source===t.id&&(this.inputs[e].source=t.input.POSITION.source)},q.prototype.parse=function(t){this.material=t.getAttribute("material"),this.count=xt(t,"count",0);for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];switch(s.nodeName){case"input":this.inputs.push((new tt).parse(t.childNodes[e]));break;case"vcount":this.vcount=Tt(s.textContent);break;case"p":this.p.push(Tt(s.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},X.prototype=Object.create(q.prototype),X.prototype.constructor=X,Z.prototype=Object.create(q.prototype),Z.prototype.constructor=Z,J.prototype=Object.create(q.prototype),J.prototype.constructor=J,K.prototype.parse=function(t){this.params=[],this.source=t.getAttribute("source"),this.count=xt(t,"count",0),this.stride=xt(t,"stride",0);for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if("param"===s.nodeName){const t={};t.name=s.getAttribute("name"),t.type=s.getAttribute("type"),this.params.push(t)}}return this},Q.prototype.parse=function(t){this.id=t.getAttribute("id");for(let e=0;e<t.childNodes.length;e++)if("input"===t.childNodes[e].nodeName){const s=(new tt).parse(t.childNodes[e]);this.input[s.semantic]=s}return this},tt.prototype.parse=function(t){return this.semantic=t.getAttribute("semantic"),this.source=t.getAttribute("source").replace(/^#/,""),this.set=xt(t,"set",-1),this.offset=xt(t,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},et.prototype.parse=function(t){this.id=t.getAttribute("id");for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];switch(s.nodeName){case"bool_array":this.data=_t(s.textContent),this.type=s.nodeName;break;case"float_array":this.data=Ot(s.textContent),this.type=s.nodeName;break;case"int_array":this.data=Tt(s.textContent),this.type=s.nodeName;break;case"IDREF_array":case"Name_array":this.data=vt(s.textContent),this.type=s.nodeName;break;case"technique_common":for(let t=0;t<s.childNodes.length;t++)if("accessor"===s.childNodes[t].nodeName){this.accessor=(new K).parse(s.childNodes[t]);break}}}return this},et.prototype.read=function(){const t=[],e=this.accessor.params[0];switch(e.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(let e=0;e<this.data.length;e+=16){const s=Lt(this.data.slice(e,e+16));t.push(s)}break;default:console.log(`ColladaLoader: Source: Read dont know how to read ${e.type}.`)}return t},st.prototype.parse=function(t){this.id=t.getAttribute("id"),this.name=t.getAttribute("name");for(let e=0;e<t.childNodes.length;e++)if("instance_effect"===t.childNodes[e].nodeName){this.instance_effect=(new lt).parse(t.childNodes[e]);break}return this},it.prototype.isColor=function(){return null===this.texture},it.prototype.isTexture=function(){return null!=this.texture},it.prototype.parse=function(t){"transparent"===t.nodeName&&(this.opaque=t.getAttribute("opaque"));for(let s=0;s<t.childNodes.length;s++){const i=t.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"color":var e=Ot(i.textContent);this.color=new THREE$3.Color,this.color.setRGB(e[0],e[1],e[2]),this.color.a=e[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},it.prototype.parseTexture=function(t){if(!t.childNodes)return this;t.childNodes[1]&&"extra"===t.childNodes[1].nodeName&&(t=t.childNodes[1]).childNodes[1]&&"technique"===t.childNodes[1].nodeName&&(t=t.childNodes[1]);for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];switch(s.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[s.nodeName]=parseFloat(s.textContent);break;case"wrapU":case"wrapV":"TRUE"===s.textContent.toUpperCase()?this.texOpts[s.nodeName]=1:this.texOpts[s.nodeName]=parseInt(s.textContent);break;default:this.texOpts[s.nodeName]=s.textContent}}return this},nt.prototype.parse=function(t){for(let i=0;i<t.childNodes.length;i++){const n=t.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":this[n.nodeName]=(new it).parse(n);break;case"bump":var e=n.getAttribute("bumptype");e?"heightfield"===e.toLowerCase()?this.bump=(new it).parse(n):"normalmap"===e.toLowerCase()?this.normal=(new it).parse(n):(console.error(`Shader.prototype.parse: Invalid value for attribute 'bumptype' (${e}) - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'`),this.bump=(new it).parse(n)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new it).parse(n));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var s=n.querySelectorAll("float");s.length>0&&(this[n.nodeName]=parseFloat(s[0].textContent))}}return this.create(),this},nt.prototype.create=function(){const t={};let e=!1;if(void 0===this.transparency&&this.transparent&&(this.transparency=1),void 0===this.transparent&&this.transparency&&(e={color:{r:1,g:1,b:1,a:1}}),void 0!==this.transparency&&void 0!==this.transparent){const s=this.transparent.color.a*this.transparency;s>0&&(e=!0,t.transparent=!0,t.opacity=1-s)}const s={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(const o in this)switch(o){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var i=this[o];if(i instanceof it)if(i.isTexture()){const e=i.texture,a=this.effect.sampler[e];if(void 0!==a&&void 0!==a.source){const e=this.effect.surface[a.source];if(void 0!==e){const r=p[e.init_from];if(r){const e=c+r.init_from;var n;const l=THREE$3.Loader.Handlers.get(e);null!==l?n=l.load(e):At(n=new THREE$3.Texture,e),"MIRROR"===a.wrap_s?n.wrapS=THREE$3.MirroredRepeatWrapping:"WRAP"===a.wrap_s||i.texOpts.wrapU?n.wrapS=THREE$3.RepeatWrapping:n.wrapS=THREE$3.ClampToEdgeWrapping,"MIRROR"===a.wrap_t?n.wrapT=THREE$3.MirroredRepeatWrapping:"WRAP"===a.wrap_t||i.texOpts.wrapV?n.wrapT=THREE$3.RepeatWrapping:n.wrapT=THREE$3.ClampToEdgeWrapping,n.offset.x=i.texOpts.offsetU,n.offset.y=i.texOpts.offsetV,n.repeat.x=i.texOpts.repeatU,n.repeat.y=i.texOpts.repeatV,t[s[o]]=n,"emission"===o&&(t.emissive=16777215)}}}}else"diffuse"!==o&&e||("emission"===o?t.emissive=i.color.getHex():t[o]=i.color.getHex());break;case"shininess":t[o]=this[o];break;case"reflectivity":t[o]=this[o],t[o]>0&&(t.envMap=M.defaultEnvMap),t.combine=THREE$3.MixOperation;break;case"index_of_refraction":t.refractionRatio=this[o],1!==this[o]&&(t.envMap=M.defaultEnvMap)}switch(t.side=this.effect.doubleSided?THREE$3.DoubleSide:THREE$3.FrontSide,void 0!==t.diffuse&&(t.color=t.diffuse,delete t.diffuse),void 0!==t.ambient&&delete t.ambient,this.type){case"constant":null!=t.emissive&&(t.color=t.emissive),this.material=new THREE$3.MeshBasicMaterial(t);break;case"phong":case"blinn":this.material=new THREE$3.MeshPhongMaterial(t);break;case"lambert":default:this.material=new THREE$3.MeshLambertMaterial(t)}return this.material},ot.prototype.parse=function(t){for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"init_from":this.init_from=s.textContent;break;case"format":this.format=s.textContent;break;default:console.log(`unhandled Surface prop: ${s.nodeName}`)}}return this},at.prototype.parse=function(t){for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"source":this.source=s.textContent;break;case"minfilter":this.minfilter=s.textContent;break;case"magfilter":this.magfilter=s.textContent;break;case"mipfilter":this.mipfilter=s.textContent;break;case"wrap_s":this.wrap_s=s.textContent;break;case"wrap_t":this.wrap_t=s.textContent;break;default:console.log(`unhandled Sampler2D prop: ${s.nodeName}`)}}return this},rt.prototype.create=function(){if(null===this.shader)return null},rt.prototype.parse=function(t){this.id=t.getAttribute("id"),this.name=t.getAttribute("name"),Pt(this,t),this.shader=null;for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(s))}}return this},rt.prototype.parseNewparam=function(t){const e=t.getAttribute("sid");for(let s=0;s<t.childNodes.length;s++){const i=t.childNodes[s];if(1==i.nodeType)switch(i.nodeName){case"surface":this.surface[e]=new ot(this).parse(i);break;case"sampler2D":this.sampler[e]=new at(this).parse(i);break;case"extra":break;default:console.log(i.nodeName)}}},rt.prototype.parseProfileCOMMON=function(t){let e;for(let i=0;i<t.childNodes.length;i++){const n=t.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"profile_COMMON":this.parseProfileCOMMON(n);break;case"technique":e=n;break;case"newparam":this.parseNewparam(n);break;case"image":var s=(new I).parse(n);p[s.id]=s;break;case"extra":break;default:console.log(n.nodeName)}}return e},rt.prototype.parseTechnique=function(t){for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new nt(s.nodeName,this).parse(s);break;case"extra":this.parseExtra(s)}}},rt.prototype.parseExtra=function(t){for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"technique":this.parseExtraTechnique(s)}}},rt.prototype.parseExtraTechnique=function(t){for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"bump":this.shader.parse(t)}}},lt.prototype.parse=function(t){return this.url=t.getAttribute("url").replace(/^#/,""),this},ht.prototype.parse=function(t){this.id=t.getAttribute("id"),this.name=t.getAttribute("name"),this.source={};for(let i=0;i<t.childNodes.length;i++){const n=t.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"animation":var e=(new ht).parse(n);for(var s in e.source)this.source[s]=e.source[s];for(let t=0;t<e.channel.length;t++)this.channel.push(e.channel[t]),this.sampler.push(e.sampler[t]);break;case"source":s=(new et).parse(n);this.source[s.id]=s;break;case"sampler":this.sampler.push(new dt(this).parse(n));break;case"channel":this.channel.push(new ct(this).parse(n))}}return this},ct.prototype.parse=function(t){this.source=t.getAttribute("source").replace(/^#/,""),this.target=t.getAttribute("target");let e=this.target.split("/");e.shift();const s=e.shift(),i=s.indexOf(".")>=0,n=s.indexOf("(")>=0;if(i)e=s.split("."),this.sid=e.shift(),this.member=e.shift();else if(n){const t=s.split("(");this.sid=t.shift();for(let e=0;e<t.length;e++)t[e]=parseInt(t[e].replace(/\)/,""));this.arrIndices=t}else this.sid=s;return this.fullSid=s,this.dotSyntax=i,this.arrSyntax=n,this},dt.prototype.parse=function(t){this.id=t.getAttribute("id"),this.inputs=[];for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"input":this.inputs.push((new tt).parse(s))}}return this},dt.prototype.create=function(){for(var t=0;t<this.inputs.length;t++){const e=this.inputs[t],s=this.animation.source[e.source];switch(e.semantic){case"INPUT":this.input=s.read();break;case"OUTPUT":this.output=s.read(),this.strideOut=s.accessor.stride;break;case"INTERPOLATION":this.interpolation=s.read();break;case"IN_TANGENT":case"OUT_TANGENT":break;default:console.log(e.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(t=0;t<this.input.length;t++)this.startTime=Math.min(this.startTime,this.input[t]),this.endTime=Math.max(this.endTime,this.input[t]);this.duration=this.endTime-this.startTime}},dt.prototype.getData=function(t,e,s){let i;if("matrix"===t&&16===this.strideOut)i=this.output[e];else if(this.strideOut>1){i=[],e*=this.strideOut;for(let t=0;t<this.strideOut;++t)i[t]=this.output[e+t];if(3===this.strideOut)switch(t){case"rotate":case"translate":St(i,-1);break;case"scale":St(i,1)}else 4===this.strideOut&&"matrix"===t&&St(i,-1)}else i=this.output[e],s&&"translate"===t&&(i=function(t,e){return e}(0,i));return i},ut.prototype.addTarget=function(t,e,s,i){this.targets.push({sid:t,member:s,transform:e,data:i})},ut.prototype.apply=function(t){for(let e=0;e<this.targets.length;++e){const s=this.targets[e];t&&s.sid!==t||s.transform.update(s.data,s.member)}},ut.prototype.getTarget=function(t){for(let e=0;e<this.targets.length;++e)if(this.targets[e].sid===t)return this.targets[e];return null},ut.prototype.hasTarget=function(t){for(let e=0;e<this.targets.length;++e)if(this.targets[e].sid===t)return!0;return!1},ut.prototype.interpolate=function(t,e){for(let o=0,a=this.targets.length;o<a;o++){var s,i=this.targets[o],n=t.getTarget(i.sid);if("matrix"!==i.transform.type&&n){let o=(e-this.time)/(t.time-this.time),a=n.data,r=i.data;if(o<0&&(o=0),o>1&&(o=1),r.length){s=[];for(let t=0;t<r.length;++t)s[t]=r[t]+(a[t]-r[t])*o}else s=r+(a-r)*o}else s=i.data;i.transform.update(s,i.member)}},pt.prototype.parse=function(t){this.id=t.getAttribute("id"),this.name=t.getAttribute("name");for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"optics":this.parseOptics(s)}}return this},pt.prototype.parseOptics=function(t){for(let i=0;i<t.childNodes.length;i++)if("technique_common"===t.childNodes[i].nodeName){const n=t.childNodes[i];for(let t=0;t<n.childNodes.length;t++)if(this.technique=n.childNodes[t].nodeName,"perspective"===this.technique){const i=n.childNodes[t];for(var e=0;e<i.childNodes.length;e++){switch((s=i.childNodes[e]).nodeName){case"yfov":this.yfov=s.textContent;break;case"xfov":this.xfov=s.textContent;break;case"znear":this.znear=s.textContent;break;case"zfar":this.zfar=s.textContent;break;case"aspect_ratio":this.aspect_ratio=s.textContent}}}else if("orthographic"===this.technique){const i=n.childNodes[t];for(e=0;e<i.childNodes.length;e++){var s;switch((s=i.childNodes[e]).nodeName){case"xmag":this.xmag=s.textContent;break;case"ymag":this.ymag=s.textContent;break;case"znear":this.znear=s.textContent;break;case"zfar":this.zfar=s.textContent;break;case"aspect_ratio":this.aspect_ratio=s.textContent}}}}return this},mt.prototype.parse=function(t){return this.url=t.getAttribute("url").replace(/^#/,""),this},gt.prototype.parse=function(t){this.id=t.getAttribute("id"),this.name=t.getAttribute("name");for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"technique_common":this.parseCommon(s);break;case"technique":this.parseTechnique(s)}}return this},gt.prototype.parseCommon=function(t){for(let n=0;n<t.childNodes.length;n++)switch(t.childNodes[n].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=t.childNodes[n].nodeName;var e=t.childNodes[n];for(let t=0;t<e.childNodes.length;t++){const n=e.childNodes[t];switch(n.nodeName){case"color":var s=Ot(n.textContent);this.color=new THREE$3.Color(0),this.color.setRGB(s[0],s[1],s[2]),this.color.a=s[3];break;case"falloff_angle":this.falloff_angle=parseFloat(n.textContent);break;case"quadratic_attenuation":var i=parseFloat(n.textContent);this.distance=i?Math.sqrt(1/i):0}}}return this},gt.prototype.parseTechnique=function(t){this.profile=t.getAttribute("profile");for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];switch(s.nodeName){case"intensity":this.intensity=parseFloat(s.textContent)}}return this},ft.prototype.parse=function(t){return this.url=t.getAttribute("url").replace(/^#/,""),this},bt.prototype.parse=function(t){this.id=t.getAttribute("id"),this.name=t.getAttribute("name"),this.joints=[],this.links=[];for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"technique_common":this.parseCommon(s)}}return this},bt.prototype.parseCommon=function(t){for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(t.childNodes[e].nodeName){case"joint":this.joints.push((new yt).parse(s));break;case"link":this.links.push((new wt).parse(s))}}return this},yt.prototype.parse=function(t){this.sid=t.getAttribute("sid"),this.name=t.getAttribute("name"),this.axis=new THREE$3.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;const e=Ot(t.querySelector("axis").textContent);this.axis=jt(e,0);const s=t.querySelector("limits min")?parseFloat(t.querySelector("limits min").textContent):-360,i=t.querySelector("limits max")?parseFloat(t.querySelector("limits max").textContent):360;this.limits={min:s,max:i};const n=["prismatic","revolute"];for(let e=0;e<n.length;e++){const s=n[e];t.querySelector(s)&&(this.type=s)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},wt.prototype.parse=function(t){this.sid=t.getAttribute("sid"),this.name=t.getAttribute("name"),this.transforms=[],this.attachments=[];for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"attachment_full":this.attachments.push((new Et).parse(s));break;case"rotate":case"translate":case"matrix":this.transforms.push((new $).parse(s))}}return this},Et.prototype.parse=function(t){this.joint=t.getAttribute("joint").split("/").pop(),this.links=[];for(let e=0;e<t.childNodes.length;e++){const s=t.childNodes[e];if(1==s.nodeType)switch(s.nodeName){case"link":this.links.push((new wt).parse(s));break;case"rotate":case"translate":case"matrix":this.transforms.push((new $).parse(s))}}return this},{load:function(t,e,s,i){let o=0;if(document.implementation&&document.implementation.createDocument){const a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState?0===a.status||200===a.status?a.response?(n=e,v(a.response,void 0,t)):i?i({type:"error",url:t}):console.error(`ColladaLoader: Empty or non-existing file (${t})`):i?i({type:"error",url:t}):console.error(`ColladaLoader: Couldn't load "${t}" (${a.status})`):3===a.readyState&&s&&(0===o&&(o=a.getResponseHeader("Content-Length")),s({total:o,loaded:a.responseText.length}))},a.open("GET",t,!0),a.send(null)}else alert("Don't know how to parse XML!")},parse:v,applySkin:j,geometries:f,options:M}}const TEXTURE_QUALITY={AUTO:"auto",LOW:"low",HIGH:"high"};class AdsumLoaderOptions extends AbstractOptions{reset(){super.reset(),this.entityManager=null,this.textureQuality=TEXTURE_QUALITY.AUTO,this.shadowEnabled=!1,this.shadowMapSize=2048,this.fogEnabled=!1,this.fogRatio=0,this.fogColor=16777215,this.preferAmbientOcclusion=!0,this.shapeAmbientOcclusionTopColor=16777215,this.shapeAmbientOcclusionBottomColor=8421504,this.deviceId=null}set(t,e,s){return"entityManager"!==t||e instanceof EntityManager?super.set(t,e,s):(this[t]=new EntityManager(e),this)}get(t){return"entityManager"===t?this[t].options.toJSON():super.get(t)}preferLambertMaterial(){return!1}advancedLightingEnabled(){return!1}}class AdsumTextureLoader{constructor(t,e,s,i){this.texturesByReference=new Map,this.threeLoader=new TextureLoader,this.regex=/\/texture\/reference\/(?:[a-f0-9]{2,3}\/)*(.*)$/,this.onLoad=i,this.init(t,e,s)}init(t,e,s){e===TEXTURE_QUALITY.HIGH?this.initHighTextureMap(t,s):this.initLowTextureMap(t,s)}initHighTextureMap(t,e){const s=[FILE_CONTEXTS.TEXTURE];e&&s.push(FILE_CONTEXTS.TEXTURE_OCCLUSION),t.findBy({context:t=>s.includes(t)}).forEach(t=>{this.texturesByReference.set(t.reference,t)})}initLowTextureMap(t,e){const s=[FILE_CONTEXTS.TEXTURE];e&&s.push(FILE_CONTEXTS.TEXTURE_OCCLUSION);const i=t.findBy({context:t=>s.includes(t)});t.findBy({context:FILE_CONTEXTS.TEXTURE_LOW}).forEach(t=>{this.texturesByReference.set(t.name,t)}),i.forEach(t=>{this.texturesByReference.has(t.reference)||(t.context===FILE_CONTEXTS.TEXTURE&&console.warn(`AdsumLoader: optimized texture not found for reference ${t.reference}`),this.texturesByReference.set(t.reference,t))})}load(t,e,s,i){const n=this.regex.exec(t);let o=t;if(null!==n){const t=n[1];this.texturesByReference.has(t)&&({uri:o}=this.texturesByReference.get(t))}return this.threeLoader.load(o,t=>{this.onLoad(),e&&e(t)},s,i)}}const LABEL_OBJECTS_ORIENTATION_MODES={BILLBOARD:"BILLBOARD",STATIC:"STATIC",FLIP:"FLIP"};class LabelObjectOptions extends AdsumObject3DOptions{static convert(t){return t.isLabelObjectOptions?t:new this(t)}reset(){super.reset(),this.isLabelObjectOptions=!0,this.autoScale=!1,this.isPermanentDisplay=!0,this.orientationMode=LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD,this.offset={x:0,y:0,z:0},this.opacity=1,this.rotation=0,this.scale={x:1,y:1,z:1}}}const v$1=new Vector3,worldPosition=new Vector3,zAxis=new Vector3(0,0,1);class LabelObject extends AdsumObject3D{constructor(t={}){const e=LabelObjectOptions.convert(t);super(e),this.autoScale=e.autoScale,this.isLabel=!0,this.isPermanentDisplay=e.isPermanentDisplay,this.offset=new Vector3(0,0,0),this.offset.copy(e.offset),this.orientationMode=null,this.setOrientationMode(e.orientationMode),this.opacity=e.opacity,this.parent=null,this.rotation=e.rotation%360,this.scale=new Vector3(1,1,1),this.scale.copy(e.scale),this.selected=!1}getType(){return AdsumObjectTypes.LabelObject}moveTo(t,e,s){return this.offset.set(t,e,s),this._updatePosition(),this}moveBy(t,e,s){return this.moveTo(this.offset.x+t,this.offset.y+e,this.offset.z+s)}setAutoScale(t){return this.autoScale=Boolean(t),this._updatePosition(),this}setOrientationMode(t){switch(t){case LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD:case LABEL_OBJECTS_ORIENTATION_MODES.STATIC:this.orientationMode=t;break;default:console.warn(`AdsumWebMap.LabelImageObject#create: Unsupported orientation mode ${t}`)}return this._applyRotation(!1),this._updatePosition(!1),this.updateMatrix(),this}setOpacity(t){return this.opacity=t,this._updateVisibility(),this}setPermanentDisplay(t){return this.isPermanentDisplay=Boolean(t),this._updateVisibility(),this}setRotation(t){return this.orientationMode!==LABEL_OBJECTS_ORIENTATION_MODES.STATIC&&console.warn("AdsumWebMap.LabelObject.setRotation: only static labels can be rotated"),this.rotation=t%360,this._applyRotation(!1),this._updatePosition(!1),this.updateMatrix(),this}setScale(t,e,s){return this.scale.set(t,e,s),this._updatePosition(),this}select(){return this.selected=!0,this._updateVisibility(),this}unselect(){return this.selected=!1,this._updateVisibility(),this}_updateVisibility(){if(null!==this._mesh){const t=this.isPermanentDisplay||this.selected;this.setDisplayMode(t?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.NONE),forEachMaterial(this._mesh,t=>{t.opacity=this.fading*this.opacity}),this.triggerChange()}}_applyRotation(t=!0){return null!==this._mesh&&this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.STATIC&&this._mesh.setRotationFromAxisAngle(zAxis,this.rotation*Math.PI/180),t&&this.updateMatrix(),this}_onBeforeRender(t,e,s,i,n,o){super._onBeforeRender(t,e,s,i,n,o),this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD&&(this._mesh.quaternion.setFromRotationMatrix(this._mesh.parent.matrixWorld).inverse(),this._mesh.quaternion.multiply(s.quaternion).normalize(),this.updateMatrix()),this._mesh.getWorldPosition(worldPosition);const a=v$1.subVectors(s.position,worldPosition).length();if(this.autoScale){const t=Math.tan(s.fov*Math.PI/180/2)*a/1e3;this.setScale(t,t,t)}}_applyLod(t,e,s){return this._updateVisibility(),super._applyLod(t,e,s),this.selected&&this._updateVisibility(),!1}_setMesh(t){return super._setMesh(t),this._applyRotation(!1),this._updatePosition(!1),this.updateMatrix(),this}_updatePosition(t=!0){if(null!==this._mesh)if(this._mesh.position.copy(this.offset),this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD){this._mesh.geometry.computeBoundingBox();const{max:t,min:e}=this._mesh.geometry.boundingBox,s=t.y-e.y;this._mesh.scale.copy(this.scale),this._mesh.position.z+=this.scale.z*s/2}else this._mesh.position.z+=1.1,this._mesh.scale.set(this.scale.x,this.scale.y,1);t&&this.updateMatrix()}}class LabelImageObjectOptions extends LabelObjectOptions{static convert(t){return t.isLabelImageObjectOptions?t:new this(t)}reset(){super.reset(),this.isLabelImageObjectOptions=!0,this.width=null,this.height=null,this.image=null}}const textureLoader=new TextureLoader;class LabelImageObject extends LabelObject{constructor(t={}){const e=LabelImageObjectOptions.convert(t);super(e),this.isLabelImage=!0,this.width=e.width,this.height=e.height,this.image=e.image,this._updateMesh()}getType(){return AdsumObjectTypes.LabelImageObject}setImage(t){return this.image=t,this._updateMesh(),this}setHeight(t){return this.height=t,this._updateMesh(),this}setWidth(t){return this.width=t,this._updateMesh(),this}_updateMesh(){if(null===this._mesh){const t=new PlaneBufferGeometry(this.width,this.height),e=new MeshBasicMaterial({color:16777215,map:this._createTexture(),side:FrontSide,transparent:!0,depthWrite:!1});this._setMesh(new Mesh(t,e))}else this._mesh.material.map.dispose(),this._mesh.material.map=this._createTexture(),this._mesh.geometry.width===this.width&&this._mesh.geometry.height===this.height||(this._mesh.geometry.dispose(),this._mesh.geometry=new PlaneBufferGeometry(this.width,this.height),this._updatePosition())}_createTexture(){if("string"==typeof this.image){const t=textureLoader.load(this.image,()=>{t.needsUpdate=!0,this.triggerChange()},void 0,t=>{console.error(`AdsumWebMap.LabelImageObject: unable to load image ${this.image}`,t)});return t}if(this.image instanceof HTMLImageElement){const t=new Texture(this.image);return this.image.complete?t.needsUpdate=!0:(this.image.addEventListener("load",()=>{t.needsUpdate=!0,this.triggerChange()},!1),this.image.addEventListener("error",t=>{console.error(`AdsumWebMap.LabelImageObject: unable to load image ${this.image}`,t)},!1)),t}if(this.image instanceof HTMLCanvasElement)return new CanvasTexture(this.image);throw new TypeError("AdsumWebMap.LabelImageObject: invalid image; expected an url, an image or a canvas")}}const fontHeightCache=new Map,color=new Color;let workingCanvas=null;const TextUtilBrowser={createTextTexture(t,e,s=new CanvasTexture(document.createElement("canvas"))){const i=s.image,n=t.split("\n");null===workingCanvas&&(workingCanvas=document.createElement("canvas"));const o=TextUtilBrowser.getFontHeight(e.size,e.font,workingCanvas),a=o*e.lineHeight,r=n.length*a;let l=0;n.forEach(t=>{l=Math.max(l,TextUtilBrowser.getTextWidth(t,e.size,e.font,workingCanvas))});const h=l+e.backgroundPadding,c=r+e.backgroundPadding;workingCanvas.width=h*e.quality,workingCanvas.height=c*e.quality;const d=workingCanvas.getContext("2d");if(d.scale(e.quality,e.quality),d.clearRect(0,0,h,c),e.backgroundColor){color.set(e.backgroundColor);const t=255*color.r,s=255*color.g,i=255*color.b,n=e.backgroundOpacity;d.fillStyle=`rgba(${t},${s},${i},${n})`,TextUtilBrowser.fillRoundedRect(d,0,0,h,c,e.backgroundRadius)}d.textBaseline="hanging",d.textAlign="center",d.font=`${e.size}pt ${e.font}`,color.set(e.color),d.fillStyle=`rgb(${255*color.r},${255*color.g},${255*color.b})`;const u=(a-o)/2;let p=u+e.backgroundPadding/2;for(let t=0;t<n.length;t++)d.fillText(n[t],Math.round(h/2),Math.round(p)),p+=a+u;return i.width=Math$1.floorPowerOfTwo(workingCanvas.width),i.height=Math$1.floorPowerOfTwo(workingCanvas.height),i.getContext("2d").drawImage(workingCanvas,0,0,workingCanvas.width,workingCanvas.height,0,0,i.width,i.height),{texture:s,width:h,height:c}},fillRoundedRect(t,e,s,i,n,o){t.beginPath(),t.moveTo(e+o,s),t.lineTo(e+i-o,s),t.quadraticCurveTo(e+i,s,e+i,s+o),t.lineTo(e+i,s+n-o),t.quadraticCurveTo(e+i,s+n,e+i-o,s+n),t.lineTo(e+o,s+n),t.quadraticCurveTo(e,s+n,e,s+n-o),t.lineTo(e,s+o),t.quadraticCurveTo(e,s,e+o,s),t.closePath(),t.fill()},getFontHeight(t,e,s){const i=`${t}pt ${e}`;if(fontHeightCache.has(i))return fontHeightCache.get(i);s.width=1e3,s.height=500;const n=s.getContext("2d");n.fillStyle="black",n.fillRect(0,0,s.width,s.height),n.textBaseline="top",n.fillStyle="white",n.font=i,n.fillText("gM",0,s.height/2);const o=n.getImageData(0,0,s.width,s.height).data;let a=-1,r=-1;for(let t=0;t<s.height;t++)for(let e=0;e<s.width;e++){if(!(0===o[4*(t*s.width+e)])){-1===a&&(a=t),r=t+1;break}}const l=r-a;return fontHeightCache.set(i,l),l},getTextWidth(t,e,s,i){const n=i.getContext("2d");return n.font=`${e}pt ${s}`,n.measureText(t).width}};class TextStyleOptions extends AbstractOptions{reset(){this.backgroundColor=null,this.backgroundOpacity=.7,this.backgroundPadding=10,this.backgroundRadius=5,this.color="#000000",this.font="Arial",this.lineHeight=1.25,this.quality=5,this.size=5}}class LabelTextObjectOptions extends LabelObjectOptions{static convert(t){return t.isLabelTextObjectOptions?t:new this(t)}reset(){super.reset(),this.isLabelTextObjectOptions=!0,this.text=null,this.style=new TextStyleOptions}}class LabelTextObject extends LabelObject{constructor(t={}){const e=LabelTextObjectOptions.convert(t);super(e),this.isLabelText=!0,this.text=e.text,this.style=e.style,this._updateMesh()}getType(){return AdsumObjectTypes.LabelTextObject}setText(t,e=null){return this.text=t,null!==e&&this.style.merge(e),this._updateMesh(),this}setStyle(t){return this.style.merge(t),this._updateMesh(),this}_updateMesh(){if(null===this._mesh){const{texture:t,width:e,height:s}=TextUtilBrowser.createTextTexture(this.text,this.style);t.anisotropy=4;const i=new PlaneBufferGeometry(e,s),n=new MeshBasicMaterial({color:16777215,map:t,side:FrontSide,transparent:!0,depthWrite:!1});this._setMesh(new Mesh(i,n))}else{const{width:t,height:e}=TextUtilBrowser.createTextTexture(this.text,this.style,this._mesh.material[0].map);this._mesh.material[0].map.needsUpdate=!0,this._mesh.geometry.width===t&&this._mesh.geometry.height===e||(this._mesh.geometry.dispose(),this._mesh.geometry=new PlaneBufferGeometry(t,e),this._updatePosition())}return this}}class AbstractLevelState{apply(t){}}class DisplayLevelState extends AbstractLevelState{constructor(t){super(),this.displayMode=t}apply(t){super.apply(t),t.setDisplayMode(this.displayMode)}}class AdsumLabelLoader{constructor(t,e){this.entityManager=t,this.projector=e}load(){const t=this.entityManager.getRepository("CustomObject"),e=this.entityManager.getRepository("File"),s=this.entityManager.getRepository("Place");return Promise.all([t.load(),e.load(),s.load()]).then(()=>{const e=t.getAll(),s=[];return e.forEach(t=>{s.push(this.build(t))}),Promise.all(s)})}build(t){const e=this.entityManager.getRepository("File"),s=this.entityManager.getRepository("Place").get(t.place),i={x:t.offset.x,y:t.offset.y,z:t.offset.z};null===s.shape_id&&null===s.building_id&&(i.x+=s.position.x,i.y+=s.position.y,i.z+=s.position.z);const n={orientationMode:t.orientation_mode,autoScale:t.autoscale,placeId:s.id,rotation:t.rotation,id:t.id,isPermanentDisplay:t.permanent_display,offset:i};if(0!==t.priority){const e=new LevelOfDetails;e.addLevelState(0,new DisplayLevelState(DISPLAY_MODES.VISIBLE)),e.addLevelState(this.projector.adsumDistanceToMeter(200*t.priority),new DisplayLevelState(DISPLAY_MODES.NONE)),n.levelOfDetails=e}if(t.type===CUSTOM_OBJECT_TYPES.PICTO){const s=e.get(t.file);return n.width=t.width,n.height=t.height,n.image=s.uri,new LabelImageObject(n)}const o={};return n.text=t.label.replace(/<br[ ]*\/?>/gi,"\n"),o.font=t.font,o.size=t.font_size,o.color=t.font_color,o.backgroundColor=t.background_color,n.style=o,new LabelTextObject(n)}}class SiteObject extends AdsumObject3D{constructor(t={}){super(t),this.isSite=!0,this.buildings=new Set,this.spaces=new Set,this.labels=new Set,this._labelGroup=new Group,this.decors=[],this.user=null}getType(){return AdsumObjectTypes.SiteObject}addLabel(t){if(null!==t.parent)throw new Error("AdsumWebMap.LabelObject#addLabel: Changing labelObject parent is not supported yet.");return t.parent=this,this.labels.add(t),this._labelGroup.add(t._mesh),t.updateMatrix(),this}removeLabel(t){return this.labels.delete(t),t.parent=null,this._labelGroup.remove(t._mesh),this.triggerChange(),this}setDisplayMode(t){switch(super.setDisplayMode(t),this.decors.forEach(e=>e.setDisplayMode(t)),t){case DISPLAY_MODES.NONE:case DISPLAY_MODES.TRANSPARENT:this._labelGroup.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._labelGroup.visible=!0;break;default:throw new Error("Unexpected")}}_raycast(t,e,s=!0){return!1!==super._raycast(t,e,s)&&(s&&(this.buildings.forEach(i=>{i._raycast(t,e,s)}),this.labels.forEach(i=>{i._raycast(t,e,s)}),this.spaces.forEach(i=>{i._raycast(t,e,s)})),!0)}_setMesh(t){return super._setMesh(t),this._mesh.add(this._labelGroup),this._labelGroup.updateMatrixWorld(),this}setFading(t){return super.setFading(t),this.decors.forEach(e=>e.setFading(t)),this.buildings.forEach(e=>e.setFading(t)),this.spaces.forEach(e=>e.setFading(t)),this.labels.forEach(e=>e.setFading(t)),this.user&&this.user.setFading(t),this}}const v1$1=new Vector3;class SelfBox3 extends Box3{setFromObject(t){this.makeEmpty();const{geometry:e}=t;if(void 0!==e)if(e.isGeometry){const{vertices:s}=e;for(let e=0,i=s.length;e<i;e++)v1$1.copy(s[e]),v1$1.applyMatrix4(t.matrixWorld),this.expandByPoint(v1$1)}else if(e.isBufferGeometry){const s=e.attributes.position;if(void 0!==s)for(let e=0,i=s.count;e<i;e++)v1$1.fromBufferAttribute(s,e).applyMatrix4(t.matrixWorld),this.expandByPoint(v1$1)}return this}}const selfBox=new SelfBox3,size=new Vector3;class BuildingObject extends AdsumObject3D{constructor(t={}){super(t),this.isBuilding=!0,this.site=null,this.floors=new Set,this.labels=new Set,this._labelGroup=new Group,this._initialColors=null}getType(){return AdsumObjectTypes.BuildingObject}addLabel(t){if(null!==t.parent)throw new Error("AdsumWebMap.SpaceObject#addLabel: Changing labelObject parent is not supported yet.");return t.parent=this,this.labels.add(t),this._labelGroup.add(t._mesh),t.updateMatrix(),this}removeLabel(t){return this.labels.delete(t),t.parent=null,this._labelGroup.remove(t._mesh),this.triggerChange(),this}setColor(t){return null===this._initialColors&&(this._initialColors=new Map,forEachMaterial(this._mesh,t=>{this._initialColors.set(t,t.color.clone()),t.addEventListener("dispose",()=>{this._initialColors.delete(t)})})),forEachMaterial(this._mesh,e=>{e.color.set(t)}),this.triggerChange(),this}isInitialColor(){if(null===this._initialColors)return!0;let t=!0;return forEachMaterial(this._mesh,e=>{this._initialColors.get(e).equals(e.color)||(t=!1)}),t}resetColor(){return null!==this._initialColors&&(forEachMaterial(this._mesh,t=>{t.color.copy(this._initialColors.get(t))}),this.triggerChange()),this}_setMesh(t){return super._setMesh(t),this._mesh.add(this._labelGroup),this.updateMatrix(),this._initialColors=null,this}setDisplayMode(t){switch(super.setDisplayMode(t),t){case DISPLAY_MODES.NONE:case DISPLAY_MODES.TRANSPARENT:this._labelGroup.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._labelGroup.visible=!0;break;default:throw new Error("Unexpected")}}_raycast(t,e,s=!0){return!1!==super._raycast(t,e,s)&&(s&&(this.floors.forEach(i=>{i._raycast(t,e,s)}),this.labels.forEach(i=>{i._raycast(t,e,s)})),!0)}updateMatrix(){super.updateMatrix(),this.getBbox(selfBox),selfBox.getSize(size),this._labelGroup.position.setZ(size.z),this._labelGroup.updateMatrix(),this._labelGroup.updateMatrixWorld()}setFading(t){return super.setFading(t),this.labels.forEach(e=>e.setFading(t)),this}}class FloorObject extends AdsumObject3D{constructor(t={}){super(t),this.isFloor=!0,this.building=null,this.spaces=new Set,this.labels=new Set,this._labelGroup=new Group,this.altitude=null,this.decors=[],this.user=null}getType(){return AdsumObjectTypes.FloorObject}setDisplayMode(t){switch(super.setDisplayMode(t),this.decors.forEach(e=>e.setDisplayMode(t)),t){case DISPLAY_MODES.NONE:case DISPLAY_MODES.TRANSPARENT:this._labelGroup.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._labelGroup.visible=!0;break;default:throw new Error("Unexpected")}}addLabel(t){if(null!==t.parent)throw new Error("AdsumWebMap.LabelObject#addLabel: Changing labelObject parent is not supported yet.");return t.parent=this,this.labels.add(t),this._labelGroup.add(t._mesh),t.updateMatrix(),this}removeLabel(t){return this.labels.delete(t),t.parent=null,this._labelGroup.remove(t._mesh),this.triggerChange(),this}_raycast(t,e,s=!0){return!1!==super._raycast(t,e,s)&&(s&&(this.spaces.forEach(i=>{i._raycast(t,e,s)}),this.labels.forEach(i=>{i._raycast(t,e,s)})),!0)}_setMesh(t){return super._setMesh(t),this._mesh.add(this._labelGroup),this}setFading(t){return super.setFading(t),this.decors.forEach(e=>e.setFading(t)),this.spaces.forEach(e=>e.setFading(t)),this.labels.forEach(e=>e.setFading(t)),this.user&&this.user.setFading(t),this}}const selfBox$1=new SelfBox3,size$1=new Vector3;class SpaceObject extends AdsumObject3D{constructor(t={}){super(t),this.isSpace=!0,this.parent=null,this.labels=new Set,this._labelGroup=new Group,this._initialColors=null}getType(){return AdsumObjectTypes.SpaceObject}_setMesh(t){return super._setMesh(t),this._mesh.add(this._labelGroup),this.updateMatrix(!0),this._initialColors=null,this}setColor(t){return null===this._initialColors&&(this._initialColors=new Map,forEachMaterial(this._mesh,t=>{this._initialColors.set(t,t.color.clone()),t.addEventListener("dispose",()=>{this._initialColors.delete(t)})})),forEachMaterial(this._mesh,e=>{e.color.set(t)}),this.triggerChange(),this}isInitialColor(){if(null===this._initialColors)return!0;let t=!0;return forEachMaterial(this._mesh,e=>{this._initialColors.get(e).equals(e.color)||(t=!1)}),t}resetColor(){return null!==this._initialColors&&(forEachMaterial(this._mesh,t=>{t.color.copy(this._initialColors.get(t))}),this.triggerChange()),this}isBounced(){return 1!==this._mesh.scale.z}getBounceFactor(){return this._mesh.scale.z}bounceUp(t){return this._mesh.scale.setZ(t),this.updateMatrix(),this}bounceDown(){return this.bounceUp(1)}addLabel(t){if(null!==t.parent)throw new Error("AdsumWebMap.SpaceObject#addLabel: Changing labelObject parent is not supported yet.");return t.parent=this,this.labels.add(t),this._labelGroup.add(t._mesh),t.updateMatrix(),this}removeLabel(t){return this.labels.delete(t),t.parent=null,this._labelGroup.remove(t._mesh),this.triggerChange(),this}_raycast(t,e,s=!0){return!1!==super._raycast(t,e,s)&&(s&&this.labels.forEach(i=>{i._raycast(t,e,s)}),!0)}updateMatrix(t=!1){super.updateMatrix(),(t||this._labelGroup.scale.z!==1/this.getBounceFactor())&&(this.getBbox(selfBox$1),selfBox$1.getSize(size$1),this._labelGroup.scale.setZ(1/this.getBounceFactor()),this._labelGroup.position.setZ(size$1.z/this.getBounceFactor()),this._labelGroup.updateMatrix(),this._labelGroup.updateMatrixWorld())}setFading(t){return super.setFading(t),this.labels.forEach(e=>e.setFading(t)),this}}class DecorObject extends AdsumObject3D{_updateVisibility(){null===this._initialOpacities&&(this._initialOpacities=new Map,this._mesh.traverse(t=>{forEachMaterial(t,t=>{t.transparent&&(this._initialOpacities.set(t,t.opacity),t.addEventListener("dispose",()=>{this._initialOpacities.delete(t)}))})})),this._mesh.traverse(t=>{forEachMaterial(t,t=>{let e=this.fading,s=1!==this.fading;this._initialOpacities.has(t)&&(e*=this._initialOpacities.get(t),s=!0),t.opacity=e,t.transparent=s})}),this.triggerChange()}}class LoaderResult{constructor(t=null){this.scene=null,this.site=null,this.buildingsMap=new Map,this.floorsMap=new Map,this.spacesMap=new Map,this.labelsMap=new Map,this.deviceId=t,this.projector=null,this.paths=null,this.places=null}}const v$2=new Vector3;class AdsumProjector{static createFake(){return new this([1,0,0,0,1,0],[0,0,0],{latitude:0,longitude:0})}constructor(t,e,s){this.matrix=new Matrix4,this.inverseMatrix=null,this.matrix.set(t[0],t[1],0,e[0],t[3],t[4],0,e[1],0,0,1,0,0,0,0,1);const i=new Vector3;i.setFromMatrixScale(this.matrix),this.scale=(i.x+i.y)/2,this.matrix.set(t[0],t[1],0,e[0],t[3],t[4],0,e[1],0,0,this.scale,0,0,0,0,1);const n=Gps.fromDegree(s.latitude,s.longitude,0);this.utmGridZone=new UtmGridZone(n),this.northDirection=new Vector2,this.northDirection.copy(this.utmToAdsum({N:1,E:0,alt:0})),v$2.copy(this.utmToAdsum({N:0,E:0,alt:0})),this.northDirection.sub(v$2),this.northDirection.normalize()}getAdsumNorthAngle(){return this.northDirection.angle()}getAdsumNorthDirection(t){return t.copy(this.northDirection),t}meterToAdsumDistance(t){return t*this.scale}adsumDistanceToMeter(t){return t/this.scale}gpsToAdsum(t){return this.utmToAdsum(this.gpsToUtm(t))}gpsToUtm(t){const{lat:e,long:s,alt:i}=t;return GpsUtmConverter.toUtm(Gps.fromDegree(e,s,i),this.utmGridZone)}utmToAdsum(t){const{E:e,N:s,alt:i}=t,n=new Vector3(e,s,i);return n.applyMatrix4(this.matrix),n}adsumToGps(t){return this.utmToGps(this.adsumToUtm(t))}adsumToUtm(t){return null===this.inverseMatrix&&(this.inverseMatrix=new Matrix4,this.inverseMatrix.getInverse(this.matrix)),v$2.copy(t),v$2.applyMatrix4(this.inverseMatrix),new Utm(v$2.x,v$2.y,v$2.z,this.utmGridZone.hemi,this.utmGridZone.zone)}utmToGps(t){return GpsUtmConverter.toGps(t)}}class AdsumLoaderBase{constructor(t){this.options=new AdsumLoaderOptions(t),this.isAoMap=!0,this.result=new LoaderResult(t.deviceId),this.adsumTextureLoader=null,this.adsumLabelLoader=null,this._registerAdsumTextureLoader()}buildLabel(t){return this.adsumLabelLoader.build(t)}load(){return this._startEntityManagerLoading(),this._registerAdsumTextureLoader().then(()=>Promise.all([this._loadCollada(),this._loadProjectorTransform(),this._loadPaths(),this._loadPlaces()])).then(()=>this._loadLabels()).then(()=>this._addLabels()).then(()=>this.result)}_loadCollada(){const t=this.options.entityManager.getRepository("File"),e=this.options.entityManager.getRepository("MapFile"),s=this.options.entityManager.getRepository("Place");return Promise.all([t.load(),e.load()]).then(()=>{const t=this._getColladaUri();return Promise.all([this._parseCollada(t),s.load()])}).then(([{scene:t}])=>{this.result.scene=t,t.autoUpdate=!1,t.updateMatrix(),t.updateMatrixWorld();const e={building:new Map,shape:new Map};s.getAll().forEach(t=>{null!==t.building_id&&e.building.set(t.building_id,t),null!==t.shape_id&&e.shape.set(t.shape_id,t)}),this._parseAndTransformAdsumScene(t,e),this._adjustSceneSettings()})}loadCalibration(t){const e=this.options.entityManager.getRepository("SiteCalibration"),s=this.options.entityManager.getRepository("FloorCalibration");return Promise.all([e.load(),s.load()]).then(()=>{const i=e.findOneBy({device:e=>e.is(t)});let n=null,o=null;const a=new Map;if(null!==i&&(s.getList(i.floor_calibrations).forEach(t=>{const e=new CameraCalibration;e.eye.copy(t.eye),e.up.copy(t.up),e.target.copy(t.target),e.zoomMin=t.zoom_min||DEFAULT_CALIBRATION.ZOOM_MIN,e.zoomMax=t.zoom_max||DEFAULT_CALIBRATION.ZOOM_MAX;const s=-1===t.floor_id?null:t.floor_id;a.set(s,e)}),n=-1===i.start_floor?null:i.start_floor,null!==i.start_point_floor)){const t=i.start_point_floor;o={floorId:-1!==t?t:null,position:i.start_point_position}}return{cameraCalibrations:a,defaultFloorId:n,userPosition:o}})}_loadPlaces(){const t=this.options.entityManager.getRepository("Place");return t.load().then(()=>{this.result.places=t.getAll()})}_loadLabels(){return this.adsumLabelLoader=new AdsumLabelLoader(this.options.entityManager,this.result.projector),this.adsumLabelLoader.load().then(t=>{t.forEach(t=>{this.result.labelsMap.set(t.id,t)})})}_startEntityManagerLoading(){this.options.entityManager.getRepository("Site").load(),this.options.entityManager.getRepository("MapFile").load(),this.options.entityManager.getRepository("File").load(),this.options.entityManager.getRepository("Place").load(),this.options.entityManager.getRepository("CustomObject").load(),this.options.entityManager.getRepository("SiteCalibration").load(),this.options.entityManager.getRepository("FloorCalibration").load()}_registerAdsumTextureLoader(){return this.options.entityManager.getRepository("File").load().then(()=>{this.adsumTextureLoader=new AdsumTextureLoader(this.options.entityManager.getRepository("File"),this.options.textureQuality,this.isAoMap,()=>{this.result.site&&this.result.site.triggerChange()}),Loader.Handlers.add(this.adsumTextureLoader.regex,this.adsumTextureLoader)})}_getColladaUri(){const t=this.options.entityManager.getRepository("File"),e=this.options.entityManager.getRepository("MapFile"),s=e.findOneBy({type:MAP_FILE_TYPES.AO_DAE,file:t=>null!==t.value});let i=null;if(this.isAoMap&&null!==s)i=s.file;else{const t=e.findOneBy({type:MAP_FILE_TYPES.DAE,file:t=>null!==t.value});if(null===t)throw new Error("AdsumWebMap.AdsumLoader: No map found");i=t.file,this.isAoMap=!1}return t.get(i).uri}_parseCollada(t){}_disposeAll(t){const{children:e,geometry:s}=t;let i;if(e)for(let t=0;t<e.length;t+=1)i=e[t],this._disposeAll(i);s&&s.dispose(),this._disposeMaterial(t)}_disposeMaterial(t){forEachMaterial(t,t=>{const e=t.map;e&&e.dispose(),t.dispose()})}_parseAndTransformAdsumScene(t,e,s=null){let i=t;if(!t.geometry&&!t.material&&t.children.length>0&&("Mesh"===t.children[0].type||t.children[0].isLight)){const{parent:e}=t;e.remove(t);const s=t.children[0];s.isLight?(s.matrix=t.matrix,s.matrix.decompose(s.position,s.quaternion,s.scale)):s.applyMatrix(t.matrix),e.add(s);for(let e=t.children.length-1;e>=0;e--){const i=t.children[e];s.add(i)}(i=s).name=t.name,s.updateMatrix(),s.updateMatrixWorld(),this._disposeAll(t)}const n=i.name||"";forEachMaterial(i,(t,e)=>{if(t.flatShading=!0,t.side=FrontSide,t.isMeshPhongMaterial?(t.emissionMap&&!t.map&&(t.map=t.emissionMap,t.emissionMap=null,t.color=16777215),t.shininess=1e-4):t.isMeshLambertMaterial&&t.emissionMap&&!t.map&&(t.map=t.emissionMap,t.emissionMap=null),t.lightMap)replaceMaterial(i,new MeshPhongMaterial({aoMap:t.lightMap,map:t.map,color:t.color}),e);else if(this.options.preferLambertMaterial()&&t.isMeshPhongMaterial){const s=["alphaTest","blendDst","blendDstAlpha","blendEquation","blendEquationAlpha","blending","blendSrc","blendSrcAlpha","clipIntersection","clippingPlanes","clipShadows","colorWrite","depthFunc","depthTest","depthWrite","fog","lights","name","overdraw","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","precision","premultipliedAlpha","dithering","flatShading","side","transparent","vertexColors","visible","userData","alphaMap","aoMap","aoMapIntensity","color","combine","emissive","emissiveMap","emissiveIntensity","envMap","lightMap","lightMapIntensity","map","morphNormals","morphTargets","reflectivity","refractionRatio","skinning","specularMap","wireframe","wireframeLinecap","wireframeLinejoin","wireframeLinewidth"],n={};for(let e=0;e<s.length;e++){const i=s[e];n[i]=t[i]}replaceMaterial(i,new MeshLambertMaterial(n),e)}});let o=null,a=null;if(n.startsWith("SITE"))this.isAoMap&&(i.rotateX(-Math.PI/2),i.updateMatrix(),i.updateMatrixWorld()),this._mergeExtrudeMesh(i),this.result.site=new SiteObject(new AdsumObject3DOptions({id:-1})),o=this.result.site,a=i,s=this.result.site;else if(n.startsWith("BUILDING")){const t=n.match(/BUILDING_(\d+)_(.*)/),r=new AdsumObject3DOptions({id:parseInt(t[1],10),name:t[2]});e.building.has(r.id)?r.placeId=e.building.get(r.id).id:console.warn(`AdsumLoader: No place associated to building ${r.id}`),this._mergeExtrudeMesh(i),o=new BuildingObject(r),a=i,o.site=s,o.site.buildings.add(o),this.result.buildingsMap.set(o.id,o),s=o}else if(n.startsWith("FLOOR")){const t=n.match(/FLOOR_(\d+)_(.*)/);this._mergeExtrudeMesh(i),o=new FloorObject(new AdsumObject3DOptions({id:parseInt(t[1],10),name:t[2]})),a=i,o.altitude=i.position.z,o.building=s,o.building.floors.add(o),this.result.floorsMap.set(o.id,o),s=o}else if(n.startsWith("SHAPE")||n.startsWith("STORE")){const t=n.match(/(?:SHAPE|STORE)_(\d+)_(.*)/);this._mergeExtrudeMesh(i);const r=new AdsumObject3DOptions({id:parseInt(t[1],10),name:t[2]});e.shape.has(r.id)?r.placeId=e.shape.get(r.id).id:console.warn(`AdsumLoader: No place associated to space ${r.id}`),o=new SpaceObject(r),a=i,o.parent=s,o.parent.spaces.add(o),this.result.spacesMap.set(o.id,o),s=o}else null!==s&&(s.isFloor||s.isSite)&&(o=new DecorObject,a=i,s.decors.push(o),s=null);for(let t=i.children.length-1;t>=0;t--)if(i.children[t].geometry||0!==i.children[t].children.length)this._parseAndTransformAdsumScene(i.children[t],e,s);else{const e=i.children[t];i.remove(e),this._disposeAll(e)}null!==o&&o._setMesh(a)}_mergeExtrudeMesh(t){for(let e=0;e<t.children.length;e++)if("ExtrudeMesh"===t.children[e].name){const s=new Geometry;s.fromBufferGeometry(t.geometry),t.geometry.dispose();const i=new Geometry;return i.fromBufferGeometry(t.children[e].children[0].geometry),t.children[e].children[0].geometry.dispose(),t.children[e].updateMatrix(),t.children[e].updateMatrixWorld(),t.children[e].children[0].updateMatrix(),t.children[e].children[0].updateMatrixWorld(),t.children[e].matrixWorld.multiplyMatrices(t.children[e].matrix,t.children[e].children[0].matrix),s.merge(i,t.children[e].matrixWorld,1),t.material=[t.material,t.children[e].children[0].material],t.geometry.fromGeometry(s),void t.remove(t.children[e])}}_adjustSceneSettings(){this.result.scene.traverse(t=>{forEachMaterial(t,t=>{t.shininess=1e-5}),this.options.shadowEnabled&&(t!==this.result.site._mesh&&(t.castShadow=!0),t.receiveShadow=!0)}),this._createLights(),this._createFog(),forEachMaterial(this.result.site._mesh,t=>{t.emissive&&t.emissive.set(0),t.shininess&&(t.shininess=1e-5)}),this.result.buildingsMap.forEach(t=>{const e=t._mesh;if(forEachMaterial(e,t=>{t.specular&&t.specular.set(0,0,0)}),e.geometry){const s=new Vector3;e.geometry.computeBoundingBox(),e.geometry.boundingBox.getCenter(s),e.geometry.center(),e.geometry.translate(0,0,s.z),s.z=0,s.multiply(e.scale),s.applyQuaternion(e.quaternion),e.position.add(s),e.children.forEach(e=>{e!==t._labelGroup&&(e.position.sub(s),e.updateMatrix())}),e.updateMatrix(),e.updateMatrixWorld()}this._colorShapeVertices(e)}),this.result.floorsMap.forEach(t=>{forEachMaterial(t._mesh,t=>{t.emissive&&t.emissive.set(0),t.shininess&&(t.shininess=1e-5)})}),this.result.spacesMap.forEach(t=>{const e=t._mesh;if(this._colorShapeVertices(e),e.geometry){const t=new Vector3;e.geometry.computeBoundingBox(),e.geometry.boundingBox.getCenter(t),e.geometry.center(),e.geometry.translate(0,0,t.z),t.z=0,t.multiply(e.scale),t.applyQuaternion(e.quaternion),e.position.add(t),e.updateMatrix(),e.updateMatrixWorld()}})}_colorShapeVertices(t){if(this.isAoMap){const e=t.geometry,s=e.getAttribute("position"),i=e.getAttribute("color"),n=new Color(this.options.shapeAmbientOcclusionTopColor),o=new Color(this.options.shapeAmbientOcclusionBottomColor);for(let t=0;t<s.count;t++){const e=0===s.getZ(t)?o:n;i.setXYZ(t,e.r,e.g,e.b)}i.needsUpdate=!0,forEachMaterial(t,t=>{t.vertexColors=VertexColors,t.needsUpdate=!0})}}_createLights(){const t=this.options.advancedLightingEnabled()?.5:1,e=new HemisphereLight(16777215,8947848,t);if(e.position.set(0,0,1),this.result.scene.add(e),e.updateMatrix(),e.updateMatrixWorld(),this.options.advancedLightingEnabled()){const t=new DirectionalLight(16777215,.2);t.position.set(1,0,0),this.result.scene.add(t),t.updateMatrix(),t.updateMatrixWorld();const e=new Box3,s=new Sphere;e.setFromObject(this.result.scene).getBoundingSphere(s);const{radius:i}=s,n=s.center.clone();n.z+=i/2,n.y+=i/2,n.x-=i/2;const o=new DirectionalLight(16777215,.85);o.position.copy(n),o.target.position.copy(s.center),this.options.shadowEnabled&&(o.castShadow=!0,o.shadow.camera.near=i/4,o.shadow.camera.far=2*i,o.shadow.camera.right=i,o.shadow.camera.left=-i,o.shadow.camera.top=i,o.shadow.camera.bottom=-i,o.shadow.mapSize.width=this.options.shadowMapSize,o.shadow.mapSize.height=this.options.shadowMapSize),this.result.scene.add(o.target),this.result.scene.add(o),o.updateMatrix(),o.updateMatrixWorld(),o.target.updateMatrix(),o.target.updateMatrixWorld()}}_createFog(){this.options.fogEnabled&&(this.result.scene.fog=new FogExp2(this.options.fogColor,this.options.fogRatio))}_addLabels(){const t=this.options.entityManager.getRepository("Place"),e=this.options.entityManager.getRepository("CustomObject");return t.load().then(()=>{this.result.labelsMap.forEach(s=>{const i=e.get(s.id),n=t.get(i.place);if(null!==n.shape_id){this.result.spacesMap.get(n.shape_id).addLabel(s)}else if(null!==n.building_id){this.result.buildingsMap.get(n.building_id).addLabel(s)}else if(-1===n.floor_id)this.result.site.addLabel(s);else{this.result.floorsMap.get(n.floor_id).addLabel(s)}})})}_loadProjectorTransform(){const t=this.options.entityManager.getRepository("Site");return t.load().then(()=>{const e=t.getCurrent();e.gps_positions.size<4||6!==e.gps_transform.size||3!==e.gps_translate.size?(console.warn("AdsumWebMap.AdsumLoader: No gps positions available, wayfinding will not be accurate (we assume world unit match meter) !!"),this.result.projector=AdsumProjector.createFake()):this.result.projector=new AdsumProjector(Array.from(e.gps_transform),Array.from(e.gps_translate),Array.from(e.gps_positions)[0])})}_loadPaths(){const t=this.options.entityManager.getRepository("MapFile");return t.load().then(()=>{const e=t.findOneBy({type:MAP_FILE_TYPES.PATH});null===e?(console.warn("AdsumWebMap.AdsumLoader: No paths found, wayfinding will not be working !"),this.result.paths=new Map,this.result.paths.set("nodes",[]),this.result.paths.set("links",[])):this.result.paths=e.paths})}}class AdsumLoader extends AdsumLoaderBase{_parseCollada(t){return new Promise((e,s)=>{return(new AdsumColladaLoader).load(t,e,null,s)})}}class Path{constructor(t=null,e=null,s=!1){this.from=t,this.to=e,this.pmr=s,this._distance=null,this._pathSections=[],this.computed=!1}get pathSections(){return console.warn("Deprecated: AdsumWebMap.Path.pathSections property access is deprecated, please use 'getPathSections'"),this.getPathSections()}getPathSections(t=!1){return t?this._pathSections:this._pathSections.filter(t=>!t.isInterGround())}setPathSections(t){return this._pathSections=t,this.computed=!0,this._distance=null,this}getDistance(){return this.computed?(null===this._distance&&(this._distance=0,this.getPathSections(!0).forEach(t=>{this._distance+=t.getDistance()})),this._distance):null}}class OrientedDotUserObjectOptions extends AbstractOptions{reset(){this.size=3,this.color=769978}}export{AdsumWebMap,Options,CameraOptions,CameraCenterOnOptions,EngineOptions,SceneOptions,SingleFloorAnimation,SingleFloorAnimationOptions,AdsumLoader,AdsumLoaderOptions,MOUSE_EVENTS,LabelTextObject,LabelImageObject,AdsumObjectTypes as ADSUM_OBJECT_TYPES,TEXTURE_QUALITY,DISPLAY_MODES as DISPLAY_MODE,DISPLAY_MODES,LABEL_OBJECTS_ORIENTATION_MODES as LABEL_ORIENTATION_MODES,SceneEvents as SCENE_EVENTS,WayfindingEvents as WAYFINDING_EVENTS,Path,DotPathBuilderOptions,ArrowPathPatternOptions,FlatArrowPathPatternOptions,DotPathBuilder,DotPathSectionDrawer,DotPathSectionDrawerOptions,DotUserObject,DotUserObjectOptions,OrientedDotUserObject,OrientedDotUserObjectOptions,DisplayLevelState,LevelOfDetails,PathSection,PATH_BUILDER_TYPES as PathBuilderTypes,PATH_PATTERN_OPTIONS_TYPES as PathPatternOptionsTypes,PathSectionObject,WayfindingOptions,UserObject};
