/**
 * Copyright (C) 2018 Adactive SAS
 */

"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var jsdom=require("jsdom"),oldApi=require("jsdom/lib/old-api"),three=require("three"),es6Tween=require("es6-tween"),adactiveAbstractOptions=require("@adactive/adactive-abstract-options"),adsumClientApi=require("@adactive/adsum-client-api"),adsumSpaceTransform=require("@adactive/adsum-space-transform"),http=_interopDefault(require("http")),https=_interopDefault(require("https")),fs=_interopDefault(require("fs")),url=require("url"),window$1=new jsdom.JSDOM;global.window=window$1.window,global.document=window$1.window.document;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),get=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var s=r.get;return void 0!==s?s.call(n):void 0},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],n=!0,r=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(i.push(s.value),!t||i.length!==t);n=!0);}catch(e){r=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw a}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)},DOMParser$1=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"parseFromString",value:function(e){return oldApi.jsdom(e,{parsingMode:"xml"})}}]),e}();global.DOMParser=DOMParser$1;var ObjectManager=function(){function e(){classCallCheck(this,e),this.site=null,this.buildings=new Map,this.floors=new Map,this.spaces=new Map,this.labels=new Map,this.user=null,this.pathSectionObjects=new Map}return createClass(e,[{key:"init",value:function(e){this.site=e.site,this.buildings=e.buildingsMap,this.floors=e.floorsMap,this.spaces=e.spacesMap,this.labels=e.labelsMap}},{key:"getFloor",value:function(e){return this.floors.has(e)?this.floors.get(e):null}},{key:"getBuilding",value:function(e){return this.buildings.has(e)?this.buildings.get(e):null}},{key:"getSpace",value:function(e){return this.spaces.has(e)?this.spaces.get(e):null}},{key:"getLabel",value:function(e){return this.labels.has(e)?this.labels.get(e):null}},{key:"getByAdsumLocation",value:function(e){return null==e?null:e.adsumObject}},{key:"addLabel",value:function(e,t){return this.labels.set(e.id,e),t.addLabel(e),this}},{key:"removeLabel",value:function(e){return this.labels.delete(e.id),e.parent.removeLabel(e),this}}]),e}(),SceneEvents={floor:{didChanged:"scene.floor.didChanged",willChanged:"scene.floor.willChanged"}},SceneManager=function(e){function n(e,t){classCallCheck(this,n);var i=possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return i.awm=e,i.scene=null,i.currentGround=null,i.options=t,i}return inherits(n,e),createClass(n,[{key:"init",value:function(e){var t=this;this.scene=e.scene,this.options.animation.init(this.awm),this.currentGround=e.site,this.scene.addEventListener("change",function(){t.awm.engineManager.requestUpdate()})}},{key:"getCurrentFloor",value:function(){return this.getFloor(this.currentGround)}},{key:"isCurrentFloor",value:function(e){return e===this.currentGround||this.isSite(this.currentGround)&&this.isSite(e)}},{key:"setCurrentFloor",value:function(e){var t=this,i=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(this.isCurrentFloor(e))return Promise.resolve();var n=this.currentGround;return this.currentGround=this.getGround(e),this.dispatchEvent({type:SceneEvents.floor.willChanged,previous:this.getFloor(n),current:this.getFloor(this.currentGround)}),this.options.animation.stop(),this.options.animation.start(n,this.currentGround,i).then(function(){t.dispatchEvent({type:SceneEvents.floor.didChanged,previous:t.getFloor(n),current:t.getFloor(t.currentGround)})})}},{key:"getGround",value:function(e){return this.isSite(e)?this.awm.objectManager.site:e}},{key:"getFloor",value:function(e){return this.isSite(e)?null:e}},{key:"isSite",value:function(e){return null===e||e.isSite}},{key:"currentFloor",get:function(){return console.warn("SceneManager.currentFloor is deprecated, use SceneManager.getCurrentFloor instead"),this.getCurrentFloor()},set:function(e){console.warn("SceneManager.currentFloor is deprecated, use SceneManager.setCurrentFloor instead"),this.setCurrentFloor(e,!1)}}]),n}(three.EventDispatcher),DISPLAY_MODES={NONE:"none",VISIBLE:"visible",TRANSPARENT:"transparent"};es6Tween.FrameThrottle(5);var EngineManagerBase=function(){function i(e,t){classCallCheck(this,i),this.awm=e,this.options=t,this.container=t.container,this.canvas=null,this.levelOfDetailsEnabled=!0,this.renderer=null,this._animationFrameId=null,this.running=!1}return createClass(i,[{key:"isLevelOfDetailsEnabled",value:function(){return this.levelOfDetailsEnabled}},{key:"enableLevelOfDetails",value:function(){return this.levelOfDetailsEnabled=!0,this.requestUpdate(),this}},{key:"disableLevelOfDetails",value:function(){return this.levelOfDetailsEnabled=!1,this.requestUpdate(),this}},{key:"init",value:function(){var e=this;window.addEventListener("resize",function(){e.requestUpdate()}),es6Tween.onRequestTick(function(){e.requestUpdate()})}},{key:"compileMaterials",value:function(){var e=this,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];this.renderer.compile(this.awm.sceneManager.scene,this.awm.cameraManager.camera),t&&this.renderer.domElement.addEventListener("webglcontextrestored",function(){e.compileMaterials(!1)},!1)}},{key:"start",value:function(){this.running=!0,this.update()}},{key:"requestUpdate",value:function(){this.running&&null===this._animationFrameId&&(this._animationFrameId=requestAnimationFrame(this.update.bind(this)))}},{key:"update",value:function(){try{this._resizeCanvas();var e=es6Tween.update();this.awm.cameraManager.control.update(),this._updateLevelOfDetails(this.awm.cameraManager.camera),this.renderer.render(this.awm.sceneManager.scene,this.awm.cameraManager.camera),this._animationFrameId&&(cancelAnimationFrame(this._animationFrameId),this._animationFrameId=null),this.options.autoCompileMaterials&&(this.options.autoCompileMaterials=!1,this.compileMaterials()),e&&this.requestUpdate()}catch(e){throw this.requestUpdate(),e}}},{key:"stop",value:function(){this._animationFrameId&&(cancelAnimationFrame(this._animationFrameId),this._animationFrameId=null),this.running=!1,es6Tween.getAll().forEach(function(e){e.stop()})}},{key:"_updateLevelOfDetails",value:function(t){var i=this,e=this.awm.objectManager.site;e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled),e.getDisplayMode()!==DISPLAY_MODES.NONE&&(e.buildings.forEach(function(e){return i._updateLevelOfDetailsOnBuilding(e,t)}),e.spaces.forEach(function(e){return i._updateLevelOfDetailsOnSpace(e,t)}),e.labels.forEach(function(e){return e._applyLod(t,i.awm.getProjector(),i.levelOfDetailsEnabled)}))}},{key:"_updateLevelOfDetailsOnBuilding",value:function(e,t){var i=this;e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled),e.getDisplayMode()!==DISPLAY_MODES.NONE&&(e.floors.forEach(function(e){return i._updateLevelOfDetailsOnFloor(e,t)}),e.labels.forEach(function(e){return e._applyLod(t,i.awm.getProjector(),i.levelOfDetailsEnabled)}))}},{key:"_updateLevelOfDetailsOnFloor",value:function(e,t){var i=this;e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled),e.getDisplayMode()!==DISPLAY_MODES.NONE&&(e.spaces.forEach(function(e){return i._updateLevelOfDetailsOnSpace(e,t)}),e.labels.forEach(function(e){return e._applyLod(t,i.awm.getProjector(),i.levelOfDetailsEnabled)}))}},{key:"_updateLevelOfDetailsOnSpace",value:function(e,t){var i=this;e._applyLod(t,this.awm.getProjector(),this.levelOfDetailsEnabled),e.getDisplayMode()!==DISPLAY_MODES.NONE&&e.labels.forEach(function(e){return e._applyLod(t,i.awm.getProjector(),i.levelOfDetailsEnabled)})}},{key:"_getDevicePixelRatio",value:function(){return window.devicePixelRatio||1}},{key:"_resizeCanvas",value:function(){var e=this.renderer.getSize(),t=e.width,i=e.height,n=t!==this.container.clientWidth||i!==this.container.clientHeight,r=this.renderer.getPixelRatio()!==this._getDevicePixelRatio();if((n||r)&&(n&&this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),r&&this.renderer.setPixelRatio(this._getDevicePixelRatio()),n)){var a=this.awm.cameraManager,s=a.camera,o=a.control;s.aspect=this.container.clientWidth/this.container.clientHeight,s.updateProjectionMatrix(),o.update()}}}]),i}(),EngineManager=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,EngineManagerBase),createClass(t,[{key:"init",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"init",this).call(this),console.warn("AdsumWebMap.EngineManager: disabled in NodeJS")}}]),t}(),THREE={Vector3:three.Vector3,MOUSE:three.MOUSE,Quaternion:three.Quaternion,Spherical:three.Spherical,EventDispatcher:three.EventDispatcher,Vector2:three.Vector2};THREE.MapControls=function(e,t){var i,n,r,a,s;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return f.phi},this.getAzimuthalAngle=function(){return f.theta},this.saveState=function(){o.target0.copy(o.target),o.position0.copy(o.object.position),o.zoom0=o.object.zoom},this.reset=function(){o.target.copy(o.target0),o.object.position.copy(o.position0),o.object.zoom=o.zoom0,o.object.updateProjectionMatrix(),o.dispatchEvent(l),o.update(),p=u.NONE},this.update=(i=new THREE.Vector3,n=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),r=n.clone().inverse(),a=new THREE.Vector3,s=new THREE.Quaternion,function(){var e=o.object.position;return i.copy(e).sub(o.target),i.applyQuaternion(n),f.setFromVector3(i),o.autoRotate&&p===u.NONE&&N(2*Math.PI/60/60*o.autoRotateSpeed),f.theta+=m.theta,f.phi+=m.phi,f.theta=Math.max(o.minAzimuthAngle,Math.min(o.maxAzimuthAngle,f.theta)),f.phi=Math.max(o.minPolarAngle,Math.min(o.maxPolarAngle,f.phi)),f.makeSafe(),f.radius*=g,f.radius=Math.max(o.minDistance,Math.min(o.maxDistance,f.radius)),o.target.add(y),i.setFromSpherical(f),i.applyQuaternion(r),e.copy(o.target).add(i),o.object.lookAt(o.target),!0===o.enableDamping?(m.theta*=1-o.dampingFactor,m.phi*=1-o.dampingFactor,y.multiplyScalar(1-o.dampingFactor)):(m.set(0,0,0),y.set(0,0,0)),g=1,!(!(v||a.distanceToSquared(o.object.position)>d||8*(1-s.dot(o.object.quaternion))>d)||(o.dispatchEvent(l),a.copy(o.object.position),s.copy(o.object.quaternion),v=!1))}),this.dispose=function(){o.domElement.removeEventListener("contextmenu",ne,!1),o.domElement.removeEventListener("mousedown",Z,!1),o.domElement.removeEventListener("wheel",K,!1),o.domElement.removeEventListener("touchstart",ee,!1),o.domElement.removeEventListener("touchend",ie,!1),o.domElement.removeEventListener("touchmove",te,!1),document.removeEventListener("mousemove",X,!1),document.removeEventListener("mouseup",J,!1),window.removeEventListener("keydown",Q,!1)};var o=this,l={type:"change"},c={type:"start"},h={type:"end"},u={NONE:0,ROTATE_UP:1,ROTATE_LEFT:2,ROTATE:3,DOLLY:4,DOLLY_ROTATE:7,PAN:8,DOLLY_PAN:12},p=u.NONE,d=1e-6,f=new THREE.Spherical,m=new THREE.Spherical,g=1,y=new THREE.Vector3,v=!1,b=new THREE.Vector2,_=new THREE.Vector2,O=new THREE.Vector2,w=new THREE.Vector2,E=new THREE.Vector2,M=new THREE.Vector2,k=new THREE.Vector2,P=new THREE.Vector2,T=new THREE.Vector2,C=new THREE.Vector2,A=new THREE.Vector2,j=new THREE.Vector2,x=new THREE.Vector2,S=new THREE.Vector2;function R(){return Math.pow(.95,o.zoomSpeed)}function N(e){m.theta-=e}function L(e){m.phi-=e}var D,I,B,F=(D=new THREE.Vector3,function(e,t){D.setFromMatrixColumn(t,0),D.multiplyScalar(-e),y.add(D)}),V=(I=new THREE.Vector3,function(e,t){!0===o.screenSpacePanning?I.setFromMatrixColumn(t,1):(I.setFromMatrixColumn(t,0),I.crossVectors(o.object.up,I)),I.multiplyScalar(e),y.add(I)}),H=(B=new THREE.Vector3,function(e,t){var i=o.domElement===document?o.domElement.body:o.domElement;if(o.object.isPerspectiveCamera){var n=o.object.position;B.copy(n).sub(o.target);var r=B.length();r*=Math.tan(o.object.fov/2*Math.PI/180),F(2*e*r/i.clientHeight,o.object.matrix),V(2*t*r/i.clientHeight,o.object.matrix)}else o.object.isOrthographicCamera?(F(e*(o.object.right-o.object.left)/o.object.zoom/i.clientWidth,o.object.matrix),V(t*(o.object.top-o.object.bottom)/o.object.zoom/i.clientHeight,o.object.matrix)):(console.warn("WARNING: MapControls.js encountered an unknown camera type - pan disabled."),o.enablePan=!1)});function U(e){o.object.isPerspectiveCamera?g/=e:o.object.isOrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom*e)),o.object.updateProjectionMatrix(),v=!0):(console.warn("WARNING: MapControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function z(e){o.object.isPerspectiveCamera?g*=e:o.object.isOrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom/e)),o.object.updateProjectionMatrix(),v=!0):(console.warn("WARNING: MapControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function G(e){if(!1!==o.enableRotate&&0!=(p&u.ROTATE)){if(O.set(e.touches[0].pageX,e.touches[0].pageY),w.set(e.touches[1].pageX,e.touches[1].pageY),E.subVectors(O,b),M.subVectors(w,_),k.subVectors(_,b),P.subVectors(w,O),function(){if(!Y(k))return!1;if(!Y(P))return!1;if(!q(E))return!1;if(!q(M))return!1;return 0<E.dot(M)}()){var t=o.domElement===document?o.domElement.body:o.domElement;L(2*Math.PI*E.y/t.clientHeight),p=u.ROTATE_UP}else 0!=(p&u.ROTATE_LEFT)&&N((k.angle()-P.angle())*o.rotateSpeed);b.copy(O),_.copy(w)}}var $,W,Y=($=Math.sin(Math.PI/6),function(e){return Math.abs(Math.sin(e.angle()))<$}),q=(W=Math.cos(Math.PI/2-Math.PI/6),function(e){return Math.abs(Math.cos(e.angle()))<W});function Z(e){if(!1!==o.enabled){switch(e.preventDefault(),e.button){case o.mouseButtons.ORBIT:if(!1===o.enableRotate)return;n=e,b.set(n.clientX,n.clientY),p=u.ROTATE;break;case o.mouseButtons.ZOOM:if(!1===o.enableZoom)return;i=e,j.set(i.clientX,i.clientY),p=u.DOLLY;break;case o.mouseButtons.PAN:if(!1===o.enablePan)return;t=e,T.set(t.clientX,t.clientY),p=u.PAN}var t,i,n;p!==u.NONE&&(document.addEventListener("mousemove",X,!1),document.addEventListener("mouseup",J,!1),o.dispatchEvent(c))}}function X(e){var t,i;if(!1!==o.enabled)switch(e.preventDefault(),p){case u.ROTATE:if(!1===o.enableRotate)return;!function(e){O.set(e.clientX,e.clientY),E.subVectors(O,b).multiplyScalar(o.rotateSpeed);var t=o.domElement===document?o.domElement.body:o.domElement;N(2*Math.PI*E.x/t.clientHeight),L(2*Math.PI*E.y/t.clientHeight),b.copy(O),o.update()}(e);break;case u.DOLLY:if(!1===o.enableZoom)return;i=e,x.set(i.clientX,i.clientY),S.subVectors(x,j),0<S.y?U(R()):S.y<0&&z(R()),j.copy(x),o.update();break;case u.PAN:if(!1===o.enablePan)return;t=e,C.set(t.clientX,t.clientY),A.subVectors(C,T).multiplyScalar(o.panSpeed),H(A.x,A.y),T.copy(C),o.update()}}function J(e){!1!==o.enabled&&(document.removeEventListener("mousemove",X,!1),document.removeEventListener("mouseup",J,!1),o.dispatchEvent(h),p=u.NONE)}function K(e){var t;!1===o.enabled||!1===o.enableZoom||p!==u.NONE&&p!==u.ROTATE||(e.preventDefault(),e.stopPropagation(),o.dispatchEvent(c),(t=e).deltaY<0?z(R()):0<t.deltaY&&U(R()),o.update(),o.dispatchEvent(h))}function Q(e){!1!==o.enabled&&!1!==o.enableKeys&&!1!==o.enablePan&&function(e){switch(e.keyCode){case o.keys.UP:H(0,o.keyPanSpeed),o.update();break;case o.keys.BOTTOM:H(0,-o.keyPanSpeed),o.update();break;case o.keys.LEFT:H(o.keyPanSpeed,0),o.update();break;case o.keys.RIGHT:H(-o.keyPanSpeed,0),o.update()}}(e)}function ee(e){if(!1!==o.enabled){switch(e.preventDefault(),e.touches.length){case 1:if(!1===o.enablePan)return;i=e,o.enablePan&&T.set(i.touches[0].pageX,i.touches[0].pageY),p=u.PAN;break;case 2:if(!1===o.enableZoom&&!1===o.enableRotate)return;t=e,b.set(t.touches[0].pageX,t.touches[0].pageY),_.set(t.touches[1].pageX,t.touches[1].pageY),function(e){if(o.enableZoom){var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+i*i);j.set(0,n)}}(e),p=u.DOLLY_ROTATE;break;default:p=u.NONE}var t,i;p!==u.NONE&&o.dispatchEvent(c)}}function te(e){var t;if(!1!==o.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===o.enablePan)return;if(p!==u.PAN)return;t=e,!1!==o.enablePan&&0!=(p&u.PAN)&&(C.set(t.touches[0].pageX,t.touches[0].pageY),A.subVectors(C,T).multiplyScalar(o.panSpeed),H(A.x,A.y),T.copy(C)),o.update();break;case 2:if(!1===o.enableZoom&&!1===o.enableRotate)return;if(0==(p&u.DOLLY_ROTATE))return;G(e),function(e){if(!1!==o.enableZoom&&0!=(p&u.DOLLY)){var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+i*i);x.set(0,n),S.set(0,Math.pow(x.y/j.y,o.zoomSpeed)),U(S.y),j.copy(x)}}(e),o.update();break;default:p=u.NONE}}function ie(e){!1!==o.enabled&&(o.dispatchEvent(h),p=u.NONE)}function ne(e){e.preventDefault(),o.enabled}o.domElement.addEventListener("contextmenu",ne,!1),o.domElement.addEventListener("mousedown",Z,!1),o.domElement.addEventListener("wheel",K,!1),o.domElement.addEventListener("touchstart",ee,!1),o.domElement.addEventListener("touchend",ie,!1),o.domElement.addEventListener("touchmove",te,!1),window.addEventListener("keydown",Q,!1),this.update()},THREE.MapControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.MapControls.prototype.constructor=THREE.MapControls,Object.defineProperties(THREE.MapControls.prototype,{center:{get:function(){return console.warn("THREE.MapControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.MapControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.MapControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.MapControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.MapControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.MapControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.MapControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.MapControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.MapControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.MapControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.MapControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.MapControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.MapControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});var MapControls=THREE.MapControls,v1=new three.Vector3,VisibleBox3=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"setFromObject",value:function(e){var l=this;return this.makeEmpty(),e.traverseVisible(function(e){var t=e.geometry;if(void 0!==t)if(t.isGeometry)for(var i=t.vertices,n=0,r=i.length;n<r;n++)v1.copy(i[n]),v1.applyMatrix4(e.matrixWorld),l.expandByPoint(v1);else if(t.isBufferGeometry){var a=t.attributes.position;if(void 0!==a)for(var s=0,o=a.count;s<o;s++)v1.fromBufferAttribute(a,s).applyMatrix4(e.matrixWorld),l.expandByPoint(v1)}}),this}}]),t}(three.Box3),DEFAULT_CALIBRATION={UP:new three.Vector3(0,0,1),ZOOM_MIN:25,ZOOM_MAX:2e4},CameraCalibration=function e(){classCallCheck(this,e),this.eye=new three.Vector3,this.up=DEFAULT_CALIBRATION.UP.clone(),this.target=new three.Vector3,this.zoomMin=DEFAULT_CALIBRATION.ZOOM_MIN,this.zoomMax=DEFAULT_CALIBRATION.ZOOM_MAX},CameraCenterOnOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){this.altitude=null,this.azimuth=null,this.fitRatio=1.5,this.time=700,this.zoom=!0}},{key:"getAzimuth",value:function(e){return null===this.azimuth?e:three.Math.degToRad(this.azimuth)}},{key:"getAltitude",value:function(e){return null===this.altitude?e:three.Math.degToRad(this.altitude)}}]),t}(adactiveAbstractOptions.AbstractOptions),THREE$1={Vector3:three.Vector3,Ray:three.Ray,Plane:three.Plane,Math:three.Math,CameraViewBox:function(){this.viewBasis={x:new THREE$1.Vector3,y:new THREE$1.Vector3,z:new THREE$1.Vector3},this.fitRatio=1,this.verticalTanFov=0,this.horizontalTanFov=0,this.viewProjection={top:new THREE$1.Vector3,left:new THREE$1.Vector3,bottom:new THREE$1.Vector3,right:new THREE$1.Vector3},this.bounds={isEmpty:!0,anchor:new THREE$1.Vector3,plane:new THREE$1.Plane,top:-1/0,left:1/0,bottom:1/0,right:-1/0}}};Object.assign(THREE$1.CameraViewBox.prototype,{isCameraViewBox:!0,setFitRatio:function(e){return this.fitRatio=e,this},setViewFromCamera:function(){var t=new THREE$1.Vector3,i=new THREE$1.Vector3,n=new THREE$1.Vector3;return function(e){return e.updateMatrixWorld(!0),e.matrixWorld.extractBasis(t,i,n),this.setViewFromBasis(t,i,n,e.fov,e.aspect)}}(),setViewFromBasis:function(){var o=new THREE$1.Vector3;return function(e,t,i,n,r){var a=THREE$1.Math.degToRad(n);this.verticalTanFov=2*Math.tan(a/2);var s=2*Math.atan(this.verticalTanFov/2*r);return this.horizontalTanFov=2*Math.tan(s/2),this.viewBasis.x.copy(e),this.viewBasis.y.copy(t),this.viewBasis.z.copy(i),this.viewProjection.top.set(0,0,0),this.viewProjection.bottom.set(0,0,0),this.viewProjection.left.set(0,0,0),this.viewProjection.right.set(0,0,0),o.copy(i).multiplyScalar(-Math.cos(a/2)),this.viewProjection.top.add(o),this.viewProjection.bottom.add(o),o.copy(t).multiplyScalar(Math.sin(a/2)),this.viewProjection.top.add(o),this.viewProjection.bottom.add(o.negate()),o.copy(i).multiplyScalar(-Math.cos(s/2)),this.viewProjection.left.add(o),this.viewProjection.right.add(o),o.copy(e).multiplyScalar(Math.sin(s/2)),this.viewProjection.right.add(o),this.viewProjection.left.add(o.negate()),this}}(),setFromObject:function(e){return this.makeEmpty(),this.expandByObject(e)},setFromObjects:function(e){return this.makeEmpty(),this.expandByObjects(e)},makeEmpty:function(){return this.isEmpty=!0,this.bounds.top=-1/0,this.bounds.left=1/0,this.bounds.bottom=1/0,this.bounds.right=-1/0,this},expandByObject:function(){var r,a,s,o=new THREE$1.Vector3;function t(e){var t=e.geometry;if(void 0!==t)if(t.isGeometry){var i=t.vertices;for(a=0,s=i.length;a<s;a++)o.copy(i[a]),o.applyMatrix4(e.matrixWorld),r.expandByPoint(o)}else if(t.isBufferGeometry){var n=t.attributes.position;if(void 0!==n)for(a=0,s=n.count;a<s;a++)o.fromBufferAttribute(n,a).applyMatrix4(e.matrixWorld),r.expandByPoint(o)}}return function(e){return r=this,e.updateMatrixWorld(!0),e.traverse(t),this}}(),expandByObjects:function(e){for(var t=0;t<e.length;t++)this.expandByObject(e[t]);return this},expandByPoint:function(){var t,i=new THREE$1.Ray,n=new THREE$1.Vector3;return function(e){this.isEmpty&&(this.bounds.anchor.copy(e),this.bounds.plane.setFromNormalAndCoplanarPoint(this.viewBasis.z,this.bounds.anchor),this.isEmpty=!1),i.origin.copy(e),i.direction.copy(this.viewProjection.top),null===i.intersectPlane(this.bounds.plane,n)&&(i.direction.negate(),i.intersectPlane(this.bounds.plane,n)),t=n.sub(this.bounds.anchor).dot(this.viewBasis.y),this.bounds.top=Math.max(this.bounds.top,t),i.direction.copy(this.viewProjection.bottom),null===i.intersectPlane(this.bounds.plane,n)&&(i.direction.negate(),i.intersectPlane(this.bounds.plane,n)),t=n.sub(this.bounds.anchor).dot(this.viewBasis.y),this.bounds.bottom=Math.min(this.bounds.bottom,t),i.direction.copy(this.viewProjection.left),null===i.intersectPlane(this.bounds.plane,n)&&(i.direction.negate(),i.intersectPlane(this.bounds.plane,n)),t=n.sub(this.bounds.anchor).dot(this.viewBasis.x),this.bounds.left=Math.min(this.bounds.left,t),i.direction.copy(this.viewProjection.right),null===i.intersectPlane(this.bounds.plane,n)&&(i.direction.negate(),i.intersectPlane(this.bounds.plane,n)),t=n.sub(this.bounds.anchor).dot(this.viewBasis.x),this.bounds.right=Math.max(this.bounds.right,t)}}(),getTarget:function(){var i=new THREE$1.Vector3;return function(e,t){return this.getCameraPositionAndTarget(i,e,t)}}(),getCameraPosition:function(){var t=new THREE$1.Vector3;return function(e){return this.getCameraPositionAndTarget(e,t)}}(),getCameraPositionAndTarget:function(){var r=new THREE$1.Vector3,a=new THREE$1.Vector3,s=new THREE$1.Ray;return function(e,t,i){a.copy(this.bounds.anchor),r.copy(this.viewBasis.y).multiplyScalar((this.bounds.top+this.bounds.bottom)/2),a.add(r),r.copy(this.viewBasis.x).multiplyScalar((this.bounds.left+this.bounds.right)/2),a.add(r);var n=Math.max((this.bounds.top-this.bounds.bottom)/this.verticalTanFov,(this.bounds.right-this.bounds.left)/this.horizontalTanFov);return r.copy(this.viewBasis.z).multiplyScalar(n*this.fitRatio),e.copy(a).add(r),t.copy(a),void 0!==i&&(s.origin.copy(e),s.direction.copy(this.viewBasis.z).negate(),null===s.intersectPlane(i,t)&&(s.direction.negate(),null===s.intersectPlane(i,t)&&console.warn("THREE.CameraViewBox: unable to put target on given floor plane"))),this}}()});var CameraViewBox=THREE$1.CameraViewBox,v2=new three.Vector2,v0=new three.Vector2,visibleBox=new VisibleBox3,CameraManagerBase=function(e){function n(e,t){classCallCheck(this,n);var i=possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return i.awm=e,i.options=t,i.camera=new three.PerspectiveCamera(45,1,.1,5e4),i.control=null,i.floorPlane=new three.Plane,i.floorPlane.normal.set(0,0,-1),i.ray=new three.Ray,i.cameraCalibrations=new Map,i._tween=null,i.cameraViewBox=new CameraViewBox,i}return inherits(n,e),createClass(n,[{key:"start",value:function(){this.control.enabled=!0}},{key:"stop",value:function(){this.control.enabled=!1}},{key:"init",value:function(e){var r=this;this.projector=e,this.awm.sceneManager.addEventListener(SceneEvents.floor.didChanged,function(e){var t=e.current,i=r._getFloorCalibration(t);r.floorPlane.constant=i.target.z;var n=r.control.target.clone().sub(r.camera.position).normalize();r._putTargetOnFloorPlan(r.control.target,n),r.camera.updateMatrix(),r.control.update(),r.awm.engineManager.requestUpdate()})}},{key:"_getFloorCalibration",value:function(e){var t=null;if(this.cameraCalibrations.has(e))t=this.cameraCalibrations.get(e);else{console.warn("AdsumWebMap.CameraManager: Missing calibration for centerOnFloor");var i=null===e?this.awm.objectManager.site:e;i.getBoundingBox(visibleBox);var n=new three.Sphere;visibleBox.getBoundingSphere(n);var r=new three.Vector3;i.getWorldPosition(r),n.center.z=r.z,(t=new CameraCalibration).target.copy(n.center),t.eye.copy(n.center);var a=1.5*n.radius*Math.sin(Math.PI/4);t.eye.setZ(t.eye.z+a),t.eye.setY(t.eye.y-a),this.cameraCalibrations.set(e,t)}return t}},{key:"centerOnFloor",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];this.reset();try{var i=this._getFloorCalibration(e),n=this.getState(i.target,i.eye);return this._goTo(n.target,n.distance,n.azimuth,n.altitude,t)}catch(e){return Promise.reject(e)}}},{key:"centerOnObjects",value:function(e){var t=this,i=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;this.reset();try{var r=null;r=null===n?this.options.centerOnOptions:new CameraCenterOnOptions(n);var a=this.getState(),s=r.getAzimuth(a.azimuth),o=r.getAltitude(a.altitude),l=a.distance,c=this.getCameraBasis(s,o),h=c.x,u=c.y,p=c.z;this.cameraViewBox.setViewFromBasis(h,u,p,this.camera.fov,this.camera.aspect),this.cameraViewBox.makeEmpty(),e.forEach(function(e){return t.cameraViewBox.expandByObject(e._mesh)});var d=new three.Vector3;if(r.zoom){var f=new three.Vector3;this.cameraViewBox.setFitRatio(r.fitRatio),this.cameraViewBox.getCameraPositionAndTarget(f,d,this.floorPlane),l=f.sub(d).length(),l=three.Math.clamp(l,this.control.minDistance,this.control.maxDistance)}else this.cameraViewBox.getTarget(d,this.floorPlane);return this._goTo(d,l,s,o,i,r.time)}catch(e){return Promise.reject(e)}}},{key:"centerOn",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;return this.centerOnObjects([e],t,i)}},{key:"_putTargetOnFloorPlan",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.floorPlane;this.ray.direction.copy(t),this.ray.origin.copy(e),null===this.ray.intersectPlane(i,e)&&(this.ray.direction.negate(),this.ray.intersectPlane(i,e))}},{key:"setCameraCalibrations",value:function(e){var o=this;this.cameraCalibrations=new Map,e.forEach(function(e,t){var i=o.awm.objectManager,n=null===t?i.site:i.getFloor(t);if(null!==n){var r=new three.Vector3;if(n.getWorldPosition(r),e.target.z!==r.z){console.warn("AdsumWebMap: invalid calibration target of "+n.id+", it's not on the floor");var a=new three.Plane;a.normal.set(0,0,-1),a.constant=r.z;var s=new three.Vector3;s.copy(e.target).sub(e.eye),s.normalize(),o._putTargetOnFloorPlan(e.target,s,a)}o.cameraCalibrations.set(null===t?null:n,e)}})}},{key:"move",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:700,n=this.getState(),r=Number.isFinite(e.azimuth)?three.Math.degToRad(e.azimuth):n.azimuth,a=Number.isFinite(e.altitude)?three.Math.degToRad(e.altitude):n.altitude,s=Number.isFinite(e.distance)?this.projector.meterToAdsumDistance(e.distance):n.distance;return this._goTo(n.target,s,r,a,t,i)}},{key:"_goTo",value:function(o,e,l,c){var h=this,u=!(4<arguments.length&&void 0!==arguments[4])||arguments[4],p=5<arguments.length&&void 0!==arguments[5]?arguments[5]:700,d=this.getState();if(d.distance===e&&d.azimuth===l&&d.altitude===c&&d.target.equals(o))return Promise.resolve(!0);var f=Math.max(e,1.1*this.camera.near,this.control.minDistance);return f=Math.min(f,this.control.maxDistance,.9*this.camera.far),new Promise(function(e,t){try{if(h.reset(),u){var i=o.clone();h.control.enabled=!1,c=h._clampAltitude(c);var n=f-d.distance,r=c-d.altitude,a=l-d.azimuth;a>Math.PI?a-=2*Math.PI:a<-Math.PI&&(a+=2*Math.PI);var s={deltaDistance:0,deltaAltitude:0,deltaAzimuth:0,x:h.control.target.x,y:h.control.target.y,z:h.control.target.z};h._tween=new es6Tween.Tween(s).to({deltaDistance:n,deltaAltitude:r,deltaAzimuth:a,x:o.x,y:o.y,z:o.z},p).on("update",function(){h.updateState(i.set(s.x,s.y,s.z),d.distance+s.deltaDistance,d.azimuth+s.deltaAzimuth,d.altitude+s.deltaAltitude)}).on("stop",function(){h.updateState(o,f,l,c),h.control.enabled=!0,e(!1)}).on("complete",function(){h.updateState(o,f,l,c),h.control.enabled=!0,e(!0)}).easing(es6Tween.Easing.Quadratic.InOut).start(),h.awm.engineManager.requestUpdate()}else h.updateState(o,f,l,c),e(!0)}catch(e){t(e)}})}},{key:"reset",value:function(){return null!==this._tween&&(this._tween.stop(),this._tween=null),this}},{key:"getState",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.control.target,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.camera.position,i=e.clone().sub(t),n=i.length(),r=this.projector.getAdsumNorthAngle();v2.set(i.x,i.y);var a=r-v2.angle();return a<0&&(a+=2*Math.PI),{target:e,distance:n,altitude:Math.asin(-i.z/n),azimuth:a}}},{key:"updateState",value:function(e,t,i,n){this.control.target.copy(e),n=this._clampAltitude(n);var r=(t=three.Math.clamp(t,this.control.minDistance,this.control.maxDistance))*Math.sin(n),a=this.projector.getAdsumNorthAngle()-i;v2.set(Math.cos(a),Math.sin(a)),v2.multiplyScalar(t*Math.cos(n)),this.camera.position.set(e.x-v2.x,e.y-v2.y,e.z+r),this.camera.updateMatrix(),this.control.update(),this.awm.engineManager.requestUpdate()}},{key:"getCameraBasis",value:function(e,t){t=this._clampAltitude(t),this.projector.getAdsumNorthDirection(v2),v0.set(0,0),v2.rotateAround(v0,-e),v2.multiplyScalar(Math.abs(Math.cos(t)));var i=new three.Vector3(+v2.x,+v2.y,-Math.sin(t));i.normalize().negate();var n=new three.Vector3(v2.x,v2.y,0);n.normalize();var r=new three.Vector3;return r.crossVectors(n,i),r.normalize(),n.crossVectors(i,r),n.normalize(),{x:r,y:n,z:i}}},{key:"_clampAltitude",value:function(e){return three.Math.clamp(e,Math.PI/2-this.control.maxPolarAngle,Math.PI/2-this.control.minPolarAngle)}}]),n}(three.EventDispatcher),CameraManager=function(e){function i(){return classCallCheck(this,i),possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments))}return inherits(i,CameraManagerBase),createClass(i,[{key:"init",value:function(e){var t=this;get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"init",this).call(this,e),this.camera.aspect=1,this.camera.near=e.meterToAdsumDistance(1),this.camera.far=e.meterToAdsumDistance(1e4),this.camera.up.set(0,0,1),this.camera.updateProjectionMatrix(),this.control=new MapControls(this.camera,document),this.control.enabled=!1,this.control.enableZoom=!0,this.control.enableRotate=!0,this.control.enableDamping=!1,this.control.enableKeys=!1,this.control.minPolarAngle=.001,this.control.maxPolarAngle=5*Math.PI/12,this.control.minDistance=e.meterToAdsumDistance(5),this.control.addEventListener("change",function(){t.camera.updateMatrix(),t.awm.engineManager.requestUpdate()})}}]),i}(),MOUSE_EVENTS={click:"click",dblClick:"dblClick"},MouseManagerBase=function(e){function i(e){classCallCheck(this,i);var t=possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.awm=e,t._mouse=new three.Vector2,t._raycaster=new three.Raycaster,t.enabled=!1,t}return inherits(i,e),createClass(i,[{key:"init",value:function(){}},{key:"start",value:function(){this.enabled=!0}},{key:"stop",value:function(){this.enabled=!1}},{key:"_onMouseClick",value:function(e){this.enabled&&(this._setMouseCoordinate(e),this.dispatchEvent({type:MOUSE_EVENTS.click,intersects:this._raycast()}))}},{key:"_onMouseDblClick",value:function(e){this.enabled&&(this._setMouseCoordinate(e),this.dispatchEvent({type:MOUSE_EVENTS.dblClick,intersects:this._raycast()}))}},{key:"_onMouseMove",value:function(){}},{key:"_setMouseCoordinate",value:function(e){var t=0,i=0;if(void 0===e.clientX&&void 0===e.clientY){var n=e.target.getBoundingClientRect();t=e.center.x-n.left,i=e.center.y-n.top}else e.offsetX||0===e.offsetX?(t=e.offsetX,i=e.offsetY):(t=e.layerX,i=e.layerY);this._mouse.set(t/this.awm.engineManager.canvas.clientWidth*2-1,-i/this.awm.engineManager.canvas.clientHeight*2+1),this._raycaster.setFromCamera(this._mouse,this.awm.cameraManager.camera),this._raycaster.near=this.awm.cameraManager.camera.near,this._raycaster.far=this.awm.cameraManager.camera.far}},{key:"_raycast",value:function(){var e=[];return this.awm.objectManager.site._raycast(this._raycaster,e),e.sort(function(e,t){return e.distance-t.distance}),e}}]),i}(three.EventDispatcher),MouseManager=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,MouseManagerBase),createClass(t,[{key:"init",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"init",this).call(this),console.warn("AdsumWebMap.MouseManager: disabled in NodeJS")}}]),t}(),AdsumObjectTypes={AdsumObject3D:"AdsumObject3D",BuildingObject:"BuildingObject",FloorObject:"FloorObject",LabelImageObject:"LabelImageObject",LabelObject:"LabelObject",LabelTextObject:"LabelTextObject",SiteObject:"SiteObject",SpaceObject:"SpaceObject",PathSectionObject:"PathSectionObject",UserObject:"UserObject",DotUserObject:"DotUserObject",OrientedDotUserObject:"OrientedDotUserObject"};function getAdsumObjectGroundAndPosition(e){var t=null,i=null;switch(e.getType()){case AdsumObjectTypes.SiteObject:case AdsumObjectTypes.FloorObject:t=e;break;case AdsumObjectTypes.BuildingObject:t=e.site,(i=e.getPosition(new three.Vector3)).setZ(0);break;case AdsumObjectTypes.SpaceObject:case AdsumObjectTypes.UserObject:t=e.parent,(i=e.getPosition(new three.Vector3)).setZ(0);break;case AdsumObjectTypes.LabelObject:case AdsumObjectTypes.LabelTextObject:case AdsumObjectTypes.LabelImageObject:(i=e.getPosition(new three.Vector3)).setZ(0);var n=e.parent;n.isSpace?(t=n.parent,i.applyMatrix4(n.matrix)):n.isBuilding?(t=n.site,i.applyMatrix4(n.matrix)):t=n;break;default:throw new Error("Unexpected")}return{ground:t,groundPosition:i}}function getUtmPosition(e,t,i){var n=e.localToWorld(t.clone());return n.setZ(e.isSite?0:e.altitude),i.adsumToUtm(n)}var PathNode=function(){function l(e,t,i,n,r){var a=r.isGate,s=r.isCheckpoint,o=r.isFloorAccess;classCallCheck(this,l),this.id=e||Symbol("PathNodeId"),this.ground=t,this.links=new Set,this.utmPosition=n,this.groundPosition=i,this.isDynamic=!1,this.version=0,this.isGate=Boolean(a),this.isCheckpoint=Boolean(s),this.isFloorAccess=Boolean(o)}return createClass(l,null,[{key:"create",value:function(e,t,i,n,r){return new this(e,t,i,getUtmPosition(t,i,n),r)}},{key:"updateFromAdsumObject",value:function(e,t,i){var n=getAdsumObjectGroundAndPosition(t,i),r=n.ground,a=n.groundPosition;e.ground=r,e.groundPosition=a,e.utmPosition=getUtmPosition(r,a,i),e.version++}},{key:"createFromAdsumObject",value:function(e,t){var i=getAdsumObjectGroundAndPosition(e,t),n=i.ground,r=i.groundPosition;return this.create(e.placeId,n,r,t,{isGate:!1,isCheckpoint:!1,isFloorAccess:!1})}}]),createClass(l,[{key:"getLinkTo",value:function(t){var i=null;return this.links.forEach(function(e){e.to!==t&&e.from!==t||(i=e)}),i}}]),l}(),PATH_LINK_TYPES={STANDARD:0,ONLY_DISABLED:1,NOT_DISABLED:2,CLOSED:3},PathLink=function(){function a(e,t,i,n){var r=!(4<arguments.length&&void 0!==arguments[4])||arguments[4];classCallCheck(this,a),this.id=e,this.type=t,this.from=i,this.to=n,this.bidirectional=r,this.distance=Math.sqrt(Math.pow(i.utmPosition.N-n.utmPosition.N,2)+Math.pow(i.utmPosition.E-n.utmPosition.E,2)+Math.pow(i.utmPosition.alt-n.utmPosition.alt,2))}return createClass(a,[{key:"isAccessible",value:function(e){return this.type===PATH_LINK_TYPES.STANDARD||(e?this.type===PATH_LINK_TYPES.ONLY_DISABLED:this.type===PATH_LINK_TYPES.NOT_DISABLED)}}]),a}(),AStar=function(){function t(e){classCallCheck(this,t),this.pathNetwork=e,this._cache=new Map,this._dynamicCache=new Map,this._computing=new Map,this._symbolStrings=new Map,this._symbolIncrement=0}return createClass(t,[{key:"search",value:function(i,m){var g=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(this._isCached(i,m,g))return this._getFromCache(i,m,g);if(this._isComputing(i,m,g))return this._getFromComputing(i,m,g);var e=Promise.resolve().then(function(){var p=new Map,d=new Set,f=new Map;f.set(i.id,{d:0,parent:null}),f.set(m.id,{d:1/0,parent:null}),p.set(i.id,i);for(var e=function(){for(var e=Array.from(p.values()),t=e[0],i=1;i<e.length;i++){var n=e[i];f.get(n.id).d<f.get(t.id).d&&(t=n)}if(t===m){for(var r=[t],a=f.get(t.id).parent;null!==a;){r.push(a),a=f.get(a.id).parent}return{v:r.reverse()}}p.delete(t.id),d.add(t.id);var s=[],o=[];t.links.forEach(function(e){e.isAccessible(g)&&(e.from===t?(s.push(e.to),o.push(e.distance)):e.to===t&&e.bidirectional&&(s.push(e.from),o.push(e.distance)))});for(var l=0;l<s.length;l++){var c=s[l];if(!d.has(c.id)){p.has(c.id)||(f.set(c.id,{d:1/0,parent:null}),p.set(c.id,c));var h=f.get(t.id).d+o[l],u=f.get(c.id);h<u.d&&(u.parent=t,u.d=h)}}};0<p.size;){var t=e();if("object"===(void 0===t?"undefined":_typeof(t)))return t.v}return[]});return this._addToComputing(i,m,g,e),e}},{key:"_addToCache",value:function(e,t,i,n){var r=this._getCacheKey(e,t,i);e.isDynamic&&(this._dynamicCache.has(e.id)?this._dynamicCache.get(e.id).cacheEntries.add(r):this._dynamicCache.set(e.id,{version:e.version,cacheEntries:new Set([r])})),t.isDynamic&&(this._dynamicCache.has(t.id)?this._dynamicCache.get(t.id).cacheEntries.add(r):this._dynamicCache.set(t.id,{version:t.version,cacheEntries:new Set([r])})),this._cache.set(r,n.map(function(e){return e.id}))}},{key:"_getFromCache",value:function(e,t,i){var n=this,r=this._getCacheKey(e,t,i);return Promise.resolve(this._cache.get(r).map(function(e){return n.pathNetwork.nodes.get(e)}))}},{key:"_getCacheKey",value:function(e,t,i){return this._stringifyId(e.id)+":"+this._stringifyId(t.id)+(i?":pmr":"")}},{key:"_stringifyId",value:function(e){return"symbol"!==(void 0===e?"undefined":_typeof(e))?""+e:(this._symbolStrings.has(e)||this._symbolStrings.set(e,"s"+this._symbolIncrement++),this._symbolStrings.get(e))}},{key:"_isCached",value:function(e,t,i){var n=this,r=!1;if(e.isDynamic)if(this._dynamicCache.has(e.id)){var a=this._dynamicCache.get(e.id);a.version!==e.version&&(a.cacheEntries.forEach(function(e){n._cache.delete(e)}),a.cacheEntries.clear(),r=!0)}else r=!0;if(t.isDynamic)if(this._dynamicCache.has(t.id)){var s=this._dynamicCache.get(t.id);s.version!==t.version&&(s.cacheEntries.forEach(function(e){n._cache.delete(e)}),s.cacheEntries.clear(),r=!0)}else r=!0;return!r&&this._cache.has(this._getCacheKey(e,t,i))}},{key:"_addToComputing",value:function(t,i,n,e){var r=this,a=this._getCacheKey(t,i,n);this._computing.set(a,e),e.then(function(e){r._addToCache(t,i,n,e),r._computing.delete(a)})}},{key:"_getFromComputing",value:function(e,t,i){var n=this,r=this._getCacheKey(e,t,i);return this._computing.get(r).then(function(){return n.search(e,t,i)})}},{key:"_isComputing",value:function(e,t,i){return this._computing.has(this._getCacheKey(e,t,i))}}]),t}(),PathSection=function(){function a(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[],r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:[];classCallCheck(this,a),this.from=e,this.to=i,this.ground=t,this.grounds=n,this.nodes=r,this._distance=null,this._curve=null}return createClass(a,[{key:"isInterGround",value:function(){return 1<this.grounds.length}},{key:"getLastGround",value:function(){return this.grounds[this.grounds.length-1]}},{key:"getDistance",value:function(){return null===this._distance&&this._initCurveAndDistance(),this._distance}},{key:"getCurve",value:function(){return this.nodes.length<2?null:(null===this._curve&&this._initCurveAndDistance(),this._curve)}},{key:"_initCurveAndDistance",value:function(){this._curve=[],this._distance=0;for(var e=null!==this.to?this.to.adsumObject:null,t=null!==e&&(e.isSpace||e.isBuilding),i=0;i<this.nodes.length-1;i++){var n=this.nodes[i].getLinkTo(this.nodes[i+1]),r=n.distance,a=this.nodes[i],s=this.nodes[i+1];t&&this.to.pathNode===s&&(r=0),this._distance+=r,this._curve.push({from:a,to:s,fromGround:a.ground,fromGroundPosition:a.isDynamic?a.groundPosition.clone():a.groundPosition,toGround:s.ground,toGroundPosition:s.isDynamic?s.groundPosition.clone():s.groundPosition,distance:n.distance,cumulativeDistance:this._distance})}}},{key:"getRealInterval",value:function(e){var t=e;e>this.getDistance()/3&&(console.warn("AdsumWebMap.PathSection.interpolate: short pathSection"),t=this.getDistance()/3);var i=Math.floor(this.getDistance()/t);return this.getDistance()/i}},{key:"interpolate",value:function(e){if(null===this.getCurve())return[];for(var t=this.getRealInterval(e),i=Math.round(this.getDistance()/t),n=[],r=0;r<=i;r++)n.push(this.at(t*r));return n}},{key:"at",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new three.Vector3,i=this.getCurve();if(null===i)return null;for(var n=e,r=0;r<i.length;r++){var a=i[r],s=a.from,o=a.to,l=a.distance;if(!(l<n)){var c=n/l;return t.lerpVectors(this.getLocalNodePosition(s),this.getLocalNodePosition(o),c),t}n-=l}var h=i[i.length-1].to;return this.getLocalNodePosition(h)}},{key:"getLocalNodePosition",value:function(e){if(e.ground===this.ground)return e.groundPosition.clone();var t=e.groundPosition.clone();return e.ground.localToWorld(t),this.ground.worldToLocal(t),t}},{key:"getAzimuthOrientation",value:function(){if(this.nodes.length<2)return null;var e=this.nodes[0],t=this.nodes[this.nodes.length-1],i=t.utmPosition.E-e.utmPosition.E,n=t.utmPosition.N-e.utmPosition.N,r=Math.atan2(n,i),a=Math.PI/2-r;return a<0&&(a+=2*Math.PI),three.Math.radToDeg(a)}}]),a}(),PathNetwork=function(){function t(e){classCallCheck(this,t),this.awm=e,this.nodes=new Map,this.spaceGatesByAdsumObjectId=new Map,this.buildingGatesByAdsumObjectId=new Map,this.aStar=new AStar(this),this.dynamicNodeAttachCache=new Map}return createClass(t,[{key:"init",value:function(e){var s=this;e.get("nodes").forEach(function(e){var t=s._findParentAndGround(e.location),i=t.parent,n=t.ground;if(null!==i){var r=new three.Vector3(e.position.x,e.position.y,e.position.z),a=PathNode.create(e.id,n,r,s.awm.projector,e);s.nodes.set(a.id,a),a.isGate&&("STORE"===e.location.type||"SHAPE"===e.location.type?(s.spaceGatesByAdsumObjectId.has(e.location.id)||s.spaceGatesByAdsumObjectId.set(e.location.id,[]),s.spaceGatesByAdsumObjectId.get(e.location.id).push(a)):"BUILDING"===e.location.type?(s.buildingGatesByAdsumObjectId.has(e.location.id)||s.buildingGatesByAdsumObjectId.set(e.location.id,[]),s.buildingGatesByAdsumObjectId.get(e.location.id).push(a)):console.warn("AdsumWebMap.PathNetwork: Invalid node gate on "+e.type+"#"+e.id))}else console.warn("AdsumWebMap.PathNetwork: invalid node")}),e.get("links").forEach(function(e){var t=s.nodes.get(e.from),i=s.nodes.get(e.to);if(void 0!==t&&void 0!==i){var n=new PathLink(e.id,e.type,t,i,e.bidirectional);t.links.add(n),n.bidirectional&&i.links.add(n)}else console.warn("AdsumWebMap.PathNetwork: invalid link")})}},{key:"computePath",value:function(t){var i=this,e=t.from,n=t.to;return!e.pathNode.isDynamic&&this.nodes.has(e.pathNode.id)||this.attachNodeLocation(e),!n.pathNode.isDynamic&&this.nodes.has(n.pathNode.id)||this.attachNodeLocation(n),this.aStar.search(e.pathNode,n.pathNode,t.pmr).then(function(e){i._buildPathSections(t,e)})}},{key:"attachNodeLocation",value:function(i){var e=i.pathNode,o=e.ground,t=e.groundPosition,n=e.version;if(!this.nodes.has(i.pathNode.id)||this.dynamicNodeAttachCache.get(i.pathNode.id)!==n){var l=null;if(i.adsumObject&&i.adsumObject.isSpace)l=this.spaceGatesByAdsumObjectId.get(i.adsumObject.id)||[];else if(i.adsumObject&&i.adsumObject.isBuilding)l=this.buildingGatesByAdsumObjectId.get(i.adsumObject.id)||[];else{l=[];var c=1/0,r=[];if(this.nodes.forEach(function(e){if(e!==i.pathNode&&e.ground===o){var t=e.groundPosition.distanceToSquared(i.pathNode.groundPosition);t<=9*c&&r.push({squareDistance:t,node:e}),t<c&&(c=t)}}),c!==1/0){r.sort(function(e,t){return e.squareDistance-t.squareDistance});var h=new three.Raycaster(o.localToWorld(t.clone())),u=[],p=[];r.forEach(function(e){var t=e.squareDistance,i=e.node;if(!(9*c<t)){h.ray.direction=o.localToWorld(i.groundPosition.clone()),h.ray.direction.sub(h.ray.origin),h.near=0,h.far=h.ray.direction.length(),h.ray.direction.normalize();for(var n=0;n<p.length;n++)if(p[n].angleTo(h.ray.direction)<Math.PI/4)return;for(var r=u.length=0;r<o._mesh.children.length;r++){var a=o._mesh.children[r],s=a.adsumObject;if(!(s&&(s.isLabel||s.isUser))&&(h.intersectObject(a,!1,u),0!==u.length))return}l.push(i),p.push(h.ray.direction)}})}}i.pathNode.links.forEach(function(e){e.from.links.delete(e),e.to.links.delete(e),i.pathNode.links.delete(e)}),l.forEach(function(e){var t=new PathLink(Symbol("PathLinkId"),PATH_LINK_TYPES.STANDARD,i.pathNode,e);i.pathNode.links.add(t),e.links.add(t)}),this.nodes.set(i.pathNode.id,i.pathNode),this.dynamicNodeAttachCache.set(i.pathNode.id,n)}}},{key:"_findParentAndGround",value:function(e){var t=null,i=null;switch(e.type){case"STORE":case"SHAPE":null!==(t=this.awm.objectManager.getSpace(e.id))&&(i=t.parent);break;case"FLOOR":null!==(t=this.awm.objectManager.getFloor(e.id))&&(i=t);break;case"BUILDING":i=(t=this.awm.objectManager.getBuilding(e.id)).site;break;case"SITE":i=t=this.awm.objectManager.site;break;default:console.warn("AdsumWebMap.WayfindingManager.PathNetwork: unknown location.type "+e.type+" ")}return null===t&&console.warn("AdsumWebMap.WayfindingManager.PathNetwork: invalid location "+e.type+"#"+e.id),{parent:t,ground:i}}},{key:"_buildPathSections",value:function(e,t){if(t.length<2)throw new Error("AdsumWebMap.PathNetwork: No path found to destination");for(var i=[],n=this.constructor._detectPathBreakpoints(t),r=0,a=0;a<n.length;a++){var s=n[a];i.push(this._getPathSection(r,s,t)),r=s}i.push(this._getPathSection(r,t.length-1,t)),e.setPathSections(i)}},{key:"_getPathSection",value:function(e,t,i){for(var n=i[e],r=i[t],a=this.getPathNodeLocation(n),s=this.getPathNodeLocation(r),o=[],l=[],c=e;c<=t;c++)0!==o.length&&o[o.length-1]===i[c].ground||o.push(i[c].ground),l.push(i[c]);return new PathSection(a,o[0],s,o,l)}},{key:"getPathNodeLocation",value:function(e){var t=this.awm.wayfindingManager.locationRepository;return t.locationsByPathNodeId.has(e.id)?t.locationsByPathNodeId.get(e.id):null}}],[{key:"_detectPathBreakpoints",value:function(e){if(e.length<2)throw new Error("AdsumWebMap.PathNetwork: No path found to destination");for(var t=[],i=1;i<e.length-1;i++){var n=e[i-1],r=e[i],a=e[i+1],s=n.ground!==r.ground,o=r.ground!==a.ground;r.isCheckpoint?t.push(i):(s||o)&&s!==o&&t.push(i)}return t}}]),t}(),AdsumLocation=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;classCallCheck(this,n),this.isLocation=!0,this.id=e,this.pathNode=t,this.adsumObject=i}return createClass(n,[{key:"updateFromObjectPosition",value:function(e){PathNode.updateFromAdsumObject(this.pathNode,this.adsumObject,e)}}]),n}(),LocationRepository=function(){function e(){classCallCheck(this,e),this.locations=new Map,this.locationsByAdsumObject=new Map,this.locationsByPathNodeId=new Map,this.projector=null,this.objectManager=null,this.userLocation=null}return createClass(e,[{key:"init",value:function(e,r,a,t){var s=this;this.projector=e,this.objectManager=a,t.forEach(function(e){if(null!==e.path_node_id&&r.nodes.has(e.path_node_id)){var t=r.nodes.get(e.path_node_id),i=null;0<e.custom_objects.size&&(i=a.getLabel(e.custom_objects.at(0).value));var n=new AdsumLocation(e.id,t,i);s.locations.set(n.id,n),s.locationsByPathNodeId.set(n.pathNode.id,n),null!==i&&s.locationsByAdsumObject.set(i,n)}}),a.labels.forEach(function(e){if(!(e.parent.isBuilding||e.parent.isSpace||s.locations.has(e.placeId))){var t=new AdsumLocation(e.placeId,PathNode.createFromAdsumObject(e,s.projector),e);s.locations.set(t.id,t),s.locationsByAdsumObject.set(e,t),s.locationsByPathNodeId.set(t.pathNode.id,t)}}),a.spaces.forEach(function(e){var t=new AdsumLocation(e.placeId,PathNode.createFromAdsumObject(e,s.projector),e);s.locations.set(t.id,t),s.locationsByAdsumObject.set(e,t),s.locationsByPathNodeId.set(t.pathNode.id,t)}),a.buildings.forEach(function(e){var t=new AdsumLocation(e.placeId,PathNode.createFromAdsumObject(e,s.projector),e);s.locations.set(t.id,t),s.locationsByAdsumObject.set(e,t),s.locationsByPathNodeId.set(t.pathNode.id,t)})}},{key:"createUserLocation",value:function(){if(null!==this.userLocation)throw new Error("Unexpected");var e=Symbol("UserLocation");this.userLocation=new AdsumLocation(e,PathNode.createFromAdsumObject(this.objectManager.user,this.projector),this.objectManager.user),this.userLocation.pathNode.isDynamic=!0,this.locations.set(e,this.userLocation),this.locationsByPathNodeId.set(this.userLocation.pathNode.id,this.userLocation)}},{key:"get",value:function(e){return this.locations.has(e)?this.locations.get(e):null}},{key:"getByAdsumObject",value:function(e){return this.locationsByAdsumObject.has(e)?this.locationsByAdsumObject.get(e):null}}]),e}(),WayfindingEvents={user:{position:{didChanged:"wayfinding.user.position.didChanged"}}},WayfindingManager=function(e){function n(e,t){classCallCheck(this,n);var i=possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return i.awm=e,i.projector=null,i.locationRepository=new LocationRepository,i.pathNetwork=new PathNetwork(e),i.options=t,i.userPositionUpdate=null,i}return inherits(n,e),createClass(n,[{key:"init",value:function(e){return this.projector=e.projector,this.awm.objectManager.user=this.options.userObject,this.awm.objectManager.user.setScale(this.projector.scale),this.setUserAzimuthHeading(0),this.pathNetwork.init(e.paths),this.options.pathSectionDrawer.init(this.awm),this.locationRepository.init(this.projector,this.pathNetwork,this.awm.objectManager,e.places),this.options.pathBuilder.init(this.projector,this.awm.objectManager)}},{key:"computePath",value:function(e){return this.removePath(e),null===e.from&&(e.from=this.locationRepository.userLocation,null===e.from)?Promise.reject(new Error("AdsumWebMap.WayfindingManager: cannot compute path because user position is not set")):null===e.to&&(e.to=this.locationRepository.userLocation,null===e.to)?Promise.reject(new Error("AdsumWebMap.WayfindingManager: cannot compute path because user position is not set")):this.pathNetwork.computePath(e)}},{key:"removePath",value:function(e){var t=this;e.getPathSections(!0).forEach(function(e){t.removePathSection(e)})}},{key:"drawPathSection",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;this.removePathSection(e);var i=this.options.pathBuilder.build(e);return this.options.pathSectionDrawer.draw(i,t)}},{key:"removePathSection",value:function(t){this.awm.objectManager.pathSectionObjects.forEach(function(e){e.pathSection===t&&e._dispose()})}},{key:"getUserUtmPosition",value:function(){var e=this.locationRepository.userLocation;return null===e?null:{utm:e.pathNode.utmPosition,floor:e.adsumObject.parent.isFloor?e.adsumObject.parent:null}}},{key:"getUserGpsPosition",value:function(){if(null===this.locationRepository.userLocation)return null;var e=this.getUserUtmPosition(),t=e.utm,i=e.floor;return{gps:this.projector.utmToGps(t),floor:i}}},{key:"setUserAdsumPosition",value:function(e){var t=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],r=null===i?this.awm.objectManager.site:i,a=this.awm.objectManager.user;null!==this.userPositionUpdate&&this.userPositionUpdate.stop();var s=new three.Vector3;if(s.copy(e),n&&r.worldToLocal(s),s.setZ(this.projector.meterToAdsumDistance(.05)),this.options.userPositionUpdateOptions.animated&&a.parent===r){var o=a.getPosition(new three.Vector3);this.userPositionUpdate=new es6Tween.Tween(o).to(s,this.options.userPositionUpdateOptions.duration).on("update",function(){t._doAdsumUserPositionUpdate(o,r)}).on("complete",function(){t._doAdsumUserPositionUpdate(s,r),t.userPositionUpdate=null,t.dispatchEvent({type:WayfindingEvents.user.position.didChanged,floor:r.isSite?null:r})}),this.userPositionUpdate.start()}else this._doAdsumUserPositionUpdate(s,r),this.dispatchEvent({type:WayfindingEvents.user.position.didChanged,floor:r.isSite?null:r});return this}},{key:"_doAdsumUserPositionUpdate",value:function(e,t){this.awm.objectManager.user.setPosition(e,t),null===this.locationRepository.userLocation?this.locationRepository.createUserLocation():this.locationRepository.userLocation.updateFromObjectPosition(this.projector)}},{key:"setUserGpsPosition",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return this.setUserAdsumPosition(this.projector.gpsToAdsum(e),t,!0)}},{key:"setUserUtmPosition",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return this.setUserAdsumPosition(this.projector.utmToAdsum(e),t,!0)}},{key:"setUserAzimuthHeading",value:function(e){return this.awm.objectManager.user.setRotation(this.projector.getAdsumNorthAngle()-three.Math.degToRad(e)),this}},{key:"getUserDistanceFromPath",value:function(e){var t=this;return Math.min.apply(Math,[1/0].concat(toConsumableArray(e.getPathSections(!0).map(function(e){return t.getUserDistanceFromPathSection(e)}))))}},{key:"getUserDistanceFromPathSection",value:function(e){return this.getUserPathSectionProgress(e).distanceFromPathSection}},{key:"getUserPathSectionProgress",value:function(e){var t=this.locationRepository.userLocation;if(null===t)throw new Error("AdsumWebMap.WayfindingManager.getUserPathSectionProgress: no user position set");if(e.ground!==t.pathNode.ground)return{distanceFromPathSection:1/0,progress:0};var a=new three.Vector3,s=new three.Line3,i=e.getCurve(),o=t.pathNode.groundPosition,l=1/0,c=null,h=null;null===i?0<e.nodes.length&&(l=o.distanceTo(e.nodes[0].groundPosition)):i.forEach(function(e){var t=e.fromGroundPosition,i=e.toGroundPosition;s.set(t,i);var n=s.closestPointToPointParameter(o,!0);s.at(n,a);var r=o.distanceTo(a);r<l&&(l=r,c=e,h=n)});var n=0;return null!==c&&(n=c.cumulativeDistance-c.distance,n+=h*c.distance,n/=e.getDistance()),{distanceFromPathSection:this.projector.adsumDistanceToMeter(l),progress:n}}}]),n}(three.EventDispatcher),EngineOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.container=null,this.gpuPower="high-performance",this.autoCompileMaterials=!0,this.clearColor=16777215,this.fogEnabled=!1,this.fogRatio=0,this.fogColor=16777215,this.backgroundImage=null,this.shadowEnabled=!1,this.shadowSize=2048}}]),t}(adactiveAbstractOptions.AbstractOptions),CameraCenterOnPathSectionOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){this.azimuth=null,this.fitRatio=1.5,this.oriented=null,this.time=700,this.zoom=!0}}]),t}(adactiveAbstractOptions.AbstractOptions),CameraOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.centerOnOptions=new CameraCenterOnOptions,this.centerOnPathSectionOptions=new CameraCenterOnPathSectionOptions,this.force2D=!1,this.zoomEnabled=!0,this.rotationEnabled=!0,this.keepInFloorBounds=!1}}]),t}(adactiveAbstractOptions.AbstractOptions),cameraWorld=new three.Vector3,objectWorld=new three.Vector3,v=new three.Vector3,LevelOfDetails=function(){function e(){classCallCheck(this,e),this.levels=new Map,this.active=!0}return createClass(e,[{key:"addLevelState",value:function(e,t){return this.levels.set(e,t),this}},{key:"clear",value:function(){return this.levels.clear(),this}},{key:"getLevelStates",value:function(){var i=[];return this.levels.forEach(function(e,t){i.push({startAt:t,levelState:e})}),i.sort(function(e,t){return e.startAt-t.startAt}),i}},{key:"removeLevelState",value:function(e){return this.levels.delete(e),this}},{key:"applyLod",value:function(e,t,i){if(!this.active||0===this.levels.size)return!1;t.getWorldPosition(cameraWorld),e.getWorldPosition(objectWorld),v.subVectors(cameraWorld,objectWorld);var n=i.adsumDistanceToMeter(v.length()),r=null,a=null;return this.levels.forEach(function(e,t){n<t||null!==a&&t<a||(r=e,a=t)}),null===a?(console.warn("AdsumWebMap.LevelOfDetails: cannot find LevelState matching, make sure you have a default one which startAt 0"),!1):(r.apply(e),!0)}}]),e}(),AdsumObject3DOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){this.isAdsumObject3DOptions=!0,this.id=Symbol("AdsumObjectId"),this.levelOfDetails=new LevelOfDetails,this.name=null,this.placeId=Symbol("AdsumMapPlaceId")}}],[{key:"convert",value:function(e){return e.isAdsumObject3DOptions?e:new this(e)}}]),t}(adactiveAbstractOptions.AbstractOptions);function forEachMaterial(e,t){if(e.material)if(e.material.isMaterial)t(e.material,null);else for(var i=e.material.length,n=0;n<i;n++)t(e.material[n],n)}function replaceMaterial(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;e.material?e.material.isMaterial||null===i?(forEachMaterial(e,function(e){e.dispose()}),e.material=t):(e.material[i].dispose(),e.material[i]=t):e.material=t}var changeEvent={type:"change"},AdsumObject3D=function(){function i(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,i);var t=AdsumObject3DOptions.convert(e);this.id=t.id,this.isAdsumObject=!0,this._mesh=null,this.levelOfDetails=t.levelOfDetails,this.name=t.name,this.placeId=t.placeId,this.fading=1,this._initialOpacities=null}return createClass(i,[{key:"getType",value:function(){return AdsumObjectTypes.AdsumObject3D}},{key:"_setMesh",value:function(e){return null!==this._mesh&&(this._mesh.adsumObject=null,this._mesh.onBeforeRender=null),this._mesh=e,(this._mesh.adsumObject=this)._mesh.onBeforeRender=this._onBeforeRender.bind(this),this._updateVisibility(),this.triggerChange(),this}},{key:"setDisplayMode",value:function(e){switch(e){case DISPLAY_MODES.NONE:this._mesh.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._mesh.visible=!0,forEachMaterial(this._mesh,function(e){e.visible=!0});break;case DISPLAY_MODES.TRANSPARENT:this._mesh.visible=!0,forEachMaterial(this._mesh,function(e){e.visible=!1});break;default:throw new Error("Unexpected")}this.triggerChange()}},{key:"getDisplayMode",value:function(){if(!this._mesh.visible)return DISPLAY_MODES.NONE;var t=!1;return forEachMaterial(this._mesh,function(e){e.visible&&(t=!0)}),t?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT}},{key:"setFading",value:function(e){return this.fading=e,this._updateVisibility(),this}},{key:"isFaded",value:function(){return 1!==this.fading}},{key:"getFading",value:function(){return this.fading}},{key:"_updateVisibility",value:function(){var n=this;null!==this._mesh&&(null===this._initialOpacities&&(this._initialOpacities=new Map,forEachMaterial(this._mesh,function(e){e.transparent&&(n._initialOpacities.set(e,e.opacity),e.addEventListener("dispose",function(){n._initialOpacities.delete(e)}))})),forEachMaterial(this._mesh,function(e){var t=n.fading,i=1!==n.fading;n._initialOpacities.has(e)&&(t*=n._initialOpacities.get(e),i=!0),e.opacity=t,e.transparent=i})),this.triggerChange()}},{key:"moveTo",value:function(e,t,i){this._mesh.position.x=e,this._mesh.position.y=t,this._mesh.position.z=i,this.updateMatrix()}},{key:"moveBy",value:function(e,t,i){this._mesh.position.x+=e,this._mesh.position.y+=t,this._mesh.position.z+=i,this.updateMatrix()}},{key:"getBbox",value:function(e){return e.setFromObject(this._mesh),e}},{key:"rotateOnAxis",value:function(e,t){return this._mesh.rotateOnAxis(e,t),this.updateMatrix(),this}},{key:"updateMatrix",value:function(){null!==this._mesh&&(this._mesh.updateMatrix(),this._mesh.updateMatrixWorld(),this.triggerChange())}},{key:"_applyLod",value:function(e,t,i){i&&this.levelOfDetails.applyLod(this,e,t)}},{key:"_onBeforeRender",value:function(e,t,i,n,r,a){}},{key:"_raycast",value:function(e,t){var i=this.getDisplayMode();if(i===DISPLAY_MODES.NONE)return!1;if(i===DISPLAY_MODES.VISIBLE){var n=[];if(this._mesh.raycast(e,n),1===n.length){var r=n[0];t.push({object:this,distance:r.distance,position:this._mesh.worldToLocal(r.point)})}}return!0}},{key:"_addChild",value:function(e){this._mesh.add(e._mesh),e.updateMatrix()}},{key:"_dispose",value:function(){var e=function(e){e.geometry&&e.geometry.dispose&&e.geometry.dispose(),forEachMaterial(e,function(i){Object.keys(i).forEach(function(e){var t=i[e];null!==t&&"object"===t&&t.dispose&&t.dispose()}),i.dispose()})};this._mesh.traverse(e),e(this._mesh),null!==this._mesh.parent&&(this.triggerChange(),this._mesh.parent.remove(this._mesh))}},{key:"getBoundingBox",value:function(e){return e.setFromObject(this._mesh),e}},{key:"getWorldPosition",value:function(e){return this._mesh.getWorldPosition(e)}},{key:"localToWorld",value:function(e){return this._mesh.localToWorld(e)}},{key:"worldToLocal",value:function(e){return this._mesh.worldToLocal(e)}},{key:"getPosition",value:function(e){return e.copy(this._mesh.position),e}},{key:"triggerChange",value:function(){for(var e=this._mesh;null!==e.parent;)e=e.parent;e.dispatchEvent(changeEvent)}}]),i}(),PathSectionObjectOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,AdsumObject3DOptions),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.isPathSectionObjectOptions=!0,this.pathSection=null,this.patternSpace=null}}],[{key:"convert",value:function(e){return e.isPathSectionObjectOptions?e:new this(e)}}]),t}(),PathSectionObject=function(e){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,n);var t=PathSectionObjectOptions.convert(e),i=possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i.isPathSection=!0,i.pathSection=t.pathSection,i.patternSpace=t.patternSpace,i.tweens=[],i}return inherits(n,AdsumObject3D),createClass(n,[{key:"getType",value:function(){return AdsumObjectTypes.PathSectionObject}},{key:"getPatterns",value:function(){return this._mesh.children}},{key:"getPattern",value:function(e){return this._mesh.children[e]}},{key:"_dispose",value:function(){this.tweens.forEach(function(e){e.stop()}),forEachMaterial(this._mesh,function(e){e.dispose()}),null!==this._mesh.parent&&(this.triggerChange(),this._mesh.parent.remove(this._mesh))}}]),n}(),FlatArrowPathPatternOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.backgroundColor=769978,this.arrowBorderColor=0,this.arrowFillColor=16777215}},{key:"getPattern",value:function(){var e=null===this.arrowFillColor?null:new three.Color(this.arrowFillColor),t=new three.MeshBasicMaterial({color:e,side:three.FrontSide}),i=new three.PlaneBufferGeometry(1,1);return i.center(),Promise.resolve(new three.Mesh(i,t))}},{key:"isPathPatternOptions",get:function(){return!0}}]),t}(adactiveAbstractOptions.AbstractOptions),PATH_PATTERN_OPTIONS_TYPES={arrow:"arrow",flatArrow:"flatArrow"},metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"},geometries=[{uuid:"37479CAC-7F5B-4703-892E-871B6E547DD5",type:"BufferGeometry",data:{attributes:{position:{itemSize:3,type:"Float32Array",array:[.42857158184051514,-.5,.10101523995399475,8.84001920553601e-8,-.35714268684387207,0,3.9206022961479903e-7,.5,.101015105843544,3.9206022961479903e-7,.5,.101015105843544,8.84001920553601e-8,-.35714268684387207,0,.42857158184051514,-.5,.10101523995399475,.42857158184051514,-.5,.10101523995399475,3.9206022961479903e-7,.5,.101015105843544,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,3.9206022961479903e-7,.5,.101015105843544,.42857158184051514,-.5,.10101523995399475,.42857158184051514,-.5,.10101523995399475,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,8.84001920553601e-8,-.35714268684387207,0,8.84001920553601e-8,-.35714268684387207,0,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,.42857158184051514,-.5,.10101523995399475,-.42857158184051514,-.49999988079071045,.10101444274187088,3.9206022961479903e-7,.5,.101015105843544,8.84001920553601e-8,-.35714268684387207,0,8.84001920553601e-8,-.35714268684387207,0,3.9206022961479903e-7,.5,.101015105843544,-.42857158184051514,-.49999988079071045,.10101444274187088,-.42857158184051514,-.49999988079071045,.10101444274187088,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,3.9206022961479903e-7,.5,.101015105843544,3.9206022961479903e-7,.5,.101015105843544,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,-.42857158184051514,-.49999988079071045,.10101444274187088,8.84001920553601e-8,-.35714268684387207,0,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,-.42857158184051514,-.49999988079071045,.10101444274187088,-.42857158184051514,-.49999988079071045,.10101444274187088,-1.7872334723278982e-8,-.35714268684387207,.20203040540218353,8.84001920553601e-8,-.35714268684387207,0],normalized:!1},normal:{itemSize:3,type:"Float32Array",array:[34.704898834228516,14.873491287231445,-126.20626068115234,34.704898834228516,14.873491287231445,-126.20626068115234,34.704898834228516,14.873491287231445,-126.20626068115234,-34.704898834228516,-14.873491287231445,126.20626068115234,-34.704898834228516,-14.873491287231445,126.20626068115234,-34.704898834228516,-14.873491287231445,126.20626068115234,34.704898834228516,14.873491287231445,126.20626068115234,34.704898834228516,14.873491287231445,126.20626068115234,34.704898834228516,14.873491287231445,126.20626068115234,-34.704898834228516,-14.873491287231445,-126.20626068115234,-34.704898834228516,-14.873491287231445,-126.20626068115234,-34.704898834228516,-14.873491287231445,-126.20626068115234,-41.65779113769531,-124.97323608398438,2880212449189588e-37,-41.65779113769531,-124.97323608398438,2880212449189588e-37,-41.65779113769531,-124.97323608398438,2880212449189588e-37,41.65779113769531,124.97323608398438,-2880212449189588e-37,41.65779113769531,124.97323608398438,-2880212449189588e-37,41.65779113769531,124.97323608398438,-2880212449189588e-37,-34.70476531982422,14.87362289428711,-126.20639038085938,-34.70476531982422,14.87362289428711,-126.20639038085938,-34.70476531982422,14.87362289428711,-126.20639038085938,34.70476531982422,-14.87362289428711,126.20639038085938,34.70476531982422,-14.87362289428711,126.20639038085938,34.70476531982422,-14.87362289428711,126.20639038085938,-34.705162048339844,14.87362289428711,126.20626068115234,-34.705162048339844,14.87362289428711,126.20626068115234,-34.705162048339844,14.87362289428711,126.20626068115234,34.705162048339844,-14.87362289428711,-126.20626068115234,34.705162048339844,-14.87362289428711,-126.20626068115234,34.705162048339844,-14.87362289428711,-126.20626068115234,41.65779113769531,-124.97323608398438,2880212449189588e-37,41.65779113769531,-124.97323608398438,2880212449189588e-37,41.65779113769531,-124.97323608398438,2880212449189588e-37,-41.65779113769531,124.97323608398438,-2880212449189588e-37,-41.65779113769531,124.97323608398438,-2880212449189588e-37,-41.65779113769531,124.97323608398438,-2880212449189588e-37],normalized:!1}},groups:[{start:0,count:36,materialIndex:0}],boundingSphere:{center:[0,0,.10101520270109177],radius:.6585389895528455}}}],materials=[{uuid:"B4F824CB-4D3B-4F41-A053-771C64851466",type:"MeshLambertMaterial",name:"Color_A06",color:13369344,emissive:0,depthFunc:3,depthTest:!0,depthWrite:!0}],object$1={uuid:"D059C6D5-2900-4095-B5C0-6F465BE2E1F9",type:"Mesh",name:"instance_0",layers:1,matrix:[2.319827504683324,0,0,0,0,2.319827504683324,0,0,0,0,2.319827504683324,0,0,0,0,1],matrixAutoUpdate:!1,geometry:"37479CAC-7F5B-4703-892E-871B6E547DD5",material:"B4F824CB-4D3B-4F41-A053-771C64851466"},arrow={metadata:metadata,geometries:geometries,materials:materials,object:object$1},ArrowPathPatternOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.color=769978}},{key:"getPattern",value:function(){var e=(new three.ObjectLoader).parse(arrow);return e.material.color.set(this.color),Promise.resolve(e)}},{key:"isPathPatternOptions",get:function(){return!0}}]),t}(adactiveAbstractOptions.AbstractOptions),DotPathBuilderOptions=function(e){function n(){return classCallCheck(this,n),possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return inherits(n,e),createClass(n,[{key:"reset",value:function(){get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"reset",this).call(this),this.patternSpace=5,this.patternSize=1,this.pattern=new FlatArrowPathPatternOptions}},{key:"set",value:function(e,t,i){return"pattern"===e?this.setPattern(t):get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"set",this).call(this,e,t,i)}},{key:"setPattern",value:function(e){if(e.isPathPatternOptions)return this.pattern=e,this;switch(e.type){case PATH_PATTERN_OPTIONS_TYPES.arrow:this.pattern=new ArrowPathPatternOptions(e.options||{});break;case PATH_PATTERN_OPTIONS_TYPES.flatArrow:this.pattern=new FlatArrowPathPatternOptions(e.options||{});break;default:console.warn('DotPathBuilderOptions.pattern: unknown type "'+e.type+'"')}return this}}]),n}(adactiveAbstractOptions.AbstractOptions),yAxis=new three.Vector3(0,1,0),direction=new three.Vector3,DotPathBuilder=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,t),this.isPathBuilder=!0,this.projector=null,this.objectManager=null,this.options=new DotPathBuilderOptions(e),this.pattern=null}return createClass(t,[{key:"init",value:function(e,t){var i=this;return this.projector=e,this.objectManager=t,this.options.pattern.getPattern().then(function(e){i.pattern=e;var t=i.projector.meterToAdsumDistance(i.options.patternSize);i.pattern.scale.set(t,t,t),i.pattern.updateMatrix(),i.pattern.updateMatrixWorld()})}},{key:"build",value:function(e){var t=new three.Group;t.visible=!1;for(var i=e.interpolate(this.options.patternSpace),n=0;n<i.length-1;n++){var r=i[n],a=i[n+1],s=this._createPattern();s.position.copy(r),direction.subVectors(a,s.position).normalize(),s.quaternion.setFromUnitVectors(yAxis,direction),s.updateMatrix(),t.add(s)}e.isInterGround()||t.position.setZ(this.projector.meterToAdsumDistance(.025));var o=new PathSectionObject({pathSection:e,patternSpace:this.options.patternSpace});return o._setMesh(t),e.ground._addChild(o),o.updateMatrix(),this.objectManager.pathSectionObjects.set(o.id,o),o}},{key:"_createPattern",value:function(){var e=this.pattern.clone();return e.traverse(function(e){e.material&&(Array.isArray(e.material)?e.material=e.material.map(function(e){return e.clone()}):e.material=e.material.clone())}),e}}]),t}(),UserPositionUpdateOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.animated=!0,this.duration=700}}]),t}(adactiveAbstractOptions.AbstractOptions),DotPathSectionDrawerOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.center=!0,this.centerOnOptions=null,this.oriented=!1,this.speed=30}}]),t}(adactiveAbstractOptions.AbstractOptions),DotPathSectionDrawer=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,t),this.isPathSectionDrawer=!0,this.awm=null,this.options=new DotPathSectionDrawerOptions(e)}return createClass(t,[{key:"init",value:function(e){this.awm=e}},{key:"draw",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=[],n=null;n=null===t?this.options:new DotPathSectionDrawerOptions(t);for(var r=e.getPatterns(),a=0;a<r.length;a++){var s=this.awm.getProjector().adsumDistanceToMeter(e.patternSpace)/n.speed*a*1e3;i.push(this._showPattern(e,a,s))}if(e.setDisplayMode(DISPLAY_MODES.VISIBLE),n.center){var o=e.pathSection,l=n.oriented?o.getAzimuthOrientation():null,c=o.from,h=o.to,u=[e];null!==c&&null!==c.adsumObject&&u.push(c.adsumObject),null!==h&&null!==h.adsumObject&&u.push(h.adsumObject);var p=n.centerOnOptions;null!==l&&(p=null===p?{azimuth:l}:Object.assign(p,{azimuth:l})),i.push(this.awm.cameraManager.centerOnObjects(u,!0,p))}return Promise.all(i).then(function(){})}},{key:"_showPattern",value:function(a,s,o){return new Promise(function(e,t){var i=a.getPattern(s),n={opacity:0};i.traverse(function(e){forEachMaterial(e,function(e){e.opacity=0,e.transparent=!0})});var r=new es6Tween.Tween(n).to({opacity:1},1e3).delay(o).easing(es6Tween.Easing.Exponential.In).on("update",function(){i.traverse(function(e){forEachMaterial(e,function(e){e.opacity=n.opacity})})}).on("complete",function(){i.traverse(function(e){forEachMaterial(e,function(e){e.opacity=1})}),e(!0)}).on("stop",function(){t(new Error("Path was stopped"))}).start();a.tweens.push(r)})}}]),t}(),UserObject=function(e){function i(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,i),e.id=Symbol("AdsumObjectId"),e.placeId=Symbol("UserPlace");var t=possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.isUser=!0,t.parent=null,t}return inherits(i,AdsumObject3D),createClass(i,[{key:"getType",value:function(){return AdsumObjectTypes.UserObject}},{key:"setPosition",value:function(e,t){return this._mesh.position.copy(e),null!==this.parent&&(this.parent.user=null),t.user=this,t._addChild(this),this.setFading(t.getFading()),this.parent=t,this.updateMatrix(),this}},{key:"setRotation",value:function(e){this._mesh.rotation.set(0,0,0),this._mesh.rotateZ(e-Math.PI/2),this.updateMatrix()}},{key:"setScale",value:function(e){return this._mesh.scale.set(e,e,e),this.updateMatrix(),this}}]),i}(),THREE$2={BufferAttribute:three.BufferAttribute,Vector3:three.Vector3,Vector2:three.Vector2,BufferGeometry:three.BufferGeometry};THREE$2.BufferGeometryUtils={computeTangents:function(e){var t=e.index,i=e.attributes;if(null!==t&&void 0!==i.position&&void 0!==i.normal&&void 0!==i.uv){var n=t.array,f=i.position.array,r=i.normal.array,m=i.uv.array,a=f.length/3;void 0===i.tangent&&e.addAttribute("tangent",new THREE$2.BufferAttribute(new Float32Array(4*a),4));for(var s=i.tangent.array,g=[],y=[],o=0;o<a;o++)g[o]=new THREE$2.Vector3,y[o]=new THREE$2.Vector3;var v=new THREE$2.Vector3,b=new THREE$2.Vector3,_=new THREE$2.Vector3,O=new THREE$2.Vector2,w=new THREE$2.Vector2,E=new THREE$2.Vector2,M=new THREE$2.Vector3,k=new THREE$2.Vector3,l=e.groups;0===l.length&&(l=[{start:0,count:n.length}]);for(var c=0,h=l.length;c<h;++c)for(var u=R=(S=l[c]).start,p=R+S.count;u<p;u+=3)N(n[u+0],n[u+1],n[u+2]);var d,P,T,C=new THREE$2.Vector3,A=new THREE$2.Vector3,j=new THREE$2.Vector3,x=new THREE$2.Vector3;for(c=0,h=l.length;c<h;++c){var S,R;for(u=R=(S=l[c]).start,p=R+S.count;u<p;u+=3)L(n[u+0]),L(n[u+1]),L(n[u+2])}}else console.warn("THREE.BufferGeometry: Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");function N(e,t,i){v.fromArray(f,3*e),b.fromArray(f,3*t),_.fromArray(f,3*i),O.fromArray(m,2*e),w.fromArray(m,2*t),E.fromArray(m,2*i);var n=b.x-v.x,r=_.x-v.x,a=b.y-v.y,s=_.y-v.y,o=b.z-v.z,l=_.z-v.z,c=w.x-O.x,h=E.x-O.x,u=w.y-O.y,p=E.y-O.y,d=1/(c*p-h*u);M.set((p*n-u*r)*d,(p*a-u*s)*d,(p*o-u*l)*d),k.set((c*r-h*n)*d,(c*s-h*a)*d,(c*l-h*o)*d),g[e].add(M),g[t].add(M),g[i].add(M),y[e].add(k),y[t].add(k),y[i].add(k)}function L(e){j.fromArray(r,3*e),x.copy(j),P=g[e],C.copy(P),C.sub(j.multiplyScalar(j.dot(P))).normalize(),A.crossVectors(x,P),T=A.dot(y[e]),d=T<0?-1:1,s[4*e]=C.x,s[4*e+1]=C.y,s[4*e+2]=C.z,s[4*e+3]=d}},mergeBufferGeometries:function(e){for(var t=null!==e[0].index,i=new Set(Object.keys(e[0].attributes)),n=new Set(Object.keys(e[0].morphAttributes)),r={},a={},s=new THREE$2.BufferGeometry,o=0;o<e.length;++o){var l=e[o];if(t!==(null!==l.index))return null;for(var c in l.attributes){if(!i.has(c))return null;void 0===r[c]&&(r[c]=[]),r[c].push(l.attributes[c])}for(var c in l.morphAttributes){if(!n.has(c))return null;void 0===a[c]&&(a[c]=[]),a[c].push(l.morphAttributes[c])}void 0!==l.userData&&(s.userData=s.userData||{},s.userData.mergedUserData=s.userData.mergedUserData||[],s.userData.mergedUserData.push(l.userData))}if(t){var h=0,u=[];for(o=0;o<e.length;++o){var p=e[o].index;if(0<h){p=p.clone();for(var d=0;d<p.count;++d)p.setX(d,p.getX(d)+h)}u.push(p),h+=e[o].attributes.position.count}var f=this.mergeBufferAttributes(u);if(!f)return null;s.index=f}for(var c in r){var m=this.mergeBufferAttributes(r[c]);if(!m)return null;s.addAttribute(c,m)}for(var c in a){var g=a[c][0].length;if(0===g)break;s.morphAttributes=s.morphAttributes||{},s.morphAttributes[c]=[];for(o=0;o<g;++o){var y=[];for(d=0;d<a[c].length;++d)y.push(a[c][d][o]);var v=this.mergeBufferAttributes(y);if(!v)return null;s.morphAttributes[c].push(v)}}return s},mergeBufferAttributes:function(e){for(var t,i,n,r=0,a=0;a<e.length;++a){var s=e[a];if(s.isInterleavedBufferAttribute)return null;if(void 0===t&&(t=s.array.constructor),t!==s.array.constructor)return null;if(void 0===i&&(i=s.itemSize),i!==s.itemSize)return null;if(void 0===n&&(n=s.normalized),n!==s.normalized)return null;r+=s.array.length}for(var o=new t(r),l=0,c=0;c<e.length;++c)o.set(e[c].array,l),l+=e[c].array.length;return new THREE$2.BufferAttribute(o,i,n)}};var BufferGeometryUtils=THREE$2.BufferGeometryUtils,DotUserObjectOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){this.size=3,this.color=769978}}]),t}(adactiveAbstractOptions.AbstractOptions),DotUserObject=function(e){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,s);var t=new DotUserObjectOptions(e),i=possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this)),n=t.size,r=BufferGeometryUtils.mergeBufferGeometries([new three.RingBufferGeometry(n/2,n/2-n/8,32),new three.CircleBufferGeometry(n/8,16)]),a=new three.MeshBasicMaterial({color:t.color,side:three.DoubleSide});return a.transparent=!0,i._setMesh(new three.Mesh(r,a)),i}return inherits(s,UserObject),s}(),PATH_BUILDER_TYPES={dot:"dot"},PathSectionDrawerTypes={dot:"dot"},OrientedDotUserObject=function(e){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,s);var t=possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,e)),i=e.size||3,n=new three.Shape;n.absarc(0,0,i/2+i/32,Math.PI/3,2*Math.PI/3),n.lineTo(0,i/2+i/6);var r=BufferGeometryUtils.mergeBufferGeometries([new three.RingBufferGeometry(i/2,i/2-i/8,32),new three.CircleBufferGeometry(i/8,16),new three.ShapeBufferGeometry(n)]),a=new three.MeshBasicMaterial({color:void 0===e.color?769978:e.color,side:three.DoubleSide});return a.transparent=!0,t._setMesh(new three.Mesh(r,a)),t}return inherits(s,UserObject),s}(),WayfindingOptions=function(e){function n(){return classCallCheck(this,n),possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return inherits(n,e),createClass(n,[{key:"reset",value:function(){get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"reset",this).call(this),this.pathBuilder=new DotPathBuilder,this.pathSectionDrawer=new DotPathSectionDrawer,this.userObject=new DotUserObject,this.userPositionUpdateOptions=new UserPositionUpdateOptions}},{key:"set",value:function(e,t,i){switch(e){case"pathBuilder":return this.setPathBuilder(t);case"pathSectionDrawer":return this.setPathSectionDrawer(t);case"userObject":return this.setUserObject(t);default:return get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"set",this).call(this,e,t,i)}}},{key:"setPathBuilder",value:function(e){if(e.isPathBuilder)return this.pathBuilder=e,this;switch(e.type){case PATH_BUILDER_TYPES.dot:this.pathBuilder=new DotPathBuilder(e.options||{});break;default:console.warn('WayfindingOptions.pathBuilder: unknown type "'+e.type+'"')}return this}},{key:"setPathSectionDrawer",value:function(e){if(e.isPathSectionDrawer)return this.pathSectionDrawer=e,this;switch(e.type){case PathSectionDrawerTypes.dot:this.pathSectionDrawer=new DotPathSectionDrawer(e.options||{});break;default:console.warn('WayfindingOptions.pathSectionDrawer: unknown type "'+e.type+'"')}return this}},{key:"setUserObject",value:function(e){if(e.isUser)return this.userObject=e,this;switch(e.type){case AdsumObjectTypes.DotUserObject:this.userObject=new DotUserObject(e.options||{});break;case AdsumObjectTypes.OrientedDotUserObject:this.userObject=new OrientedDotUserObject(e.options||{});break;default:console.warn('WayfindingOptions.userObject: unknown type "'+e.type+'"')}return this}}]),n}(adactiveAbstractOptions.AbstractOptions),SingleFloorAnimationOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.inTime=300,this.keepSiteVisible=!0,this.outTime=300,this.pause=300}}]),t}(adactiveAbstractOptions.AbstractOptions),SingleFloorAnimation=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,t),this.isFloorAnimation=!0,this.awm=null,this.options=new SingleFloorAnimationOptions(e),this.isSameBuilding=!1,this.tweenIn=null,this.tweenOut=null}return createClass(t,[{key:"init",value:function(e){var t=this;this.awm=e,this.setVisibility(this.awm.objectManager.site,!0,1),this.awm.objectManager.floors.forEach(function(e){t.setVisibility(e,!1,0)})}},{key:"start",value:function(i,n,e){var r=this;if(this.isSameBuilding=i.isFloor&&n.isFloor&&i.building===n.building,!e)return new Promise(function(e,t){try{r.setVisibility(i,!1,0),r.setVisibility(n,!0,1),e()}catch(e){t(e)}});var t=function(){r.setVisibility(i,!1,0),r.setVisibility(n,!0,1)},a=Promise.all([this.prepareFadeOut(i,t),this.prepareFadeIn(n,t)]);return this.tweenOut.chainedTweens(this.tweenIn),this.tweenOut.start(),a.then(function(){})}},{key:"stop",value:function(){null!==this.tweenOut&&this.tweenOut.stop(),null!==this.tweenIn&&this.tweenIn.stop()}},{key:"setVisibility",value:function(e,t,i){if(e.isSite)this.options.keepSiteVisible||(e.setFading(i),e.setDisplayMode(t?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT),e.buildings.forEach(function(e){e.setDisplayMode(t?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT)}));else if(e.setFading(i),e.setDisplayMode(t?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.NONE),this.options.keepSiteVisible){var n=!(t&&1===i)&&!this.isSameBuilding;e.building.setDisplayMode(n?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.TRANSPARENT)}}},{key:"prepareFadeIn",value:function(n,r){var a=this;return new Promise(function(e,t){var i={fading:0};a.tweenIn=new es6Tween.Tween(i).to({fading:1},a.options.inTime).delay(a.options.pause).on("start",function(){a.setVisibility(n,!0,0)}).on("update",function(){n.setFading(i.fading)}).on("stop",function(){r(),a.tweenIn=null,t(new Error("AdsumWebMap.SingleFloorAnimation: stopped"))}).on("complete",function(){a.setVisibility(n,!0,1),a.tweenIn=null,e()})})}},{key:"prepareFadeOut",value:function(n,r){var a=this;return new Promise(function(e,t){var i={fading:n.getFading()};a.tweenOut=new es6Tween.Tween(i).to({fading:0},a.options.outTime).on("update",function(){a.setVisibility(n,!0,i.fading)}).on("stop",function(){r(),a.tweenOut=null,t(new Error("AdsumWebMap.SingleFloorAnimation: stopped"))}).on("complete",function(){a.setVisibility(n,!1,0),a.tweenOut=null,e()})})}}]),t}(),FLOOR_ANIMATION_TYPES={single:"single"},SceneOptions=function(e){function n(){return classCallCheck(this,n),possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return inherits(n,e),createClass(n,[{key:"reset",value:function(){get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"reset",this).call(this),this.animation=new SingleFloorAnimation}},{key:"set",value:function(e,t,i){switch(e){case"animation":return this.setAnimation(t);default:return get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"set",this).call(this,e,t,i)}}},{key:"setAnimation",value:function(e){if(e.isFloorAnimation)return this.animation=e,this;switch(e.type){case FLOOR_ANIMATION_TYPES.single:this.animation=new SingleFloorAnimation(e.options||{});break;default:console.warn('SceneOptions.animation: unknown type "'+e.type+'"')}return this}}]),n}(adactiveAbstractOptions.AbstractOptions),Options=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.engine=new EngineOptions,this.camera=new CameraOptions,this.scene=new SceneOptions,this.wayfinding=new WayfindingOptions,this.loader=null}}]),t}(adactiveAbstractOptions.AbstractOptions);three.Cache.enabled=!0,three.Object3D.DefaultMatrixAutoUpdate=!1;var AdsumWebMap=function(){function i(e){classCallCheck(this,i);var t=new Options(e);this.objectManager=new ObjectManager,this.sceneManager=new SceneManager(this,t.scene),this.engineManager=new EngineManager(this,t.engine),this.cameraManager=new CameraManager(this,t.camera),this.mouseManager=new MouseManager(this),this.wayfindingManager=new WayfindingManager(this,t.wayfinding),this.deviceId=null,this.defaultFloor=null,this.loader=t.loader}return createClass(i,[{key:"init",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return null!==e&&(this.loader=e),this.loader.load().then(function(e){return t.projector=e.projector,t.engineManager.init(e),t.objectManager.init(e),t.sceneManager.init(e),t.cameraManager.init(t.projector),t.mouseManager.init(),t.wayfindingManager.init(e).then(function(){return t.setDeviceId(e.deviceId,!1)})})}},{key:"start",value:function(){this.engineManager.start(),this.mouseManager.start(),this.cameraManager.start()}},{key:"stop",value:function(){this.engineManager.stop(),this.mouseManager.stop(),this.cameraManager.stop()}},{key:"getDeviceId",value:function(){return this.deviceId}},{key:"getProjector",value:function(){return this.projector}},{key:"setDeviceId",value:function(e){var r=this,a=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return this.deviceId=e,this.defaultFloor=null,this.loader.loadCalibration(this.deviceId).then(function(e){var t=e.cameraCalibrations,i=e.defaultFloorId,n=e.userPosition;return null!==n&&(null===n.floorId?r.wayfindingManager.setUserAdsumPosition(n.position,null,!0):r.wayfindingManager.setUserAdsumPosition(n.position,r.objectManager.getFloor(n.floorId),!0)),r.cameraManager.setCameraCalibrations(t),null!==i&&(r.defaultFloor=r.objectManager.getFloor(i)),r.sceneManager.setCurrentFloor(r.defaultFloor,a)}).then(function(){return r.cameraManager.centerOnFloor(r.defaultFloor,a)}).then(function(){})}}]),i}(),THREE$3={Group:three.Group,Matrix4:three.Matrix4,Vector3:three.Vector3,Quaternion:three.Quaternion,Vector4:three.Vector4,Math:three.Math,Object3D:three.Object3D,DoubleSide:three.DoubleSide,MeshLambertMaterial:three.MeshLambertMaterial,MeshBasicMaterial:three.MeshBasicMaterial,MeshPhongMaterial:three.MeshPhongMaterial,FrontSide:three.FrontSide,MultiMaterial:three.MultiMaterial,SkinnedMesh:three.SkinnedMesh,Mesh:three.Mesh,Line:three.Line,PerspectiveCamera:three.PerspectiveCamera,DirectionalLight:three.DirectionalLight,PointLight:three.PointLight,SpotLight:three.SpotLight,AmbientLight:three.AmbientLight,Geometry:three.Geometry,Vector2:three.Vector2,Color:three.Color,Face3:three.Face3,Loader:three.Loader,Texture:three.Texture,MirroredRepeatWrapping:three.MirroredRepeatWrapping,RepeatWrapping:three.RepeatWrapping,ClampToEdgeWrapping:three.ClampToEdgeWrapping,MixOperation:three.MixOperation,ImageLoader:three.ImageLoader,Scene:three.Scene,BufferGeometry:three.BufferGeometry};function AdsumColladaLoader(){var t,h=null,l=null,O=void 0,c=void 0,s=null,j={},d={},w={},I={},B={},F={},V={},H={},U={},u=void 0,p=void 0,o=void 0,f=void 0,m=void 0,z=void 0,G=void 0,x={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},g=1;function y(e,t,i){if(h=(new DOMParser).parseFromString(e,"text/xml"),t=t||s,void 0!==i){var n=i.split("/");n.pop(),m=(n.length<1?".":n.join("/"))+"/"}!function(){var e=h.querySelectorAll("asset")[0];if(e&&e.childNodes)for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"unit":var n=i.getAttribute("meter");n&&(g=parseFloat(n));break;case"up_axis":i.textContent.charAt(0)}}}(),null,d=v("library_images image",P,"image"),F=v("library_materials material",ne,"material"),V=v("library_effects effect",le,"effect"),B=v("library_geometries geometry",L,"geometry"),H=v("library_cameras camera",de,"camera"),U=v("library_lights light",me,"light"),I=v("library_controllers controller",T,"controller"),w=v("library_animations animation",ce,"animation"),o=v("library_visual_scenes visual_scene",C,"visual_scene"),f=v("library_kinematics_models kinematics_model",ye,"kinematics_model"),z=[],G=[],O=function(){var e=h.querySelectorAll("scene instance_visual_scene")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return o[0<t.length?t:"visual_scene0"]}return null}(),l=new THREE$3.Scene;for(var r=0;r<O.nodes.length;r++)l.add(Y(O.nodes[r]));l.scale.multiplyScalar(g),u=[],function e(t){var i=O.getChildById(t.colladaId,!0),n=null;if(i&&i.keys){n={fps:60,hierarchy:[{node:i,keys:i.keys,sids:i.sids}],node:t,name:"animation_"+t.name,length:0},u.push(n);for(var r=0,a=i.keys.length;r<a;r++)n.length=Math.max(n.length,i.keys[r].time)}else n={hierarchy:[{keys:[],sids:[]}]};for(var r=0,a=t.children.length;r<a;r++)for(var s=e(t.children[r]),o=0,l=s.hierarchy.length;o<l;o++)n.hierarchy.push({keys:[],sids:[]});return n}(l),c=function(){var e=h.querySelectorAll("instance_kinematics_model")[0];if(e){var t=e.getAttribute("url").replace(/^#/,"");return f[0<t.length?t:"kinematics_model0"]}return null}(),function(){if(c&&0===c.joints.length)return p=void 0;var d={},e=function(t,e){var i=e.getAttribute("id"),n=O.getChildById(i,!0),r=c.joints[t];l.traverse(function(e){e.colladaId==i&&(d[t]={node:e,transforms:n.transforms,joint:r,position:r.zeroPosition})})};p={joints:c&&c.joints,getJointValue:function(e){var t=d[e];if(t)return t.position;console.log("getJointValue: joint "+e+" doesn't exist")},setJointValue:function(e,t){var i=d[e];if(i){var n=i.joint;if(t>n.limits.max||t<n.limits.min)console.log("setJointValue: joint "+e+" value "+t+" outside of limits (min: "+n.limits.min+", max: "+n.limits.max+")");else if(n.static)console.log("setJointValue: joint "+e+" is static");else{var r=i.node,a=n.axis,s=i.transforms,o=new THREE$3.Matrix4,l=new THREE$3.Matrix4;for(f=0;f<s.length;f++){var c=s[f];if(c.sid&&-1!==c.sid.indexOf("joint"+e))switch(n.type){case"revolute":o.multiply(l.makeRotationAxis(a,THREE$3.Math.degToRad(t)));break;case"prismatic":o.multiply(l.makeTranslation(a.x*t,a.y*t,a.z*t));break;default:console.warn("setJointValue: unknown joint type: "+n.type)}else switch(c.type){case"matrix":o.multiply(c.obj);break;case"translate":o.multiply(l.makeTranslation(c.obj.x,c.obj.y,c.obj.z));break;case"rotate":o.multiply(l.makeRotationAxis(c.obj,c.angle))}}var h=o.elements,u=Array.prototype.slice.call(h),p=[u[0],u[4],u[8],u[12],u[1],u[5],u[9],u[13],u[2],u[6],u[10],u[14],u[3],u[7],u[11],u[15]];r.matrix.set.apply(r.matrix,p),r.matrix.decompose(r.position,r.quaternion,r.scale),d[e].position=t}}else console.log("setJointValue: joint "+e+" doesn't exist")}};var t=h.querySelector("scene instance_kinematics_scene");if(t)for(var f=0;f<t.childNodes.length;f++){var i=t.childNodes[f];if(1==i.nodeType)switch(i.nodeName){case"bind_joint_axis":var n=i.getAttribute("target").split("/").pop(),r=i.querySelector("axis param").textContent,a=parseInt(r.split("joint").pop().split(".")[0]),s=h.querySelector('[sid="'+n+'"]');if(s){var o=s.parentElement;e(a,o)}}}}();var a={scene:l,morphs:z,skins:G,animations:u,kinematics:p,dae:{images:d,materials:F,cameras:H,lights:U,effects:V,geometries:B,controllers:I,animations:w,visualScenes:o,visualScene:O,scene:O,kinematicsModels:f,kinematicsModel:c}};return t&&t(a),a}function v(e,t,i){for(var n=h.querySelectorAll(e),r={},a=0,s=n.length,o=0;o<s;o++){var l=n[o],c=(new t).parse(l);c.id&&0!==c.id.length||(c.id=i+a++),r[c.id]=c}return r}function $(e,t){var i=t instanceof R?I[t.url]:t;if(i&&i.morph){for(var n=i.morph,r=0;r<n.targets.length;r++){var a=n.targets[r],s=B[a];if(s.mesh&&s.mesh.primitives&&s.mesh.primitives.length){var o=s.mesh.primitives[0].geometry;o.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:o.vertices})}}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}else console.log("could not find morph controller!")}function E(e,t,i,n){if(e.world=e.world||new THREE$3.Matrix4,e.localworld=e.localworld||new THREE$3.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix),e.channels&&e.channels.length){var r=e.channels[0].sampler.output[i];r instanceof THREE$3.Matrix4&&(e.world.copy(r),e.localworld.copy(r),0===i&&e.matrix.copy(r))}n&&e.world.multiplyMatrices(n,e.world),t.push(e);for(var a=0;a<e.nodes.length;a++)E(e.nodes[a],t,i,e.world)}function M(e,t){for(var i=0;i<e.length;i++){var n=e[i],r=-1;if("JOINT"==n.type){for(var a=0;a<t.joints.length;a++)if(n.sid===t.joints[a]){r=a;break}if(0<=r){var s=t.invBindMatrices[r];n.invBindMatrix=s,n.skinningMatrix=new THREE$3.Matrix4,n.skinningMatrix.multiplyMatrices(n.world,s),n.animatrix=new THREE$3.Matrix4,n.animatrix.copy(n.localworld),n.weights=[];for(a=0;a<t.weights.length;a++)for(var o=0;o<t.weights[a].length;o++){var l=t.weights[a][o];l.joint===r&&n.weights.push(l)}}else console.warn("ColladaLoader: Could not find joint '"+n.sid+"'."),n.skinningMatrix=new THREE$3.Matrix4,n.weights=[]}}}function W(e,t,i){void 0===i&&(i=40);var n=I[t.url];if(n&&n.skin)if(t.skeleton&&t.skeleton.length){for(var r,a=function(){var e=1e6,t=-e,i=0,n=void 0;for(var r in w){var a=w[r];n=n||a.id;for(var s=0;s<a.sampler.length;s++){var o=a.sampler[s];o.create(),e=Math.min(e,o.startTime),t=Math.max(t,o.endTime),i=Math.max(i,o.input.length)}}return{start:e,end:t,frames:i,ID:n}}(),s=O.getChildById(t.skeleton[0],!0)||O.getChildBySid(t.skeleton[0],!0),o=(function e(t,i,n){var r={};r.name=i.sid,r.parent=t,r.matrix=i.matrix;var a=[new THREE$3.Vector3,new THREE$3.Quaternion,new THREE$3.Vector3];for(var s in r.matrix.decompose(a[0],a[1],a[2]),r.pos=[a[0].x,a[0].y,a[0].z],r.scl=[a[2].x,a[2].y,a[2].z],r.rotq=[a[1].x,a[1].y,a[1].z,a[1].w],n.push(r),i.nodes)e(i.sid,i.nodes[s],n)}(-1,s,r=[]),r),l=n.skin.joints,c=[],h=0;h<l.length;h++)for(var u=0;u<o.length;u++)o[u].name===l[h]&&(c[h]=o[u]);for(var h=0;h<c.length;h++)for(var u=0;u<c.length;u++)c[h].parent===c[u].name&&(c[h].parent=u);new THREE$3.Vector3;for(h=0;h<e.vertices.length;h++)e.vertices[h].applyMatrix4(n.skin.bindShapeMatrix);var p=[],d=[],f=n.skin.weights;for(h=0;h<f.length;h++){var m=new THREE$3.Vector4(f[h][0]?f[h][0].joint:0,f[h][1]?f[h][1].joint:0,f[h][2]?f[h][2].joint:0,f[h][3]?f[h][3].joint:0),g=new THREE$3.Vector4(f[h][0]?f[h][0].weight:0,f[h][1]?f[h][1].weight:0,f[h][2]?f[h][2].weight:0,f[h][3]?f[h][3].weight:0);p.push(m),d.push(g)}e.skinIndices=p,e.skinWeights=d,e.bones=c;var y={name:a.ID,fps:30,length:a.frames/30,hierarchy:[]};for(u=0;u<c.length;u++)y.hierarchy.push({parent:c[u].parent,name:c[u].name,keys:[]});for(console.log("ColladaLoader:",a.ID+" has "+c.length+" bones."),function(e,t,i){var n=[];E(t,n,-1),M(n,i.skin);for(var r=new THREE$3.Vector3,a=[],s=0;s<e.vertices.length;s++)a.push(new THREE$3.Vector3);for(s=0;s<n.length;s++)if("JOINT"==n[s].type)for(var o=0;o<n[s].weights.length;o++){var l=n[s].weights[o],c=l.index,h=l.weight,u=e.vertices[c],p=a[c];r.x=u.x,r.y=u.y,r.z=u.z,r.applyMatrix4(n[s].skinningMatrix),p.x+=r.x*h,p.y+=r.y*h,p.z+=r.z*h}for(s=0;s<e.vertices.length;s++)e.vertices[s]=a[s]}(e,s,n),i=0;i<a.frames;i++){var v=[];E(s,v,i),M(v,n.skin);for(h=0;h<v.length;h++)for(u=0;u<y.hierarchy.length;u++)if(y.hierarchy[u].name===v[h].sid){var b={};b.time=i/30,b.matrix=v[h].animatrix,0===i&&(v[h].matrix=b.matrix);var _=[new THREE$3.Vector3,new THREE$3.Quaternion,new THREE$3.Vector3];b.matrix.decompose(_[0],_[1],_[2]),b.pos=[_[0].x,_[0].y,_[0].z],b.scl=[_[2].x,_[2].y,_[2].z],b.rot=_[1],y.hierarchy[u].keys.push(b)}e.animation=y}}else console.log("ColladaLoader: Could not find the skeleton for the skin. ");else console.log("ColladaLoader: Could not find skin controller.")}function Y(e,t){var i=new THREE$3.Object3D,n=void 0,r=void 0,a=void 0,s=void 0;for(a=0;a<e.controllers.length;a++){var o=I[e.controllers[a].url];switch(o.type){case"skin":if(B[o.skin.source])(c=new q).url=o.skin.source,c.instance_material=e.controllers[a].instance_material,e.geometries.push(c),n=e.controllers[a];else if(I[o.skin.source]){var l=I[o.skin.source];if((r=l).morph&&B[l.morph.source])(c=new q).url=l.morph.source,c.instance_material=e.controllers[a].instance_material,e.geometries.push(c)}break;case"morph":var c;if(B[o.morph.source])(c=new q).url=o.morph.source,c.instance_material=e.controllers[a].instance_material,e.geometries.push(c),r=e.controllers[a];console.log("ColladaLoader: Morph-controller partially supported.")}}var h={};for(a=0;a<e.geometries.length;a++){var u,p=e.geometries[a],d=p.instance_material,f=B[p.url],m={},g=[],y=0;if(f){if(!f.mesh||!f.mesh.primitives)continue;if(0===i.name.length&&(i.name=f.id),d)for(s=0;s<d.length;s++){var v=d[s],b=F[v.target],_=b.instance_effect.url,O=V[_].shader.material;if(f.doubleSided){if(!(v.symbol in h)){var w=O.clone();w.side=THREE$3.DoubleSide,h[v.symbol]=w}O=h[v.symbol]}O.opacity=O.opacity?O.opacity:1,m[v.symbol]=y,g.push(O),(u=O).name=null===b.name||""===b.name?b.id:b.name,y++}var E,M=u||new THREE$3.MeshLambertMaterial({color:14540253,side:f.doubleSided?THREE$3.DoubleSide:THREE$3.FrontSide}),k=f.mesh.geometry3js;if(1<y)for(M=new THREE$3.MultiMaterial(g),s=0;s<k.faces.length;s++){var P=k.faces[s];P.materialIndex=m[P.daeMaterial]}void 0!==n?(W(k,n),0<k.morphTargets.length?(M.morphTargets=!0,M.skinning=!1):(M.morphTargets=!1,M.skinning=!0),(E=new THREE$3.SkinnedMesh(k,M,!1)).name="skin_"+G.length,G.push(E)):void 0!==r?($(k,r),M.morphTargets=!0,(E=new THREE$3.Mesh(k,M)).name="morph_"+z.length,z.push(E)):E=!0===k.isLineStrip?new THREE$3.Line(k):new THREE$3.Mesh(k,M),i.add(E)}}for(a=0;a<e.cameras.length;a++){var T=e.cameras[a],C=H[T.url],A=new THREE$3.PerspectiveCamera(C.yfov,parseFloat(C.aspect_ratio),parseFloat(C.znear),parseFloat(C.zfar));i.add(A)}for(a=0;a<e.lights.length;a++){var j=null,x=e.lights[a],S=U[x.url];if(S&&S.technique){var R=S.color.getHex(),N=S.intensity,L=S.distance,D=S.falloff_angle;switch(S.technique){case"directional":(j=new THREE$3.DirectionalLight(R,N,L)).position.set(0,0,1);break;case"point":j=new THREE$3.PointLight(R,N,L);break;case"spot":(j=new THREE$3.SpotLight(R,N,L,D)).position.set(0,0,1);break;case"ambient":j=new THREE$3.AmbientLight(R)}}j&&i.add(j)}for(i.name=e.name||e.id||"",i.colladaId=e.id||"",i.layer=e.layer||"",i.matrix=e.matrix,i.matrix.decompose(i.position,i.quaternion,i.scale),a=0;a<e.nodes.length;a++)i.add(Y(e.nodes[a],e));return i}function r(e){for(var t=h.querySelectorAll("library_nodes node"),i=0;i<t.length;i++){var n=t[i].attributes.getNamedItem("id");if(n&&n.value===e)return t[i]}}function b(e,t){for(var i=null,n=0,r=e.length;n<r&&null===i;n++){var a=e[n];if(a.time===t)i=a;else if(a.time>t)break}return i}function _(e,t){for(var i=-1,n=0,r=e.length;n<r&&-1===i;n++){e[n].time>=t&&(i=n)}return i}function k(e,t,i,n){var r=function(e,t,i){for(i=0<=i?i:i+e.length;0<=i;i--){var n=e[i];if(n.hasTarget(t))return n}return null}(e,n,i?i-1:0),a=function(e,t,i){for(;i<e.length;i++){var n=e[i];if(n.hasTarget(t))return n}return null}(e,n,i+1);if(r&&a){var s=(t.time-r.time)/(a.time-r.time),o=r.getTarget(n),l=a.getTarget(n).data,c=o.data,h=void 0;if("matrix"===o.type)h=c;else if(c.length){h=[];for(var u=0;u<c.length;++u)h[u]=c[u]+(l[u]-c[u])*s}else h=c+(l-c)*s;t.addTarget(n,o.transform,o.member,h)}}function P(){this.id="",this.init_from=""}function T(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function n(){this.method=null,this.source=null,this.targets=null,this.weights=null}function a(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function C(){this.id="",this.name="",this.nodes=[],this.scene=new THREE$3.Group}function A(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE$3.Matrix4}function S(){this.sid="",this.type="",this.data=[],this.obj=null}function R(){this.url="",this.skeleton=[],this.instance_material=[]}function N(){this.symbol="",this.target=""}function q(){this.url="",this.instance_material=[]}function L(){this.id="",this.mesh=null}function D(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function Z(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE$3.Geometry}function X(){Z.call(this),this.vcount=[]}function J(){Z.call(this),this.vcount=1}function K(){Z.call(this),this.vcount=3}function Q(){this.source="",this.count=0,this.stride=0,this.params=[]}function ee(){this.input={}}function te(){this.semantic="",this.offset=0,this.source="",this.set=0}function ie(e){this.id=e,this.type=null}function ne(){this.id="",this.name="",this.instance_effect=null}function re(){this.color=new THREE$3.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function ae(e,t){this.type=e,this.effect=t,this.material=null}function se(e){this.effect=e,this.init_from=null,this.format=null}function oe(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function le(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function i(){this.url=""}function ce(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function he(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function ue(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function pe(e){this.targets=[],this.time=e}function de(){this.id="",this.name="",this.technique=""}function fe(){this.url=""}function me(){this.id="",this.name="",this.technique=""}function ge(){this.url=""}function ye(){this.id="",this.name="",this.joints=[],this.links=[]}function ve(){this.sid="",this.name="",this.axis=new THREE$3.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function be(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function _e(){this.joint="",this.transforms=[],this.links=[]}function Oe(e){var t=e.getAttribute("id");return null!=j[t]||(j[t]=new ie(t).parse(e)),j[t]}function we(e){for(var t=ke(e),i=[],n=0,r=t.length;n<r;n++)i.push(!("true"!==t[n]&&"1"!==t[n]));return i}function Ee(e){for(var t=ke(e),i=[],n=0,r=t.length;n<r;n++)i.push(parseFloat(t[n]));return i}function Me(e){for(var t=ke(e),i=[],n=0,r=t.length;n<r;n++)i.push(parseInt(t[n],10));return i}function ke(e){return 0<e.length?(t=e,t.replace(/^\s+/,"").replace(/\s+$/,"")).split(/\s+/):[];var t}function Pe(e,t,i){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):i}function Te(t,e){(new THREE$3.ImageLoader).load(e,function(e){t.image=e,t.needsUpdate=!0})}function Ce(e,t){e.doubleSided=!1;var i=t.querySelectorAll("extra double_sided")[0];i&&i&&1===parseInt(i.textContent,10)&&(e.doubleSided=!0)}function Ae(e,t){}function je(e,t){var i=[e[t],e[t+1],e[t+2]];return new THREE$3.Vector3(i[0],i[1],i[2])}function xe(e){return(new THREE$3.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function Se(e){if(-1<e&&e<3){e={X:0,Y:1,Z:2}[e=Re(["X","Y","Z"][e])]}return e}function Re(e){return e}return P.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];"init_from"===i.nodeName&&(this.init_from=i.textContent)}return this},T.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"skin":this.skin=(new a).parse(i),this.type=i.nodeName;break;case"morph":this.morph=(new n).parse(i),this.type=i.nodeName}}return this},n.prototype.parse=function(e){var t={},i=[],n=void 0;for(this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,""),n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];if(1==r.nodeType)switch(r.nodeName){case"source":t[(s=(new ie).parse(r)).id]=s;break;case"targets":i=this.parseInputs(r);break;default:console.log(r.nodeName)}}for(n=0;n<i.length;n++){var a=i[n],s=t[a.source];switch(a.semantic){case"MORPH_TARGET":this.targets=s.read();break;case"MORPH_WEIGHT":this.weights=s.read()}}return this},n.prototype.parseInputs=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":t.push((new te).parse(n))}}return t},a.prototype.parse=function(e){var t={},i=void 0,n=void 0;this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var r=0;r<e.childNodes.length;r++){var a=e.childNodes[r];if(1==a.nodeType)switch(a.nodeName){case"bind_shape_matrix":var s=Ee(a.textContent);this.bindShapeMatrix=xe(s);break;case"source":var o=(new ie).parse(a);t[o.id]=o;break;case"joints":i=a;break;case"vertex_weights":n=a;break;default:console.log(a.nodeName)}}return this.parseJoints(i,t),this.parseWeights(n,t),this},a.prototype.parseJoints=function(e,t){for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"input":var r=(new te).parse(n),a=t[r.source];"JOINT"===r.semantic?this.joints=a.read():"INV_BIND_MATRIX"===r.semantic&&(this.invBindMatrices=a.read())}}},a.prototype.parseWeights=function(e,t){for(var i=void 0,n=void 0,r=[],a=0;a<e.childNodes.length;a++){var s=e.childNodes[a];if(1==s.nodeType)switch(s.nodeName){case"input":r.push((new te).parse(s));break;case"v":i=Me(s.textContent);break;case"vcount":n=Me(s.textContent)}}var o=0;for(a=0;a<n.length;a++){for(var l=n[a],c=[],h=0;h<l;h++){for(var u={},p=0;p<r.length;p++){var d=r[p],f=i[o+d.offset];switch(d.semantic){case"JOINT":u.joint=f;break;case"WEIGHT":u.weight=t[d.source].data[f]}}c.push(u),o+=r.length}for(h=0;h<c.length;h++)c[h].index=a;this.weights.push(c)}},C.prototype.getChildById=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},C.prototype.getChildBySid=function(e,t){for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},C.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new A).parse(i))}}return this},A.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var i,n=this.channels[t],r=n.target.split("/"),a=(r.shift(),r.shift()),s=0<=a.indexOf("."),o=0<=a.indexOf("(");if(s)a=(r=a.split(".")).shift();else if(o){a=(i=a.split("(")).shift();for(var l=0;l<i.length;l++)i[l]=parseInt(i[l].replace(/\)/,""))}if(a===e)return n.info={sid:a,dotSyntax:s,arrSyntax:o,arrIndices:i},n}return null},A.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildById(e,t);if(n)return n}return null},A.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var i=0;i<this.nodes.length;i++){var n=this.nodes[i].getChildBySid(e,t);if(n)return n}return null},A.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},A.prototype.parse=function(e){this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE$3.Matrix4;for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"node":this.nodes.push((new A).parse(i));break;case"instance_camera":this.cameras.push((new fe).parse(i));break;case"instance_controller":this.controllers.push((new R).parse(i));break;case"instance_geometry":this.geometries.push((new q).parse(i));break;case"instance_light":this.lights.push((new ge).parse(i));break;case"instance_node":var n=r(i.getAttribute("url").replace(/^#/,""));n&&this.nodes.push((new A).parse(n));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new S).parse(i));break;case"extra":break;default:console.log(i.nodeName)}}return this.channels=function(e){var t=[],i=1e6,n=-1e6;for(var r in w)for(var a=w[r],s=0;s<a.channel.length;s++){var o=a.channel[s],l=a.sampler[s];(r=o.target.split("/")[0])==e.id&&(l.create(),o.sampler=l,i=Math.min(i,l.startTime),n=Math.max(n,l.endTime),t.push(o))}return t.length&&(e.startTime=i,e.endTime=n),t}(this),function(e){if(e.channels&&e.channels.length){for(var t=[],i=[],n=0,r=e.channels.length;n<r;n++){var a,s=e.channels[n],o=s.fullSid,l=s.sampler,c=l.input,h=e.getTransformBySid(s.sid);if(s.arrIndices){a=[];for(var u=0,p=s.arrIndices.length;u<p;u++)a[u]=Se(s.arrIndices[u])}else a=Re(s.member);if(h)for(-1===i.indexOf(o)&&i.push(o),u=0,p=c.length;u<p;u++){var d=c[u],f=l.getData(h.type,u,a);if(!(y=b(t,d))){y=new pe(d);var m=_(t,d);t.splice(-1===m?t.length:m,0,y)}y.addTarget(o,h,a,f)}else console.log('Could not find transform "'+s.sid+'" in node '+e.id)}for(n=0;n<i.length;n++){var g=i[n];for(u=0;u<t.length;u++){var y;(y=t[u]).hasTarget(g)||k(t,y,u,g)}}e.keys=t,e.sids=i}}(this),this.updateMatrix(),this},A.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},S.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=Ee(e.textContent),this.convert(),this},S.prototype.convert=function(){switch(this.type){case"matrix":this.obj=xe(this.data);break;case"rotate":this.angle=THREE$3.Math.degToRad(this.data[3]);case"translate":Ae(this.data,-1),this.obj=new THREE$3.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":Ae(this.data,1),this.obj=new THREE$3.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},S.prototype.apply=(t=new THREE$3.Matrix4,function(e){switch(this.type){case"matrix":e.multiply(this.obj);break;case"translate":e.multiply(t.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":e.multiply(t.makeRotationAxis(this.obj,this.angle));break;case"scale":e.scale(this.obj)}}),S.prototype.update=function(e,t){var i=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(t)if(1===t.length)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(2===t.length){var n="n"+(t[0]+1)+(t[1]+1);this.obj[n]=e}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(e);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(t)&&(t=i[t[0]]),t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE$3.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE$3.Math.degToRad(e[3])}}},R.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1===i.nodeType)switch(i.nodeName){case"skeleton":this.skeleton.push(i.textContent.replace(/^#/,""));break;case"bind_material":for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new N).parse(a))}}}return this},N.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},q.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType&&"bind_material"===i.nodeName){for(var n=i.querySelectorAll("instance_material"),r=0;r<n.length;r++){var a=n[r];this.instance_material.push((new N).parse(a))}break}}return this},L.prototype.parse=function(e){this.id=e.getAttribute("id"),Ce(this,e);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"mesh":this.mesh=new D(this).parse(i)}}return this},D.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"source":Oe(i);break;case"vertices":this.vertices=(new ee).parse(i);break;case"linestrips":this.primitives.push((new J).parse(i));break;case"triangles":this.primitives.push((new K).parse(i));break;case"polygons":this.primitives.push((new Z).parse(i));break;case"polylist":this.primitives.push((new X).parse(i))}}if(this.geometry3js=new THREE$3.Geometry,null===this.vertices)return this;var n=j[this.vertices.input.POSITION.source].data;for(t=0;t<n.length;t+=3)this.geometry3js.vertices.push(je(n,t).clone());for(t=0;t<this.primitives.length;t++){var r=this.primitives[t];r.setVertices(this.vertices),this.handlePrimitive(r,this.geometry3js)}this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals);var a=this.geometry3js;return this.geometry3js=new THREE$3.BufferGeometry,this.geometry3js.fromGeometry(a),a.dispose(),this},D.prototype.handlePrimitive=function(e,t){if(e instanceof J)t.isLineStrip=!0;else{var i=void 0,n=void 0,r=e.p,a=e.inputs,s=void 0,o=void 0,l=void 0,c=void 0,h=void 0,u=void 0,p=0,d=0,f=[];for(i=0;i<a.length;i++){var m=(s=a[i]).offset+1;switch(d=d<m?m:d,s.semantic){case"TEXCOORD":f.push(s.set)}}for(var g=0;g<r.length;++g)for(var y=r[g],v=0;v<y.length;){var b=[],_=[],O=null,w=[];for(u=e.vcount?e.vcount.length?e.vcount[p++]:e.vcount:y.length/d,i=0;i<u;i++)for(n=0;n<a.length;n++)switch(s=a[n],c=j[s.source],l=(o=y[v+i*d+s.offset])*(h=c.accessor.params.length),s.semantic){case"VERTEX":b.push(o);break;case"NORMAL":_.push(je(c.data,l));break;case"TEXCOORD":void 0===(O=O||{})[s.set]&&(O[s.set]=[]),O[s.set].push(new THREE$3.Vector2(c.data[l],c.data[l+1]));break;case"COLOR":w.push((new THREE$3.Color).setRGB(c.data[l],c.data[l+1],c.data[l+2]))}if(0===_.length)if(s=this.vertices.input.NORMAL){h=(c=j[s.source]).accessor.params.length;for(var E=0,M=b.length;E<M;E++)_.push(je(c.data,b[E]*h))}else t.calcNormals=!0;if(!O&&(O={},s=this.vertices.input.TEXCOORD)){f.push(s.set),h=(c=j[s.source]).accessor.params.length;for(E=0,M=b.length;E<M;E++)l=b[E]*h,void 0===O[s.set]&&(O[s.set]=[]),O[s.set].push(new THREE$3.Vector2(c.data[l],1-c.data[l+1]))}if(0===w.length&&(s=this.vertices.input.COLOR)){h=(c=j[s.source]).accessor.params.length;for(E=0,M=b.length;E<M;E++)l=b[E]*h,w.push((new THREE$3.Color).setRGB(c.data[l],c.data[l+1],c.data[l+2]))}var k,P,T=null,C=[];if(3===u)C.push(new THREE$3.Face3(b[0],b[1],b[2],_,w.length?w:new THREE$3.Color));else if(4===u)C.push(new THREE$3.Face3(b[0],b[1],b[3],_.length?[_[0].clone(),_[1].clone(),_[3].clone()]:[],w.length?[w[0],w[1],w[3]]:new THREE$3.Color)),C.push(new THREE$3.Face3(b[1],b[2],b[3],_.length?[_[1].clone(),_[2].clone(),_[3].clone()]:[],w.length?[w[1],w[2],w[3]]:new THREE$3.Color));else if(4<u&&x.subdivideFaces){var A=w.length?w:new THREE$3.Color;for(n=1;n<u-1;)C.push(new THREE$3.Face3(b[0],b[n],b[n+1],_.length?[_[0].clone(),_[n++].clone(),_[n].clone()]:[],A))}if(C.length)for(E=0,M=C.length;E<M;E++)for((T=C[E]).daeMaterial=e.material,t.faces.push(T),n=0;n<f.length;n++)k=O[f[n]],P=4<u?[k[0],k[E+1],k[E+2]]:4===u?0===E?[k[0],k[1],k[3]]:[k[1].clone(),k[2],k[3].clone()]:[k[0],k[1],k[2]],void 0===t.faceVertexUvs[n]&&(t.faceVertexUvs[n]=[]),t.faceVertexUvs[n].push(P);else console.log("dropped face with vcount "+u+" for geometry with id: "+t.id);v+=d*u}}},Z.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},Z.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=Pe(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"input":this.inputs.push((new te).parse(e.childNodes[t]));break;case"vcount":this.vcount=Me(i.textContent);break;case"p":this.p.push(Me(i.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},(X.prototype=Object.create(Z.prototype)).constructor=X,(J.prototype=Object.create(Z.prototype)).constructor=J,(K.prototype=Object.create(Z.prototype)).constructor=K,Q.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=Pe(e,"count",0),this.stride=Pe(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if("param"===i.nodeName){var n={};n.name=i.getAttribute("name"),n.type=i.getAttribute("type"),this.params.push(n)}}return this},ee.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if("input"===e.childNodes[t].nodeName){var i=(new te).parse(e.childNodes[t]);this.input[i.semantic]=i}return this},te.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=Pe(e,"set",-1),this.offset=Pe(e,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},ie.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"bool_array":this.data=we(i.textContent),this.type=i.nodeName;break;case"float_array":this.data=Ee(i.textContent),this.type=i.nodeName;break;case"int_array":this.data=Me(i.textContent),this.type=i.nodeName;break;case"IDREF_array":case"Name_array":this.data=ke(i.textContent),this.type=i.nodeName;break;case"technique_common":for(var n=0;n<i.childNodes.length;n++)if("accessor"===i.childNodes[n].nodeName){this.accessor=(new Q).parse(i.childNodes[n]);break}}}return this},ie.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var i=0;i<this.data.length;i+=16){var n=xe(this.data.slice(i,i+16));e.push(n)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},ne.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if("instance_effect"===e.childNodes[t].nodeName){this.instance_effect=(new i).parse(e.childNodes[t]);break}return this},re.prototype.isColor=function(){return null===this.texture},re.prototype.isTexture=function(){return null!=this.texture},re.prototype.parse=function(e){"transparent"===e.nodeName&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"color":var n=Ee(i.textContent);this.color=new THREE$3.Color,this.color.setRGB(n[0],n[1],n[2]),this.color.a=n[3];break;case"texture":this.texture=i.getAttribute("texture"),this.texcoord=i.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(i)}}return this},re.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&"extra"===e.childNodes[1].nodeName&&(e=e.childNodes[1]).childNodes[1]&&"technique"===e.childNodes[1].nodeName&&(e=e.childNodes[1]);for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[i.nodeName]=parseFloat(i.textContent);break;case"wrapU":case"wrapV":"TRUE"===i.textContent.toUpperCase()?this.texOpts[i.nodeName]=1:this.texOpts[i.nodeName]=parseInt(i.textContent);break;default:this.texOpts[i.nodeName]=i.textContent}}return this},ae.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"ambient":case"emission":case"diffuse":case"specular":case"transparent":this[i.nodeName]=(new re).parse(i);break;case"bump":var n=i.getAttribute("bumptype");n?"heightfield"===n.toLowerCase()?this.bump=(new re).parse(i):"normalmap"===n.toLowerCase()?this.normal=(new re).parse(i):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+n+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new re).parse(i)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new re).parse(i));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var r=i.querySelectorAll("float");0<r.length&&(this[i.nodeName]=parseFloat(r[0].textContent))}}return this.create(),this},ae.prototype.create=function(){var e={},t=!1;if(void 0===this.transparency&&this.transparent&&(this.transparency=1),void 0===this.transparent&&this.transparency&&(t={color:{r:1,g:1,b:1,a:1}}),void 0!==this.transparency&&void 0!==this.transparent){var i=this.transparent.color.a*this.transparency;0<i&&(t=!0,e.transparent=!0,e.opacity=1-i)}var n={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var r in this)switch(r){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var a=this[r];if(a instanceof re)if(a.isTexture()){var s=a.texture,o=this.effect.sampler[s];if(void 0!==o&&void 0!==o.source){var l=this.effect.surface[o.source];if(void 0!==l){var c=d[l.init_from];if(c){var h,u=m+c.init_from,p=THREE$3.Loader.Handlers.get(u);null!==p?h=p.load(u):Te(h=new THREE$3.Texture,u),"MIRROR"===o.wrap_s?h.wrapS=THREE$3.MirroredRepeatWrapping:"WRAP"===o.wrap_s||a.texOpts.wrapU?h.wrapS=THREE$3.RepeatWrapping:h.wrapS=THREE$3.ClampToEdgeWrapping,"MIRROR"===o.wrap_t?h.wrapT=THREE$3.MirroredRepeatWrapping:"WRAP"===o.wrap_t||a.texOpts.wrapV?h.wrapT=THREE$3.RepeatWrapping:h.wrapT=THREE$3.ClampToEdgeWrapping,h.offset.x=a.texOpts.offsetU,h.offset.y=a.texOpts.offsetV,h.repeat.x=a.texOpts.repeatU,h.repeat.y=a.texOpts.repeatV,e[n[r]]=h,"emission"===r&&(e.emissive=16777215)}}}}else"diffuse"!==r&&t||("emission"===r?e.emissive=a.color.getHex():e[r]=a.color.getHex());break;case"shininess":e[r]=this[r];break;case"reflectivity":e[r]=this[r],0<e[r]&&(e.envMap=x.defaultEnvMap),e.combine=THREE$3.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[r],1!==this[r]&&(e.envMap=x.defaultEnvMap)}switch(e.side=this.effect.doubleSided?THREE$3.DoubleSide:THREE$3.FrontSide,void 0!==e.diffuse&&(e.color=e.diffuse,delete e.diffuse),void 0!==e.ambient&&delete e.ambient,this.type){case"constant":null!=e.emissive&&(e.color=e.emissive),this.material=new THREE$3.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE$3.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE$3.MeshLambertMaterial(e)}return this.material},se.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"init_from":this.init_from=i.textContent;break;case"format":this.format=i.textContent;break;default:console.log("unhandled Surface prop: "+i.nodeName)}}return this},oe.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"source":this.source=i.textContent;break;case"minfilter":this.minfilter=i.textContent;break;case"magfilter":this.magfilter=i.textContent;break;case"mipfilter":this.mipfilter=i.textContent;break;case"wrap_s":this.wrap_s=i.textContent;break;case"wrap_t":this.wrap_t=i.textContent;break;default:console.log("unhandled Sampler2D prop: "+i.nodeName)}}return this},le.prototype.create=function(){if(null===this.shader)return null},le.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),Ce(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(i))}}return this},le.prototype.parseNewparam=function(e){for(var t=e.getAttribute("sid"),i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"surface":this.surface[t]=new se(this).parse(n);break;case"sampler2D":this.sampler[t]=new oe(this).parse(n);break;case"extra":break;default:console.log(n.nodeName)}}},le.prototype.parseProfileCOMMON=function(e){for(var t=void 0,i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(1==n.nodeType)switch(n.nodeName){case"profile_COMMON":this.parseProfileCOMMON(n);break;case"technique":t=n;break;case"newparam":this.parseNewparam(n);break;case"image":var r=(new P).parse(n);d[r.id]=r;break;case"extra":break;default:console.log(n.nodeName)}}return t},le.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new ae(i.nodeName,this).parse(i);break;case"extra":this.parseExtra(i)}}},le.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique":this.parseExtraTechnique(i)}}},le.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"bump":this.shader.parse(e)}}},i.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ce.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"animation":var n=(new ce).parse(i);for(var r in n.source)this.source[r]=n.source[r];for(var a=0;a<n.channel.length;a++)this.channel.push(n.channel[a]),this.sampler.push(n.sampler[a]);break;case"source":r=(new ie).parse(i);this.source[r.id]=r;break;case"sampler":this.sampler.push(new ue(this).parse(i));break;case"channel":this.channel.push(new he(this).parse(i))}}return this},he.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),i=(t.shift(),t.shift()),n=0<=i.indexOf("."),r=0<=i.indexOf("(");if(n)t=i.split("."),this.sid=t.shift(),this.member=t.shift();else if(r){var a=i.split("(");this.sid=a.shift();for(var s=0;s<a.length;s++)a[s]=parseInt(a[s].replace(/\)/,""));this.arrIndices=a}else this.sid=i;return this.fullSid=i,this.dotSyntax=n,this.arrSyntax=r,this},ue.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"input":this.inputs.push((new te).parse(i))}}return this},ue.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],i=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=i.read();break;case"OUTPUT":this.output=i.read(),this.strideOut=i.accessor.stride;break;case"INTERPOLATION":this.interpolation=i.read();break;case"IN_TANGENT":case"OUT_TANGENT":break;default:console.log(t.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},ue.prototype.getData=function(e,t,i){var n=void 0;if("matrix"===e&&16===this.strideOut)n=this.output[t];else if(1<this.strideOut){n=[],t*=this.strideOut;for(var r=0;r<this.strideOut;++r)n[r]=this.output[t+r];if(3===this.strideOut)switch(e){case"rotate":case"translate":Ae(n,-1);break;case"scale":Ae(n,1)}else 4===this.strideOut&&"matrix"===e&&Ae(n,-1)}else n=this.output[t],i&&"translate"===e&&(n=n);return n},pe.prototype.addTarget=function(e,t,i,n){this.targets.push({sid:e,member:i,transform:t,data:n})},pe.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var i=this.targets[t];e&&i.sid!==e||i.transform.update(i.data,i.member)}},pe.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},pe.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},pe.prototype.interpolate=function(e,t){for(var i=0,n=this.targets.length;i<n;i++){var r,a=this.targets[i],s=e.getTarget(a.sid);if("matrix"!==a.transform.type&&s){var o=(t-this.time)/(e.time-this.time),l=s.data,c=a.data;if(o<0&&(o=0),1<o&&(o=1),c.length){r=[];for(var h=0;h<c.length;++h)r[h]=c[h]+(l[h]-c[h])*o}else r=c+(l-c)*o}else r=a.data;a.transform.update(r,a.member)}},de.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"optics":this.parseOptics(i)}}return this},de.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if("technique_common"===e.childNodes[t].nodeName)for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++)if(this.technique=i.childNodes[n].nodeName,"perspective"===this.technique)for(var r=i.childNodes[n],a=0;a<r.childNodes.length;a++){switch((o=r.childNodes[a]).nodeName){case"yfov":this.yfov=o.textContent;break;case"xfov":this.xfov=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}else if("orthographic"===this.technique){var s=i.childNodes[n];for(a=0;a<s.childNodes.length;a++){var o;switch((o=s.childNodes[a]).nodeName){case"xmag":this.xmag=o.textContent;break;case"ymag":this.ymag=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}}return this},fe.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},me.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i);break;case"technique":this.parseTechnique(i)}}return this},me.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;for(var i=e.childNodes[t],n=0;n<i.childNodes.length;n++){var r=i.childNodes[n];switch(r.nodeName){case"color":var a=Ee(r.textContent);this.color=new THREE$3.Color(0),this.color.setRGB(a[0],a[1],a[2]),this.color.a=a[3];break;case"falloff_angle":this.falloff_angle=parseFloat(r.textContent);break;case"quadratic_attenuation":var s=parseFloat(r.textContent);this.distance=s?Math.sqrt(1/s):0}}}return this},me.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"intensity":this.intensity=parseFloat(i.textContent)}}return this},ge.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},ye.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"technique_common":this.parseCommon(i)}}return this},ye.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new ve).parse(i));break;case"link":this.links.push((new be).parse(i))}}return this},ve.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE$3.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;var t=Ee(e.querySelector("axis").textContent);this.axis=je(t,0);var i=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,n=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:i,max:n};for(var r=["prismatic","revolute"],a=0;a<r.length;a++){var s=r[a];e.querySelector(s)&&(this.type=s)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},be.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"attachment_full":this.attachments.push((new _e).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new S).parse(i))}}return this},_e.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if(1==i.nodeType)switch(i.nodeName){case"link":this.links.push((new be).parse(i));break;case"rotate":case"translate":case"matrix":this.transforms.push((new S).parse(i))}}return this},{load:function(e,t,i,n){var r=0;if(document.implementation&&document.implementation.createDocument){var a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState?0===a.status||200===a.status?a.response?(s=t,y(a.response,void 0,e)):n?n({type:"error",url:e}):console.error("ColladaLoader: Empty or non-existing file ("+e+")"):n?n({type:"error",url:e}):console.error("ColladaLoader: Couldn't load \""+e+'" ('+a.status+")"):3===a.readyState&&i&&(0===r&&(r=a.getResponseHeader("Content-Length")),i({total:r,loaded:a.responseText.length}))},a.open("GET",e,!0),a.send(null)}else alert("Don't know how to parse XML!")},parse:y,applySkin:W,geometries:B,options:x}}var TEXTURE_QUALITY={AUTO:"auto",LOW:"low",HIGH:"high"},AdsumLoaderOptions=function(e){function n(){return classCallCheck(this,n),possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return inherits(n,e),createClass(n,[{key:"reset",value:function(){get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"reset",this).call(this),this.entityManager=null,this.textureQuality=TEXTURE_QUALITY.AUTO,this.shadowEnabled=!1,this.shadowMapSize=2048,this.fogEnabled=!1,this.fogRatio=0,this.fogColor=16777215,this.preferAmbientOcclusion=!0,this.shapeAmbientOcclusionTopColor=16777215,this.shapeAmbientOcclusionBottomColor=8421504,this.deviceId=null}},{key:"set",value:function(e,t,i){return"entityManager"!==e||t instanceof adsumClientApi.EntityManager?get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"set",this).call(this,e,t,i):(this[e]=new adsumClientApi.EntityManager(t),this)}},{key:"get",value:function(e){return"entityManager"===e?this[e].options.toJSON():get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"get",this).call(this,e)}},{key:"preferLambertMaterial",value:function(){return!1}},{key:"advancedLightingEnabled",value:function(){return!1}}]),n}(adactiveAbstractOptions.AbstractOptions),AdsumTextureLoader=function(){function e(){classCallCheck(this,e),this.regex=/.*/}return createClass(e,[{key:"load",value:function(){return new three.Texture}}]),e}(),LABEL_OBJECTS_ORIENTATION_MODES={BILLBOARD:"BILLBOARD",STATIC:"STATIC",FLIP:"FLIP"},LabelObjectOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,AdsumObject3DOptions),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.isLabelObjectOptions=!0,this.autoScale=!1,this.isPermanentDisplay=!0,this.orientationMode=LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD,this.offset={x:0,y:0,z:0},this.opacity=1,this.rotation=0,this.scale={x:1,y:1,z:1}}}],[{key:"convert",value:function(e){return e.isLabelObjectOptions?e:new this(e)}}]),t}(),v$1=new three.Vector3,worldPosition=new three.Vector3,zAxis=new three.Vector3(0,0,1),LabelObject=function(e){function l(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,l);var t=LabelObjectOptions.convert(e),i=possibleConstructorReturn(this,(l.__proto__||Object.getPrototypeOf(l)).call(this,t));return i.autoScale=t.autoScale,i.isLabel=!0,i.isPermanentDisplay=t.isPermanentDisplay,i.offset=new three.Vector3(0,0,0),i.offset.copy(t.offset),i.orientationMode=null,i.setOrientationMode(t.orientationMode),i.opacity=t.opacity,i.parent=null,i.rotation=t.rotation%360,i.scale=new three.Vector3(1,1,1),i.scale.copy(t.scale),i.selected=!1,i}return inherits(l,AdsumObject3D),createClass(l,[{key:"getType",value:function(){return AdsumObjectTypes.LabelObject}},{key:"moveTo",value:function(e,t,i){return this.offset.set(e,t,i),this._updatePosition(),this}},{key:"moveBy",value:function(e,t,i){return this.moveTo(this.offset.x+e,this.offset.y+t,this.offset.z+i)}},{key:"setAutoScale",value:function(e){return this.autoScale=Boolean(e),this._updatePosition(),this}},{key:"setOrientationMode",value:function(e){switch(e){case LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD:case LABEL_OBJECTS_ORIENTATION_MODES.STATIC:this.orientationMode=e;break;default:console.warn("AdsumWebMap.LabelImageObject#create: Unsupported orientation mode "+e)}return this._applyRotation(!1),this._updatePosition(!1),this.updateMatrix(),this}},{key:"setOpacity",value:function(e){return this.opacity=e,this._updateVisibility(),this}},{key:"setPermanentDisplay",value:function(e){return this.isPermanentDisplay=Boolean(e),this._updateVisibility(),this}},{key:"setRotation",value:function(e){return this.orientationMode!==LABEL_OBJECTS_ORIENTATION_MODES.STATIC&&console.warn("AdsumWebMap.LabelObject.setRotation: only static labels can be rotated"),this.rotation=e%360,this._applyRotation(!1),this._updatePosition(!1),this.updateMatrix(),this}},{key:"setScale",value:function(e,t,i){return this.scale.set(e,t,i),this._updatePosition(),this}},{key:"select",value:function(){return this.selected=!0,this._updateVisibility(),this}},{key:"unselect",value:function(){return this.selected=!1,this._updateVisibility(),this}},{key:"_updateVisibility",value:function(){var t=this;if(null!==this._mesh){var e=this.isPermanentDisplay||this.selected;this.setDisplayMode(e?DISPLAY_MODES.VISIBLE:DISPLAY_MODES.NONE),forEachMaterial(this._mesh,function(e){e.opacity=t.fading*t.opacity}),this.triggerChange()}}},{key:"_applyRotation",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];return null!==this._mesh&&this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.STATIC&&this._mesh.setRotationFromAxisAngle(zAxis,this.rotation*Math.PI/180),e&&this.updateMatrix(),this}},{key:"_onBeforeRender",value:function(e,t,i,n,r,a){get(l.prototype.__proto__||Object.getPrototypeOf(l.prototype),"_onBeforeRender",this).call(this,e,t,i,n,r,a),this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD&&(this._mesh.quaternion.setFromRotationMatrix(this._mesh.parent.matrixWorld).inverse(),this._mesh.quaternion.multiply(i.quaternion).normalize(),this.updateMatrix()),this._mesh.getWorldPosition(worldPosition);var s=v$1.subVectors(i.position,worldPosition).length();if(this.autoScale){var o=Math.tan(i.fov*Math.PI/180/2)*s/1e3;this.setScale(o,o,o)}}},{key:"_applyLod",value:function(e,t,i){return this._updateVisibility(),get(l.prototype.__proto__||Object.getPrototypeOf(l.prototype),"_applyLod",this).call(this,e,t,i),this.selected&&this._updateVisibility(),!1}},{key:"_setMesh",value:function(e){return get(l.prototype.__proto__||Object.getPrototypeOf(l.prototype),"_setMesh",this).call(this,e),this._applyRotation(!1),this._updatePosition(!1),this.updateMatrix(),this}},{key:"_updatePosition",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(null!==this._mesh)if(this._mesh.position.copy(this.offset),this.orientationMode===LABEL_OBJECTS_ORIENTATION_MODES.BILLBOARD){this._mesh.geometry.computeBoundingBox();var t=this._mesh.geometry.boundingBox,i=t.max,n=t.min,r=i.y-n.y;this._mesh.scale.copy(this.scale),this._mesh.position.z+=this.scale.z*r/2}else this._mesh.position.z+=1.1,this._mesh.scale.set(this.scale.x,this.scale.y,1);e&&this.updateMatrix()}}]),l}(),LabelImageObjectOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,LabelObjectOptions),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.isLabelImageObjectOptions=!0,this.width=null,this.height=null,this.image=null}}],[{key:"convert",value:function(e){return e.isLabelImageObjectOptions?e:new this(e)}}]),t}(),textureLoader=new three.TextureLoader,LabelImageObject=function(e){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,n);var t=LabelImageObjectOptions.convert(e),i=possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i.isLabelImage=!0,i.width=t.width,i.height=t.height,i.image=t.image,i._updateMesh(),i}return inherits(n,LabelObject),createClass(n,[{key:"getType",value:function(){return AdsumObjectTypes.LabelImageObject}},{key:"setImage",value:function(e){return this.image=e,this._updateMesh(),this}},{key:"setHeight",value:function(e){return this.height=e,this._updateMesh(),this}},{key:"setWidth",value:function(e){return this.width=e,this._updateMesh(),this}},{key:"_updateMesh",value:function(){if(null===this._mesh){var e=new three.PlaneBufferGeometry(this.width,this.height),t=new three.MeshBasicMaterial({color:16777215,map:this._createTexture(),side:three.FrontSide,transparent:!0,depthWrite:!1});this._setMesh(new three.Mesh(e,t))}else this._mesh.material.map.dispose(),this._mesh.material.map=this._createTexture(),this._mesh.geometry.width===this.width&&this._mesh.geometry.height===this.height||(this._mesh.geometry.dispose(),this._mesh.geometry=new three.PlaneBufferGeometry(this.width,this.height),this._updatePosition())}},{key:"_createTexture",value:function(){var t=this;if("string"==typeof this.image){var e=textureLoader.load(this.image,function(){e.needsUpdate=!0,t.triggerChange()},void 0,function(e){console.error("AdsumWebMap.LabelImageObject: unable to load image "+t.image,e)});return e}if(this.image instanceof HTMLImageElement){var i=new three.Texture(this.image);return this.image.complete?i.needsUpdate=!0:(this.image.addEventListener("load",function(){i.needsUpdate=!0,t.triggerChange()},!1),this.image.addEventListener("error",function(e){console.error("AdsumWebMap.LabelImageObject: unable to load image "+t.image,e)},!1)),i}if(this.image instanceof HTMLCanvasElement)return new three.CanvasTexture(this.image);throw new TypeError("AdsumWebMap.LabelImageObject: invalid image; expected an url, an image or a canvas")}}]),n}(),TextUtil={createTextTexture:function(){return{texture:new three.Texture,width:50,height:50}}},TextStyleOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){this.backgroundColor=null,this.backgroundOpacity=.7,this.backgroundPadding=10,this.backgroundRadius=5,this.color="#000000",this.font="Arial",this.lineHeight=1.25,this.quality=5,this.size=5}}]),t}(adactiveAbstractOptions.AbstractOptions),LabelTextObjectOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,LabelObjectOptions),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.isLabelTextObjectOptions=!0,this.text=null,this.style=new TextStyleOptions}}],[{key:"convert",value:function(e){return e.isLabelTextObjectOptions?e:new this(e)}}]),t}(),LabelTextObject=function(e){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,n);var t=LabelTextObjectOptions.convert(e),i=possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i.isLabelText=!0,i.text=t.text,i.style=t.style,i._updateMesh(),i}return inherits(n,LabelObject),createClass(n,[{key:"getType",value:function(){return AdsumObjectTypes.LabelTextObject}},{key:"setText",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return this.text=e,null!==t&&this.style.merge(t),this._updateMesh(),this}},{key:"setStyle",value:function(e){return this.style.merge(e),this._updateMesh(),this}},{key:"_updateMesh",value:function(){if(null===this._mesh){var e=TextUtil.createTextTexture(this.text,this.style),t=e.texture,i=e.width,n=e.height;t.anisotropy=4;var r=new three.PlaneBufferGeometry(i,n),a=new three.MeshBasicMaterial({color:16777215,map:t,side:three.FrontSide,transparent:!0,depthWrite:!1});this._setMesh(new three.Mesh(r,a))}else{var s=TextUtil.createTextTexture(this.text,this.style,this._mesh.material[0].map),o=s.width,l=s.height;this._mesh.material[0].map.needsUpdate=!0,this._mesh.geometry.width===o&&this._mesh.geometry.height===l||(this._mesh.geometry.dispose(),this._mesh.geometry=new three.PlaneBufferGeometry(o,l),this._updatePosition())}return this}}]),n}(),AbstractLevelState=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"apply",value:function(e){}}]),e}(),DisplayLevelState=function(e){function i(e){classCallCheck(this,i);var t=possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.displayMode=e,t}return inherits(i,AbstractLevelState),createClass(i,[{key:"apply",value:function(e){get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"apply",this).call(this,e),e.setDisplayMode(this.displayMode)}}]),i}(),AdsumLabelLoader=function(){function i(e,t){classCallCheck(this,i),this.entityManager=e,this.projector=t}return createClass(i,[{key:"load",value:function(){var i=this,n=this.entityManager.getRepository("CustomObject"),e=this.entityManager.getRepository("File"),t=this.entityManager.getRepository("Place");return Promise.all([n.load(),e.load(),t.load()]).then(function(){var e=n.getAll(),t=[];return e.forEach(function(e){t.push(i.build(e))}),Promise.all(t)})}},{key:"build",value:function(e){var t=this.entityManager.getRepository("File"),i=this.entityManager.getRepository("Place").get(e.place),n={x:e.offset.x,y:e.offset.y,z:e.offset.z};null===i.shape_id&&null===i.building_id&&(n.x+=i.position.x,n.y+=i.position.y,n.z+=i.position.z);var r={orientationMode:e.orientation_mode,autoScale:e.autoscale,placeId:i.id,rotation:e.rotation,id:e.id,isPermanentDisplay:e.permanent_display,offset:n};if(0!==e.priority){var a=new LevelOfDetails;a.addLevelState(0,new DisplayLevelState(DISPLAY_MODES.VISIBLE)),a.addLevelState(this.projector.adsumDistanceToMeter(200*e.priority),new DisplayLevelState(DISPLAY_MODES.NONE)),r.levelOfDetails=a}if(e.type===adsumClientApi.CUSTOM_OBJECT_TYPES.PICTO){var s=t.get(e.file);return r.width=e.width,r.height=e.height,r.image=s.uri,new LabelImageObject(r)}var o={};return r.text=e.label.replace(/<br[ ]*\/?>/gi,"\n"),o.font=e.font,o.size=e.font_size,o.color=e.font_color,o.backgroundColor=e.background_color,r.style=o,new LabelTextObject(r)}}]),i}(),SiteObject=function(e){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,r);var t=possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return t.isSite=!0,t.buildings=new Set,t.spaces=new Set,t.labels=new Set,t._labelGroup=new three.Group,t.decors=[],t.user=null,t}return inherits(r,AdsumObject3D),createClass(r,[{key:"getType",value:function(){return AdsumObjectTypes.SiteObject}},{key:"addLabel",value:function(e){if(null!==e.parent)throw new Error("AdsumWebMap.LabelObject#addLabel: Changing labelObject parent is not supported yet.");return(e.parent=this).labels.add(e),this._labelGroup.add(e._mesh),e.updateMatrix(),this}},{key:"removeLabel",value:function(e){return this.labels.delete(e),e.parent=null,this._labelGroup.remove(e._mesh),this.triggerChange(),this}},{key:"setDisplayMode",value:function(t){switch(get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"setDisplayMode",this).call(this,t),this.decors.forEach(function(e){return e.setDisplayMode(t)}),t){case DISPLAY_MODES.NONE:case DISPLAY_MODES.TRANSPARENT:this._labelGroup.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._labelGroup.visible=!0;break;default:throw new Error("Unexpected")}}},{key:"_raycast",value:function(t,i){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];return!1!==get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_raycast",this).call(this,t,i,n)&&(n&&(this.buildings.forEach(function(e){e._raycast(t,i,n)}),this.labels.forEach(function(e){e._raycast(t,i,n)}),this.spaces.forEach(function(e){e._raycast(t,i,n)})),!0)}},{key:"_setMesh",value:function(e){return get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_setMesh",this).call(this,e),this._mesh.add(this._labelGroup),this._labelGroup.updateMatrixWorld(),this}},{key:"setFading",value:function(t){return get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"setFading",this).call(this,t),this.decors.forEach(function(e){return e.setFading(t)}),this.buildings.forEach(function(e){return e.setFading(t)}),this.spaces.forEach(function(e){return e.setFading(t)}),this.labels.forEach(function(e){return e.setFading(t)}),this.user&&this.user.setFading(t),this}}]),r}(),v1$1=new three.Vector3,SelfBox3=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"setFromObject",value:function(e){this.makeEmpty();var t=e.geometry;if(void 0!==t)if(t.isGeometry)for(var i=t.vertices,n=0,r=i.length;n<r;n++)v1$1.copy(i[n]),v1$1.applyMatrix4(e.matrixWorld),this.expandByPoint(v1$1);else if(t.isBufferGeometry){var a=t.attributes.position;if(void 0!==a)for(var s=0,o=a.count;s<o;s++)v1$1.fromBufferAttribute(a,s).applyMatrix4(e.matrixWorld),this.expandByPoint(v1$1)}return this}}]),t}(three.Box3),selfBox=new SelfBox3,size=new three.Vector3,BuildingObject=function(e){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,r);var t=possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return t.isBuilding=!0,t.site=null,t.floors=new Set,t.labels=new Set,t._labelGroup=new three.Group,t._initialColors=null,t}return inherits(r,AdsumObject3D),createClass(r,[{key:"getType",value:function(){return AdsumObjectTypes.BuildingObject}},{key:"addLabel",value:function(e){if(null!==e.parent)throw new Error("AdsumWebMap.SpaceObject#addLabel: Changing labelObject parent is not supported yet.");return(e.parent=this).labels.add(e),this._labelGroup.add(e._mesh),e.updateMatrix(),this}},{key:"removeLabel",value:function(e){return this.labels.delete(e),e.parent=null,this._labelGroup.remove(e._mesh),this.triggerChange(),this}},{key:"setColor",value:function(t){var i=this;return null===this._initialColors&&(this._initialColors=new Map,forEachMaterial(this._mesh,function(e){i._initialColors.set(e,e.color.clone()),e.addEventListener("dispose",function(){i._initialColors.delete(e)})})),forEachMaterial(this._mesh,function(e){e.color.set(t)}),this.triggerChange(),this}},{key:"isInitialColor",value:function(){var t=this;if(null===this._initialColors)return!0;var i=!0;return forEachMaterial(this._mesh,function(e){t._initialColors.get(e).equals(e.color)||(i=!1)}),i}},{key:"resetColor",value:function(){var t=this;return null!==this._initialColors&&(forEachMaterial(this._mesh,function(e){e.color.copy(t._initialColors.get(e))}),this.triggerChange()),this}},{key:"_setMesh",value:function(e){return get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_setMesh",this).call(this,e),this._mesh.add(this._labelGroup),this.updateMatrix(),this._initialColors=null,this}},{key:"setDisplayMode",value:function(e){switch(get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"setDisplayMode",this).call(this,e),e){case DISPLAY_MODES.NONE:case DISPLAY_MODES.TRANSPARENT:this._labelGroup.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._labelGroup.visible=!0;break;default:throw new Error("Unexpected")}}},{key:"_raycast",value:function(t,i){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];return!1!==get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_raycast",this).call(this,t,i,n)&&(n&&(this.floors.forEach(function(e){e._raycast(t,i,n)}),this.labels.forEach(function(e){e._raycast(t,i,n)})),!0)}},{key:"updateMatrix",value:function(){get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"updateMatrix",this).call(this),this.getBbox(selfBox),selfBox.getSize(size),this._labelGroup.position.setZ(size.z),this._labelGroup.updateMatrix(),this._labelGroup.updateMatrixWorld()}},{key:"setFading",value:function(t){return get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"setFading",this).call(this,t),this.labels.forEach(function(e){return e.setFading(t)}),this}}]),r}(),FloorObject=function(e){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,r);var t=possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return t.isFloor=!0,t.building=null,t.spaces=new Set,t.labels=new Set,t._labelGroup=new three.Group,t.altitude=null,t.decors=[],t.user=null,t}return inherits(r,AdsumObject3D),createClass(r,[{key:"getType",value:function(){return AdsumObjectTypes.FloorObject}},{key:"setDisplayMode",value:function(t){switch(get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"setDisplayMode",this).call(this,t),this.decors.forEach(function(e){return e.setDisplayMode(t)}),t){case DISPLAY_MODES.NONE:case DISPLAY_MODES.TRANSPARENT:this._labelGroup.visible=!1;break;case DISPLAY_MODES.VISIBLE:this._labelGroup.visible=!0;break;default:throw new Error("Unexpected")}}},{key:"addLabel",value:function(e){if(null!==e.parent)throw new Error("AdsumWebMap.LabelObject#addLabel: Changing labelObject parent is not supported yet.");return(e.parent=this).labels.add(e),this._labelGroup.add(e._mesh),e.updateMatrix(),this}},{key:"removeLabel",value:function(e){return this.labels.delete(e),e.parent=null,this._labelGroup.remove(e._mesh),this.triggerChange(),this}},{key:"_raycast",value:function(t,i){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];return!1!==get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_raycast",this).call(this,t,i,n)&&(n&&(this.spaces.forEach(function(e){e._raycast(t,i,n)}),this.labels.forEach(function(e){e._raycast(t,i,n)})),!0)}},{key:"_setMesh",value:function(e){return get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_setMesh",this).call(this,e),this._mesh.add(this._labelGroup),this}},{key:"setFading",value:function(t){return get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"setFading",this).call(this,t),this.decors.forEach(function(e){return e.setFading(t)}),this.spaces.forEach(function(e){return e.setFading(t)}),this.labels.forEach(function(e){return e.setFading(t)}),this.user&&this.user.setFading(t),this}}]),r}(),selfBox$1=new SelfBox3,size$1=new three.Vector3,SpaceObject=function(e){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};classCallCheck(this,r);var t=possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return t.isSpace=!0,t.parent=null,t.labels=new Set,t._labelGroup=new three.Group,t._initialColors=null,t}return inherits(r,AdsumObject3D),createClass(r,[{key:"getType",value:function(){return AdsumObjectTypes.SpaceObject}},{key:"_setMesh",value:function(e){return get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_setMesh",this).call(this,e),this._mesh.add(this._labelGroup),this.updateMatrix(!0),this._initialColors=null,this}},{key:"setColor",value:function(t){var i=this;return null===this._initialColors&&(this._initialColors=new Map,forEachMaterial(this._mesh,function(e){i._initialColors.set(e,e.color.clone()),e.addEventListener("dispose",function(){i._initialColors.delete(e)})})),forEachMaterial(this._mesh,function(e){e.color.set(t)}),this.triggerChange(),this}},{key:"isInitialColor",value:function(){var t=this;if(null===this._initialColors)return!0;var i=!0;return forEachMaterial(this._mesh,function(e){t._initialColors.get(e).equals(e.color)||(i=!1)}),i}},{key:"resetColor",value:function(){var t=this;return null!==this._initialColors&&(forEachMaterial(this._mesh,function(e){e.color.copy(t._initialColors.get(e))}),this.triggerChange()),this}},{key:"isBounced",value:function(){return 1!==this._mesh.scale.z}},{key:"getBounceFactor",value:function(){return this._mesh.scale.z}},{key:"bounceUp",value:function(e){return this._mesh.scale.setZ(e),this.updateMatrix(),this}},{key:"bounceDown",value:function(){return this.bounceUp(1)}},{key:"addLabel",value:function(e){if(null!==e.parent)throw new Error("AdsumWebMap.SpaceObject#addLabel: Changing labelObject parent is not supported yet.");return(e.parent=this).labels.add(e),this._labelGroup.add(e._mesh),e.updateMatrix(),this}},{key:"removeLabel",value:function(e){return this.labels.delete(e),e.parent=null,this._labelGroup.remove(e._mesh),this.triggerChange(),this}},{key:"_raycast",value:function(t,i){var n=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];return!1!==get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_raycast",this).call(this,t,i,n)&&(n&&this.labels.forEach(function(e){e._raycast(t,i,n)}),!0)}},{key:"updateMatrix",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"updateMatrix",this).call(this),(e||this._labelGroup.scale.z!==1/this.getBounceFactor())&&(this.getBbox(selfBox$1),selfBox$1.getSize(size$1),this._labelGroup.scale.setZ(1/this.getBounceFactor()),this._labelGroup.position.setZ(size$1.z/this.getBounceFactor()),this._labelGroup.updateMatrix(),this._labelGroup.updateMatrixWorld())}},{key:"setFading",value:function(t){return get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"setFading",this).call(this,t),this.labels.forEach(function(e){return e.setFading(t)}),this}}]),r}(),DecorObject=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,AdsumObject3D),createClass(t,[{key:"_updateVisibility",value:function(){var n=this;null===this._initialOpacities&&(this._initialOpacities=new Map,this._mesh.traverse(function(e){forEachMaterial(e,function(e){e.transparent&&(n._initialOpacities.set(e,e.opacity),e.addEventListener("dispose",function(){n._initialOpacities.delete(e)}))})})),this._mesh.traverse(function(e){forEachMaterial(e,function(e){var t=n.fading,i=1!==n.fading;n._initialOpacities.has(e)&&(t*=n._initialOpacities.get(e),i=!0),e.opacity=t,e.transparent=i})}),this.triggerChange()}}]),t}(),LoaderResult=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;classCallCheck(this,e),this.scene=null,this.site=null,this.buildingsMap=new Map,this.floorsMap=new Map,this.spacesMap=new Map,this.labelsMap=new Map,this.deviceId=t,this.projector=null,this.paths=null,this.places=null},v$2=new three.Vector3,AdsumProjector=function(){function a(e,t,i){classCallCheck(this,a),this.matrix=new three.Matrix4,this.inverseMatrix=null,this.matrix.set(e[0],e[1],0,t[0],e[3],e[4],0,t[1],0,0,1,0,0,0,0,1);var n=new three.Vector3;n.setFromMatrixScale(this.matrix),this.scale=(n.x+n.y)/2,this.matrix.set(e[0],e[1],0,t[0],e[3],e[4],0,t[1],0,0,this.scale,0,0,0,0,1);var r=adsumSpaceTransform.Gps.fromDegree(i.latitude,i.longitude,0);this.utmGridZone=new adsumSpaceTransform.UtmGridZone(r),this.northDirection=new three.Vector2,this.northDirection.copy(this.utmToAdsum({N:1,E:0,alt:0})),v$2.copy(this.utmToAdsum({N:0,E:0,alt:0})),this.northDirection.sub(v$2),this.northDirection.normalize()}return createClass(a,null,[{key:"createFake",value:function(){return new this([1,0,0,0,1,0],[0,0,0],{latitude:0,longitude:0})}}]),createClass(a,[{key:"getAdsumNorthAngle",value:function(){return this.northDirection.angle()}},{key:"getAdsumNorthDirection",value:function(e){return e.copy(this.northDirection),e}},{key:"meterToAdsumDistance",value:function(e){return e*this.scale}},{key:"adsumDistanceToMeter",value:function(e){return e/this.scale}},{key:"gpsToAdsum",value:function(e){return this.utmToAdsum(this.gpsToUtm(e))}},{key:"gpsToUtm",value:function(e){var t=e.lat,i=e.long,n=e.alt;return adsumSpaceTransform.GpsUtmConverter.toUtm(adsumSpaceTransform.Gps.fromDegree(t,i,n),this.utmGridZone)}},{key:"utmToAdsum",value:function(e){var t=e.E,i=e.N,n=e.alt,r=new three.Vector3(t,i,n);return r.applyMatrix4(this.matrix),r}},{key:"adsumToGps",value:function(e){return this.utmToGps(this.adsumToUtm(e))}},{key:"adsumToUtm",value:function(e){return null===this.inverseMatrix&&(this.inverseMatrix=new three.Matrix4,this.inverseMatrix.getInverse(this.matrix)),v$2.copy(e),v$2.applyMatrix4(this.inverseMatrix),new adsumSpaceTransform.Utm(v$2.x,v$2.y,v$2.z,this.utmGridZone.hemi,this.utmGridZone.zone)}},{key:"utmToGps",value:function(e){return adsumSpaceTransform.GpsUtmConverter.toGps(e)}}]),a}(),AdsumLoaderBase=function(){function t(e){classCallCheck(this,t),this.options=new AdsumLoaderOptions(e),this.isAoMap=!0,this.result=new LoaderResult(e.deviceId),this.adsumTextureLoader=null,this.adsumLabelLoader=null,this._registerAdsumTextureLoader()}return createClass(t,[{key:"buildLabel",value:function(e){return this.adsumLabelLoader.build(e)}},{key:"load",value:function(){var e=this;return this._startEntityManagerLoading(),this._registerAdsumTextureLoader().then(function(){return Promise.all([e._loadCollada(),e._loadProjectorTransform(),e._loadPaths(),e._loadPlaces()])}).then(function(){return e._loadLabels()}).then(function(){return e._addLabels()}).then(function(){return e.result})}},{key:"_loadCollada",value:function(){var n=this,e=this.options.entityManager.getRepository("File"),t=this.options.entityManager.getRepository("MapFile"),r=this.options.entityManager.getRepository("Place");return Promise.all([e.load(),t.load()]).then(function(){var e=n._getColladaUri();return Promise.all([n._parseCollada(e),r.load()])}).then(function(e){var t=slicedToArray(e,1)[0].scene;(n.result.scene=t).autoUpdate=!1,t.updateMatrix(),t.updateMatrixWorld();var i={building:new Map,shape:new Map};r.getAll().forEach(function(e){null!==e.building_id&&i.building.set(e.building_id,e),null!==e.shape_id&&i.shape.set(e.shape_id,e)}),n._parseAndTransformAdsumScene(t,i),n._adjustSceneSettings()})}},{key:"loadCalibration",value:function(a){var s=this.options.entityManager.getRepository("SiteCalibration"),o=this.options.entityManager.getRepository("FloorCalibration");return Promise.all([s.load(),o.load()]).then(function(){var e=s.findOneBy({device:function(e){return e.is(a)}}),t=null,i=null,n=new Map;if(null!==e&&(o.getList(e.floor_calibrations).forEach(function(e){var t=new CameraCalibration;t.eye.copy(e.eye),t.up.copy(e.up),t.target.copy(e.target),t.zoomMin=e.zoom_min||DEFAULT_CALIBRATION.ZOOM_MIN,t.zoomMax=e.zoom_max||DEFAULT_CALIBRATION.ZOOM_MAX;var i=-1===e.floor_id?null:e.floor_id;n.set(i,t)}),t=-1===e.start_floor?null:e.start_floor,null!==e.start_point_floor)){var r=e.start_point_floor;i={floorId:-1!==r?r:null,position:e.start_point_position}}return{cameraCalibrations:n,defaultFloorId:t,userPosition:i}})}},{key:"_loadPlaces",value:function(){var e=this,t=this.options.entityManager.getRepository("Place");return t.load().then(function(){e.result.places=t.getAll()})}},{key:"_loadLabels",value:function(){var t=this;return this.adsumLabelLoader=new AdsumLabelLoader(this.options.entityManager,this.result.projector),this.adsumLabelLoader.load().then(function(e){e.forEach(function(e){t.result.labelsMap.set(e.id,e)})})}},{key:"_startEntityManagerLoading",value:function(){this.options.entityManager.getRepository("Site").load(),this.options.entityManager.getRepository("MapFile").load(),this.options.entityManager.getRepository("File").load(),this.options.entityManager.getRepository("Place").load(),this.options.entityManager.getRepository("CustomObject").load(),this.options.entityManager.getRepository("SiteCalibration").load(),this.options.entityManager.getRepository("FloorCalibration").load()}},{key:"_registerAdsumTextureLoader",value:function(){var e=this;return this.options.entityManager.getRepository("File").load().then(function(){e.adsumTextureLoader=new AdsumTextureLoader(e.options.entityManager.getRepository("File"),e.options.textureQuality,e.isAoMap,function(){e.result.site&&e.result.site.triggerChange()}),three.Loader.Handlers.add(e.adsumTextureLoader.regex,e.adsumTextureLoader)})}},{key:"_getColladaUri",value:function(){var e=this.options.entityManager.getRepository("File"),t=this.options.entityManager.getRepository("MapFile"),i=t.findOneBy({type:adsumClientApi.MAP_FILE_TYPES.AO_DAE,file:function(e){return null!==e.value}}),n=null;if(this.isAoMap&&null!==i)n=i.file;else{var r=t.findOneBy({type:adsumClientApi.MAP_FILE_TYPES.DAE,file:function(e){return null!==e.value}});if(null===r)throw new Error("AdsumWebMap.AdsumLoader: No map found");n=r.file,this.isAoMap=!1}return e.get(n).uri}},{key:"_parseCollada",value:function(e){}},{key:"_disposeAll",value:function(e){var t=e.children,i=e.geometry,n=void 0;if(t)for(var r=0;r<t.length;r+=1)n=t[r],this._disposeAll(n);i&&i.dispose(),this._disposeMaterial(e)}},{key:"_disposeMaterial",value:function(e){forEachMaterial(e,function(e){var t=e.map;t&&t.dispose(),e.dispose()})}},{key:"_parseAndTransformAdsumScene",value:function(e,t){var s=this,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,o=e;if(!e.geometry&&!e.material&&0<e.children.length&&("Mesh"===e.children[0].type||e.children[0].isLight)){var n=e.parent;n.remove(e);var r=e.children[0];r.isLight?(r.matrix=e.matrix,r.matrix.decompose(r.position,r.quaternion,r.scale)):r.applyMatrix(e.matrix),n.add(r);for(var a=e.children.length-1;0<=a;a--){var l=e.children[a];r.add(l)}(o=r).name=e.name,r.updateMatrix(),r.updateMatrixWorld(),this._disposeAll(e)}var c=o.name||"";forEachMaterial(o,function(e,t){if(e.flatShading=!0,e.side=three.FrontSide,e.isMeshPhongMaterial?(e.emissionMap&&!e.map&&(e.map=e.emissionMap,e.emissionMap=null,e.color=16777215),e.shininess=1e-4):e.isMeshLambertMaterial&&e.emissionMap&&!e.map&&(e.map=e.emissionMap,e.emissionMap=null),e.lightMap)replaceMaterial(o,new three.MeshPhongMaterial({aoMap:e.lightMap,map:e.map,color:e.color}),t);else if(s.options.preferLambertMaterial()&&e.isMeshPhongMaterial){for(var i=["alphaTest","blendDst","blendDstAlpha","blendEquation","blendEquationAlpha","blending","blendSrc","blendSrcAlpha","clipIntersection","clippingPlanes","clipShadows","colorWrite","depthFunc","depthTest","depthWrite","fog","lights","name","overdraw","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","precision","premultipliedAlpha","dithering","flatShading","side","transparent","vertexColors","visible","userData","alphaMap","aoMap","aoMapIntensity","color","combine","emissive","emissiveMap","emissiveIntensity","envMap","lightMap","lightMapIntensity","map","morphNormals","morphTargets","reflectivity","refractionRatio","skinning","specularMap","wireframe","wireframeLinecap","wireframeLinejoin","wireframeLinewidth"],n={},r=0;r<i.length;r++){var a=i[r];n[a]=e[a]}replaceMaterial(o,new three.MeshLambertMaterial(n),t)}});var h=null,u=null;if(c.startsWith("SITE"))this.isAoMap&&(o.rotateX(-Math.PI/2),o.updateMatrix(),o.updateMatrixWorld()),this._mergeExtrudeMesh(o),this.result.site=new SiteObject(new AdsumObject3DOptions({id:-1})),h=this.result.site,u=o,i=this.result.site;else if(c.startsWith("BUILDING")){var p=c.match(/BUILDING_(\d+)_(.*)/),d=new AdsumObject3DOptions({id:parseInt(p[1],10),name:p[2]});t.building.has(d.id)?d.placeId=t.building.get(d.id).id:console.warn("AdsumLoader: No place associated to building "+d.id),this._mergeExtrudeMesh(o),h=new BuildingObject(d),u=o,h.site=i,h.site.buildings.add(h),this.result.buildingsMap.set(h.id,h),i=h}else if(c.startsWith("FLOOR")){var f=c.match(/FLOOR_(\d+)_(.*)/);this._mergeExtrudeMesh(o),h=new FloorObject(new AdsumObject3DOptions({id:parseInt(f[1],10),name:f[2]})),u=o,h.altitude=o.position.z,h.building=i,h.building.floors.add(h),this.result.floorsMap.set(h.id,h),i=h}else if(c.startsWith("SHAPE")||c.startsWith("STORE")){var m=c.match(/(?:SHAPE|STORE)_(\d+)_(.*)/);this._mergeExtrudeMesh(o);var g=new AdsumObject3DOptions({id:parseInt(m[1],10),name:m[2]});t.shape.has(g.id)?g.placeId=t.shape.get(g.id).id:console.warn("AdsumLoader: No place associated to space "+g.id),h=new SpaceObject(g),u=o,h.parent=i,h.parent.spaces.add(h),this.result.spacesMap.set(h.id,h),i=h}else null!==i&&(i.isFloor||i.isSite)&&(h=new DecorObject,u=o,i.decors.push(h),i=null);for(var y=o.children.length-1;0<=y;y--)if(o.children[y].geometry||0!==o.children[y].children.length)this._parseAndTransformAdsumScene(o.children[y],t,i);else{var v=o.children[y];o.remove(v),this._disposeAll(v)}null!==h&&h._setMesh(u)}},{key:"_mergeExtrudeMesh",value:function(e){for(var t=0;t<e.children.length;t++)if("ExtrudeMesh"===e.children[t].name){var i=new three.Geometry;i.fromBufferGeometry(e.geometry),e.geometry.dispose();var n=new three.Geometry;return n.fromBufferGeometry(e.children[t].children[0].geometry),e.children[t].children[0].geometry.dispose(),e.children[t].updateMatrix(),e.children[t].updateMatrixWorld(),e.children[t].children[0].updateMatrix(),e.children[t].children[0].updateMatrixWorld(),e.children[t].matrixWorld.multiplyMatrices(e.children[t].matrix,e.children[t].children[0].matrix),i.merge(n,e.children[t].matrixWorld,1),e.material=[e.material,e.children[t].children[0].material],e.geometry.fromGeometry(i),void e.remove(e.children[t])}}},{key:"_adjustSceneSettings",value:function(){var n=this;this.result.scene.traverse(function(e){forEachMaterial(e,function(e){e.shininess=1e-5}),n.options.shadowEnabled&&(e!==n.result.site._mesh&&(e.castShadow=!0),e.receiveShadow=!0)}),this._createLights(),this._createFog(),forEachMaterial(this.result.site._mesh,function(e){e.emissive&&e.emissive.set(0),e.shininess&&(e.shininess=1e-5)}),this.result.buildingsMap.forEach(function(t){var e=t._mesh;if(forEachMaterial(e,function(e){e.specular&&e.specular.set(0,0,0)}),e.geometry){var i=new three.Vector3;e.geometry.computeBoundingBox(),e.geometry.boundingBox.getCenter(i),e.geometry.center(),e.geometry.translate(0,0,i.z),i.z=0,i.multiply(e.scale),i.applyQuaternion(e.quaternion),e.position.add(i),e.children.forEach(function(e){e!==t._labelGroup&&(e.position.sub(i),e.updateMatrix())}),e.updateMatrix(),e.updateMatrixWorld()}n._colorShapeVertices(e)}),this.result.floorsMap.forEach(function(e){forEachMaterial(e._mesh,function(e){e.emissive&&e.emissive.set(0),e.shininess&&(e.shininess=1e-5)})}),this.result.spacesMap.forEach(function(e){var t=e._mesh;if(n._colorShapeVertices(t),t.geometry){var i=new three.Vector3;t.geometry.computeBoundingBox(),t.geometry.boundingBox.getCenter(i),t.geometry.center(),t.geometry.translate(0,0,i.z),i.z=0,i.multiply(t.scale),i.applyQuaternion(t.quaternion),t.position.add(i),t.updateMatrix(),t.updateMatrixWorld()}})}},{key:"_colorShapeVertices",value:function(e){if(this.isAoMap){for(var t=e.geometry,i=t.getAttribute("position"),n=t.getAttribute("color"),r=new three.Color(this.options.shapeAmbientOcclusionTopColor),a=new three.Color(this.options.shapeAmbientOcclusionBottomColor),s=0;s<i.count;s++){var o=0===i.getZ(s)?a:r;n.setXYZ(s,o.r,o.g,o.b)}n.needsUpdate=!0,forEachMaterial(e,function(e){e.vertexColors=three.VertexColors,e.needsUpdate=!0})}}},{key:"_createLights",value:function(){var e=this.options.advancedLightingEnabled()?.5:1,t=new three.HemisphereLight(16777215,8947848,e);if(t.position.set(0,0,1),this.result.scene.add(t),t.updateMatrix(),t.updateMatrixWorld(),this.options.advancedLightingEnabled()){var i=new three.DirectionalLight(16777215,.2);i.position.set(1,0,0),this.result.scene.add(i),i.updateMatrix(),i.updateMatrixWorld();var n=new three.Box3,r=new three.Sphere;n.setFromObject(this.result.scene).getBoundingSphere(r);var a=r.radius,s=r.center.clone();s.z+=a/2,s.y+=a/2,s.x-=a/2;var o=new three.DirectionalLight(16777215,.85);o.position.copy(s),o.target.position.copy(r.center),this.options.shadowEnabled&&(o.castShadow=!0,o.shadow.camera.near=a/4,o.shadow.camera.far=2*a,o.shadow.camera.right=a,o.shadow.camera.left=-a,o.shadow.camera.top=a,o.shadow.camera.bottom=-a,o.shadow.mapSize.width=this.options.shadowMapSize,o.shadow.mapSize.height=this.options.shadowMapSize),this.result.scene.add(o.target),this.result.scene.add(o),o.updateMatrix(),o.updateMatrixWorld(),o.target.updateMatrix(),o.target.updateMatrixWorld()}}},{key:"_createFog",value:function(){this.options.fogEnabled&&(this.result.scene.fog=new three.FogExp2(this.options.fogColor,this.options.fogRatio))}},{key:"_addLabels",value:function(){var n=this,r=this.options.entityManager.getRepository("Place"),a=this.options.entityManager.getRepository("CustomObject");return r.load().then(function(){n.result.labelsMap.forEach(function(e){var t=a.get(e.id),i=r.get(t.place);if(null!==i.shape_id)n.result.spacesMap.get(i.shape_id).addLabel(e);else if(null!==i.building_id){n.result.buildingsMap.get(i.building_id).addLabel(e)}else if(-1===i.floor_id)n.result.site.addLabel(e);else{n.result.floorsMap.get(i.floor_id).addLabel(e)}})})}},{key:"_loadProjectorTransform",value:function(){var t=this,i=this.options.entityManager.getRepository("Site");return i.load().then(function(){var e=i.getCurrent();e.gps_positions.size<4||6!==e.gps_transform.size||3!==e.gps_translate.size?(console.warn("AdsumWebMap.AdsumLoader: No gps positions available, wayfinding will not be accurate (we assume world unit match meter) !!"),t.result.projector=AdsumProjector.createFake()):t.result.projector=new AdsumProjector(Array.from(e.gps_transform),Array.from(e.gps_translate),Array.from(e.gps_positions)[0])})}},{key:"_loadPaths",value:function(){var t=this,i=this.options.entityManager.getRepository("MapFile");return i.load().then(function(){var e=i.findOneBy({type:adsumClientApi.MAP_FILE_TYPES.PATH});null===e?(console.warn("AdsumWebMap.AdsumLoader: No paths found, wayfinding will not be working !"),t.result.paths=new Map,t.result.paths.set("nodes",[]),t.result.paths.set("links",[])):t.result.paths=e.paths})}}]),t}(),AdsumLoader=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,AdsumLoaderBase),createClass(t,[{key:"_parseCollada",value:function(t){return this._downloadCollada(t).then(function(e){return(new AdsumColladaLoader).parse(e,void 0,t)})}},{key:"_downloadCollada",value:function(e){var t=null,i=null;try{"https:"===(t=new url.URL(e)).protocol?i=https:"http:"===t.protocol&&(i=http)}catch(e){}return null===i?new Promise(function(i,n){fs.readFile(e,function(e,t){e?n(e):i(t)})}):new Promise(function(r,a){i.get(t,function(e){var t=e.statusCode,i=void 0;if(200!==t&&(i=new Error("Request Failed with status Code: "+t)),i)return e.resume(),void a(i);e.setEncoding("utf8");var n="";e.on("data",function(e){n+=e}),e.on("end",function(){r(n)})}).on("error",function(e){a(e)})})}}]),t}(),Path=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=2<arguments.length&&void 0!==arguments[2]&&arguments[2];classCallCheck(this,n),this.from=e,this.to=t,this.pmr=i,this._distance=null,this._pathSections=[],this.computed=!1}return createClass(n,[{key:"getPathSections",value:function(){return 0<arguments.length&&void 0!==arguments[0]&&arguments[0]?this._pathSections:this._pathSections.filter(function(e){return!e.isInterGround()})}},{key:"setPathSections",value:function(e){return this._pathSections=e,this.computed=!0,this._distance=null,this}},{key:"getDistance",value:function(){var t=this;return this.computed?(null===this._distance&&(this._distance=0,this.getPathSections(!0).forEach(function(e){t._distance+=e.getDistance()})),this._distance):null}},{key:"pathSections",get:function(){return console.warn("Deprecated: AdsumWebMap.Path.pathSections property access is deprecated, please use 'getPathSections'"),this.getPathSections()}}]),n}(),FlatArrowPathPatternOptions$1=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.backgroundColor=769978,this.arrowBorderColor=0,this.arrowFillColor=16777215}},{key:"getPattern",value:function(){var e=null===this.backgroundColor?null:new three.Color(this.backgroundColor),t=null===this.arrowBorderColor?null:new three.Color(this.arrowBorderColor),i=null===this.arrowFillColor?null:new three.Color(this.arrowFillColor),n=document.createElement("canvas"),r=n.getContext("2d");n.width=64,n.height=64;var a=41.6,s=11.2;null!==e&&(r.arc(32,32,32,0,2*Math.PI),r.fillStyle="#"+e.getHexString(),r.fill()),r.beginPath(),r.moveTo(s,48),r.lineTo(32,16),r.lineTo(52.8,48),r.lineTo(42.8,48),r.lineTo(32,16+640/a),r.lineTo(21.2,48),r.closePath(),null!==i&&(r.fillStyle="#"+i.getHexString(),r.fill()),null!==t&&(r.lineWidth=1,r.strokeStyle="#"+t.getHexString(),r.stroke());var o=new three.CanvasTexture(n),l=new three.MeshBasicMaterial({color:16777215,map:o,side:three.FrontSide}),c=new three.PlaneBufferGeometry(1,1);return c.center(),Promise.resolve(new three.Mesh(c,l))}},{key:"isPathPatternOptions",get:function(){return!0}}]),t}(adactiveAbstractOptions.AbstractOptions),OrientedDotUserObjectOptions=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"reset",value:function(){this.size=3,this.color=769978}}]),t}(adactiveAbstractOptions.AbstractOptions);exports.AdsumWebMap=AdsumWebMap,exports.Options=Options,exports.CameraOptions=CameraOptions,exports.CameraCenterOnOptions=CameraCenterOnOptions,exports.EngineOptions=EngineOptions,exports.SceneOptions=SceneOptions,exports.SingleFloorAnimation=SingleFloorAnimation,exports.SingleFloorAnimationOptions=SingleFloorAnimationOptions,exports.AdsumLoader=AdsumLoader,exports.AdsumLoaderOptions=AdsumLoaderOptions,exports.MOUSE_EVENTS=MOUSE_EVENTS,exports.LabelTextObject=LabelTextObject,exports.LabelImageObject=LabelImageObject,exports.ADSUM_OBJECT_TYPES=AdsumObjectTypes,exports.TEXTURE_QUALITY=TEXTURE_QUALITY,exports.DISPLAY_MODE=DISPLAY_MODES,exports.DISPLAY_MODES=DISPLAY_MODES,exports.LABEL_ORIENTATION_MODES=LABEL_OBJECTS_ORIENTATION_MODES,exports.SCENE_EVENTS=SceneEvents,exports.WAYFINDING_EVENTS=WayfindingEvents,exports.Path=Path,exports.DotPathBuilderOptions=DotPathBuilderOptions,exports.ArrowPathPatternOptions=ArrowPathPatternOptions,exports.FlatArrowPathPatternOptions=FlatArrowPathPatternOptions$1,exports.DotPathBuilder=DotPathBuilder,exports.DotPathSectionDrawer=DotPathSectionDrawer,exports.DotPathSectionDrawerOptions=DotPathSectionDrawerOptions,exports.DotUserObject=DotUserObject,exports.DotUserObjectOptions=DotUserObjectOptions,exports.OrientedDotUserObject=OrientedDotUserObject,exports.OrientedDotUserObjectOptions=OrientedDotUserObjectOptions,exports.DisplayLevelState=DisplayLevelState,exports.LevelOfDetails=LevelOfDetails,exports.PathSection=PathSection,exports.PathBuilderTypes=PATH_BUILDER_TYPES,exports.PathPatternOptionsTypes=PATH_PATTERN_OPTIONS_TYPES,exports.PathSectionObject=PathSectionObject,exports.WayfindingOptions=WayfindingOptions,exports.UserObject=UserObject;
