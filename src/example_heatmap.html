<!DOCTYPE html>
<html lang="en">

<head>
    <title>AdsumWebMap : Change floor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
    html,
    body {
        font-family: Monospace;
        background-color: #f0f0f0;
        height: 100%;
        width: 100%;
    }
    
    #adsum-web-map-container {
        height: 100%;
        width: 100%;
    }
    </style>
</head>

<body>
    <div id="adsum-web-map-container"></div>
    <script src="./js/libs/adsum-client-api.es5.min.js"></script>
    <script src="./js/libs/adsum-web-map.es5.min.js"></script>
    <script src="./js/libs/adsum-web-map-heatmap.es5.min.js"></script>
    <script src="./js/libs/dat.gui.min.js"></script>
    <script>
    // ======================INITIALIZATION======================
    var SHAPE_MOUSE_OVER_COLOR = 0xEEEEEE;
    var SHAPE_SELECTED_COLOR = 0xFFEE00;

    var ZOOM_ON_PLACE = true;

    var adsumWebMap = null;
    var entityManager = null;
    var selectedPlace = null;

    // entry point
    window.onload = function() {
        initAdsumClientApi();
        initAdsumWebMap();
    };

    // callback definitions 
    var guiParam = {
        'floor': [],
        'radius': 10,
        'max': 100,
    };

    // initialize the adsum-client-api entity manager to get data
    var initAdsumClientApi = function() {
        var clientOptions = new ACA.Options();
        clientOptions.endpoint = "https://api.adsum.io";
        clientOptions.site = 322;
        clientOptions.username = "323-device";
        clientOptions.key = "343169bf805f8abd5fa71a4f529594a654de6afbac70a2d867a8b458c526fb7d";

        entityManager = new ACA.EntityManager(clientOptions);
    };

    // initialize the adsum-web-map => give it the entity manager and customize it
    var initAdsumWebMap = function() {
        var adsumWebMapOptions = {
            container: "adsum-web-map-container",
            deviceId: 323,
            entityManager: entityManager,
            floorsOptions: {
                showFloorsUnder: true,
                useFloorAnimations: true
            },
            pathsOptions: {
                scaleRatio: 2,
                patternSpace: 10,
                speedRatio: 1.5
            },
            positionIndicatorOptions: {
                scaleRatio: 1
            },
        };

        adsumWebMap = new AWM.AdsumWebMap(adsumWebMapOptions);

        adsumWebMap.dataManager.events.dataDidLoad.add(function() {
            initHeatMap();
        });

        adsumWebMap.init().then(function() {
            initGui();
            initModels();
            bindEvents();
        });
    };

    // Initialize the models used for path patterns and for the start point 
    var initModels = function() {
        adsumWebMap.pathManager.setPathPatternObject('./models/path_arrow.json');
        adsumWebMap.pathManager.setStartPointObject('./models/youarehere.json');
    };

    var changeFloor = function(floorId) {
        // You have to call those two methods to properly change a floor 
        adsumWebMap.cameraManager.centerOnFloor(floorId);
        adsumWebMap.mapManager.setCurrentFloor(floorId);
        // You can also chain animations : 
        // adsumWebMap.mapManager.setCurrentFloor(floorId).then(function() { 
        //     adsumWebMap.cameraManager.centerOnFloor(floorId);
        // });
    };

    ///////////////////////////////////////////////////////////////////////////
    /*
     * HeatMap demo
     */
    var adsumWebMapHeatMap = null;

    var getTwoRandomPlaces = function (allPlaces) {
        var i = Math.floor((Math.random() * (allPlaces.length-1)) + 1);
        var j = Math.floor((Math.random() * (allPlaces.length-1)) + 1);
        var ret = {
            start: allPlaces[i],
            end: allPlaces[j]
        };
        allPlaces.splice(i, 1);
        allPlaces.splice(j, 1);
        return ret;
    };

    var addSampledPositions = function(sampledPositions,data){
        for(var i=0; i < sampledPositions.length-1; i+=20){
            var pos = sampledPositions[i];
            var entry = {
                position: new AWM.THREE.Vector3(pos.x,pos.y,0),
                value: Math.floor((Math.random() * 80) + 1)
            };
            data.push(entry);
        }
    };
    var promises = [];
    var addPromises = function(startPlaceId,endPlaceId){
        var currPath = new AWM.Path();
        currPath.start = entityManager.getRepository("Place").get(startPlaceId);
        currPath.end = entityManager.getRepository("Place").get(endPlaceId);
        promises.push(adsumWebMap.pathManager.computePath( currPath ));
        return currPath;
    };

    var getFloorData = function(floorId) {
        promises = [];
        var allPlaces = entityManager.getRepository("Place").findBy({ floor_id: floorId });
        var paths = [];
        var previousRdm = null;
        while (allPlaces.length > 4) {
            var places = getTwoRandomPlaces(allPlaces);
            paths.push(addPromises(places.start.id,places.end.id));
            if(previousRdm !== null) {
                paths.push(addPromises(previousRdm.end.id,places.start.id));
            }
            previousRdm = places;
        }       

        return new Promise(function(resolve, reject) {
            Promise.all(promises).then(
            function() {
                    var data = [];
                    for(var i=0; i < paths.length-1; i++){
                        addSampledPositions(paths[i].pathSections[ 0 ]._sampledPositions,data);
                    };
                    resolve(data);
                }
            );
        });
    }

    var initHeatMap = function() {
        var currentFloorId = adsumWebMap.mapManager.getCurrentFloor();

       getFloorData(currentFloorId).then(function(data) {
            
            adsumWebMapHeatMap = new AHM.HeatMap({
                awm: adsumWebMap,
                data: data,
                floorId: currentFloorId,
                canvasSize: 2048,
                radius: 50,
                max: 30,
                z: 0,
                mode:'clarity'
            });

            adsumWebMapHeatMap.init();

            adsumWebMapHeatMap.render();

        } );
    };

    var heatMapRadiusUpdate = function(radius) {
        // Set the radius of each point of the HeatMap
        adsumWebMapHeatMap.setRadius(radius);

        //Rerender
        adsumWebMapHeatMap.render();
    };

    var heatMapMaxUpdate = function(max) {
        // Set the radius of each point of the HeatMap
        adsumWebMapHeatMap.setDataMax(max);

        //Rerender
        adsumWebMapHeatMap.clear();
        adsumWebMapHeatMap.render();
    };

    var heatMapChangeFloor = function(floorId) {

        getFloorData(floorId).then(function(data) {

            // Clear the heapMap
            adsumWebMapHeatMap.clear();

            // Set the new floor
            adsumWebMapHeatMap.setFloor(floorId); 
            
            // Data must floor related
            adsumWebMapHeatMap.setData({
                max: 30,
                data: data
            });

            //Rerender
            adsumWebMapHeatMap.render();

        });
    };

    ///////////////////////////////////////////////////////////////////////////

    // initialize the graphic user interface
    var initGui = function() {
        var info = document.createElement('div');
        info.style.position = 'absolute';
        info.style.top = '50px';
        info.style.width = '100%';
        info.style.textAlign = 'center';
        info.innerHTML = 'AdsumWebMap HeatMap example';

        document.getElementById("adsum-web-map-container").appendChild(info);

        initHeatMapGui();
    };

    var initHeatMapGui = function() {
        // Get a list of all the floors 
        var floors = adsumWebMap.mapManager.getAllFloors();

        var gui = new dat.GUI();
        var floorCtrl = gui.add(guiParam, "floor", floors);
        // Init the drop-down at the current floor value
        floorCtrl.setValue(adsumWebMap.mapManager.getCurrentFloor());

        var radiusCtrl = gui.add(guiParam, 'radius').min(10).max(70).step(10);
        radiusCtrl.setValue(50);

        var maxCtrl = gui.add(guiParam, 'max').min(10).max(200).step(10);
        maxCtrl.setValue(30);

        // When the user changes the selected floor in the drop-down, update the map
        floorCtrl.onChange(function(floorId) {
            changeFloor(parseInt(floorId));
            heatMapChangeFloor(parseInt(floorId));
        });

        radiusCtrl.onChange(function(radius) {
            heatMapRadiusUpdate(parseInt(radius));
        });

        maxCtrl.onChange(function(max) {
            heatMapMaxUpdate(parseInt(max));
        });
    };

    var bindEvents = function() {
        adsumWebMap.mapManager.events.floor.willChange.add(function(floorId) {
            console.log("The floor " + floorId + " will be the currentFloor");
        });

        adsumWebMap.mapManager.events.floor.didChange.add(function(floorId) {
            console.log("The floor " + floorId + " is now the current floor");
        });
    };
    </script>
</body>

</html>
