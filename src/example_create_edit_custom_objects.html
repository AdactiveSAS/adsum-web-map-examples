<!DOCTYPE html>
<html lang="en">

<head>
    <title>AdsumWebMap : create and edit custom objects</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
    html,
    body {
        font-family: Monospace;
        background-color: #f0f0f0;
        height: 100%;
        width: 100%;
    }
    
    #adsum-web-map-container {
        height: 100%;
        width: 100%;
    }
    </style>
</head>

<body>
    <div id="adsum-web-map-container"></div>
    <script type="text/JavaScript" src="js/libs/polyfill.min.js"></script>
    <script type="text/JavaScript" src="js/libs/adsum-client-api.ie9.min.js"></script>
    <script type="text/JavaScript" src="js/libs/adsum-web-map.ie10.min.js"></script>
    <script type="text/JavaScript" src="js/libs/dat.gui.min.js"></script>
    <script>
    // ======================INITIALIZATION======================
    var adsumWebMap = null;
    var entityManager = null;

    // entry point
    window.onload = function() {
        initAdsumClientApi().then(function(){
            initAdsumWebMap();
        }, function(e){
            console.error("Error: Unable to initialize EntityManager: " + e.message);
        });
    };

    // initialize the adsum-client-api entity manager to get data
    var initAdsumClientApi = function() {
        var clientOptions = new ACA.Options();
        clientOptions.endpoint = "https://api.adsum.io";
        clientOptions.site = 322;
        clientOptions.username = "323-device";
        clientOptions.key = "343169bf805f8abd5fa71a4f529594a654de6afbac70a2d867a8b458c526fb7d";

        entityManager = new ACA.EntityManager(clientOptions);
        return entityManager.load();
    };

    // initialize the adsum-web-map => give it the entity manager and customize it
    var initAdsumWebMap = function() {
        var adsumWebMapOptions = {
            container: "adsum-web-map-container",
            deviceId: 323,
            entityManager: entityManager,
            floorsOptions: {
                showFloorsUnder: true,
                useFloorAnimations: true
            },
            pathsOptions: {
                scaleRatio: 2,
                patternSpace: 10,
                speedRatio: 1.5
            },
            positionIndicatorOptions: {
                scaleRatio: 1
            }
        };

        adsumWebMap = new AWM.AdsumWebMap(adsumWebMapOptions);

        adsumWebMap.init().then(function() {
            initGui();
            initModels();
            bindMouseClickOnLabel();
            bindMouseClickOnFloor();
        });
    };

    // initialize the graphic user interface
    var initGui = function() {
        var info = document.createElement('div');
        info.style.position = 'absolute';
        info.style.top = '10px';
        info.style.width = '100%';
        info.style.textAlign = 'center';
        info.innerHTML = "AdsumWebMap example : Click on a label to change it's text. Click on the floor to create a picto";
        document.getElementById("adsum-web-map-container").appendChild(info);
    };

    // initialize the models used for path patterns and for the start point 
    var initModels = function() {
        adsumWebMap.pathManager.setPathPatternObject('./models/path_arrow.json');
        adsumWebMap.pathManager.setStartPointObject('./models/youarehere.json');
    };

    // ======================CUSTOM OBJECTS EDITING======================

    var changeLabelText = function(labelPlace) {
        var customObjectRepository = entityManager.getRepository("CustomObject");
        // Create a writable copy of the label that was clicked
        var label = customObjectRepository.getList(labelPlace.custom_objects)[0].clone();
        var text = prompt("Please enter some text", "");
        if (text != null) {
            // Set the label text
            label.label = text;
            // Add a background color
            label.background_color = "#0000FF";
            customObjectRepository._create(label);
            // Persist the modified object. The AdsumWebMap will automatically detect the change and update the label
            //customObjectRepository.persist(label);
        }
    };

    var createPicto = function(floorId, position) {
        // Create a ACA.File for the image you want to display  
        var file = new ACA.File();
        // You have to give a name to the file
        file.name = "adsum";
        // Set the url of the image you want to display
        file.uri = "images/adsum.png";
        // Persist the file entity
        entityManager.getRepository("File").persist(file);


        // Create a place that will be associated to the picto
        var place = new ACA.Place();
        // You have to give a name to the place
        place.name = "adsum-place";
        // Position the place where the user clicked  
        place.position = {
            x: position.x,
            y: position.y,
            z: 0 // A place always z = 0
        };
        // The place is on the clicked floor
        place.floor_id = floorId;
        // Persist the place entity
        entityManager.getRepository("Place").persist(place);


        // Create the picto
        var picto = new ACA.Picto();
        // Indicate which file the picto is displaying
        picto.file = file;
        // Indicate which place the picto is on
        picto.place = place;
        // You must specify the width and height of the picto
        picto.width = 50;
        picto.height = 50;
        entityManager.getRepository("CustomObject")._create(picto);
        // Persist the picto. The AdsumWebMap will detect a picto has been created and will display it
        //entityManager.getRepository("CustomObject").persist(picto);
    };

    // Bind a click on a label to the function changeLabelText
    var bindMouseClickOnLabel = function() {
        adsumWebMap.mapManager.events.label.mouseClick.add(changeLabelText);
    };

    // Bind a click on a floor to the function createPicto
    var bindMouseClickOnFloor = function() {
        adsumWebMap.mapManager.events.floor.mouseClick.add(createPicto);
    };
    </script>
</body>

</html>
