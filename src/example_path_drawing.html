<!DOCTYPE html>
<html lang="en">

<head>
    <title>AdsumWebMap : draw paths</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
    html,
    body {
        font-family: Monospace;
        background-color: #f0f0f0;
        height: 100%;
        width: 100%;
    }
    
    #adsum-web-map-container {
        height: 100%;
        width: 100%;
    }
    </style>
</head>

<body>
    <div id="adsum-web-map-container"></div>
    <script src="js/libs/adsum-client-api.es5.min.js"></script>
    <script src="js/libs/adsum-web-map.es5.min.js"></script>
    <script src="js/libs/dat.gui.min.js"></script>
    <script>
    // ======================INITIALIZATION======================
    var adsumWebMap = null;
    var entityManager = null;
    var lastDrawnPath = null;
    var drawing = false;
    // entry point
    window.onload = function() {
        initAdsumClientApi();
        initAdsumWebMap();
    };

    // callback definitions 
    var guiParam = {
        'from start point': function() {
            onGuiDrawPathFromStartPoint();
        },
        'from a place': function() {
            onGuiDrawPathFromPlace();
        }
    };

    // initialize the adsum-client-api entity manager to get data
    var initAdsumClientApi = function() {
        var clientOptions = new ACA.Options();
        clientOptions.endpoint = "https://api.adsum.io";
        clientOptions.site = 322;
        clientOptions.username = "323-device";
        clientOptions.key = "343169bf805f8abd5fa71a4f529594a654de6afbac70a2d867a8b458c526fb7d";

        entityManager = new ACA.EntityManager(clientOptions);
    };

    // initialize the adsum-web-map => give it the entity manager and customize it
    var initAdsumWebMap = function() {
        var adsumWebMapOptions = {
            container: "adsum-web-map-container",
            deviceId: 323,
            entityManager: entityManager,
            floorsOptions: {
                showFloorsUnder: true,
                useFloorAnimations: true
            },
            pathsOptions: {
                scaleRatio: 2,
                patternSpace: 10,
                speedRatio: 1.5
            },
            positionIndicatorOptions: {
                scaleRatio: 1
            },
        };

        adsumWebMap = new AWM.AdsumWebMap(adsumWebMapOptions);

        adsumWebMap.init().then(function() {
            initGui();
            initModels();
        });
    };

    // initialize the graphic user interface
    var initGui = function() {
        var gui = new dat.GUI();
        var f1 = gui.addFolder('Draw a path');
        f1.add(guiParam, 'from start point');
        f1.add(guiParam, 'from a place');

        var info = document.createElement('div');
        info.style.position = 'absolute';
        info.style.top = '10px';
        info.style.width = '100%';
        info.style.textAlign = 'center';
        info.innerHTML = 'AdsumWebMap example : how to draw paths';
        document.getElementById("adsum-web-map-container").appendChild(info);
    };

    // ======================PATH DRAWING FUNCTIONS======================

    // initialize the models used for path patterns and for the start point 
    var initModels = function() {
        adsumWebMap.pathManager.setPathPatternObject('./models/path_arrow.json');
        adsumWebMap.pathManager.setStartPointObject('./models/youarehere.json');
    };

    // function executed when "from start point" is clicked
    var onGuiDrawPathFromStartPoint = function() {
        // Prevent drawing several paths at the same time
        if (drawing) return;

        var destinationPlaceId = 72409;

        var path = new AWM.Path();
        path.prm = false;
        path.end = entityManager.getRepository("Place").get(destinationPlaceId);

        displayPath(path);
    };

    // function executed when "from a place" is clicked
    var onGuiDrawPathFromPlace = function() {
        // Prevent drawing several paths at the same time
        if (drawing) return;

        var sourcePlaceId = 72409;
        var destinationPlaceId = 72316;

        var path = new AWM.Path();
        path.prm = false;
        path.start = entityManager.getRepository("Place").get(sourcePlaceId);
        path.end = entityManager.getRepository("Place").get(destinationPlaceId);

        displayPath(path);

    };

    // compute the given path and display it on the map
    var displayPath = function(path) {
        // Compute the path with the pathManager
        adsumWebMap.pathManager.computePath(path).then(function() {
            drawing = true;
            // remove the path previously drawn 
            if (lastDrawnPath) {
                adsumWebMap.pathManager.removePath(lastDrawnPath);
            }
            lastDrawnPath = path;

            // draw the pathSection
            displayPathSection(path.pathSections[0]);
        }).catch(function(error) {
            console.log("Impossible to compute the path");
        });
    }

    // recursive function to chain pathSection drawing
    var displayPathSection = function(pathSection) {
        // stop condition : drawing is over
        if (!pathSection) {
            drawing = false;
            return;
        }
        // set the map to the floor the pathSection is on 
        adsumWebMap.mapManager.setCurrentFloor(pathSection.getFloorId())
            .then(function() {
                // center the camera on the pathSection and zoom on it
                var zoomOnPathSection = true;
                return adsumWebMap.cameraManager.centerOnPathSection(pathSection, zoomOnPathSection);
            })
            .then(function() {
                // draw the pathSection on the map
                return adsumWebMap.pathManager.drawPathSection(pathSection);
            })
            .then(function() {
                // Handle the next pathSection
                displayPathSection(pathSection.getNext());
            });
    };
    </script>
</body>

</html>
