<!DOCTYPE html>
<html lang="en">

<head>
    <title>AdsumWebMap : standard user interactions</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
    html,
    body {
        font-family: Monospace;
        background-color: #f0f0f0;
        height: 100%;
        width: 100%;
    }
    
    #adsum-web-map-container {
        height: 100%;
        width: 100%;
    }
    </style>
</head>

<body>
    <div id="adsum-web-map-container"></div>
    <script type="text/JavaScript" src="js/libs/polyfill.min.js"></script>
    <script type="text/JavaScript" src="js/libs/adsum-client-api.ie9.min.js"></script>
    <script type="text/JavaScript" src="js/libs/adsum-web-map.ie10.min.js"></script>
    <script type="text/JavaScript" src="js/libs/dat.gui.min.js"></script>
    <script type="text/JavaScript">
    // ======================INITIALIZATION======================
    var SHAPE_MOUSE_OVER_COLOR = 0xEEEEEE;
    var SHAPE_SELECTED_COLOR = 0xFFEE00;

    var ZOOM_ON_PLACE = true;

    var adsumWebMap = null;
    var entityManager = null;
    var selectedPlace = null;

    // entry point
    window.onload = function() {
        initAdsumClientApi().then(function(){
            initAdsumWebMap();
        }, function(e){
            console.error("Error: Unable to initialize EntityManager: " + e.message);
        });
    };

    // callback definitions 
    var guiParam = {
        'all places': function() {

        },
        'a poi places': function() {

        }
    };

    // initialize the adsum-client-api entity manager to get data
    var initAdsumClientApi = function() {
        var clientOptions = new ACA.Options();
        clientOptions.endpoint = "https://api.adsum.io";
        clientOptions.site = 322;
        clientOptions.username = "323-device";
        clientOptions.key = "343169bf805f8abd5fa71a4f529594a654de6afbac70a2d867a8b458c526fb7d";

        entityManager = new ACA.EntityManager(clientOptions);
        return entityManager.load();
    };

    // initialize the adsum-web-map => give it the entity manager and customize it
    var initAdsumWebMap = function() {
        var adsumWebMapOptions = {
            container: "adsum-web-map-container",
            deviceId: 323,
            entityManager: entityManager,
            floorsOptions: {
                showFloorsUnder: true,
                useFloorAnimations: true
            },
            pathsOptions: {
                scaleRatio: 2,
                patternSpace: 10,
                speedRatio: 1.5
            },
            positionIndicatorOptions: {
                scaleRatio: 1
            }
        };

        adsumWebMap = new AWM.AdsumWebMap(adsumWebMapOptions);

        adsumWebMap.init().then(function() {
            initGui();
            initModels();
            initShapeSelection();
            initShapeMouseOver();
        });
    };
    // initialize the graphic user interface
    var initGui = function() {
        var info = document.createElement('div');
        info.style.position = 'absolute';
        info.style.top = '10px';
        info.style.width = '100%';
        info.style.textAlign = 'center';
        info.innerHTML = 'AdsumWebMap example : Basic user interactions';
        document.getElementById("adsum-web-map-container").appendChild(info);
    };

    // initialize the models used for path patterns and for the start point 
    var initModels = function() {
        adsumWebMap.pathManager.setPathPatternObject('./models/path_arrow.json');
        adsumWebMap.pathManager.setStartPointObject('./models/youarehere.json');
    };

    // ======================USER INTERACTIONS ======================

    var initShapeMouseOver = function() {
        adsumWebMap.mapManager.events.shape.mouseEnter.add(function(place) {
            if (place == selectedPlace) return;
            var shapeId = place.shape_id;
            if (place.pois.size > 0 && adsumWebMap.mapManager.isShapeOnCurrentFloor(shapeId)) {
                adsumWebMap.mapManager.setShapeBounceUp(shapeId, 2).then(function(complete) {
                    if (complete) adsumWebMap.mapManager.setShapeColor(shapeId, SHAPE_MOUSE_OVER_COLOR);

                });
            }
        });
        adsumWebMap.mapManager.events.shape.mouseLeave.add(function(place) {
            if (place == selectedPlace) return;
            var shapeId = place.shape_id;

            if (place.pois.size > 0 && adsumWebMap.mapManager.isShapeOnCurrentFloor(shapeId)) {
                adsumWebMap.mapManager.resetShapeColor(shapeId).then(function(complete) {
                    if (complete) adsumWebMap.mapManager.setShapeBounceDown(shapeId);
                });
            }
        });
    };

    var initShapeSelection = function() {
        adsumWebMap.mapManager.events.shape.mouseClick.add(function(place) {

            adsumWebMap.cameraManager.centerOnPlace(place, ZOOM_ON_PLACE).then(function(completed) {
                var shapeId = place.shape_id;

                if (!completed || (typeof shapeId !== "number")) return;

                if (selectedPlace) {
                    deselectShape(selectedPlace);
                }

                selectedPlace = place;

                if (adsumWebMap.mapManager.isShapeOnCurrentFloor(shapeId)) {
                    selectShape(place);
                }
            });

        });
    };

    var deselectShape = function(place) {
        place.custom_objects.values.forEach(function(customObjectId) {
            adsumWebMap.mapManager.resetCustomObjectAlwaysVisible(customObjectId);
            adsumWebMap.mapManager.setCustomObjectVisibility(customObjectId, false, true);
        });
        adsumWebMap.mapManager.resetShapeColor(place.shape_id);
        adsumWebMap.mapManager.setShapeBounceDown(place.shape_id);
    }

    var selectShape = function(place) {
        place.custom_objects.values.forEach(function(customObjectId) {
            adsumWebMap.mapManager.setCustomObjectAlwaysVisible(customObjectId, true);
            adsumWebMap.mapManager.setCustomObjectVisibility(customObjectId, true, true);
        });
        adsumWebMap.mapManager.setShapeColor(place.shape_id, SHAPE_SELECTED_COLOR);
        adsumWebMap.mapManager.setShapeBounceUp(place.shape_id, 2.5);
    }
    </script>
</body>

</html>
